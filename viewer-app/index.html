<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster Viewer v50.1 (Index Fix)</title>
    <!-- 
      DeliveryMaster Live Viewer App v50.1 (Index Fix)
      
      Changelog:
      - v50.1 (FIX): Resolved Firestore index error in `listenToActiveOrdersViewer`.
        - Removed `orderBy("createdAt", "desc")` from the Firestore query.
        - Added client-side sorting by `createdAt` timestamp within the onSnapshot callback.
      - v50.0: Rebuilt viewer app based on Admin App v31.7.2.
      - Connects to Firebase for live data (Drivers, Locations, Active Orders).
      - Uses modern design (Tailwind, Inter font, Feather Icons).
      - Displays live map with active driver locations and active order locations.
      - Sidebar shows filterable lists of active orders (חדש, שויך, בדרך) and all drivers.
      - Read-only interface - no editing capabilities.
      - Real-time updates via Firestore onSnapshot listeners.
      - Integrated SmartLog for consistency.
    -->
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        
        .viewer-layout {
            display: grid;
            grid-template-rows: auto 1fr; /* Header and main content */
            height: 100vh;
        }
        
        #viewer-main-content {
            display: grid;
            grid-template-columns: 1fr 350px; /* Map and Sidebar */
            height: 100%;
            overflow: hidden;
        }
        
        #viewer-map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #viewer-map {
            height: 100%;
            width: 100%;
        }
        #viewer-side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Side Panel */
        .panel-list-container {
            flex: 1;
            overflow-y: auto;
            position: relative; /* For loader */
        }
        .panel-list {
            overflow-y: auto;
            position: relative; /* For loader */
        }
        .order-card, .driver-card {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .order-card:hover, .driver-card:hover {
            background-color: #fafafa;
        }
         .order-card.active, .driver-card.active {
             background-color: #eff6ff; /* blue-50 */
             border-right: 3px solid var(--primary-color);
         }
        .order-card .font-bold {
            color: var(--primary-dark);
        }
        
        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-active { background-color: #22c55e; } /* green-500 */
        .status-stuck { background-color: #ef4444; } /* red-500 */
        .status-inactive { background-color: #9ca3af; } /* gray-400 */
        
        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }
        
        /* Loader */
        .loader-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Connection Status */
         #connection-status {
             font-size: 0.8rem;
             font-weight: 500;
             padding: 4px 8px;
             border-radius: 99px;
             display: inline-flex;
             align-items: center;
             gap: 4px;
         }
         #connection-status.connected { background-color: #dcfce7; color: #166534; } /* green */
         #connection-status.connecting { background-color: #fef9c3; color: #854d0e; } /* yellow */
         #connection-status.error { background-color: #fee2e2; color: #991b1b; } /* red */
         #connection-status .dot { width: 6px; height: 6px; border-radius: 50%; }
         #connection-status.connected .dot { background-color: #22c55e; }
         #connection-status.connecting .dot { background-color: #facc15; }
         #connection-status.error .dot { background-color: #ef4444; }


        /* Responsive */
        @media (max-width: 768px) {
            #viewer-main-content {
                grid-template-columns: 1fr; /* Stack map and list */
            }
            #viewer-side-panel {
                position: fixed; bottom: 0; left: 0; right: 0;
                height: 50vh; /* Show panel at bottom */
                z-index: 2000; border-right: none;
                border-top: 1px solid var(--border-color);
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }
             #viewer-side-panel.open { /* Class to toggle visibility */
                 transform: translateY(0);
             }
            /* Add a toggle button if needed, or trigger via map interaction */
        }
    </style>
</head>
<body class="antialiased">

    <div class="viewer-layout">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
             <div class="flex items-center space-x-2 space-x-reverse">
                 <i data-feather="truck" class="w-7 h-7 text-blue-500"></i>
                 <h1 class="text-xl font-bold">DeliveryMaster Viewer</h1>
             </div>
             <div id="connection-status" class="connecting">
                 <span class="dot"></span>
                 <span>מתחבר...</span>
             </div>
        </header>

        <!-- Main Content (Map + Side Panel) -->
        <main id="viewer-main-content">
            <!-- Map Container -->
            <div id="viewer-map-container">
                <div id="viewer-map"></div>
                <div id="viewer-map-loader" class="loader-container">
                    <div class="loader"></div>
                    <span class="ml-4 font-semibold">טוען מפה ונתונים...</span>
                </div>
            </div>

            <!-- Side Panel (Lists) -->
            <aside id="viewer-side-panel">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button id="tab-orders" class="flex-1 p-4 font-semibold text-center border-b-2 border-blue-500 text-blue-500" onclick="showViewerPanelTab('orders')">
                        הזמנות פעילות
                    </button>
                    <button id="tab-drivers" class="flex-1 p-4 font-semibold text-center border-b-2 border-transparent text-gray-500" onclick="showViewerPanelTab('drivers')">
                        נהגים
                    </button>
                </div>
                
                <!-- Search -->
                <div class="p-3 border-b border-gray-200">
                    <input type="text" id="viewer-search-input" placeholder="חפש הזמנה או נהג..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterViewerLists()">
                </div>
                
                <!-- Lists Container -->
                <div class="panel-list-container">
                    <!-- Orders List -->
                    <div id="viewer-orders-list" class="panel-list">
                        <div class="loader-container"><div class="loader"></div></div>
                    </div>
                    
                    <!-- Drivers List -->
                    <div id="viewer-drivers-list" class="panel-list" style="display: none;">
                        <div class="loader-container"><div class="loader"></div></div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- No Modals needed for viewer -->

    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"; // Removed updateDoc, deleteDoc etc. Added 'where'
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"; // Keep serverTimestamp for logging
        // Removed Functions import if not needed

        // --- Inlined Config Logic ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        let app, auth, db;
        let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); db = getFirestore(app);
            console.log("Firebase initialized for Viewer");
        } catch (error) { console.error("CRITICAL: Firebase init failed!", error); initializationError = error; }

        const MAX_AUTH_RETRIES = 3; const RETRY_DELAY_MS = 3000;
        async function ensureAuth() {
            console.log("ensureAuth: Starting..."); let tries = 0;
            updateConnectionStatus('connecting', 'מאמת...');
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    console.log(`ensureAuth: Attempt ${tries}/${MAX_AUTH_RETRIES}...`);
                    const userCredential = await signInAnonymously(auth);
                    console.log("ensureAuth: Success.", userCredential.user.uid);
                    updateConnectionStatus('connecting', 'מאזין...'); // Stage after auth
                    return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { console.error("ensureAuth: All attempts failed."); throw e; }
                    console.log(`ensureAuth: Retrying in ${RETRY_DELAY_MS / 1000}s...`); await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            } throw new Error("ensureAuth: Max retries reached.");
        }
        const authReadyPromise = ensureAuth();

        // --- Inlined SmartLog Logic (Optional but good practice) ---
        const LOG_COLLECTION = 'system_logs_v3_viewer'; // Separate collection?
        const sessionId = (Date.now() + Math.random()).toString(36);
        let isDbAvailable = !!db; let authChecked = false;
        const writeLog = async (level, message, origin, context = {}, category = null, solution = null) => {
            const consoleArgs = [`[${origin}] ${level}:`, message]; if (Object.keys(context).length > 0) consoleArgs.push(context); if (category) consoleArgs.push(`[Cat: ${category}]`); if (solution) consoleArgs.push(`[Sol: ${solution}]`);
            switch (level) { case 'INFO': console.log(...consoleArgs); break; case 'WARN': console.warn(...consoleArgs); break; case 'ERROR': console.error(...consoleArgs); break; default: console.log(...consoleArgs); }
            if (!isDbAvailable) { return; }
            try {
                if (!authChecked || !auth?.currentUser) {
                    await authReadyPromise; authChecked = true;
                }
                const user = auth?.currentUser; if (!user) { console.warn("Viewer SmartLog: User missing after authReady."); return; }
                const userContext = { uid: user.uid, isAnonymous: user.isAnonymous };
                const logEntry = {
                    timestamp: serverTimestamp(), level, message: String(message), origin: `Viewer-${origin}`, // Add prefix
                    context: { ...JSON.parse(JSON.stringify(context || {})), sessionId, userAgent: navigator.userAgent || 'N/A', page: 'ViewerApp' },
                    user: userContext, category: category || null, solution: solution || null
                };
                // Don't await, fire-and-forget for viewer logs unless critical
                 addDoc(collection(db, LOG_COLLECTION), logEntry).catch(e => console.error("Viewer SmartLog write error:", e));
            } catch (error) {
                console.error("Viewer SmartLog FATAL ERROR.", error, { originalMessage: message });
                if (error.code === 'permission-denied' || error.message.includes('permissions')) { console.warn("Viewer SmartLog: Disabling Firestore logging."); isDbAvailable = false; }
            }
        };
        const SmartLog = {
            info: (msg, origin, ctx = {}) => { writeLog('INFO', msg, origin, ctx); },
            warn: (msg, origin, ctx = {}, cat = null, sol = null) => { writeLog('WARN', msg, origin, ctx, cat, sol); },
            error: (err, origin, ctx = {}, cat = null, sol = null) => { const msg = err instanceof Error ? err.message : String(err); const stack = err instanceof Error ? err.stack : 'N/A'; writeLog('ERROR', msg, origin, { ...ctx, stack }, cat, sol); }
        };

        // --- CONFIG & STATE ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const ACTIVE_ORDER_STATUSES = ["חדש", "שויך", "בדרך"]; // Statuses to display

        let viewerState = {
            activeOrders: [],
            drivers: [],
            liveLocations: {},
        };
        
        let viewerMap;
        let viewerDriverMarkers = {};
        let viewerOrderMarkers = {};
        
        // --- ICONS (Leaflet) ---
        // Copied from admin app
        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });

        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            initializeViewerApplication();
        });
        
        async function initializeViewerApplication() {
            SmartLog.info("v50.1 Viewer: Initializing...", "Init"); // Version bump
            try {
                updateConnectionStatus('connecting', 'מפעיל מפה...');
                initViewerMap();
                showLoader('viewer-orders-list', true);
                showLoader('viewer-drivers-list', true);
                
                await authReadyPromise; // Waits for ensureAuth to complete
                SmartLog.info(`Firebase Auth successful for viewer.`, "Init.Auth");
                
                // Auth is ready, now attach listeners
                listenToDriversViewer();
                listenToActiveOrdersViewer();
                listenToLocationsViewer();
                
                showLoader('viewer-map-loader', false);
                updateConnectionStatus('connected', 'מחובר'); // Final connected status
                
            } catch (error) {
                SmartLog.error(error, "Init.Critical", { message: "Viewer initialization failed." });
                updateConnectionStatus('error', `שגיאת אתחול: ${error.message}`);
                document.getElementById('viewer-map-loader').innerHTML = `<span class="text-red-600">שגיאת אתחול קריטית.</span>`;
                showToast(`שגיאת אתחול: ${error.message}`, 'error');
            }
        }

        function initViewerMap() {
            try {
                viewerMap = L.map('viewer-map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(viewerMap);
                SmartLog.info("Viewer Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                document.getElementById('viewer-map').innerHTML = `<div class="p-8 text-center text-red-600">שגיאה בטעינת המפה.</div>`;
            }
        }
        
        function updateConnectionStatus(statusClass, message) {
             const el = document.getElementById('connection-status');
             if (el) {
                 el.className = statusClass; // 'connecting', 'connected', 'error'
                 const span = el.querySelector('span:last-child');
                 if (span) span.innerText = message;
             }
         }

        // --- FIRESTORE LISTENERS (REAL-TIME for Viewer) ---
        
        function listenToDriversViewer() {
            SmartLog.info("Listening to Drivers...", "Firestore.Listen");
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                SmartLog.info(`Drivers: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                viewerState.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderViewerDriversList();
                renderViewerMapMarkers();
                showLoader('viewer-drivers-list', false);
            }, e => { 
                SmartLog.error(e, "Firestore.Drivers.Listener"); 
                updateConnectionStatus("error", "שגיאת נהגים"); 
            });
        }
        
        function listenToActiveOrdersViewer() {
            SmartLog.info("Listening to Active Orders...", "Firestore.Listen");
            const q = query(
                collection(db, "orders"), 
                where("status", "in", ACTIVE_ORDER_STATUSES) // Filter for active statuses
                // *** REMOVED: orderBy("createdAt", "desc") ***
            );
            onSnapshot(q, (snapshot) => {
                SmartLog.info(`Active Orders: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                // Map the data
                let ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // *** ADDED: Client-side sorting ***
                ordersData.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); // Newest first

                viewerState.activeOrders = ordersData; // Assign sorted data to state
                
                renderViewerOrdersList();
                renderViewerMapMarkers();
                showLoader('viewer-orders-list', false);
            }, e => { 
                // Log the specific error for debugging
                console.error("Firestore Orders Listener Error:", e); 
                SmartLog.error(e, "Firestore.Orders.Listener"); 
                updateConnectionStatus("error", "שגיאת הזמנות"); 
            });
        }

        function listenToLocationsViewer() {
             SmartLog.info("Listening to Locations...", "Firestore.Listen");
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                SmartLog.info(`Locations: ${snapshot.docs.length} changes.`, "Firestore.Snapshot");
                const newLocations = {};
                snapshot.forEach(doc => {
                    newLocations[doc.id] = { id: doc.id, ...doc.data() };
                });
                viewerState.liveLocations = newLocations;
                // These changes affect driver list (status) and map
                renderViewerDriversList();
                renderViewerMapMarkers();
             }, e => { 
                SmartLog.error(e, "Firestore.Locations.Listener"); 
                updateConnectionStatus("error", "שגיאת מיקומים"); 
            });
        }
        

        // --- RENDER FUNCTIONS for Viewer ---
        
        function renderViewerDriversList() {
            const list = document.getElementById('viewer-drivers-list');
             if (!list) return; // Guard clause
            list.innerHTML = ''; // Clear
            
            if (viewerState.drivers.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">לא נמצאו נהגים.</div>`;
                return;
            }
            
            viewerState.drivers.forEach(driver => {
                const location = viewerState.liveLocations[driver.id]; 
                list.appendChild(createViewerDriverCard(driver, location));
            });
            filterViewerLists(); // Apply filter after rendering
        }
        
        function createViewerDriverCard(driver, location) {
            const el = document.createElement('div');
            el.className = 'driver-card p-4 cursor-pointer';
            el.id = `viewer-driver-card-${driver.id}`; 
            el.setAttribute('data-search', driver.name.toLowerCase());
            el.onclick = () => focusViewerMapItem(driver.id, 'driver'); 
            
            let statusClass = 'status-inactive';
            let statusText = 'לא מחובר';
            
            if (location) {
                statusClass = location.isStuck ? 'status-stuck' : 'status-active';
                statusText = location.isStuck ? `תקוע (${location.minutesAgo || '?'})` : 'פעיל';
            }
            
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold">${driver.name}</span>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm font-medium">${statusText}</span>
                        <span class="status-dot ${statusClass}"></span>
                    </div>
                </div>
                <div class="text-sm text-gray-500 mt-1">
                    <span>${driver.vehicleType || 'משאית'} | ${driver.phone}</span>
                </div>
            `;
            return el;
        }
        
        function renderViewerOrdersList() {
            const list = document.getElementById('viewer-orders-list');
             if (!list) return; // Guard clause
            list.innerHTML = ''; // Clear
            
            if (viewerState.activeOrders.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">אין הזמנות פעילות כרגע.</div>`;
                return;
            }
            
            // Data is already sorted in the listener
             viewerState.activeOrders.forEach(order => {
                    list.appendChild(createViewerOrderCard(order));
                });
             filterViewerLists(); // Apply filter after rendering
        }
        
        function createViewerOrderCard(order) {
            const el = document.createElement('div');
            el.className = 'order-card p-4 cursor-pointer';
            el.id = `viewer-order-card-${order.id}`; 
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
            el.onclick = () => focusViewerMapItem(order.id, 'order'); 
            
            const customerName = order.customer?.name || 'לקוח לא ידוע';
            const address = order.address || 'כתובת לא צוינה';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            const status = order.status || '?';
            const driverName = order.driver?.name ? `(${order.driver.name})` : '';

            el.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-blue-600">${displayId}</span>
                    <span class="text-sm font-semibold">${status} ${driverName}</span>
                </div>
                <div class="font-semibold text-gray-800">${customerName}</div>
                <div class="text-sm text-gray-600 truncate">${address}</div>
                <div class="text-xs text-gray-500 mt-1">
                    <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span>
                </div>
            `;
            return el;
        }
        
        function renderViewerMapMarkers() {
            if (!viewerMap) return;

            const bounds = L.latLngBounds();

            // Render Drivers
            Object.values(viewerState.liveLocations).forEach(driverLoc => {
                if (!driverLoc.latitude || !driverLoc.longitude) return;
                
                const driverData = viewerState.drivers.find(d => d.id === driverLoc.id);
                const name = driverData?.name || 'נהג לא ידוע';
                
                const latLng = [driverLoc.latitude, driverLoc.longitude];
                const icon = driverLoc.isStuck ? driverIconStuck : driverIconActive;
                const popupContent = `<h4>${name}</h4><p>${driverLoc.isStuck ? 'תקוע' : 'פעיל'}</p>`;
                
                if (viewerDriverMarkers[driverLoc.id]) {
                    viewerDriverMarkers[driverLoc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    viewerDriverMarkers[driverLoc.id] = L.marker(latLng, { icon: icon })
                        .addTo(viewerMap)
                        .bindPopup(popupContent)
                        .on('click', () => focusViewerMapItem(driverLoc.id, 'driver'));
                }
                 if (!driverLoc.isStuck) bounds.extend(latLng);
            });
            
            // Render Active Orders
            const activeMapOrders = viewerState.activeOrders.filter(o => o.latitude && o.longitude);
            
            // Clear markers for orders that are no longer active or don't exist
            Object.keys(viewerOrderMarkers).forEach(orderId => {
                if (!activeMapOrders.some(o => o.id == orderId)) {
                    if (viewerMap.hasLayer(viewerOrderMarkers[orderId])) {
                        viewerMap.removeLayer(viewerOrderMarkers[orderId]);
                    }
                    delete viewerOrderMarkers[orderId];
                }
            });

            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const customerName = order.customer?.name || 'לקוח לא ידוע';
                const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                const popupContent = `<h4>הזמנה ${displayId}</h4><p>${customerName}</p><p>${order.address || '...'}</p><p>סטטוס: ${order.status}</p>`;
                
                if (viewerOrderMarkers[order.id]) {
                    viewerOrderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    viewerOrderMarkers[order.id] = L.marker(latLng, { icon: orderIconActive }) // Use active icon
                        .addTo(viewerMap)
                        .bindPopup(popupContent)
                        .on('click', () => focusViewerMapItem(order.id, 'order'));
                }
                bounds.extend(latLng);
            });

            // Adjust map view only if there are markers to show
             if (bounds.isValid() && (activeMapOrders.length > 0 || Object.keys(viewerDriverMarkers).some(id => !viewerState.liveLocations[id]?.isStuck))) {
                 try { viewerMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) { console.warn("FitBounds error:", e); }
             } else if (!bounds.isValid()) {
                viewerMap.setView(ISRAEL_CENTER, 9); // Reset if no markers
             }
        }
        
        
        // --- UI INTERACTIONS for Viewer ---
        
        function showViewerPanelTab(tabName) {
            document.getElementById('viewer-orders-list').style.display = (tabName === 'orders') ? 'block' : 'none';
            document.getElementById('viewer-drivers-list').style.display = (tabName === 'drivers') ? 'block' : 'none';
            
            document.getElementById('tab-orders').classList.toggle('border-blue-500', tabName === 'orders');
            document.getElementById('tab-orders').classList.toggle('text-blue-500', tabName === 'orders');
            document.getElementById('tab-orders').classList.toggle('text-gray-500', tabName !== 'orders');
            document.getElementById('tab-orders').classList.toggle('border-transparent', tabName !== 'orders');

            document.getElementById('tab-drivers').classList.toggle('border-blue-500', tabName === 'drivers');
            document.getElementById('tab-drivers').classList.toggle('text-blue-500', tabName === 'drivers');
            document.getElementById('tab-drivers').classList.toggle('text-gray-500', tabName !== 'drivers');
            document.getElementById('tab-drivers').classList.toggle('border-transparent', tabName !== 'drivers');
        }
        window.showViewerPanelTab = showViewerPanelTab; // Make global
        
        function filterViewerLists() {
            const query = document.getElementById('viewer-search-input').value.toLowerCase();
            
            document.querySelectorAll('#viewer-drivers-list .driver-card').forEach(card => {
                const search = card.getAttribute('data-search') || '';
                card.style.display = search.includes(query) ? 'block' : 'none';
            });
            document.querySelectorAll('#viewer-orders-list .order-card').forEach(card => {
                const search = card.getAttribute('data-search') || '';
                card.style.display = search.includes(query) ? 'block' : 'none';
            });
        }
        window.filterViewerLists = filterViewerLists; // Make global
        
        function focusViewerMapItem(id, type) {
            let marker, card, list;
             // Deselect all cards first
             document.querySelectorAll('.driver-card, .order-card').forEach(c => c.classList.remove('active'));

            if (type === 'driver') {
                marker = viewerDriverMarkers[id];
                 card = document.getElementById(`viewer-driver-card-${id}`);
                 list = document.getElementById('viewer-drivers-list');
            } else { // order
                marker = viewerOrderMarkers[id];
                 card = document.getElementById(`viewer-order-card-${id}`);
                 list = document.getElementById('viewer-orders-list');
            }
            
            if (marker) {
                viewerMap.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
             if (card) {
                 card.classList.add('active');
                 // Scroll into view if needed
                 card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
             }
             // Optionally close sidebar on mobile after focusing
             // document.getElementById('viewer-side-panel').classList.remove('open');
        }
        window.focusViewerMapItem = focusViewerMapItem; // Make global

        
        // --- HELPERS ---
        
        function showLoader(elementId, show) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            let loader = container.querySelector('.loader-container');
            if (show) {
                if (!loader && !container.querySelector('.loader')) { 
                    loader = document.createElement('div');
                    loader.className = 'loader-container';
                    loader.innerHTML = `<div class="loader"></div>`;
                    if (elementId !== 'viewer-map-loader') {
                         container.prepend(loader); // Prepend for lists
                    } else {
                         container.style.display = 'flex'; // Show for map
                    }
                } else if (loader) {
                     loader.style.display = 'flex'; // Ensure visible if hidden
                }
            } else {
                if (loader) {
                     loader.style.display = 'none'; // Hide instead of removing
                }
                // Handle map loader separately
                 if (elementId === 'viewer-map-loader') {
                     container.style.display = 'none';
                 }
            }
        }
        
        function showToast(message, type = 'info') {
             // Simple console log for viewer, or implement toast if needed
             console.log(`[Toast-${type.toUpperCase()}]: ${message}`);
            // If you want the visual toast:
            /*
            const container = document.getElementById('toast-container'); // Need to add this div to HTML
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
            }, 3000);
            */
        }

    </script>
</body>
</html>

