<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster - חדר מצב</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Rubik', sans-serif; }
        .order-item-clickable { cursor: pointer; transition: background-color 0.2s; }
        .order-item-clickable:hover { background-color: #f9fafb; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600"><i class="fas fa-broadcast-tower mr-2"></i> חדר מצב</h1>
        </header>

        <!-- ============================================================= -->
        <!-- MODULE 1: "החוקר הפרטי" - Frontend Component -->
        <!-- ============================================================= -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-red-600 mb-4"><i class="fas fa-user-secret"></i> חוקר פרטי: ניתוח חריגות</h2>
            <div id="investigator-panel" class="max-h-48 overflow-y-auto">
                <p class="text-gray-500 text-center">מאתר חריגות ועיכובים...</p>
            </div>
        </div>
        <!-- --- END OF MODULE --- -->

        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">סידור עבודה</h2>
            <div id="orderList" class="h-96 overflow-y-auto flex-grow"></div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col" id="modalContent"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzCr1jBhS1vqVPcrdZH72t4TWdMA5vubidNTXzXzfKjNm8Hm3uou3Ct4oRg3IOCOd52/exec';
        const investigatorPanel = document.getElementById('investigator-panel');
        const orderListContainer = document.getElementById('orderList');
        const modal = document.getElementById('orderDetailsModal');
        const modalContent = document.getElementById('modalContent');
        let currentOrders = [];

        async function fetchAnalysisAlerts() {
            try {
                const response = await fetch(`${API_URL}?action=getAlerts`);
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    const delayAlerts = result.data.filter(a => a.type === 'delay' && a.status === 'new');
                    renderDelayAlerts(delayAlerts);
                }
            } catch (error) {
                console.error("Error fetching delay alerts:", error);
                investigatorPanel.innerHTML = '<p class="text-red-500">שגיאה בטעינת נתוני חריגות.</p>';
            }
        }

        function renderDelayAlerts(alerts) {
            if (alerts.length === 0) {
                investigatorPanel.innerHTML = '<p class="text-green-500 text-center p-4"><i class="fas fa-check-circle"></i> הכל תקין, לא זוהו עיכובים.</p>';
                return;
            }
            investigatorPanel.innerHTML = alerts.map(alert => {
                const orderIdMatch = alert.message.match(/משימה (ORD-\d+)/);
                const orderId = orderIdMatch ? orderIdMatch[1] : null;
                return `
                    <div class="order-item-clickable p-3 border-b border-red-200 bg-red-50" ${orderId ? `onclick="openOrderModal('${orderId}')"` : ''}>
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-exclamation-triangle mr-3 text-xl"></i>
                            <div>
                                <p class="font-bold">${alert.subject}</p>
                                <p class="text-sm">${alert.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function fetchAllOrders() {
             try {
                const response = await fetch(`${API_URL}?action=getOrders&date=${new Date().toISOString().split('T')[0]}`);
                const result = await response.json();
                if (result.status === 'success') {
                    currentOrders = result.data;
                    renderOrderList(currentOrders);
                }
            } catch (error) {
                console.error("Error fetching orders:", error);
            }
        }

        function renderOrderList(orders) {
            orderListContainer.innerHTML = orders.map(order => `
                <div class="order-item-clickable p-3 border-b" onclick="openOrderModal('${order.orderId}')">
                    <p class="font-bold">${order.customerName}</p>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span>נהג: ${order.driverId || 'טרם שובץ'}</span>
                        <span>סטטוס: ${order.status}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function openOrderModal(orderId) {
            modal.classList.remove('hidden', 'opacity-0');
            modalContent.innerHTML = '<p class="p-8 text-center">טוען פרטים...</p>';
            try {
                const response = await fetch(`${API_URL}?action=getOrderDetails&orderId=${orderId}`);
                const result = await response.json();
                if(result.status !== 'success' || !result.data) throw new Error(result.message);
                const order = result.data;
                modalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <h2 class="text-2xl font-bold mb-4">${order.customerName}</h2>
                            <button onclick="closeModal()" class="text-2xl">&times;</button>
                        </div>
                        <p><b>סטטוס:</b> ${order.status}</p>
                        <p><b>נהג:</b> ${order.driverId || 'טרם שובץ'}</p>
                        <p><b>כתובת:</b> ${order.address}</p>
                        <p><b>הערות:</b> ${order.notes || '-'}</p>
                    </div>
                `;
            } catch (error) {
                 modalContent.innerHTML = `<p class="p-8 text-center text-red-500">שגיאה: ${error.message}</p>`;
            }
        }
        
        function closeModal() {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAllOrders();
            fetchAnalysisAlerts();
            setInterval(fetchAllOrders, 60000);
            setInterval(fetchAnalysisAlerts, 60000);
        });
    </script>
</body>
</html>
// --- END OF MODULE ---

