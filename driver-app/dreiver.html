<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeliveryMaster Driver v29.4</title>
    <!-- <link rel="manifest" href="manifest.json"> -->

    <!-- v29.3: הוספת Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <!-- v29.3: סקריפט זיהוי מובייל -->
    <script>
        (function() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            document.documentElement.className = isMobile ? 'mobile' : 'desktop';
        })();
    </script>
    
    <style>
        /* ... (כל ה-CSS מ-v29.3 נשאר זהה) ... */
        :root {
            --bg-color: #f4f4f8;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .screen.active {
            display: flex;
        }
        .container {
            padding: 15px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        #login-screen {
            justify-content: center;
            align-items: center;
        }
        #login-screen h2 {
            color: var(--primary-color);
        }
        #login-screen input {
            width: 80%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        button {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background-color: var(--primary-color);
            color: white;
            margin-top: 10px;
        }
        button.btn-secondary {
            background-color: var(--secondary-color);
        }
        button.btn-success {
            background-color: var(--success-color);
        }
        button.btn-danger {
            background-color: var(--danger-color);
        }
        button:active {
            opacity: 0.8;
        }
        #order-list-screen .header {
            background: var(--header-bg);
            padding: 15px;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border-color);
        }
        #driver-welcome {
            margin: 0;
            font-size: 1.3rem;
        }
        #order-list {
            padding: 10px 0;
        }
        .order-list-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            border-right: 5px solid var(--primary-color);
        }
        .order-list-item h4 { margin: 0 0 5px 0; }
        .order-list-item p { margin: 5px 0; font-size: 0.9rem; }
        .order-list-item .status {
            font-weight: 600;
            color: var(--secondary-color);
        }
        #order-details-screen .header {
             background: var(--header-bg);
             padding: 10px 15px;
             box-shadow: var(--shadow);
             border-bottom: 1px solid var(--border-color);
             display: flex;
             align-items: center;
        }
        #back-button {
            width: auto;
            padding: 8px 12px;
            font-size: 1rem;
            margin: 0;
            background: none;
            color: var(--primary-color);
            box-shadow: none;
        }
        #order-customer-name { margin: 0; padding-right: 15px; }
        .order-details-content {
            padding: 15px;
        }
        .order-details-content p {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        #map-canvas {
            height: 300px;
            width: 100%;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #eee;
        }
        .leaflet-container { border-radius: 8px; }
        .actions {
            padding: 10px 15px;
            background: var(--header-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            position: sticky;
            bottom: 0;
        }
        #signature-screen {
            align-items: center;
        }
        #signature-pad-container {
            width: 100%;
            max-width: 500px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }
        #signature-pad {
            width: 100%;
            height: 250px;
            display: block;
        }
        .sig-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            padding: 0 15px;
            box-sizing: border-box;
        }
        #loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 10000;
            font-weight: 500;
            display: none;
        }
    </style>
</head>
<body class="">

    <div id="loading-spinner">טוען...</div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="container">
            <h2>כניסת נהג</h2>
            <input type="text" id="driver-id-input" placeholder="שם משתמש (נהג)" autocapitalize="none">
            <button onclick="login()">התחבר</button>
        </div>
    </div>

    <!-- Order List Screen -->
    <div id="order-list-screen" class="screen">
        <div class="header">
            <h2 id="driver-welcome">ברוך הבא...</h2>
        </div>
        <div class="container">
            <h3>ההזמנות שלך להיום:</h3>
            <div id="order-list">
            </div>
            <button onclick="logout()" class="btn-secondary">התנתק</button>
        </div>
    </div>
    
    <!-- Order Details Screen -->
    <div id="order-details-screen" class="screen">
        <div class="header">
            <button id="back-button" onclick="showScreen('order-list-screen')">חזור</button>
            <h3 id="order-customer-name">טוען...</h3>
        </div>
        
        <div class="order-details-content">
            <p id="order-address"></p>
            <p id="order-phone"></p>
            <p id="order-notes"></p>
            
            <div id="map-canvas"></div>
        </div>
        
        <div class="actions">
            <button id="nav-button" class="btn-success">נווט (Waze)</button>
            <button id="status-start-btn" onclick="updateStatus('בדרך')">יצאתי לדרך</button>
            <button id="status-arrive-btn" onclick="updateStatus('הגעתי')">הגעתי ליעד</button>
            <button id="status-complete-btn" onclick="showSignaturePad()">סיים (מסירה)</button>
        </div>
    </div>
    
    <!-- Signature Screen -->
    <div id="signature-screen" class="screen">
        <div class="header">
             <button id="back-button-sig" onclick="showScreen('order-details-screen')">חזור</button>
             <h4>חתום לאישור מסירה:</h4>
        </div>
        <div id="signature-pad-container">
            <canvas id="signature-pad"></canvas>
        </div>
        <div class="sig-buttons">
            <button onclick="clearSignature()" class="btn-secondary">נקה</button>
            <button onclick="saveSignature()" class="btn-success">שמור חתימה</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script>
        // --- v29.3: הגדרות גלובליות ---
        let currentDriver = null;
        let currentOrder = null;
        let locationWatcherId = null;
        let signaturePad = null;
        let map;
        let orderMarker;
        let driverMarker;
        
        const osmStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        
        // --- v29.4: שדרוג תקשורת שרת ל-Fetch ---
        function showLoading() { document.getElementById('loading-spinner').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading-spinner').style.display = 'none'; }
        
        /**
         * v29.4: פונקציית תקשורת מבוססת fetch לאתר חיצוני
         * (אפליקציית נהג משתמשת רק ב-POST)
         */
        function runServerScript(action, params = {}, method = 'POST') {
             showLoading();
             
             // v29.4: כתובת שרת קבועה (החלף בכתובת ה-exec שלך)
             const SERVER_URL = "https://script.google.com/macros/s/AKfycbydcJnRqEUH821BnZa8Q131Z_a-VGXefpWlsXLMJEv8b1zFVHuDafo3JlbDcCf5Z3CkvQ/exec";

             let url = SERVER_URL;
             let options = {
                 method: 'POST',
                 headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                 mode: 'cors',
                 body: JSON.stringify({ action, ...params })
             };

             return new Promise((resolve, reject) => {
                 fetch(url, options)
                     .then(response => {
                         if (!response.ok) {
                             throw new Error(`Server returned status: ${response.status}`);
                         }
                         return response.json();
                     })
                     .then(data => {
                         hideLoading();
                         if (data && data.status === 'success') {
                             resolve(data.data);
                         } else {
                             reject(new Error(data.message || 'Unknown server error'));
                         }
                     })
                     .catch(error => {
                         hideLoading();
                         console.error('Fetch Error:', error.message, error);
                         reject(error);
                     });
             });
         }


        // --- פונקציות ניווט ו-Lifecycle (ללא שינוי מ-v29.3) ---
        
        document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById('signature-pad');
            function resizeCanvas() {
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                const container = document.getElementById('signature-pad-container');
                canvas.width = container.offsetWidth * ratio;
                canvas.height = container.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            
            signaturePad = new SignaturePad(canvas, {
                 backgroundColor: 'rgb(255, 255, 255)'
            });

            currentDriver = JSON.parse(localStorage.getItem('currentDriver'));
            if (currentDriver) {
                document.getElementById('driver-welcome').innerText = `ברוך הבא, ${currentDriver.name}`;
                showScreen('order-list-screen');
                loadDriverOrders();
                startLocationTracking();
            } else {
                showScreen('login-screen');
            }
        });
        
        function showScreen(screenId) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'order-details-screen' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            if (screenId === 'signature-screen') {
                clearSignature();
            }
        }

        // --- פונקציות ליבה (ללא שינוי מ-v29.3) ---

        function login() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const driverId = document.getElementById('driver-id-input').value.trim();
            if (!driverId) {
                alert('יש להזין שם משתמש');
                return;
            }
            const deviceId = 'driver-device-' + (localStorage.getItem('deviceId') || Math.random().toString(36).substr(2, 9));
            localStorage.setItem('deviceId', deviceId);
            runServerScript('loginDriver', { driverId, deviceId })
                .then(driverData => {
                    currentDriver = driverData;
                    localStorage.setItem('currentDriver', JSON.stringify(currentDriver));
                    document.getElementById('driver-welcome').innerText = `ברוך הבא, ${currentDriver.name}`;
                    showScreen('order-list-screen');
                    loadDriverOrders();
                    startLocationTracking();
                })
                .catch(err => alert(`שגיאת התחברות: ${err.message}`));
        }
        
        function logout() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                localStorage.removeItem('currentDriver');
                currentDriver = null;
                if (locationWatcherId) {
                    navigator.geolocation.clearWatch(locationWatcherId);
                    locationWatcherId = null;
                }
                document.getElementById('order-list').innerHTML = '';
                document.getElementById('driver-id-input').value = '';
                showScreen('login-screen');
            }
        }

        function loadDriverOrders() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!currentDriver) return;
            runServerScript('getDriverOrders', { driverId: currentDriver.driverId })
                .then(orders => {
                    const listEl = document.getElementById('order-list');
                    listEl.innerHTML = '';
                    if (orders.length === 0) {
                        listEl.innerHTML = '<p style="text-align: center;">אין לך הזמנות להיום.</p>';
                        return;
                    }
                    orders.forEach(order => {
                        const orderEl = document.createElement('div');
                        orderEl.className = 'order-list-item';
                        orderEl.innerHTML = `
                            <h4>${order.customerName}</h4>
                            <p>${order.address}</p>
                            <p class="status">סטטוס: ${order.status}</p>
                        `;
                        orderEl.onclick = () => openOrderDetails(order);
                        listEl.appendChild(orderEl);
                    });
                })
                .catch(err => alert(`שגיאה בטעינת הזמנות: ${err.message}`));
        }

        function openOrderDetails(order) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            currentOrder = order;
            document.getElementById('order-customer-name').innerText = order.customerName;
            document.getElementById('order-address').innerText = `כתובת: ${order.address}`;
            document.getElementById('order-phone').innerText = `טלפון: ${order.customerPhone || 'לא זמין'}`;
            document.getElementById('order-notes').innerText = `הערות: ${order.notes || 'אין'}`;
            document.getElementById('nav-button').onclick = () => {
                window.open(`https://waze.com/ul?ll=${order.latitude},${order.longitude}&navigate=yes`, '_blank');
            };
            updateStatusButtons(order.status);
            showScreen('order-details-screen');
            showOrderMap(order.latitude, order.longitude);
        }
        
        function updateStatusButtons(status) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            document.getElementById('status-start-btn').style.display = (status === 'שויך' || status === 'נסרק (מוכן לשיוך)') ? 'block' : 'none';
            document.getElementById('status-arrive-btn').style.display = (status === 'בדרך') ? 'block' : 'none';
            document.getElementById('status-complete-btn').style.display = (status === 'הגעתי') ? 'block' : 'none';
        }

        function showOrderMap(lat, lng) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!lat || !lng) {
                 document.getElementById('map-canvas').innerHTML = '<p style="text-align:center; padding-top: 20px;">אין מיקום זמין להזמנה זו.</p>';
                 return;
            }
            const latLng = [lat, lng];
            if (map) {
                map.setView(latLng, 16);
            } else {
                map = L.map('map-canvas', {
                    center: latLng,
                    zoom: 16,
                    layers: [osmStreetLayer.clone()]
                });
            }
            if (orderMarker) {
                orderMarker.setLatLng(latLng);
            } else {
                orderMarker = L.marker(latLng, {
                     icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                    })
                }).addTo(map)
                  .bindPopup(currentOrder.address);
            }
        }

        function startLocationTracking() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (locationWatcherId) {
                 console.log('Location tracking already active.');
                 return;
            }
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by this browser.');
                return;
            }
            locationWatcherId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    console.log(`Sending location: ${latitude}, ${longitude}`);
                    runServerScript('updateDriverLocation', {
                        driverId: currentDriver.driverId,
                        latitude: latitude,
                        longitude: longitude
                    }).catch(err => console.error('Failed to send location:', err.message));
                    
                    if (map && document.getElementById('order-details-screen').classList.contains('active')) {
                        const driverLatLng = [latitude, longitude];
                        if (driverMarker) {
                            driverMarker.setLatLng(driverLatLng);
                        } else {
                            driverMarker = L.marker(driverLatLng, {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                    iconSize: [25, 41], iconAnchor: [12, 41]
                                })
                            }).addTo(map).bindPopup('המיקום הנוכחי שלך');
                        }
                    }
                },
                (error) => {
                    console.error('Geolocation Error:', error.message);
                    if (error.code === error.PERMISSION_DENIED) {
                         navigator.geolocation.clearWatch(locationWatcherId);
                         locationWatcherId = null;
                         alert('מעקב המיקום נכשל. יש לאפשר הרשאות מיקום לדפדפן.');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0,
                    distanceFilter: 10
                }
            );
        }
        
        function updateStatus(newStatus) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!currentOrder) return;
            const params = {
                orderId: currentOrder.orderId,
                status: newStatus,
                driverId: currentDriver.driverId
            };
            if (newStatus === 'הגעתי') {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        params.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        sendUpdate(params);
                    },
                    (error) => {
                        console.warn('Could not get location for arrival status', error.message);
                        sendUpdate(params);
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                 sendUpdate(params);
            }
        }
        
        function sendUpdate(params) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            runServerScript('updateOrderStatus', params)
            .then(() => {
                alert(`סטטוס עודכן ל: ${params.status}`);
                currentOrder.status = params.status;
                updateStatusButtons(params.status);
            })
            .catch(err => alert(`שגיאה בעדכון סטטוס: ${err.message}`));
        }

        function showSignaturePad() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            showScreen('signature-screen');
        }
        
        function clearSignature() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (signaturePad) {
                signaturePad.clear();
            }
        }
        
        function saveSignature() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!signaturePad || signaturePad.isEmpty()) {
                alert("יש לחתום לפני השמירה.");
                return;
            }
            const signatureData = signaturePad.toDataURL('image/png');
            const params = {
                orderId: currentOrder.orderId,
                status: 'הושלם',
                driverId: currentDriver.driverId,
                signature: signatureData
            };
            runServerScript('updateOrderStatus', params)
                .then(data => {
                    alert('ההזמנה הושלמה בהצלחה!');
                    signaturePad.clear();
                    showScreen('order-list-screen');
                    loadDriverOrders();
                })
                .catch(err => alert(`שגיאה בסיום הזמנה: ${err.message}`));
        }
        
    </script>
</body>
</html>

