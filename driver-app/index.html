<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster - נהג</title>
    
    <!-- ... (head content like manifest, fonts, icons remains the same) ... -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE"></script>
    <style>
        /* ... (existing styles) ... */
        #mapView { display: none; flex-direction: column; height: 100vh; }
        #routeMap { width: 100%; flex-grow: 1; }
    </style>
</head>
<body>
    <!-- ... (loginView and mainView with list remain the same, but add the showMapBtn) ... -->
    <div id="mainView" class="view">
         <header class="app-header">
            <h1 id="welcomeMessage"></h1>
            <div class="header-buttons">
                <button id="showMapBtn" title="הצג מפה"><i class="fas fa-map-route"></i></button>
                <button id="logoutBtn" title="התנתק"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>
        <main>
            <div id="orderList" class="order-list"></div>
        </main>
    </div>

    <!-- ================================================================== -->
    <!-- MODULE 2: "מפת הדרכים החכמה" - Frontend Component -->
    <!-- ================================================================== -->
    <div id="mapView" class="view">
         <header class="app-header">
            <h1>מפת הדרכים</h1>
            <button id="backToListBtn" title="חזור לרשימה"><i class="fas fa-list"></i></button>
        </header>
        <main id="routeMap"></main>
    </div>
    <!-- --- END OF MODULE --- -->

    <!-- ... (modals) ... -->
    
    <script>
        // ... (existing script variables) ...
        const mapView = document.getElementById('mapView');
        const routeMapElement = document.getElementById('routeMap');
        const backToListBtn = document.getElementById('backToListBtn');
        const showMapBtn = document.getElementById('showMapBtn');
        let routeMap;

        // --- Add event listeners in initializeApp ---
        // showMapBtn.addEventListener('click', displayRouteMap);
        // backToListBtn.addEventListener('click', () => switchView('mainView'));
        
        async function displayRouteMap() {
            const driverId = sessionStorage.getItem('driverId');
            if (!driverId) return;

            switchView('mapView');
            routeMapElement.innerHTML = '<p class="text-center p-8">טוען מסלול...</p>';

            try {
                const response = await fetch(`${API_URL}?action=getDriverRoute&driverId=${driverId}`);
                const result = await response.json();
                
                if (result.status !== 'success' || !result.data) throw new Error(result.message);
                const { waypoints, legs } = result.data;
                if (waypoints.length === 0) {
                     routeMapElement.innerHTML = '<p class="text-center p-8">אין משימות להצגה.</p>';
                     return;
                }

                routeMap = new google.maps.Map(routeMapElement, { zoom: 10, center: { lat: waypoints[0].latitude, lng: waypoints[0].longitude } });
                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer({ map: routeMap, suppressMarkers: true });

                const request = {
                    origin: { lat: waypoints[0].latitude, lng: waypoints[0].longitude },
                    destination: { lat: waypoints[waypoints.length - 1].latitude, lng: waypoints[waypoints.length - 1].longitude },
                    waypoints: waypoints.slice(1, -1).map(wp => ({ location: { lat: wp.latitude, lng: wp.longitude } })),
                    travelMode: 'DRIVING'
                };
                
                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        directionsRenderer.setDirections(result);
                        result.routes[0].legs.forEach((leg, index) => {
                            const order = waypoints[index];
                            const marker = new google.maps.Marker({
                                position: leg.end_location,
                                map: routeMap,
                                label: `${index + 1}`
                            });
                            const content = `
                                <div dir="rtl">
                                    <h4>${order.customerName}</h4>
                                    <p><b>זמן הגעה משוער לקטע זה:</b> ${leg.duration.text}</p>
                                    <p><b>סטטוס:</b> ${order.status}</p>
                                    <button onclick="updateStatusFromMap('${order.orderId}', 'בדרך')">התחל נסיעה</button>
                                    <button onclick="openPodModal('${order.orderId}')">סיים משימה</button>
                                </div>
                            `;
                            const infoWindow = new google.maps.InfoWindow({ content: content });
                            marker.addListener('click', () => infoWindow.open(routeMap, marker));
                        });
                    }
                });

            } catch (error) {
                console.error("Error displaying route map:", error);
                routeMapElement.innerHTML = '<p class="text-red-500 text-center">שגיאה בטעינת המפה.</p>';
            }
        }
        
        function updateStatusFromMap(orderId, newStatus) {
            // Re-use existing function
            const fakeEvent = { currentTarget: document.createElement('button') };
            updateOrderStatus(fakeEvent, orderId, newStatus);
        }
    </script>
</body>
</html>

