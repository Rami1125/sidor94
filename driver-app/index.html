<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster </title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3a86ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- Styles unchanged --- */
        body { font-family: 'Rubik', sans-serif; overscroll-behavior-y: contain; }
        #map { height: 250px; border-radius: 0.5rem; background-color: #e5e7eb; }
        .leaflet-control-zoom { display: none; } .leaflet-control-attribution { font-size: 10px; }
        .btn-primary { background-color: #3a86ff; color: white; } .btn-primary:hover { background-color: #2f6ac2; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; color: white; } .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: #ffc107; color: #212529; } .btn-warning:hover { background-color: #e0a800; }
        .btn-icon { padding: 0.5rem; } .btn-disabled { opacity: 0.6; cursor: not-allowed; }
        .notification-card { border-left: 5px solid #ffc107; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3a86ff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #critical-error-display { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Main Container -->
    <div class="container mx-auto max-w-lg p-0 flex flex-col h-screen">

        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
                <p id="driver-name-display" class="text-sm text-gray-600">: 注...</p>
            </div>
            <div id="status-indicator" class="flex items-center space-x-2 space-x-reverse text-sm">
                 <span id="status-text" class="text-yellow-600 font-medium">注 驻拽爪...</span>
                 <div id="status-dot" class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
            </div>
        </header>

        <!-- Permission Request Area -->
        <div id="permission-section" class="p-4 space-y-3 bg-yellow-100 border-b border-yellow-300" style="display: none;">
             <p class="text-sm font-medium text-yellow-800">专砖转 专砖转 拽 转专转:</p>
             <button id="request-perms-btn" class="w-full text-sm py-2 px-4 rounded bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition duration-150">拽砖 专砖转</button>
        </div>

        <!-- Info & Map Area -->
        <div class="p-4">
            <div id="location-info" class="bg-blue-50 p-3 rounded-lg mb-4 text-center text-sm text-blue-800">
                 <p id="current-location-text"> 转专 拽 ...</p>
                 <p id="eta-text" class="mt-1 font-medium hidden">...</p>
            </div>
            <div id="map"><p class="p-4 text-center text-gray-500">注 驻...</p></div>
        </div>

        <!-- Order List -->
        <main id="order-list" class="flex-grow overflow-y-auto p-4 space-y-4">
             <div id="loading-orders" class="text-center py-10 text-gray-500">
                 <div class="loader mx-auto mb-2"></div>
                 注 砖转...
             </div>
        </main>

         <!-- Error Display Area -->
         <div id="critical-error-display" class="p-4 m-4 bg-red-100 border border-red-400 text-red-700 rounded text-center">
             <h3 class="font-bold">砖 拽专转!</h3>
             <p id="critical-error-message">驻拽爪 转拽 注 转 爪驻.</p>
             <p class="text-xs mt-2" id="error-suggestion"> 住 专注 转 祝  驻 转.</p>
         </div>

    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Tone.js for Sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>


    <!-- Combined & Inlined App Logic -->
    <script type="module">
      // v51.0: Top-level try-catch, Regenerated script body
      try {
        console.log('Driver App script started (v51.0)');

        // --- Firebase SDK Imports ---
        const { initializeApp, getApps, getApp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js");
        const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js");
        const { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, serverTimestamp, deleteDoc, where, writeBatch, setDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        console.log("Firebase SDKs imported.");

        // --- Config Logic ---
        const firebaseConfig = {
             apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
             storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        let app, auth, db; let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig); console.log("FB App ensured.");
            auth = getAuth(app); db = getFirestore(app);
        } catch (error) { console.error("CRITICAL: FB init failed!", error); initializationError = error; }

        const MAX_AUTH_RETRIES = 3; const RETRY_DELAY_MS = 3000;
        async function ensureAuth() {
            console.log("ensureAuth (v51.0): Starting..."); let tries = 0;
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    console.log(`ensureAuth: Attempt ${tries}/${MAX_AUTH_RETRIES}...`);
                    const userCredential = await signInAnonymously(auth);
                    if (!userCredential || !userCredential.user || !userCredential.user.uid) {
                         console.error("ensureAuth: Invalid user object!", { userCredential });
                         const currentUser = auth.currentUser;
                         if(currentUser && currentUser.uid) { console.log("ensureAuth: Fallback ok."); return currentUser; }
                         throw new Error("Invalid user object from Auth.");
                    }
                    console.log("ensureAuth: Success.", userCredential.user.uid);
                    return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { console.error("ensureAuth: All attempts failed."); throw e; }
                    console.log(`ensureAuth: Retrying in ${RETRY_DELAY_MS / 1000}s...`); await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            }
            throw new Error("ensureAuth: Unexpected exit.");
        }
        const authReadyPromise = ensureAuth();
        console.log("Config part done.");

        // --- SmartLog Logic ---
        const LOG_COLLECTION = 'system_logs_v3'; const sessionId = (Date.now() + Math.random()).toString(36);
        let isDbAvailable = !!db; let isAuthReadyForLogging = false;
        authReadyPromise.then(() => { isAuthReadyForLogging = true; console.log("SL: Auth ready."); }).catch(() => { console.warn("SL: Auth failed."); isDbAvailable = false; });
        const writeLog = async (level, message, origin, context = {}, category = null, solution = null) => {
            const consoleArgs = [`[${origin}] ${level}:`, message]; if (Object.keys(context).length > 0) consoleArgs.push(context); if (category) consoleArgs.push(`[Cat: ${category}]`); if (solution) consoleArgs.push(`[Sol: ${solution}]`);
            switch (level) { case 'INFO': console.log(...consoleArgs); break; case 'WARN': console.warn(...consoleArgs); break; case 'ERROR': console.error(...consoleArgs); break; default: console.log(...consoleArgs); }
            if (!isDbAvailable || !isAuthReadyForLogging) return;
            try {
                const user = auth?.currentUser; if (!user) return;
                const userContext = { uid: user.uid, isAnonymous: user.isAnonymous };
                const logEntry = {
                    timestamp: serverTimestamp(), level, message: String(message), origin,
                    context: { ...JSON.parse(JSON.stringify(context || {})), sessionId, userAgent: navigator.userAgent || 'N/A', page: window.location.pathname || '/driver-app/' },
                    user: userContext, category: category || null, solution: solution || null
                };
                await addDoc(collection(db, LOG_COLLECTION), logEntry);
            } catch (error) { console.error("SL FATAL Firestore write.", error); if (error.code === 'permission-denied') { console.warn("SL: Disabling Firestore log."); isDbAvailable = false; } }
        };
        const SmartLog = {
            info: (msg, origin, ctx = {}) => { writeLog('INFO', msg, origin, ctx); },
            warn: (msg, origin, ctx = {}, cat = null, sol = null) => { writeLog('WARN', msg, origin, ctx, cat, sol); },
            error: (err, origin, ctx = {}, cat = null, sol = null) => { const msg = err instanceof Error ? err.message : String(err); const stack = err instanceof Error ? err.stack : 'N/A'; writeLog('ERROR', msg, origin, { ...ctx, stack }, cat, sol); }
        };
        console.log("SmartLog part done.");


        // --- Driver App Logic ---
        let map; let driverMarker; let currentDriverId = null; let currentDriverName = null; let watchId = null; let currentOrders = {}; let notificationAudio = null; let hasNotificationPermission = false; let hasGeolocationPermission = false; let lastLocationUpdate = 0;
        let DOM = {};

        // --- Initialization ---
        async function initializeDriverApp() {
            DOM = {
                 driverNameDisplay: document.getElementById('driver-name-display'), statusText: document.getElementById('status-text'), statusDot: document.getElementById('status-dot'),
                 permissionSection: document.getElementById('permission-section'), requestPermsBtn: document.getElementById('request-perms-btn'), locationInfo: document.getElementById('location-info'),
                 currentLocationText: document.getElementById('current-location-text'), etaText: document.getElementById('eta-text'), mapElement: document.getElementById('map'), orderList: document.getElementById('order-list'), loadingOrders: document.getElementById('loading-orders'),
                 criticalErrorDisplay: document.getElementById('critical-error-display'), criticalErrorMessage: document.getElementById('critical-error-message'), errorSuggestion: document.getElementById('error-suggestion')
            };
            SmartLog.info("DOM referenced.", "Init.DOM");
            if (!DOM.driverNameDisplay || !DOM.statusText || !DOM.mapElement || !DOM.orderList) { throw new Error("DOM elements missing!"); }
            SmartLog.info("Initializing Driver App (v51.0)...", "Init"); // v51.0

            try {
                // Step 1: Check driver ID
                SmartLog.info("Step 1: Checking localStorage...", "Init");
                currentDriverId = localStorage.getItem('driverId'); currentDriverName = localStorage.getItem('driverName');
                if (!currentDriverId || !currentDriverName) { throw new Error("Missing driverId/Name in localStorage"); }
                DOM.driverNameDisplay.textContent = `: ${currentDriverName}`; SmartLog.info("Driver ID found.", "Auth");

                // Step 2: Wait for Firebase Auth
                updateStatus("转 转...", "yellow", true); SmartLog.info("Step 2: Waiting for Auth...", "Init.Auth");
                const user = await authReadyPromise; console.log("User received:", user); SmartLog.info("User received", "Auth.Debug", { user: JSON.stringify(user) });
                if (!user || !user.uid) { throw new Error("Invalid user object post-auth."); }
                SmartLog.info(`Auth successful. User: ${user.uid}`, "Init.Auth");

                // Step 3: Permissions
                updateStatus("拽 专砖转...", "yellow", true); SmartLog.info("Step 3: Checking permissions...", "Init.Permissions");
                await checkAndRequestPermissions(); SmartLog.info("Permissions check complete.", "Init.Permissions");

                // Step 4: Initialize Map
                updateStatus("转 驻...", "yellow", true); SmartLog.info("Step 4: Initializing Map...", "Init.Map");
                initMap(); SmartLog.info("Map init appears successful.", "Init.Map");

                // Step 5: Start Geolocation
                SmartLog.info("Step 5: Attempting Geolocation...", "Init.GPS");
                if (hasGeolocationPermission) { updateStatus("驻注 GPS...", "yellow", true); startGeolocation(); }
                else { updateStatus("转 砖专 拽", "red", false); SmartLog.warn("Geo permission denied/pending.", "Permissions"); }

                // Step 6: Notifications
                SmartLog.info("Step 6: Initializing Notifications...", "Init.Notifications"); initNotifications();

                // Step 7: Attach Order Listener
                updateStatus("住专 砖转...", "yellow", true); SmartLog.info("Step 7: Attaching Order Listener...", "Init.Firestore");
                listenToOrders(); SmartLog.info("Order listener attached.", "Init.Firestore");

                updateFinalStatus(); SmartLog.info("Initialization Complete.", "Init");

            } catch (error) { SmartLog.error(error, "Init.Critical"); const msg = `转 砖: ${error.message}`; updateStatus(msg, "red", false); displayCriticalError(msg, error); }
        }

        function displayCriticalError(message, errorObject = null) {
            console.error("displayCriticalError:", message, errorObject);
             if (DOM.criticalErrorDisplay && DOM.criticalErrorMessage && DOM.errorSuggestion) {
                 DOM.criticalErrorMessage.textContent = message;
                 if (message.includes("Invalid user object")) { DOM.errorSuggestion.textContent = "砖转 转. 住 住专 驻转 砖."; }
                 else { DOM.errorSuggestion.textContent = "住 专注  驻 转."; }
                 DOM.criticalErrorDisplay.style.display = 'block';
             }
        }

        // --- Status Update ---
        function updateStatus(text, color = "gray", pulse = false) { if (!DOM.statusText || !DOM.statusDot) { console.warn("Status elements missing:", text); return; } SmartLog.info(`Status: ${text}`, "UI.Status", { color, pulse }); DOM.statusText.textContent = text; DOM.statusText.className = `text-sm font-medium text-${color}-600`; DOM.statusDot.className = `w-3 h-3 rounded-full bg-${color}-400 ${pulse ? 'animate-pulse' : ''}`; }
        function updateFinalStatus() { if (watchId) updateStatus("GPS 驻注", "green", false); else if (!hasGeolocationPermission) updateStatus("专砖转 专砖转 拽", "red", false); else updateStatus("GPS  驻注", "yellow", false); }

        // --- Permissions ---
        async function checkAndRequestPermissions() {
             SmartLog.info("Checking permissions...", "Permissions"); let needsGeo = false; let needsNotif = false;
             try { const geo = await navigator.permissions.query({ name: 'geolocation' }); hasGeolocationPermission = geo.state === 'granted'; if (geo.state === 'prompt') needsGeo = true; SmartLog.info("Geo status:", "Permissions", { status: geo.state }); } catch (e) { SmartLog.warn("Geo query failed.", "Permissions", e); needsGeo = true; }
             if ('Notification' in window) { hasNotificationPermission = Notification.permission === 'granted'; if (Notification.permission === 'default') needsNotif = true; SmartLog.info("Notif status:", "Permissions", { status: Notification.permission }); } else { SmartLog.warn("Notifications not supported.", "Permissions"); }
             if (needsGeo || needsNotif) { if (DOM.permissionSection && DOM.requestPermsBtn) { DOM.permissionSection.style.display = 'block'; DOM.requestPermsBtn.removeEventListener('click', handlePermissionRequest); DOM.requestPermsBtn.addEventListener('click', handlePermissionRequest); updateStatus("转 专砖转", "yellow", true); } else { SmartLog.error("Permission UI missing!", "Permissions"); } }
             else { if (DOM.permissionSection) DOM.permissionSection.style.display = 'none'; SmartLog.info("Permissions handled.", "Permissions"); }
        }
        async function handlePermissionRequest() {
            SmartLog.info("Requesting permissions...", "Permissions"); let geoGranted = hasGeolocationPermission; let notifGranted = hasNotificationPermission;
            if (!hasGeolocationPermission) { try { await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 15000 })); const geo = await navigator.permissions.query({ name: 'geolocation' }); geoGranted = geo.state === 'granted'; hasGeolocationPermission = geoGranted; SmartLog.info("Geo result:", "Permissions", { status: geo.state }); if(geoGranted && !watchId) startGeolocation(); } catch (e) { SmartLog.error(e, "Permissions", { msg: "Geo request failed." }); } }
            if ('Notification' in window && Notification.permission === 'default') { try { const perm = await Notification.requestPermission(); notifGranted = perm === 'granted'; hasNotificationPermission = notifGranted; SmartLog.info("Notif result:", "Permissions", { status: perm }); if(notifGranted) initNotifications(); } catch (e) { SmartLog.error(e, "Permissions", { msg: "Notif request failed." }); } }
            if (geoGranted) { if (DOM.permissionSection) DOM.permissionSection.style.display = 'none'; updateFinalStatus(); }
            else { updateStatus("专砖转 专砖转 拽!", "red", false); if (DOM.requestPermsBtn) { DOM.requestPermsBtn.textContent = "拽砖 专砖 砖"; DOM.requestPermsBtn.classList.add('btn-disabled'); setTimeout(() => DOM.requestPermsBtn.classList.remove('btn-disabled'), 5000); } }
        }

        // --- Geolocation & Location Update ---
        function startGeolocation() {
            if (watchId) return; if (!hasGeolocationPermission) { SmartLog.warn("Cannot start GPS, no permission.", "GPS"); return; } if (!('geolocation' in navigator)) { SmartLog.error("Geo not supported.", "GPS"); return; }
            SmartLog.info("Starting watchPosition...", "GPS"); updateStatus("驻注 GPS...", "yellow", true);
            watchId = navigator.geolocation.watchPosition(
                async (pos) => { const { latitude, longitude, accuracy } = pos.coords; SmartLog.info("GPS Update", "GPS", { lat: latitude.toFixed(4), lon: longitude.toFixed(4), acc }); updateStatus("GPS 驻注", "green", false); updateDriverMarkerOnMap(latitude, longitude); updateLocationText(latitude, longitude); const now = Date.now(); if (now - lastLocationUpdate > 20000) { SmartLog.info("Sending location to FS...", "GPS.FS"); await updateLocationInFirestore(latitude, longitude); lastLocationUpdate = now; } },
                (err) => { SmartLog.error(err, "GPS.Error"); let msg = "砖转 GPS"; if (err.code === 1) msg = "GPS:  专砖"; else if (err.code === 2) msg = "GPS:  "; else if (err.code === 3) msg = "GPS: Timeout"; updateStatus(msg, "red", false); if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; } },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
            );
        }
        async function updateLocationInFirestore(lat, lng) { if (!db || !currentDriverId) return; const ref = doc(db, "driverLocations", currentDriverId); try { await updateDoc(ref, { latitude: lat, longitude: lng, lastUpdate: serverTimestamp() }); SmartLog.info("Location updated.", "GPS.FS"); } catch (e) { if (e.code === 'not-found') { SmartLog.warn("Location doc missing, creating...", "GPS.FS"); try { await setDoc(ref, { latitude: lat, longitude: lng, lastUpdate: serverTimestamp(), driverName: currentDriverName }); SmartLog.info("Location doc created.", "GPS.FS"); } catch (ce) { SmartLog.error(ce, "GPS.FS.Create"); } } else { SmartLog.error(e, "GPS.FS.Update"); } } }
        async function updateLocationText(lat, lng) { if (!DOM.currentLocationText) return; DOM.currentLocationText.textContent = ` ${lat.toFixed(4)}, ${lng.toFixed(4)}`; try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`); if (!res.ok) throw new Error(`${res.status}`); const data = await res.json(); if (data?.display_name) { const parts = data.display_name.split(', '); const short = parts.slice(0, 3).join(', '); DOM.currentLocationText.textContent = ` ${short}`; SmartLog.info("Rev geocode ok", "GPS.Geo", { addr: short }); } else { SmartLog.warn("Rev geocode failed: No display_name", "GPS.Geo"); } } catch (e) { SmartLog.error(e, "GPS.RevGeocode"); } }

        // --- Map Handling ---
        function initMap() { SmartLog.info("initMap...", "Map.Init"); try { if (map) map.remove(); if (!DOM.mapElement) throw new Error("Map DOM missing!"); map = L.map(DOM.mapElement); SmartLog.info("L.map ok.", "Map.Init"); L.tileLayer('https{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM', maxZoom: 18 }).addTo(map); SmartLog.info("TileLayer ok.", "Map.Init"); map.setView([32.0853, 34.7818], 13); SmartLog.info("View set.", "Map.Init"); SmartLog.info("Map init success.", "Map"); } catch (e) { SmartLog.error(e, "Map.Init"); if (DOM.mapElement) DOM.mapElement.innerHTML = '<p class="err">Map Error!</p>'; throw e; } }
        function updateDriverMarkerOnMap(lat, lng) { if (!map) return; const latLng = [lat, lng]; if (driverMarker) { driverMarker.setLatLng(latLng); } else { driverMarker = L.circleMarker(latLng, { radius: 8, fillColor: "#3a86ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map); SmartLog.info("Driver marker added.", "Map"); } map.panTo(latLng); }

        // --- Order Handling ---
        function listenToOrders() { SmartLog.info("Listening to orders:", "Orders", { driverId: currentDriverId }); const q = query( collection(db, "orders"), where("driver.id", "==", currentDriverId), where("status", "in", ["砖", "转 拽", "专"]) ); onSnapshot(q, (snapshot) => { SmartLog.info(`Orders snapshot: ${snapshot.docChanges().length} changes`, "Orders"); if (DOM.loadingOrders) DOM.loadingOrders.style.display = 'none'; let newOrder = false; snapshot.docChanges().forEach((change) => { const id = change.doc.id; const data = { id, ...change.doc.data() }; if (change.type === "added") { SmartLog.info("New order:", "Orders", { id }); currentOrders[id] = data; if (data.status === '砖') newOrder = true; } else if (change.type === "modified") { SmartLog.info("Order modified:", "Orders", { id, status: data.status }); currentOrders[id] = data; } else if (change.type === "removed") { SmartLog.info("Order removed:", "Orders", { id }); delete currentOrders[id]; } }); renderOrderList(); if (newOrder) handleNewOrderNotification(); }, (error) => { SmartLog.error(error, "Orders.Listener"); updateStatus("Sync Error", "red", false); if (DOM.loadingOrders) DOM.loadingOrders.innerHTML = '<p class="err">Sync Error</p>'; }); }
        function renderOrderList() { const arr = Object.values(currentOrders).sort((a, b) => (a.status === '砖' ? -1 : 1)); if (!DOM.orderList) return; if (arr.length === 0) { DOM.orderList.innerHTML = `<p class="center gray py-10"> 砖转.</p>`; return; } DOM.orderList.innerHTML = arr.map(o => createOrderCard(o)).join(''); try{feather.replace();} catch(e){} }
        function createOrderCard(order) { let card = "bg-white p-4 rounded-lg shadow"; let action = ''; let status = order.status || '?'; let color = "gray-500"; switch (order.status) { case '砖': card += " notification-card"; status = "砖 - 砖专"; color = "yellow-600 font-bold"; action = `<button class="w-full py-2 px-4 rounded bg-green-500 text-white font-semibold hover:bg-green-600 transition btn-success" onclick="window.acknowledgeOrder('${order.id}')"><i data-feather="check-circle" class="inline w-4 h-4 ml-1"></i> 砖专 注住</button>`; break; case '转 拽': status = "注住"; color = "blue-600"; action = `<p class="center text-sm gray-500 italic">转...</p>`; break; case '专': status = "专 拽"; color = "green-600 font-semibold"; action = `<button class="w-full py-2 px-4 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition btn-success" onclick="window.completeOrder('${order.id}')"><i data-feather="flag" class="inline w-4 h-4 ml-1"></i> 住 砖</button>`; break; default: card += " opacity-70"; } const btns = `<div class="grid grid-cols-2 gap-2 mt-3 text-sm"><a href="tel:${order.customer?.phone || ''}" class="py-2 px-3 rounded bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition center"><i data-feather="phone" class="inline w-4 h-4 ml-1"></i> 拽</a><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(order.address || '')}" target="_blank" class="py-2 px-3 rounded bg-blue-500 text-white font-medium hover:bg-blue-600 transition center"><i data-feather="navigation" class="inline w-4 h-4 ml-1"></i> </a></div>`; return `<div class="${card}" id="order-${order.id}"><div class="flex justify-between items-start mb-2"><div><h3 class="text-lg font-bold text-gray-900">${order.customer?.name || '?'}</h3><p class="text-sm text-gray-600">${order.address || '?'}</p></div><span class="text-xs font-medium text-${color} whitespace-nowrap">${status}</span></div><p class="text-xs text-gray-500 mb-3">注专转: ${order.notes || ''}</p>${action}${btns}</div>`; }

        // --- Order Actions ---
        window.acknowledgeOrder = async (orderId) => { SmartLog.info("Ack order...", "Orders.Action", { orderId }); try { const ref = doc(db, "orders", orderId); await updateDoc(ref, { status: "转 拽" }); SmartLog.info("Status -> 转 拽", "Orders.Action", { orderId }); stopNotificationSound(); document.getElementById(`order-${orderId}`)?.classList.remove('notification-card'); } catch (e) { SmartLog.error(e, "Orders.Action.Ack"); alert("砖."); } };
        window.completeOrder = async (orderId) => { SmartLog.info("Completing order...", "Orders.Action", { orderId }); if (!confirm("住 砖?")) return; try { const ref = doc(db, "orders", orderId); await updateDoc(ref, { status: "砖", completedAt: serverTimestamp() }); SmartLog.info("Status -> 砖", "Orders.Action", { orderId }); } catch (e) { SmartLog.error(e, "Orders.Action.Complete"); alert("砖."); } };

        // --- Notifications ---
        function initNotifications() { if (!hasNotificationPermission || !window.Tone) return; try { notificationAudio = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination(); SmartLog.info("Audio init ok.", "Notifications"); } catch (e) { SmartLog.error(e, "Notifications.InitAudio"); } }
        function handleNewOrderNotification() { SmartLog.info("New order notification...", "Notifications"); if (notificationAudio && Tone?.context?.state === 'running') { try { notificationAudio.triggerAttackRelease("C5", "8n", Tone.now()); notificationAudio.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); SmartLog.info("Sound ok.", "Notifications"); } catch(e) { SmartLog.error(e, "Notifications.PlaySound"); } } else if (notificationAudio) { Tone.start().then(() => { SmartLog.info("Audio ctx resumed.", "Notifications"); try { notificationAudio.triggerAttackRelease("C5", "8n", Tone.now()); notificationAudio.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); } catch(e) { SmartLog.error(e, "Notifications.PlayRetry"); } }).catch(e => SmartLog.error(e, "Notifications.ToneStartFail")); } else { SmartLog.warn("Cannot play sound.", "Notifications"); } if (hasNotificationPermission && 'Notification' in window) { const n = new Notification(" 砖!", { body: "砖 砖 砖专.", icon: "https://i.postimg.cc/ryPT3r29/image.png", vibrate: [200, 100, 200] }); n.onclick = () => { window.focus(); SmartLog.info("Notif clicked.", "Notifications"); }; SmartLog.info("Browser notif ok.", "Notifications"); } else { SmartLog.warn("Cannot show browser notif.", "Notifications"); } }
        function stopNotificationSound() { SmartLog.info("Stopping sound (placeholder).", "Notifications"); }

        // --- Service Worker ---
        function registerServiceWorker() { if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => SmartLog.info('SW ok', 'PWA', { scope: reg.scope })).catch(err => SmartLog.error(err, 'PWA', { msg: 'SW fail' })); }); } else { SmartLog.warn("SW not supported.", "PWA"); } }

        // --- Start Application ---
        function runInitialization() {
             console.log('DOMContentLoaded fired (v51.0). Attaching main initialization.'); // v51.0
             try { if (typeof SmartLog === 'undefined') { throw new Error("SmartLog missing!"); } SmartLog.info("DOMContentLoaded.", "Init"); registerServiceWorker(); initializeDriverApp(); try { if(feather) feather.replace(); } catch (e) { SmartLog.warn("Feather fail.", "UI", e); } }
             catch (criticalError) { console.error("CRITICAL SYNC ERROR:", criticalError); displayCriticalError(`砖 拽专转: ${criticalError.message}`, criticalError); (SmartLog.error || console.error)(criticalError, "Init.SyncCritical"); }
        }
        console.log("Attaching DOMContentLoaded listener..."); document.addEventListener('DOMContentLoaded', runInitialization); console.log("Listener attached.");

      } catch (topLevelError) { console.error("CRITICAL TOP-LEVEL SCRIPT ERROR:", topLevelError); try { const el = document.createElement('div'); el.style.cssText = 'position:fixed;top:10px;left:10px;right:10px;padding:10px;background:red;color:white;z-index:9999;'; el.textContent = `JS Error: ${topLevelError.message}`; document.body?.prepend(el); } catch (e) { console.error("UI error display failed:", e); } }
    </script>

</body>
</html>

