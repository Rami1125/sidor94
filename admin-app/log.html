<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster - לוגים</title>
    <!-- DeliveryMaster Log Viewer v28.8 -->

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9fafb;
        }
        .log-item {
            border-right-width: 4px;
        }
        .log-INFO { border-right-color: #3498db; }
        .log-ERROR { border-right-color: #e74c3c; }
        .log-WARNING { border-right-color: #f39c12; }
        .log-Client { border-right-color: #9b59b6; }
        
        #log-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #log-details-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #map-placeholder {
            height: 300px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            border-radius: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">מציג לוגים - v28.8</h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <select id="level-filter" class="border rounded-md px-3 py-2" onchange="renderLogs()">
                    <option value="ALL">כל הרמות</option>
                    <option value="ERROR">ERROR</option>
                    <option value="WARNING">WARNING</option>
                    <option value="INFO">INFO</option>
                    <option value="Client">Client</option>
                </select>
                <button onclick="loadLogs()" id="refresh-btn" class="p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    <i data-feather="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div id="loader" class="text-center py-10" style="display: none;">
            <div class="loader inline-block border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 animate-spin"></div>
        </div>
        <div id="log-list" class="space-y-3">
            <!-- Log items will be injected here -->
        </div>
    </main>

    <!-- Log Details Modal -->
    <div id="log-details-modal" onclick="closeModal()">
        <div id="log-details-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">פרטי לוג</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800">
                    <i data-feather="x"></i>
                </button>
            </div>
            <pre id="log-json" class="bg-gray-100 p-4 rounded-md overflow-x-auto text-sm"></pre>
            <div id="map-placeholder">
                טוען מפה...
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWnjH9nlF5Yw3tpG6OygtBKRZHaB8Sfc2aw3_kY70RhE9UJUsTEjnmjf-i4OiXVK97/exec';
        let allLogs = [];
        let mapInstance = null;

        // --- API ---
        async function apiFetch(action, method = 'GET', data = null) {
            const url = `${API_URL}?action=${action}`;
            const options = {
                method: method,
                redirect: 'follow',
                muteHttpExceptions: true,
            };

            if (method === 'POST') {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify({ action: action, data: data });
            }

            try {
                const response = await fetch(method === 'GET' ? url : API_URL, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.data);
                }
                return result.data;
            } catch (error) {
                console.error(`API Fetch Error (${action}):`, error);
                alert(`שגיאת תקשורת: ${error.message}`);
                throw error;
            }
        }

        // --- Logic ---
        function loadLogs() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('log-list').innerHTML = '';
            document.getElementById('refresh-btn').disabled = true;

            apiFetch('getLogs&limit=200')
                .then(logs => {
                    allLogs = logs;
                    renderLogs();
                })
                .catch(error => {
                    document.getElementById('log-list').innerHTML = `<p class="text-center text-red-500">שגיאה בטעינת לוגים: ${error.message}</p>`;
                })
                .finally(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('refresh-btn').disabled = false;
                });
        }

        function renderLogs() {
            const list = document.getElementById('log-list');
            const filter = document.getElementById('level-filter').value;
            list.innerHTML = '';

            const filteredLogs = allLogs.filter(log => filter === 'ALL' || log.Level === filter);

            if (filteredLogs.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">לא נמצאו לוגים.</p>';
                return;
            }

            filteredLogs.forEach((log, index) => {
                list.appendChild(createLogElement(log, index));
            });

            feather.replace(); // Re-apply icons
        }

        function createLogElement(log, index) {
            const el = document.createElement('div');
            const level = log.Level || 'INFO';
            const origin = log.Origin || 'Unknown';
            const timestamp = new Date(log.Timestamp).toLocaleString('he-IL', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            el.className = `log-item log-${level} bg-white p-4 rounded-md shadow-sm flex justify-between items-center`;
            
            el.innerHTML = `
                <div class="flex-1 overflow-hidden">
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <span class="font-bold text-gray-800">${origin}</span>
                        <span class="text-sm text-gray-500">${timestamp}</span>
                    </div>
                    <p class="text-gray-700 truncate" title="${log.Message}">${log.Message}</p>
                </div>
                <button class="mr-4 text-gray-500 hover:text-blue-500" onclick="showDetails(${index})">
                    <i data-feather="zoom-in"></i>
                </button>
            `;
            return el;
        }

        function showDetails(index) {
            const log = allLogs[index];
            let dataObject = {};
            
            try {
                // The data might be a stringified JSON string, or just a string
                dataObject = JSON.parse(log.Data);
            } catch (e) {
                dataObject = { rawData: log.Data };
            }

            // Format JSON for display
            document.getElementById('log-json').textContent = JSON.stringify(log, null, 2);
            document.getElementById('log-details-modal').style.display = 'flex';
            
            // Check for coordinates in the data object
            let lat = null, lon = null;
            if (dataObject.context && dataObject.context.latitude) {
                // Client log with context
                lat = dataObject.context.latitude;
                lon = dataObject.context.longitude;
            } else if (dataObject.latitude) {
                // Simple object with coords
                lat = dataObject.latitude;
                lon = dataObject.longitude;
            }

            // Initialize map if coords exist
            const mapEl = document.getElementById('map-placeholder');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            
            if (lat && lon) {
                mapEl.innerHTML = ''; // Clear "loading" text
                mapEl.style.height = '300px';
                
                mapInstance = L.map(mapEl).setView([lat, lon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(mapInstance);
                L.marker([lat, lon]).addTo(mapInstance);
                
                // Leaflet sometimes has trouble resizing in a modal
                // We force it to re-check its size
                setTimeout(() => mapInstance.invalidateSize(), 100);
                
            } else {
                mapEl.style.height = '100px';
                mapEl.innerHTML = 'אין נתוני מיקום בלוג זה.';
            }

            feather.replace();
        }

        function closeModal() {
            document.getElementById('log-details-modal').style.display = 'none';
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            loadLogs();
        });
    </script>

</body>
</html>
