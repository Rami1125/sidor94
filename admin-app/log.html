<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v33.1 - ×¦×’ ×œ×•×’×™× ×—×›× (××œ×©×™× ×•×Ÿ)</title>
    <!-- Tailwind Play CDN (for quick demo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        }
        /* Glass UI Style */
        .glass-ui {
            background-color: rgba(31, 41, 55, 0.7); /* bg-gray-800 bg-opacity-70 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Log level colors */
        .level-INFO { --tw-text-opacity: 1; color: rgb(59 130 246 / var(--tw-text-opacity)); }
        .level-WARN { --tw-text-opacity: 1; color: rgb(245 158 11 / var(--tw-text-opacity)); }
        .level-ERROR { --tw-text-opacity: 1; color: rgb(239 68 68 / var(--tw-text-opacity)); font-weight: 600; }
        .level-CLIENT_ERROR { --tw-text-opacity: 1; color: rgb(234 179 8 / var(--tw-text-opacity)); font-weight: 600; }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 1.25rem;
            left: 1.25rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            direction: rtl; /* Ensure toasts are RTL */
        }
        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(-100%); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <div class="container mx-auto max-w-7xl space-y-6">
        
        <!-- 1. Header -->
        <header class="glass-ui p-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white">×¦×’ ×œ×•×’×™× ×—×›× (××œ×©×™× ×•×Ÿ)</h1>
                <p class="text-sm text-gray-400">v33.1 - × ×™×˜×•×¨ ×¤×¢×•×œ×•×ª ××¢×¨×›×ª ×‘×–××Ÿ ×××ª</p>
            </div>
            <div class="text-sm text-gray-400" id="connection-status">
                <span class="text-yellow-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
            </div>
        </header>

        <!-- 2. Filters -->
        <div class="glass-ui p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" id="filter-text" class="w-full bg-gray-900 text-white p-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:ring-blue-500" placeholder="×¡× ×Ÿ ×œ×¤×™ ×”×•×“×¢×”, ××§×•×¨...">
            <select id="filter-level" class="w-full bg-gray-900 text-white p-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:ring-blue-500">
                <option value="">×›×œ ×”×¨××•×ª</option>
                <option value="ERROR">×©×’×™××” (ERROR)</option>
                <option value="WARN">××–×”×¨×” (WARN)</option>
                <option value="INFO">××™×“×¢ (INFO)</option>
            </select>
            <button id="force-refresh" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                ×¨×¢× ×Ÿ ×›×¢×ª
            </button>
        </div>

        <!-- 3. Log Table -->
        <div class="glass-ui overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-full text-right">
                    <thead class="border-b border-gray-700">
                        <tr class="text-gray-400 text-sm">
                            <th class="p-3">ğŸ•“ ×–××Ÿ</th>
                            <th class="p-3">ğŸ·ï¸ ×¨××”</th>
                            <th class="p-3">ğŸ§© ××§×•×¨</th>
                            <th class="p-3">ğŸ’¬ ×”×•×“×¢×”</th>
                            <th class="p-3">ğŸ’¡ ×”××œ×¦×” ×œ×¤×ª×¨×•×Ÿ</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body" class="divide-y divide-gray-700">
                        <!-- Rows injected by JS -->
                        <tr><td colspan="5" class="p-8 text-center text-gray-500">×˜×•×¢×Ÿ ×œ×•×’×™×...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyZ84w5JTr-up3kU5mFFqmbhtZMqhHZ5RsG-lnul4Y9_bH5lOAAbdzD291I1SBda91m/exec"; // !!! ×™×© ×œ×”×“×‘×™×§ ×›××Ÿ ××ª ×”-URL ×©×œ ×”-WebApp
        const POLL_INTERVAL = 10000; // 10 ×©× ×™×•×ª
        const APP_NAME = "AdminLogMonitor_v33.1";

        // --- 2. Global State ---
        let globalState = {
            logs: [],
            lastLogTimestamp: null // Used to detect new logs for notifications
        };

        // --- 3. API Fetch Utility ---
        async function apiFetch(action, payload = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload, context: { app: APP_NAME } }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error(`API Failure: ${action}`, error);
                document.getElementById('connection-status').innerHTML = `<span class="text-red-500">×©×’×™××ª ×”×ª×—×‘×¨×•×ª</span>`;
                throw error;
            }
        }

        // --- 4. Core Logic ---
        async function fetchLogs() {
            try {
                const newLogs = await apiFetch('getRecentLogs');
                if (!newLogs || newLogs.length === 0) {
                    document.getElementById('connection-status').innerHTML = `<span class="text-green-400">××—×•×‘×¨ (××™×Ÿ ×œ×•×’×™×)</span>`;
                    return;
                }

                document.getElementById('connection-status').innerHTML = `<span class="text-green-400">××—×•×‘×¨ (×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: ${new Date().toLocaleTimeString()})</span>`;

                // Check for new logs to notify
                const newestLogTimestamp = newLogs[0].Timestamp;
                if (globalState.lastLogTimestamp && newestLogTimestamp > globalState.lastLogTimestamp) {
                    const trulyNewLogs = newLogs.filter(log => log.Timestamp > globalState.lastLogTimestamp);
                    showNewLogNotifications(trulyNewLogs);
                }
                
                globalState.lastLogTimestamp = newestLogTimestamp;
                globalState.logs = newLogs;
                renderLogs();

            } catch (error) {
                // Error is already logged by apiFetch
            }
        }

        // --- 5. Render Functions ---
        function renderLogs() {
            const tableBody = document.getElementById('logs-table-body');
            const filterText = document.getElementById('filter-text').value.toLowerCase();
            const filterLevel = document.getElementById('filter-level').value;

            const filteredLogs = globalState.logs.filter(log => {
                const textMatch = !filterText ||
                    (log.Message && log.Message.toLowerCase().includes(filterText)) ||
                    (log.Origin && log.Origin.toLowerCase().includes(filterText)) ||
                    (log.Hint && log.Hint.toLowerCase().includes(filterText));
                const levelMatch = !filterLevel || (log.Level && log.Level === filterLevel);
                return textMatch && levelMatch;
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">×œ× × ××¦××• ×œ×•×’×™× ×ª×•×××™×.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredLogs.map(log => {
                const level = log.Level || 'INFO';
                const levelClass = `level-${level.replace(' ', '_')}`;
                
                return `
                    <tr class="hover:bg-gray-700 text-sm">
                        <td class="p-3 text-gray-400">${new Date(log.Timestamp).toLocaleString('he-IL')}</td>
                        <td class="p-3 font-bold ${levelClass}">${level}</td>
                        <td class="p-3 text-cyan-300 font-mono">[${log.Origin}]</td>
                        <td class="p-3 text-white">${log.Message}</td>
                        <td class="p-3 text-yellow-300 font-mono">${log.Hint || '---'}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- 6. Notification (Toast) System ---
        function showNewLogNotifications(newLogs) {
            // Find the most critical new log
            const criticalLog = newLogs.find(l => l.Level === 'ERROR') || newLogs.find(l => l.Level === 'WARN');
            
            if (criticalLog) {
                createToast(criticalLog.Level, criticalLog.Message, criticalLog.Origin);
            }
        }

        function createToast(level, message, origin) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let borderColor = 'border-gray-500';
            let icon = 'ğŸ””';
            if (level === 'ERROR') { 
                borderColor = 'border-red-500'; 
                icon = 'âŒ';
            }
            if (level === 'WARN') { 
                borderColor = 'border-yellow-500';
                icon = 'âš ï¸';
            }

            toast.className = `toast glass-ui p-4 w-80 shadow-lg border-r-4 ${borderColor}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">${icon}</div>
                    <div>
                        <h4 class="font-bold text-white">×”×ª×¨××” ×—×“×©×” [${origin}]</h4>
                        <p class="text-sm text-gray-200">${message}</p>
                    </div>
                </div>
            `;
            
            container.prepend(toast); // Add new toast at the top
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // --- 7. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners
            document.getElementById('filter-text').addEventListener('input', renderLogs);
            document.getElementById('filter-level').addEventListener('input', renderLogs);
            document.getElementById('force-refresh').addEventListener('click', fetchLogs);

            // Initial load
            fetchLogs();

            // Start polling
            setInterval(fetchLogs, POLL_INTERVAL);
        });

    </script>
</body>
</html>
