<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- v29.3: עדכון Viewport למניעת זום במובייל -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeliveryMaster Admin v29.3</title>
    
    <!-- v29.3: הוספת Leaflet.js (החלפת Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- v29.3: סקריפט זיהוי מובייל/דסקטופ -->
    <script>
        (function() {
            // הוספת קלאס ל-<html> במקום ל-<body> כדי למנוע FOUC
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            document.documentElement.className = isMobile ? 'mobile' : 'desktop';
        })();
    </script>

    <style>
        /* --- סגנון בסיסי --- */
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --header-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --border-color: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: var(--text-color);
            direction: rtl;
        }
        
        #app-container {
            display: flex;
            min-height: 100vh;
        }

        /* --- סרגל צד --- */
        #sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            transition: width 0.3s ease;
        }
        #sidebar h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0 0 20px 0;
            text-align: center;
        }
        #sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #sidebar nav li {
            padding: 12px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #sidebar nav li:hover, #sidebar nav li.active {
            background-color: #f0f2f5;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* --- תוכן ראשי --- */
        #main-content {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }
        
        header {
            background: var(--header-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-content {
            display: none;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .tab-content.active {
            display: block;
        }

        /* --- רכיבים --- */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        
        input[type="date"], input[type="text"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* --- מפה (v29.3) --- */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #eee; /* רקע בזמן טעינה */
        }
        /* התאמות ל-Leaflet */
        .leaflet-container {
            border-radius: 8px;
        }

        /* --- סידור (Scheduler) --- */
        #scheduler-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 400px;
        }
        .driver-column, .unassigned-column {
            flex: 1;
            min-width: 250px;
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .column-header {
            padding: 10px;
            font-weight: 600;
            background: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        .order-list {
            padding: 10px;
            min-height: 350px; /* מאפשר גרירה לאזור ריק */
        }
        .order-card {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .order-card:active {
            cursor: grabbing;
            background: #fefefe;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .order-card-dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        /* --- טעינה --- */
        #loading-spinner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none; /* מופעל ע"י JS */
        }

        /* --- רספונסיביות (v29.3) --- */
        
        /* סגנון דסקטופ (ברירת מחדל) */
        .desktop #app-container {
            flex-direction: row;
        }

        /* סגנון מובייל (מופעל ע"י קלאס ב-<html>) */
        .mobile #app-container {
            flex-direction: column;
        }
        .mobile #sidebar {
            width: 100%;
            height: auto;
            position: relative;
            box-shadow: none;
            border-left: none;
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
            flex-direction: row; /* שינוי כיוון לפריסה רוחבית */
            overflow-x: auto; /* גלילה רוחבית לניווט */
            white-space: nowrap; /* מניעת שבירת שורות */
        }
        .mobile #sidebar h1 {
            display: none; /* הסתרת כותרת במובייל */
        }
        .mobile #sidebar nav ul {
            display: flex; /* סידור הפריטים בשורה */
            gap: 10px;
        }
         .mobile #sidebar nav li {
            padding: 8px 12px;
         }
        
        .mobile #main-content {
            padding: 10px;
        }
        .mobile header {
            padding: 10px;
            margin-bottom: 10px;
        }
        .mobile .tab-content {
            padding: 10px;
        }
        .mobile #map {
            height: 300px; /* הקטנת גובה מפה במובייל */
        }
        .mobile #scheduler-container {
            flex-direction: column; /* הצגת עמודות אחת מתחת לשניה */
        }
        .mobile .driver-column, .mobile .unassigned-column {
            min-width: 100%; /* רוחב מלא */
        }
        
    </style>
</head>
<body class=""> <!-- הקלאס 'mobile' או 'desktop' יתווסף ע"י JS ל-<html> -->

    <div id="loading-spinner">טוען...</div>

    <div id="app-container">
        <!-- סרגל צד -->
        <aside id="sidebar">
            <h1>DeliveryMaster</h1>
            <nav>
                <ul>
                    <li class="tab-link active" data-tab="dashboard-tab">מפה חיה</li>
                    <li class="tab-link" data-tab="scheduler-tab">סידור עבודה</li>
                    <li class="tab-link" data-tab="orders-tab">הזמנות</li>
                    <li class="tab-link" data-tab="drivers-tab">נהגים</li>
                    <li class="tab-link" data-tab="reports-tab">דוחות</li>
                </ul>
            </nav>
        </aside>

        <!-- תוכן ראשי -->
        <main id="main-content">
            <header>
                <h2 id="header-title">מפה חיה</h2>
                <!-- כאן אפשר להוסיף כפתורי פעולה, חיפוש וכו' -->
                <div id="header-actions">
                    <input type="date" id="scheduler-date" title="בחר תאריך לסידור">
                    <button onclick="loadScheduler()">טען סידור</button>
                </div>
            </header>

            <!-- Tab: Dashboard (Live Map) -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- v29.3: אלמנט המפה של Leaflet -->
                <div id="map"></div>
                <!-- ... (כאן ניתן להוסיף סטטיסטיקות נוספות) ... -->
            </div>
            
            <!-- Tab: Scheduler -->
            <div id="scheduler-tab" class="tab-content">
                <div id="scheduler-controls">
                    <!-- התאריך עבר לכותרת, אך ניתן להוסיף כאן כפתורי סינון -->
                </div>
                <div id="scheduler-container">
                    <div class="unassigned-column" id="unassigned-column" data-driver-id="null">
                        <div class="column-header">הזמנות ממתינות לשיבוץ</div>
                        <div class="order-list" id="unassigned-list">
                            <!-- כרטיסי הזמנות יטענו לכאן -->
                        </div>
                    </div>
                    <!-- עמודות נהגים יטענו לכאן דינמית -->
                </div>
            </div>
            
            <!-- Tab: Orders -->
            <div id="orders-tab" class="tab-content">
                <h2>ניהול הזמנות (מלא)</h2>
                <!-- טבלה / רשימה של כל ההזמנות להיום -->
            </div>
            
            <!-- Tab: Drivers -->
            <div id="drivers-tab" class="tab-content">
                <h2>ניהול נהגים</h2>
                <!-- טבלה / רשימה של כל הנהגים -->
            </div>
            
            <!-- Tab: Reports -->
            <div id="reports-tab" class="tab-content">
                <h2>דוחות וניתוחים</h2>
                <!-- כאן ישולבו הדוחות מ-v28.8 -->
            </div>
        </main>
    </div>


    <script>
        // --- v29.3: הגדרות מפה גלובליות (Leaflet) ---
        var map;
        var driverMarkers = {};
        var orderMarkers = {};
        var osmStreetLayer, esriSatelliteLayer;

        // --- v29.3: פונקציות עזר של המפה (כפי שהוגדר ב-v29.2) ---
        
        /**
         * יצירה או עדכון סמן (נהג או הזמנה)
         * @param {string} id - מזהה ייחודי (driverId או orderId)
         * @param {number} lat - קו רוחב
         * @param {number} lng - קו אורך
         * @param {string} popupContent - תוכן ה-HTML שיוצג בלחיצה
         * @param {Object} markerStorage - האובייקט לאחסון הסמנים (driverMarkers או orderMarkers)
         * @param {string | null} iconUrl - (אופציונלי) כתובת לאייקון מותאם אישית
         */
        function createOrUpdateMarker(id, lat, lng, popupContent, markerStorage, iconUrl = null) {
            if (!map || !lat || !lng) {
                console.warn(`Skipping marker create/update for ${id}: Invalid map or location.`);
                return; 
            }

            var latLng = [lat, lng];
            var customIcon = null;

            if (iconUrl) {
                customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [25, 41], // גודל סטנדרטי של אייקון Leaflet
                    iconAnchor: [12, 41], // נקודת העיגון התחתונה-אמצעית
                    popupAnchor: [1, -34] // מיקום הפופאפ יחסית לאייקון
                });
            }

            if (markerStorage[id]) {
                // סמן קיים - עדכן מיקום ופופאפ
                markerStorage[id].setLatLng(latLng);
                markerStorage[id].bindPopup(popupContent);
                if (customIcon) {
                    markerStorage[id].setIcon(customIcon);
                }
            } else {
                // סמן חדש - צור והוסף למפה
                var markerOptions = customIcon ? { icon: customIcon } : {};
                markerStorage[id] = L.marker(latLng, markerOptions)
                    .addTo(map)
                    .bindPopup(popupContent);
            }
        }

        /**
         * הסרת סמן מהמפה
         * @param {string} id - מזהה הסמן
         * @param {Object} markerStorage - האובייקט ממנו יוסר הסמן
         */
        function removeMarker(id, markerStorage) {
            if (markerStorage[id]) {
                try {
                    map.removeLayer(markerStorage[id]);
                } catch(e) {
                    console.error(`Error removing marker ${id}: ${e.message}`);
                }
                delete markerStorage[id];
            }
        }

        /**
         * v29.3: פונקציית אתחול המפה (Leaflet)
         */
        function initMap() {
            if (document.getElementById('map') && !map) { // ודא שהמפה לא אותחלה כבר
                // הגדרת שכבות בסיס
                osmStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                });

                esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © <a href="https://www.esri.com/">Esri</a>'
                });

                // אתחול המפה
                map = L.map('map', {
                    center: [31.7683, 35.2137], // מרכז ישראל
                    zoom: 8,
                    layers: [osmStreetLayer] // שכבת ברירת מחדל
                });

                // הוספת בורר שכבות
                var baseLayers = {
                    "מפת רחובות (עברית)": osmStreetLayer,
                    "תצוגת לווין": esriSatelliteLayer
                };
                L.control.layers(baseLayers).addTo(map);
                
                console.log('Leaflet Map Initialized (v29.3)');
                
                // טעינת נתונים ראשונית למפה
                loadLiveMapData();
            }
        }
        
        // --- פונקציות API (באמצעות google.script.run) ---

        function showLoading() { document.getElementById('loading-spinner').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading-spinner').style.display = 'none'; }
        
        /**
         * פונקציית עזר גנרית להרצת פונקציות שרת
         * @param {string} action - שם הפונקציה ב-Code.gs (למשל 'getDrivers')
         * @param {Object} params - אובייקט פרמטרים
         * @param {string} method - 'GET' או 'POST'
         * @returns {Promise<any>}
         */
        function runServerScript(action, params = {}, method = 'GET') {
            showLoading();
            return new Promise((resolve, reject) => {
                const handler = google.script.run
                    .withSuccessHandler(response => {
                        hideLoading();
                        if (response && response.status === 'success') {
                            resolve(response.data);
                        } else {
                            const errorMessage = (response && response.message) ? response.message : 'Unknown server error';
                            console.error('Server Error:', errorMessage, response);
                            reject(new Error(errorMessage));
                        }
                    })
                    .withFailureHandler(error => {
                        hideLoading();
                        console.error('Script Error:', error.message, error);
                        reject(error);
                    });

                // הרצת הפונקציה המתאימה בשרת
                if (method === 'POST') {
                    // POST שולח אובייקט יחיד
                    const payload = { postData: { contents: JSON.stringify({ action, ...params }) } };
                    handler.doPost(payload);
                } else {
                    // GET שולח אובייקט פרמטרים
                    const payload = { parameter: { action, ...params } };
                    handler.doGet(payload);
                }
            });
        }
        
        // --- פונקציית הטעינה הראשית ---
        document.addEventListener("DOMContentLoaded", () => {
            // אתחול המפה רק אם הטאב שלה פעיל
            if (document.getElementById('dashboard-tab').classList.contains('active')) {
                initMap();
            }
            
            // הגדרת תאריך ברירת מחדל
            const dateInput = document.getElementById('scheduler-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            
            // טעינת הסידור
            loadScheduler();
            
            // הגדרת אירועי לחיצה לטאבים
            setupTabs();
            
            // רענון אוטומטי למפה
            setInterval(loadLiveMapData, 60000); // כל 60 שניות
        });
        
        // --- ניהול טאבים ---
        function setupTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    
                    // עדכון כותרת
                    document.getElementById('header-title').innerText = link.innerText;
                    
                    // עדכון קלאס פעיל בקישורים
                    tabLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // הצגת הטאב הנכון
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // אתחול המפה אם זה הטאב שלה
                    if (tabId === 'dashboard-tab') {
                        initMap(); // יאתחל רק אם לא אותחל כבר
                        // רענון גודל המפה (חשוב אם ה-div היה מוסתר)
                        if(map) {
                            setTimeout(() => map.invalidateSize(), 10);
                        }
                    }
                });
            });
        }

        // --- פונקציות ליבה ---
        
        function loadScheduler() {
            const date = document.getElementById('scheduler-date').value;
            if (!date) {
                alert('יש לבחור תאריך');
                return;
            }
            
            Promise.all([
                runServerScript('getDrivers', {}, 'GET'),
                runServerScript('getOrders', { date: date }, 'GET')
            ]).then(([drivers, orders]) => {
                buildSchedulerUI(drivers, orders);
                displayOrdersOnMap(orders); // עדכון סמני הזמנות במפה
            }).catch(err => {
                console.error('Error loading scheduler:', err);
                alert('שגיאה בטעינת הסידור: ' + err.message);
            });
        }

        function loadLiveMapData() {
            // טעינת נתונים חיים (רק אם הטאב של המפה פעיל)
            if (document.getElementById('dashboard-tab').classList.contains('active') && map) {
                console.log('Refreshing live map data...');
                runServerScript('getLiveMapData', {}, 'GET')
                    .then(data => {
                        updateDriverMarkers(data.drivers);
                        displayOrdersOnMap(data.orders);
                    })
                    .catch(err => console.error('Failed to load map data:', err.message));
            }
        }

        /**
         * v29.3: עדכון סמני נהגים (Leaflet)
         */
        function updateDriverMarkers(drivers) {
            if (!map) return;
            const activeDriverIds = [];
            
            drivers.forEach(driver => {
                if (driver.location && driver.location.latitude && driver.location.longitude) {
                    activeDriverIds.push(driver.driverId);
                    const lastUpdate = driver.location.lastUpdate ? new Date(driver.location.lastUpdate).toLocaleTimeString('he-IL') : 'אין';
                    const popupContent = `<b>${driver.name}</b><br>רכב: ${driver.vehicleType || 'לא ידוע'}<br>עדכון אחרון: ${lastUpdate}`;
                    
                    const iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png'; // אייקון כחול
                    
                    createOrUpdateMarker(
                        driver.driverId,
                        driver.location.latitude,
                        driver.location.longitude,
                        popupContent,
                        driverMarkers,
                        iconUrl
                    );
                }
            });
            
            // הסרת סמנים של נהגים שכבר לא פעילים
            Object.keys(driverMarkers).forEach(driverId => {
                if (!activeDriverIds.includes(driverId)) {
                    removeMarker(driverId, driverMarkers);
                }
            });
        }
        
        /**
         * v29.3: עדכון סמני הזמנות (Leaflet)
         */
        function displayOrdersOnMap(orders) {
            if (!map) return;
            const activeOrderIds = [];

            // סנן רק הזמנות פעילות שיש להן מיקום
            const mapOrders = orders.filter(o => o.latitude && o.longitude && o.status !== 'הושלם' && o.status !== 'מבוטל');

            mapOrders.forEach(order => {
                activeOrderIds.push(order.orderId);
                const popupContent = `<b>הזמנה: ${order.orderId}</b><br>${order.customerName}<br>${order.address}<br>סטטוס: ${order.status}`;
                
                // קביעת צבע סמן לפי סטטוס
                let iconUrl;
                if (order.status === 'שויך') {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png'; // צהוב
                } else if (order.status === 'בדרך') {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'; // ירוק
                } else {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png'; // אפור (חדש)
                }
                
                createOrUpdateMarker(
                    order.orderId,
                    order.latitude,
                    order.longitude,
                    popupContent,
                    orderMarkers,
                    iconUrl
                );
            });
            
            // הסרת סמני הזמנות שכבר לא רלוונטיות
            Object.keys(orderMarkers).forEach(orderId => {
                if (!activeOrderIds.includes(String(orderId))) { // המרה ל-string ליתר ביטחון
                    removeMarker(orderId, orderMarkers);
                }
            });
        }
        
        // --- לוגיקת סידור (Scheduler) ---
        
        function buildSchedulerUI(drivers, orders) {
            const container = document.getElementById('scheduler-container');
            
            // ניקוי עמודות נהגים קיימות (שמירה על עמודת "ממתינות")
            container.querySelectorAll('.driver-column').forEach(col => col.remove());
            
            // ניקוי רשימת ממתינות
            const unassignedList = document.getElementById('unassigned-list');
            unassignedList.innerHTML = '';

            // יצירת עמודות לנהגים
            drivers.forEach(driver => {
                const driverCol = document.createElement('div');
                driverCol.className = 'driver-column';
                driverCol.dataset.driverId = driver.driverId;
                driverCol.innerHTML = `
                    <div class="column-header">${driver.name} (${driver.vehicleType})</div>
                    <div class="order-list" id="list-driver-${driver.driverId}"></div>
                `;
                container.appendChild(driverCol);
            });
            
            // מיון הזמנות
            orders.forEach(order => {
                const card = createOrderCard(order);
                if (order.driverId && container.querySelector(`#list-driver-${order.driverId}`)) {
                    // הזמנה משויכת
                    container.querySelector(`#list-driver-${order.driverId}`).appendChild(card);
                } else {
                    // הזמנה לא משויכת
                    unassignedList.appendChild(card);
                }
            });
            
            // הפעלת גרירה
            setupDragAndDrop();
        }
        
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.id = `order-${order.orderId}`;
            card.dataset.orderId = order.orderId;
            card.draggable = true;
            card.innerHTML = `
                <strong>${order.customerName}</strong><br>
                <small>${order.address}</small><br>
                <small>סטטוס: ${order.status} | סוג: ${order.deliveryType}</small>
            `;
            return card;
        }

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.order-card');
            const lists = document.querySelectorAll('.order-list');
            let draggedCard = null;

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    setTimeout(() => card.classList.add('order-card-dragging'), 0);
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                card.addEventListener('dragend', () => {
                    if (draggedCard) {
                        draggedCard.classList.remove('order-card-dragging');
                        draggedCard = null;
                    }
                });
            });
            
            lists.forEach(list => {
                list.addEventListener('dragover', (e) => {
                    e.preventDefault(); // הכרחי לאפשר drop
                    e.dataTransfer.dropEffect = 'move';
                });
                
                list.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedCard) {
                        const targetList = e.currentTarget;
                        const targetColumn = targetList.closest('.driver-column, .unassigned-column');
                        const newDriverId = targetColumn.dataset.driverId;
                        const orderId = draggedCard.dataset.orderId;
                        
                        // הוספה ויזואלית
                        targetList.appendChild(draggedCard);
                        
                        // קריאה לשרת לעדכון השיוך
                        assignOrder(orderId, newDriverId);
                    }
                });
            });
        }
        
        function assignOrder(orderId, driverId) {
            // 'null' מה-DOM מגיע כסטרינג, השרת מצפה ל-null אמיתי או ID
            const targetDriverId = (driverId === 'null' || !driverId) ? null : driverId;
            
            console.log(`Assigning ${orderId} to ${targetDriverId}`);
            
            runServerScript('assignOrder', { 
                orderId: orderId, 
                driverId: targetDriverId,
                index: 0 // (לא ממומש כרגע)
            }, 'POST')
            .then(() => {
                console.log(`Order ${orderId} assigned successfully.`);
                // רענון קטן לסטטוס בכרטיס (אופציונלי)
                const card = document.getElementById(`order-${orderId}`);
                if (card) {
                    const statusEl = card.querySelector('small'); // מציאת האלמנט
                    if (statusEl) {
                         // עדכון גס, אפשר לשפר
                         statusEl.innerHTML = statusEl.innerHTML.replace(/סטטוס: [^|]+/, `סטטוס: ${targetDriverId ? 'שויך' : 'ממתין'}`);
                    }
                }
            })
            .catch(err => {
                alert(`שגיאה בשיוך הזמנה: ${err.message}`);
                // שחזור מיקום הכרטיס (דורש לוגיקה מורכבת יותר)
                loadScheduler(); // הפתרון הפשוט - טעינה מחדש
            });
        }
        
    </script>
</body>
</html>
