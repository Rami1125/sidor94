<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v33.0 - צג לוגים (מלשינון)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: monospace; }
        .log-row { transition: background-color 0.3s ease; }
        .log-row:hover { background-color: #374151; }
        .level-INFO { color: #3b82f6; }
        .level-WARN { color: #f59e0b; }
        .level-ERROR { color: #ef4444; font-weight: bold; }
        .level-FATAL_ERROR { color: #ef4444; background-color: #450a0a; font-weight: bold; }
        .level-CLIENT_ERROR { color: #eab308; }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto">
        <h1 class="text-2xl font-bold text-white mb-4">צג לוגים חי (מלשינון) v33.0</h1>
        
        <div class="bg-gray-800 rounded-lg shadow p-4 border border-gray-700">
            <div class="flex space-x-4 space-x-reverse mb-4">
                <input type="text" id="filter-text" class="flex-grow bg-gray-900 text-white p-2 rounded" placeholder="סנן לפי טקסט...">
                <select id="filter-level" class="bg-gray-900 text-white p-2 rounded">
                    <option value="">כל הרמות</option>
                    <option value="ERROR">ERROR</option>
                    <option value="WARN">WARN</option>
                    <option value="INFO">INFO</option>
                </select>
            </div>
            
            <div id="log-container" class="h-[80vh] overflow-y-scroll bg-gray-900 rounded p-2">
                <div class="p-8 text-center text-gray-500">טוען לוגים...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxbP_jAKtqTG279H_we5sB_QgRgLBTh7C7_D_-HAOmvfVYnFdWeJ6RBXH-LmYPw83Da/exec"; // יש להדביק כאן את ה-URL של ה-WebApp
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        // --- 2. State ---
        let allLogs = [];

        // --- 3. API Call ---
        // (Note: We need a 'getLogs' action in Code.gs. 
        // For this demo, we'll assume it exists or fetch from a public sheet)
        // For now, this will just simulate fetching.
        // A real 'getLogs' would read 'System_Logs' sheet.
        
        async function fetchLogs() {
            try {
                // In a real app: await apiFetch('getLogs');
                // Simulating for demo:
                const simulatedLogs = [
                    { Timestamp: new Date(), Origin: 'Server', Level: 'INFO', Message: 'שרת v33.0 אותחל.' },
                    { Timestamp: new Date(), Origin: 'AdminApp_v33', Level: 'INFO', Message: 'API Request: getDashboardData' },
                    { Timestamp: new Date(), Origin: 'DriverApp_v33', Level: 'CLIENT_ERROR', Message: 'Failed to get location', Data: '{ "code": 1 }' }
                ];
                
                // This would be the real fetch:
                // const response = await fetch("...URL to System_Logs sheet as CSV...");
                // const csvData = await response.text();
                // allLogs = parseCsv(csvData); 
                
                // Using simulation
                if(allLogs.length === 0) allLogs = simulatedLogs;

                renderLogs();

            } catch (error) {
                console.error("Failed to fetch logs", error);
                document.getElementById('log-container').innerHTML = `<div class="p-8 text-center text-red-500">שגיאה בטעינת לוגים: ${error.message}</div>`;
            }
        }

        // --- 4. Render Logic ---
        function renderLogs() {
            const container = document.getElementById('log-container');
            const filterText = document.getElementById('filter-text').value.toLowerCase();
            const filterLevel = document.getElementById('filter-level').value;

            const filteredLogs = allLogs.filter(log => {
                const textMatch = !filterText || (log.Message && log.Message.toLowerCase().includes(filterText)) || (log.Origin && log.Origin.toLowerCase().includes(filterText));
                const levelMatch = !filterLevel || (log.Level && log.Level === filterLevel);
                return textMatch && levelMatch;
            });

            if (filteredLogs.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-500">לא נמצאו לוגים תואמים.</div>`;
                return;
            }

            // Render in reverse (newest first)
            container.innerHTML = filteredLogs.reverse().map(log => `
                <div class="log-row p-1.5 border-b border-gray-800 flex">
                    <span class="w-40 text-gray-500">${new Date(log.Timestamp).toLocaleString('he-IL')}</span>
                    <span class="w-28 font-semibold level-${log.Level}">${log.Level}</span>
                    <span class="w-32 text-cyan-400">[${log.Origin}]</span>
                    <span class="flex-1 text-gray-200">${log.Message}</span>
                    ${log.Data ? `<span class="text-gray-600 ml-4">(...נתונים)</span>` : ''}
                </div>
            `).join('');
        }
        
        // --- 5. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchLogs();
            setInterval(fetchLogs, REFRESH_INTERVAL);
            
            document.getElementById('filter-text').addEventListener('input', renderLogs);
            document.getElementById('filter-level').addEventListener('input', renderLogs);
        });

    </script>
</body>
</html>
