<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v33.3 - צג לוגים חכם (מלשינון)</title>
    
    <!--
      Tailwind CSS v33.3 - No CDN
      הסרנו את ה-CDN והטמענו את הסגנונות הנדרשים ישירות כאן.
    -->
    <style>
        /* 1. Tailwind Base (Reset & Defaults) */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; -moz-tab-size: 4; tab-size: 4; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; direction: rtl; }
        body { margin: 0; line-height: inherit; background-color: #111827; color: #d1d5db; }
        
        /* 2. Tailwind Utilities (Subset used in this file) */
        .container { width: 100%; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .max-w-7xl { max-width: 80rem; }
        .p-4 { padding: 1rem; }
        .p-8 { padding: 2rem; }
        .p-3 { padding: 0.75rem; }
        .p-2 { padding: 0.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-3 { gap: 0.75rem; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) {
            .md\:p-8 { padding: 2rem; }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .w-80 { width: 20rem; }
        .min-w-full { min-width: 100%; }
        .h-full { height: 100%; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .text-sm { font-size: 0.875rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .text-white { color: #fff; }
        .text-gray-200 { color: #e5e7eb; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-700 { color: #374151; }
        .text-cyan-300 { color: #67e8f9; }
        .text-green-400 { color: #4ade80; }
        .text-yellow-300 { color: #fde047; }
        .text-yellow-400 { color: #facc15; }
        .text-red-500 { color: #ef4444; }
        .text-blue-500 { color: #3b82f6; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-900 { background-color: #111827; }
        .bg-blue-600 { background-color: #2563eb; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-r-4 { border-right-width: 4px; }
        .border-gray-500 { border-color: #6b7280; }
        .border-gray-700 { border-color: #374151; }
        .border-red-500 { border-color: #ef4444; }
        .border-yellow-500 { border-color: #f59e0b; }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 1px; }
        .divide-gray-700 > :not([hidden]) ~ :not([hidden]) { border-color: #374151; }
        .focus\:border-blue-500:focus { border-color: #3b82f6; }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; box-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color); }
        input, select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; border: none; padding: 0; margin: 0; width: 100%; min-width: 0; display: block; }
        select { background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }

        /* 3. Custom Glass UI & App Styles */
        .glass-ui {
            background-color: rgba(31, 41, 55, 0.7); /* bg-gray-800 bg-opacity-70 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .level-INFO { color: #3b82f6; }
        .level-WARN { color: #f59e0b; }
        .level-ERROR { color: #ef4444; font-weight: 600; }
        .level-CLIENT_ERROR { color: #eab308; font-weight: 600; }
        #toast-container {
            position: fixed;
            top: 1.25rem;
            left: 1.25rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            direction: rtl;
        }
        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(-100%); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <div class="container mx-auto max-w-7xl space-y-6">
        
        <!-- 1. Header -->
        <header class="glass-ui p-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white">צג לוגים חכם (מלשינון)</h1>
                <p class="text-sm text-gray-400">v33.3 - ניטור פעולות מערכת בזמן אמת</p>
            </div>
            <div class="text-sm text-gray-400" id="connection-status">
                <span class="text-yellow-400">טוען נתונים...</span>
            </div>
        </header>

        <!-- 2. Filters -->
        <div class="glass-ui p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" id="filter-text" class="w-full bg-gray-900 text-white p-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:ring-blue-500" placeholder="סנן לפי הודעה, מקור...">
            <select id="filter-level" class="w-full bg-gray-900 text-white p-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:ring-blue-500">
                <option value="">כל הרמות</option>
                <option value="ERROR">שגיאה (ERROR)</option>
                <option value="WARN">אזהרה (WARN)</option>
                <option value="INFO">מידע (INFO)</option>
            </select>
            <button id="force-refresh" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                רענן כעת
            </button>
        </div>

        <!-- 3. Log Table -->
        <div class="glass-ui overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-full text-right">
                    <thead class="border-b border-gray-700">
                        <tr class="text-gray-400 text-sm">
                            <th class="p-3">🕓 זמן</th>
                            <th class="p-3">🏷️ רמה</th>
                            <th class="p-3">🧩 מקור</th>
                            <th class="p-3">💬 הודעה</th>
                            <th class="p-3">💡 המלצה לפתרון</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body" class="divide-y divide-gray-700">
                        <!-- Rows injected by JS -->
                        <tr><td colspan="5" class="p-8 text-center text-gray-500">טוען לוגים...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration ---
        // !!! עדכון v33.3: ה-URL עודכן לגרסת הפריסה החדשה שסיפקת.
        const API_URL = "https://script.google.com/macros/s/AKfycbyJIYZ_UoGtZaXYjfyBtIxWU8lrrsEZg6_yKHt6xA7Dm2Kjj8poZNtqmeACCX68Zlam/exec"; 
        const POLL_INTERVAL = 10000; // 10 שניות
        const APP_NAME = "AdminLogMonitor_v33.3";

        // --- 2. Global State ---
        let globalState = {
            logs: [],
            lastLogTimestamp: null
        };

        // --- 3. API Fetch Utility ---
        async function apiFetch(action, payload = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload, context: { app: APP_NAME } }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });

                // בדיקה אם התשובה תקינה (למקרה של שגיאת רשת)
                if (!response.ok) {
                    throw new Error(`שגיאת רשת: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();

                // בדיקה אם ה-API עצמו החזיר שגיאה לוגית
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                return result.data;

            } catch (error) {
                // זה המקום שבו הלוג שלך "API Failure: getRecentLogs TypeError: Failed to fetch" נוצר
                console.error(`API Failure: ${action}`, error);
                document.getElementById('connection-status').innerHTML = `<span class="text-red-500">שגיאת התחברות</span>`;
                
                // מציג התראת שגיאה למשתמש
                createToast('ERROR', `שגיאת תקשורת: ${error.message}.`, 'LogMonitor');
                
                throw error; // עוצר את המשך הריצה של הפונקציה
            }
        }

        // --- 4. Core Logic ---
        async function fetchLogs() {
            try {
                const newLogs = await apiFetch('getRecentLogs');
                
                // אם הגענו לכאן, התקשורת הצליחה
                if (!newLogs || newLogs.length === 0) {
                    document.getElementById('connection-status').innerHTML = `<span class="text-green-400">מחובר (אין לוגים)</span>`;
                    globalState.logs = []; // נקה לוגים קודמים אם הגיליון התרוקן
                    renderLogs(); // רנדר מחדש כדי להציג "אין לוגים"
                    return;
                }

                document.getElementById('connection-status').innerHTML = `<span class="text-green-400">מחובר (עדכון אחרון: ${new Date().toLocaleTimeString()})</span>`;

                const newestLogTimestamp = newLogs[0].Timestamp;
                if (globalState.lastLogTimestamp && newestLogTimestamp > globalState.lastLogTimestamp) {
                    const trulyNewLogs = newLogs.filter(log => log.Timestamp > globalState.lastLogTimestamp);
                    showNewLogNotifications(trulyNewLogs);
                }
                
                globalState.lastLogTimestamp = newestLogTimestamp;
                globalState.logs = newLogs;
                renderLogs();

            } catch (error) {
                // השגיאה כבר טופלה והוצגה על ידי apiFetch
                console.warn("fetchLogs נכשל. הלוגים לא יתעדכנו בסבב זה.");
            }
        }

        // --- 5. Render Functions ---
        function renderLogs() {
            const tableBody = document.getElementById('logs-table-body');
            const filterText = document.getElementById('filter-text').value.toLowerCase();
            const filterLevel = document.getElementById('filter-level').value;

            // ודא ש-globalState.logs הוא מערך
            const logsToFilter = Array.isArray(globalState.logs) ? globalState.logs : [];

            const filteredLogs = logsToFilter.filter(log => {
                // בדיקות בטוחות למקרה שאובייקט הלוג לא תקין
                const textMatch = !filterText ||
                    (log.Message && typeof log.Message === 'string' && log.Message.toLowerCase().includes(filterText)) ||
                    (log.Origin && typeof log.Origin === 'string' && log.Origin.toLowerCase().includes(filterText)) ||
                    (log.Hint && typeof log.Hint === 'string' && log.Hint.toLowerCase().includes(filterText));
                const levelMatch = !filterLevel || (log.Level && log.Level === filterLevel);
                return textMatch && levelMatch;
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">לא נמצאו לוגים תואמים.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredLogs.map(log => {
                const level = log.Level || 'INFO';
                const levelClass = `level-${level.replace(' ', '_')}`;
                
                return `
                    <tr class="hover:bg-gray-700 text-sm">
                        <td class="p-3 text-gray-400">${new Date(log.Timestamp).toLocaleString('he-IL')}</td>
                        <td class="p-3 font-bold ${levelClass}">${level}</td>
                        <td class="p-3 text-cyan-300 font-mono">[${log.Origin || 'N/A'}]</td>
                        <td class="p-3 text-white">${log.Message || '---'}</td>
                        <td class="p-3 text-yellow-300 font-mono">${log.Hint || '---'}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- 6. Notification (Toast) System ---
        function showNewLogNotifications(newLogs) {
            const criticalLog = newLogs.find(l => l.Level === 'ERROR') || newLogs.find(l => l.Level === 'WARN');
            if (criticalLog) {
                createToast(criticalLog.Level, criticalLog.Message, criticalLog.Origin);
            }
        }

        function createToast(level, message, origin) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let borderColor = 'border-gray-500';
            let icon = '🔔';
            if (level === 'ERROR') { 
                borderColor = 'border-red-500'; 
                icon = '❌';
            }
            if (level === 'WARN') { 
                borderColor = 'border-yellow-500';
                icon = '⚠️';
            }

            toast.className = `toast glass-ui p-4 w-80 shadow-lg border-r-4 ${borderColor}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">${icon}</div>
                    <div>
                        <h4 class="font-bold text-white">התראה חדשה [${origin}]</h4>
                        <p class="text-sm text-gray-200">${message}</p>
                    </div>
                </div>
            `;
            
            container.prepend(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        // --- 7. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filter-text').addEventListener('input', renderLogs);
            document.getElementById('filter-level').addEventListener('input', renderLogs);
            document.getElementById('force-refresh').addEventListener('click', fetchLogs);
            fetchLogs();
            setInterval(fetchLogs, POLL_INTERVAL);
        });

    </script>
</body>
</html>

