<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeliveryMaster Admin v29.4</title>
    
    <!-- v29.3: הוספת Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- v29.3: סקריפט זיהוי מובייל/דסקטופ -->
    <script>
        (function() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            document.documentElement.className = isMobile ? 'mobile' : 'desktop';
        })();
    </script>

    <style>
        /* ... (כל ה-CSS מ-v29.3 נשאר זהה) ... */
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --header-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --border-color: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: var(--text-color);
            direction: rtl;
        }
        
        #app-container {
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            transition: width 0.3s ease;
        }
        #sidebar h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0 0 20px 0;
            text-align: center;
        }
        #sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #sidebar nav li {
            padding: 12px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #sidebar nav li:hover, #sidebar nav li.active {
            background-color: #f0f2f5;
            color: var(--primary-color);
            font-weight: 600;
        }
        #main-content {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }
        header {
            background: var(--header-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-content {
            display: none;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .tab-content.active {
            display: block;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="date"], input[type="text"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #eee;
        }
        .leaflet-container {
            border-radius: 8px;
        }
        #scheduler-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 400px;
        }
        .driver-column, .unassigned-column {
            flex: 1;
            min-width: 250px;
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .column-header {
            padding: 10px;
            font-weight: 600;
            background: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        .order-list {
            padding: 10px;
            min-height: 350px;
        }
        .order-card {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .order-card:active {
            cursor: grabbing;
            background: #fefefe;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .order-card-dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        #loading-spinner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
        }
        .desktop #app-container {
            flex-direction: row;
        }
        .mobile #app-container {
            flex-direction: column;
        }
        .mobile #sidebar {
            width: 100%;
            height: auto;
            position: relative;
            box-shadow: none;
            border-left: none;
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
            flex-direction: row;
            overflow-x: auto;
            white-space: nowrap;
        }
        .mobile #sidebar h1 {
            display: none;
        }
        .mobile #sidebar nav ul {
            display: flex;
            gap: 10px;
        }
         .mobile #sidebar nav li {
            padding: 8px 12px;
         }
        .mobile #main-content {
            padding: 10px;
        }
        .mobile header {
            padding: 10px;
            margin-bottom: 10px;
        }
        .mobile .tab-content {
            padding: 10px;
        }
        .mobile #map {
            height: 300px;
        }
        .mobile #scheduler-container {
            flex-direction: column;
        }
        .mobile .driver-column, .mobile .unassigned-column {
            min-width: 100%;
        }
    </style>
</head>
<body class="">

    <div id="loading-spinner">טוען...</div>

    <div id="app-container">
        <!-- סרגל צד -->
        <aside id="sidebar">
            <h1>DeliveryMaster</h1>
            <nav>
                <ul>
                    <li class="tab-link active" data-tab="dashboard-tab">מפה חיה</li>
                    <li class="tab-link" data-tab="scheduler-tab">סידור עבודה</li>
                    <li class="tab-link" data-tab="orders-tab">הזמנות</li>
                    <li class="tab-link" data-tab="drivers-tab">נהגים</li>
                    <li class="tab-link" data-tab="reports-tab">דוחות</li>
                </ul>
            </nav>
        </aside>

        <!-- תוכן ראשי -->
        <main id="main-content">
            <header>
                <h2 id="header-title">מפה חיה</h2>
                <div id="header-actions">
                    <input type="date" id="scheduler-date" title="בחר תאריך לסידור">
                    <button onclick="loadScheduler()">טען סידור</button>
                </div>
            </header>

            <!-- Tab: Dashboard (Live Map) -->
            <div id="dashboard-tab" class="tab-content active">
                <div id="map"></div>
            </div>
            
            <!-- Tab: Scheduler -->
            <div id="scheduler-tab" class="tab-content">
                <div id="scheduler-controls">
                </div>
                <div id="scheduler-container">
                    <div class="unassigned-column" id="unassigned-column" data-driver-id="null">
                        <div class="column-header">הזמנות ממתינות לשיבוץ</div>
                        <div class="order-list" id="unassigned-list">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Orders -->
            <div id="orders-tab" class="tab-content">
                <h2>ניהול הזמנות (מלא)</h2>
            </div>
            
            <!-- Tab: Drivers -->
            <div id="drivers-tab" class="tab-content">
                <h2>ניהול נהגים</h2>
            </div>
            
            <!-- Tab: Reports -->
            <div id="reports-tab" class="tab-content">
                <h2>דוחות וניתוחים</h2>
            </div>
        </main>
    </div>


    <script>
        // --- v29.3: הגדרות מפה גלובליות (Leaflet) ---
        var map;
        var driverMarkers = {};
        var orderMarkers = {};
        var osmStreetLayer, esriSatelliteLayer;

        // --- v29.3: פונקציות עזר של המפה ---
        
        function createOrUpdateMarker(id, lat, lng, popupContent, markerStorage, iconUrl = null) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!map || !lat || !lng) {
                console.warn(`Skipping marker create/update for ${id}: Invalid map or location.`);
                return; 
            }
            var latLng = [lat, lng];
            var customIcon = null;
            if (iconUrl) {
                customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });
            }
            if (markerStorage[id]) {
                markerStorage[id].setLatLng(latLng);
                markerStorage[id].bindPopup(popupContent);
                if (customIcon) {
                    markerStorage[id].setIcon(customIcon);
                }
            } else {
                var markerOptions = customIcon ? { icon: customIcon } : {};
                markerStorage[id] = L.marker(latLng, markerOptions)
                    .addTo(map)
                    .bindPopup(popupContent);
            }
        }

        function removeMarker(id, markerStorage) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (markerStorage[id]) {
                try {
                    map.removeLayer(markerStorage[id]);
                } catch(e) {
                    console.error(`Error removing marker ${id}: ${e.message}`);
                }
                delete markerStorage[id];
            }
        }

        function initMap() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (document.getElementById('map') && !map) {
                osmStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                });
                esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © <a href="https://www.esri.com/">Esri</a>'
                });
                map = L.map('map', {
                    center: [31.7683, 35.2137],
                    zoom: 8,
                    layers: [osmStreetLayer]
                });
                var baseLayers = {
                    "מפת רחובות (עברית)": osmStreetLayer,
                    "תצוגת לווין": esriSatelliteLayer
                };
                L.control.layers(baseLayers).addTo(map);
                console.log('Leaflet Map Initialized (v29.4)');
                loadLiveMapData();
            }
        }
        
        // --- v29.4: שדרוג תקשורת שרת ל-Fetch ---

        function showLoading() { document.getElementById('loading-spinner').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading-spinner').style.display = 'none'; }
        
        /**
         * v29.4: פונקציית תקשורת מבוססת fetch לאתר חיצוני
         * מחליפה את google.script.run
         */
        function runServerScript(action, params = {}, method = 'GET') {
            showLoading();

            // v29.4: כתובת שרת קבועה (החלף בכתובת ה-exec שלך)
            const SERVER_URL = "https://script.google.com/macros/s/AKfycbydcJnRqEUH821BnZa8Q131Z_a-VGXefpWlsXLMJEv8b1zFVHuDafo3JlbDcCf5Z3CkvQ/exec";
            
            let url = SERVER_URL;
            let options = {
                method: method,
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // מומלץ ל-Apps Script
                mode: 'cors',
            };

            if (method === 'POST') {
                // ב-POST, ה-action והפרמטרים נשלחים ב-body
                options.body = JSON.stringify({ action, ...params });
            } else { // GET
                // ב-GET, ה-action והפרמטרים נשלחים כ-query params
                const queryParams = new URLSearchParams({ action, ...params });
                url += `?${queryParams.toString()}`;
            }

            return new Promise((resolve, reject) => {
                fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        hideLoading();
                        // הנחת מבנה התגובה של Code.gs
                        if (data && data.status === 'success') {
                            resolve(data.data);
                        } else {
                            reject(new Error(data.message || 'Unknown server error'));
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Fetch Error:', error.message, error);
                        reject(error);
                    });
            });
        }
        
        // --- פונקציית הטעינה הראשית (ללא שינוי) ---
        document.addEventListener("DOMContentLoaded", () => {
            if (document.getElementById('dashboard-tab').classList.contains('active')) {
                initMap();
            }
            const dateInput = document.getElementById('scheduler-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            loadScheduler();
            setupTabs();
            setInterval(loadLiveMapData, 60000);
        });
        
        // --- שאר פונקציות האפליקציה (ללא שינוי מ-v29.3) ---
        
        function setupTabs() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const tabLinks = document.querySelectorAll('.tab-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    document.getElementById('header-title').innerText = link.innerText;
                    tabLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    if (tabId === 'dashboard-tab') {
                        initMap();
                        if(map) {
                            setTimeout(() => map.invalidateSize(), 10);
                        }
                    }
                });
            });
        }

        function loadScheduler() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const date = document.getElementById('scheduler-date').value;
            if (!date) {
                alert('יש לבחור תאריך');
                return;
            }
            Promise.all([
                runServerScript('getDrivers', {}, 'GET'),
                runServerScript('getOrders', { date: date }, 'GET')
            ]).then(([drivers, orders]) => {
                buildSchedulerUI(drivers, orders);
                displayOrdersOnMap(orders);
            }).catch(err => {
                console.error('Error loading scheduler:', err);
                alert('שגיאה בטעינת הסידור: ' + err.message);
            });
        }

        function loadLiveMapData() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (document.getElementById('dashboard-tab').classList.contains('active') && map) {
                console.log('Refreshing live map data...');
                runServerScript('getLiveMapData', {}, 'GET')
                    .then(data => {
                        updateDriverMarkers(data.drivers);
                        displayOrdersOnMap(data.orders);
                    })
                    .catch(err => console.error('Failed to load map data:', err.message));
            }
        }

        function updateDriverMarkers(drivers) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!map) return;
            const activeDriverIds = [];
            drivers.forEach(driver => {
                if (driver.location && driver.location.latitude && driver.location.longitude) {
                    activeDriverIds.push(driver.driverId);
                    const lastUpdate = driver.location.lastUpdate ? new Date(driver.location.lastUpdate).toLocaleTimeString('he-IL') : 'אין';
                    const popupContent = `<b>${driver.name}</b><br>רכב: ${driver.vehicleType || 'לא ידוע'}<br>עדכון אחרון: ${lastUpdate}`;
                    const iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png';
                    createOrUpdateMarker(
                        driver.driverId,
                        driver.location.latitude,
                        driver.location.longitude,
                        popupContent,
                        driverMarkers,
                        iconUrl
                    );
                }
            });
            Object.keys(driverMarkers).forEach(driverId => {
                if (!activeDriverIds.includes(driverId)) {
                    removeMarker(driverId, driverMarkers);
                }
            });
        }
        
        function displayOrdersOnMap(orders) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            if (!map) return;
            const activeOrderIds = [];
            const mapOrders = orders.filter(o => o.latitude && o.longitude && o.status !== 'הושלם' && o.status !== 'מבוטל');
            mapOrders.forEach(order => {
                activeOrderIds.push(order.orderId);
                const popupContent = `<b>הזמנה: ${order.orderId}</b><br>${order.customerName}<br>${order.address}<br>סטטוס: ${order.status}`;
                let iconUrl;
                if (order.status === 'שויך') {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png';
                } else if (order.status === 'בדרך') {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                } else {
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';
                }
                createOrUpdateMarker(
                    order.orderId,
                    order.latitude,
                    order.longitude,
                    popupContent,
                    orderMarkers,
                    iconUrl
                );
            });
            Object.keys(orderMarkers).forEach(orderId => {
                if (!activeOrderIds.includes(String(orderId))) {
                    removeMarker(orderId, orderMarkers);
                }
            });
        }
        
        function buildSchedulerUI(drivers, orders) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const container = document.getElementById('scheduler-container');
            container.querySelectorAll('.driver-column').forEach(col => col.remove());
            const unassignedList = document.getElementById('unassigned-list');
            unassignedList.innerHTML = '';
            drivers.forEach(driver => {
                const driverCol = document.createElement('div');
                driverCol.className = 'driver-column';
                driverCol.dataset.driverId = driver.driverId;
                driverCol.innerHTML = `
                    <div class="column-header">${driver.name} (${driver.vehicleType})</div>
                    <div class="order-list" id="list-driver-${driver.driverId}"></div>
                `;
                container.appendChild(driverCol);
            });
            orders.forEach(order => {
                const card = createOrderCard(order);
                if (order.driverId && container.querySelector(`#list-driver-${order.driverId}`)) {
                    container.querySelector(`#list-driver-${order.driverId}`).appendChild(card);
                } else {
                    unassignedList.appendChild(card);
                }
            });
            setupDragAndDrop();
        }
        
        function createOrderCard(order) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const card = document.createElement('div');
            card.className = 'order-card';
            card.id = `order-${order.orderId}`;
            card.dataset.orderId = order.orderId;
            card.draggable = true;
            card.innerHTML = `
                <strong>${order.customerName}</strong><br>
                <small>${order.address}</small><br>
                <small>סטטוס: ${order.status} | סוג: ${order.deliveryType}</small>
            `;
            return card;
        }

        function setupDragAndDrop() {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const cards = document.querySelectorAll('.order-card');
            const lists = document.querySelectorAll('.order-list');
            let draggedCard = null;
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    setTimeout(() => card.classList.add('order-card-dragging'), 0);
                    e.dataTransfer.effectAllowed = 'move';
                });
                card.addEventListener('dragend', () => {
                    if (draggedCard) {
                        draggedCard.classList.remove('order-card-dragging');
                        draggedCard = null;
                    }
                });
            });
            lists.forEach(list => {
                list.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                list.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedCard) {
                        const targetList = e.currentTarget;
                        const targetColumn = targetList.closest('.driver-column, .unassigned-column');
                        const newDriverId = targetColumn.dataset.driverId;
                        const orderId = draggedCard.dataset.orderId;
                        targetList.appendChild(draggedCard);
                        assignOrder(orderId, newDriverId);
                    }
                });
            });
        }
        
        function assignOrder(orderId, driverId) {
            // ... (הפונקציה נשארת זהה ל-v29.3) ...
            const targetDriverId = (driverId === 'null' || !driverId) ? null : driverId;
            console.log(`Assigning ${orderId} to ${targetDriverId}`);
            runServerScript('assignOrder', { 
                orderId: orderId, 
                driverId: targetDriverId,
                index: 0
            }, 'POST')
            .then(() => {
                console.log(`Order ${orderId} assigned successfully.`);
                const card = document.getElementById(`order-${orderId}`);
                if (card) {
                    const statusEl = card.querySelector('small:last-child');
                    if (statusEl) {
                         statusEl.innerHTML = statusEl.innerHTML.replace(/סטטוס: [^|]+/, `סטטוס: ${targetDriverId ? 'שויך' : 'ממתין'}`);
                    }
                }
            })
            .catch(err => {
                alert(`שגיאה בשיוך הזמנה: ${err.message}`);
                loadScheduler();
            });
        }
        
    </script>
</body>
</html>

