<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v37.0 - מרכז בקרה (מפה)</title>
    
    <!-- 1. Leaflet (Map System) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* 1. Tailwind Base & Utilities (subset for light theme) */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; /* gray-200 */ }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; font-family: 'Inter', system-ui, sans-serif; direction: rtl; }
        body { margin: 0; line-height: inherit; background-color: #f3f4f6; /* bg-gray-100 */ color: #1f2937; /* text-gray-800 */ overflow-y: hidden; }
        
        /* 2. Custom Light Theme UI (Instead of Glass) */
        .light-card {
            background-color: #ffffff; /* bg-white */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); /* shadow-md */
        }

        /* 3. App-specific Styles (v37 Layout - Light Theme) */
        .p-4 { padding: 1rem; }
        .p-3 { padding: 0.75rem; }
        .p-6 { padding: 1.5rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-white { color: #fff; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-500 { color: #6b7280; }
        .text-green-500 { color: #22c55e; }
        .text-yellow-500 { color: #eab308; }
        .text-red-500 { color: #ef4444; }
        .text-cyan-500 { color: #06b6d4; }
        .text-blue-600 { color: #2563eb; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .w-full { width: 100%; }
        .min-w-full { min-width: 100%; }
        .h-screen { height: 100vh; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .border-b { border-bottom-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 1px; }
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #e5e7eb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; } /* gray-100 */
        
        /* Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100vh;
            padding: 1rem;
            gap: 1rem;
        }
        main {
            height: 100%;
            overflow-y: auto;
        }
        
        /* Sidebar - Light Theme */
        .sidebar { background-color: #fff; /* white */ }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            color: #4b5563; /* text-gray-600 */
            font-weight: 600; transition: all 0.2s ease;
        }
        .sidebar-nav a:hover {
            background-color: #e0f2fe; /* bg-sky-100 */
            color: #0369a1; /* text-sky-700 */
        }
        .sidebar-nav a.active {
            background-color: #0ea5e9; /* bg-sky-500 */
            color: white;
        }
        .sidebar-nav a svg { width: 1.25rem; height: 1.25rem; }

        /* Map - Light Theme */
        #leaflet-map {
            height: 100%; width: 100%;
            border-radius: 0.75rem; z-index: 10;
        }
        .leaflet-container { background: #e5e7eb; /* bg-gray-200 */ }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #fff; color: #1f2937; border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .leaflet-popup-close-button { color: #374151 !important; }
        .map-popup-button { /* כפתור קטן בתוך הפופאפ */
             margin-top: 8px; padding: 4px 8px; font-size: 12px;
             background-color: #0ea5e9; color: white; border: none;
             border-radius: 4px; cursor: pointer;
        }

        /* Buttons - Light Theme */
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; border: 1px solid transparent; }
        .btn-primary { background-color: #0ea5e9; color: white; border-color: #0ea5e9; } /* sky-500 */
        .btn-primary:hover { background-color: #0284c7; border-color: #0284c7; } /* sky-600 */
        .btn-secondary { background-color: #fff; color: #374151; border-color: #d1d5db; } /* gray-300 */
        .btn-secondary:hover { background-color: #f9fafb; } /* gray-50 */
        .btn-success { background-color: #22c55e; color: white; border-color: #22c55e; } /* green-500 */
        .btn-success:hover { background-color: #16a34a; border-color: #16a34a; } /* green-600 */
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; } /* amber-500 */
        .btn-warning:hover { background-color: #d97706; border-color: #d97706; } /* amber-600 */
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; } /* red-500 */
        .btn-danger:hover { background-color: #dc2626; border-color: #dc2626; } /* red-600 */
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Status & Logs - Light Theme */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-חדש { background-color: #e0f2fe; color: #0ea5e9; } /* sky-100 / sky-500 */
        .status-שויך { background-color: #fef3c7; color: #d97706; } /* amber-100 / amber-600 */
        .status-הושלם { background-color: #dcfce7; color: #16a34a; } /* green-100 / green-600 */
        .status-default { background-color: #e5e7eb; color: #4b5563; } /* gray-200 / gray-600 */
        .level-INFO { color: #0ea5e9; } /* sky-500 */
        .level-WARN { color: #f59e0b; } /* amber-500 */
        .level-ERROR { color: #ef4444; font-weight: 700; } /* red-500 */
        
        /* Modal Styles - Light Theme */
        .modal-backdrop { /* נשאר כהה ליצירת קונטרסט */
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content { width: 90%; max-width: 500px; background-color: #fff; /* white */ }
        
        /* Form Inputs - Light Theme */
        .form-input {
            width: 100%; background-color: #f9fafb; /* gray-50 */
            border: 1px solid #d1d5db; /* gray-300 */
            color: #1f2937; /* gray-800 */
            padding: 0.75rem 1rem; border-radius: 0.5rem;
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; /* gray-700 */ }
        
        /* Table Styles - Light Theme */
        table { border-collapse: collapse; }
        thead { background-color: #f9fafb; /* gray-50 */ }
        th { color: #4b5563; /* gray-600 */ }
        tbody { background-color: #fff; }
    </style>

    <!-- 1. Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- 2. Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
          authDomain: "saban94-78949.firebaseapp.com",
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app",
          messagingSenderId: "41553157903",
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };

        // --- 3. Init ---
        let db;
        let currentEditDoc = null; 
        let mapInstance = null;
        let allDrivers = {}; 
        let driverMarkers = {}; 
        let orderMarkers = {}; 
        
        // --- v37: Light Theme Icons ---
        const driverIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-amber-500"><path d="M3.375 4.5C2.339 4.5 1.5 5.34 1.5 6.375V13.5h1.063c.24 0 .47.09.643.255l3.48 3.099A2.25 2.25 0 008.25 18H18a2.25 2.25 0 002.25-2.25V6.375c0-1.036-.84-1.875-1.875-1.875H3.375zM13.5 15a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z" /><path d="M13.5 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25zM17.25 15a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25zM17.25 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25zM5.25 15a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25zM5.25 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25zM22.5 9.375c0-1.036-.84-1.875-1.875-1.875h-.375v10.125c0 1.035-.84 1.875-1.875 1.875h-.375v.75c0 1.036-.84 1.875-1.875 1.875H8.625c-1.035 0-1.875-.84-1.875-1.875v-.75H6v-3.83l-3.47-3.088A2.25 2.25 0 00.9 9.375H.375A.375.375 0 010 9V7.125A.375.375 0 01.375 6.75H6.75v5.64l3.47 3.088c.174.155.402.242.643.242H21.375a.375.375 0 01.375.375v1.875a.375.375 0 01-.375.375h-.375a.375.375 0 01-.375-.375v-.75H18a.375.375 0 01-.375-.375V6.75h4.5a.375.375 0 01.375.375v2.25a.375.375 0 01-.375.375h-.375z" /></svg>`,
            className: '', iconSize: [32, 32], iconAnchor: [16, 32]
        });
        const orderIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-sky-500"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0L2.41 11.47a.75.75 0 101.06 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75v4.5A.75.75 0 019 21.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>`,
            className: '', iconSize: [24, 24], iconAnchor: [12, 24]
        });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                
                setStatus('מתחבר...', 'text-yellow-500');
                await signInAnonymously(auth);
                setStatus('מחובר (מאזין לנתונים...)', 'text-green-500');
                
                initNavigation();
                initMap();
                listenToDrivers();
                listenToDriverLocations();
                listenToOrders();
                listenToCustomers();
                listenToSystemLogs();

            } catch (error) {
                console.error("Firebase Init Error", error);
                setStatus(`שגיאת התחברות: ${error.message}`, 'text-red-500');
            }
        });
        
        // --- 4. Navigation ---
        function initNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.currentTarget.getAttribute('href').substring(1);
                    showView(viewId);
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });
            showView('view-map');
            document.querySelector('.sidebar-nav a[href="#view-map"]').classList.add('active');
        }
        
        window.showView = (viewId) => {
            document.querySelectorAll('.app-view').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.remove('hidden');
            if (viewId === 'view-map' && mapInstance) mapInstance.invalidateSize();
        }

        // --- 5. Real-time Listeners (READ) ---
        // (Listeners for drivers, locations, orders, customers, logs - same as v36)
         function listenToDrivers() {
            const driversCollection = collection(db, "drivers");
            onSnapshot(driversCollection, (querySnapshot) => {
                const drivers = [];
                allDrivers = {}; // Clear cache
                querySnapshot.forEach((doc) => {
                    const driverData = doc.data();
                    allDrivers[doc.id] = driverData; // Update cache
                    drivers.push({ id: doc.id, ...driverData });
                });
                renderDriversTable(drivers); // v36
            }, (error) => console.error("Error listening to drivers:", error));
        }

        function listenToDriverLocations() {
            const locationsCollection = collection(db, "driverLocations");
            onSnapshot(locationsCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const driverId = change.doc.id;
                    const locationData = change.doc.data();
                    
                    if (change.type === "added" || change.type === "modified") {
                        updateDriverMarker(driverId, locationData);
                    } else if (change.type === "removed") {
                        if (driverMarkers[driverId]) {
                            mapInstance.removeLayer(driverMarkers[driverId]);
                            delete driverMarkers[driverId];
                        }
                    }
                });
            }, (error) => console.error("Error listening to driver locations:", error));
        }

        function listenToOrders() {
            const ordersCollection = collection(db, "orders");
            const q = query(ordersCollection, orderBy("createdAt", "desc")); // ממיין לפי זמן יצירה

            onSnapshot(q, (querySnapshot) => {
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                renderOrdersTable(orders); // v36: מעדכן טבלת הזמנות
                updateOrderMarkers(orders); // v36: מעדכן מפה
            }, (error) => {
                console.error("Firestore Listen Error (Orders)", error);
                setStatus("שגיאה בהאזנה להזמנות", 'text-red-500');
            });
        }
        
        function listenToCustomers() {
            const customersCollection = collection(db, "customers");
            const q = query(customersCollection, orderBy("name", "asc"));

            onSnapshot(q, (querySnapshot) => {
                const customers = [];
                querySnapshot.forEach((doc) => {
                    customers.push({ id: doc.id, ...doc.data() });
                });
                renderCustomersTable(customers); // v36
            }, (error) => console.error("Error listening to customers:", error));
        }
        
        function listenToSystemLogs() {
            const logsCollection = collection(db, "system_logs");
            const q = query(logsCollection, orderBy("timestamp", "desc"));

            onSnapshot(q, (querySnapshot) => {
                const logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                renderLogsTable(logs); // v36
            }, (error) => console.error("Error listening to logs:", error));
        }


        // --- 6. Render Functions ---
        // (Render functions for tables - same logic as v36, adapted for light theme)
        function renderOrdersTable(orders) {
            const tableBody = document.getElementById('orders-table-body');
            if (!tableBody) return;
            if (!orders || orders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">עדיין אין הזמנות...</td></tr>`;
                return;
            }
            tableBody.innerHTML = orders.map(order => {
                const customerName = order.customer ? order.customer.name : 'לא ידוע';
                const driverName = order.driver ? order.driver.name : 'טרם שויך';
                const status = order.status || 'חדש';
                const statusClass = `status-${status.replace(' ', '_')}` || 'status-default';

                let actionsHtml = '';
                if (status === 'חדש') {
                    actionsHtml = `<button class="btn btn-warning btn-sm" onclick="openAssignDriverModal('${order.id}')">שבץ</button>`;
                } else if (status === 'שויך') {
                    actionsHtml = `<button class="btn btn-success btn-sm" onclick="handleMarkAsCompleted('${order.id}')">הושלם</button>`;
                }
                
                return `
                    <tr class="hover:bg-gray-100 text-sm">
                        <td class="p-3">${order.id}</td>
                        <td class="p-3 text-gray-800 font-semibold">${customerName}</td>
                        <td class="p-3">${order.address}</td>
                        <td class="p-3 text-gray-800 font-semibold">${driverName}</td>
                        <td class="p-3"><span class="status-badge ${statusClass}">${status}</span></td>
                        <td class="p-3 flex gap-2">
                            ${actionsHtml}
                            <button class="btn btn-secondary btn-sm" onclick="openEditOrderModal(JSON.stringify(window.allOrders['${order.id}']))">ערוך</button>
                            <button class="btn btn-danger btn-sm" onclick="handleDelete('orders', '${order.id}')">מחק</button>
                        </td>
                    </tr>
                `;
            }).join('');
            window.allOrders = orders.reduce((acc, order) => { acc[order.id] = order; return acc; }, {});
        }
        
        function renderDriversTable(drivers) {
             const tableBody = document.getElementById('drivers-table-body');
             if (!tableBody) return;
             tableBody.innerHTML = drivers.map(driver => `
                <tr class="hover:bg-gray-100 text-sm">
                    <td class="p-3 text-gray-800 font-semibold">${driver.name || driver.id}</td>
                    <td class="p-3">${driver.phone || '---'}</td>
                    <td class="p-3">${driver.vehicleType || 'לא ידוע'}</td>
                    <td class="p-3">${driver.status || 'לא פעיל'}</td>
                    <td class="p-3 flex gap-2">
                         <button class="btn btn-danger btn-sm" onclick="handleDelete('drivers', '${driver.id}')">מחק</button>
                    </td>
                </tr>
             `).join('');
        }
        
        function renderCustomersTable(customers) {
             const tableBody = document.getElementById('customers-table-body');
             if (!tableBody) return;
             tableBody.innerHTML = customers.map(customer => `
                <tr class="hover:bg-gray-100 text-sm">
                    <td class="p-3 text-gray-800 font-semibold">${customer.name || customer.id}</td>
                    <td class="p-3">${customer.phone || '---'}</td>
                    <td class="p-3">${customer.defaultAddress || '---'}</td>
                    <td class="p-3">${customer.contactPerson || '---'}</td>
                    <td class="p-3 flex gap-2">
                         <button class="btn btn-danger btn-sm" onclick="handleDelete('customers', '${customer.id}')">מחק</button>
                    </td>
                </tr>
             `).join('');
        }
        
        function renderLogsTable(logs) {
             const tableBody = document.getElementById('logs-table-body');
             if (!tableBody) return;
             tableBody.innerHTML = logs.map(log => {
                const level = log.level || 'INFO';
                const time = log.timestamp ? log.timestamp.toDate().toLocaleString('he-IL') : '---';
                return `
                    <tr class="hover:bg-gray-100 text-sm font-mono">
                        <td class="p-3 text-gray-500">${time}</td>
                        <td class="p-3 font-bold level-${level}">${level}</td>
                        <td class="p-3 text-cyan-500">[${log.origin || 'N/A'}]</td>
                        <td class="p-3 text-gray-800">${log.message || '---'}</td>
                        <td class="p-3 text-xs text-gray-500">${log.data || ''}</td>
                    </tr>
                `;
             }).join('');
        }
        
        function setStatus(message, cssClass) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.className = `text-sm ${cssClass}`;
        }

        // --- 7. Map Functions ---
        window.initMap = () => {
            try {
                mapInstance = L.map('leaflet-map').setView([31.7683, 35.2137], 8);
                // v37: Light map tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd', maxZoom: 19
                }).addTo(mapInstance);
            } catch (e) {
                console.error("Failed to initialize Leaflet map", e);
                document.getElementById('leaflet-map').innerHTML = "שגיאה בטעינת המפה.";
            }
        }

        function updateDriverMarker(driverId, locationData) {
            if (!mapInstance || !locationData.latitude || !locationData.longitude) return;
            const latLng = [locationData.latitude, locationData.longitude];
            const driverName = allDrivers[driverId] ? allDrivers[driverId].name : driverId;
            const popupContent = `<b>נהג: ${driverName}</b><br>עודכן: ${new Date(locationData.lastUpdate.toDate()).toLocaleTimeString('he-IL')}`;

            if (driverMarkers[driverId]) {
                driverMarkers[driverId].setLatLng(latLng);
                driverMarkers[driverId].setPopupContent(popupContent);
            } else {
                driverMarkers[driverId] = L.marker(latLng, { icon: driverIcon })
                    .addTo(mapInstance)
                    .bindPopup(popupContent);
            }
        }

        function updateOrderMarkers(orders) {
            if (!mapInstance) return;
            // TODO: Clear old markers more efficiently
            const currentOrderIds = orders.map(o => o.id);
            Object.keys(orderMarkers).forEach(markerId => {
                if (!currentOrderIds.includes(markerId)) {
                    mapInstance.removeLayer(orderMarkers[markerId]);
                    delete orderMarkers[markerId];
                }
            });

            orders.forEach(order => {
                if (order.status !== 'הושלם' && order.latitude && order.longitude) {
                    const latLng = [order.latitude, order.longitude];
                    // v37: Added assign button to popup
                    const popupContent = `<b>${order.customer.name}</b><br>${order.address}<br>סטטוס: ${order.status}` +
                                         (order.status === 'חדש' ? `<br><button class="map-popup-button" onclick="openAssignDriverModal('${order.id}')">שבץ נהג</button>` : '');
                    const orderId = order.id;
                    
                    if (orderMarkers[orderId]) {
                        orderMarkers[orderId].setLatLng(latLng);
                        orderMarkers[orderId].setPopupContent(popupContent);
                    } else {
                        orderMarkers[orderId] = L.marker(latLng, { icon: orderIcon })
                            .addTo(mapInstance)
                            .bindPopup(popupContent);
                    }
                } else if (orderMarkers[order.id]) {
                    mapInstance.removeLayer(orderMarkers[order.id]);
                    delete orderMarkers[order.id];
                }
            });
        }
        
        // --- 8. Write Functions (CRUD) ---
        // (Modal controls, Create/Update Order, Assign Driver, Mark Completed, Delete - same as v36)
         // --- Modal Controls ---
        window.openAddOrderModal = () => {
            currentEditDoc = null; 
            document.getElementById('addOrderModalTitle').textContent = "יצירת הזמנה חדשה";
            document.getElementById('addOrderForm').reset();
            document.getElementById('addOrderModal').style.display = 'flex';
        }

        window.openEditOrderModal = (orderJson) => {
            const order = JSON.parse(orderJson);
            currentEditDoc = order; 
            
            const form = document.getElementById('addOrderForm');
            form.customerName.value = order.customer?.name || '';
            form.customerPhone.value = order.customer?.phone || '';
            form.address.value = order.address || '';
            form.latitude.value = order.latitude || '';
            form.longitude.value = order.longitude || '';
            form.deliveryType.value = order.deliveryType || '';
            form.customerId.value = order.customer?.id || '';
            
            document.getElementById('addOrderModalTitle').textContent = `עריכת הזמנה ${order.id}`;
            document.getElementById('addOrderModal').style.display = 'flex';
        }
        
        window.openAssignDriverModal = (orderId) => {
            currentEditDoc = { id: orderId }; // Only need ID for assignment
            document.getElementById('assignDriverModal').style.display = 'flex';
        }
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // --- Create / Update (Order) ---
        window.handleSaveOrder = async () => {
            const form = document.getElementById('addOrderForm');
            const isEditMode = !!currentEditDoc;
            const orderId = isEditMode ? currentEditDoc.id : Date.now().toString();
            const orderRef = doc(db, "orders", orderId);

            try {
                const orderData = {
                    orderId: orderId,
                    address: form.address.value,
                    latitude: parseFloat(form.latitude.value) || null,
                    longitude: parseFloat(form.longitude.value) || null,
                    deliveryType: form.deliveryType.value,
                    customer: {
                        name: form.customerName.value,
                        phone: form.customerPhone.value,
                        id: form.customerId.value || null
                    },
                    ...isEditMode && { 
                        driver: currentEditDoc.driver, 
                        status: currentEditDoc.status, 
                        orderDate: currentEditDoc.orderDate,
                        createdAt: currentEditDoc.createdAt // Preserve original creation time
                    },
                    ...!isEditMode && {
                        driver: null,
                        status: "חדש",
                        orderDate: new Date().toLocaleDateString('he-IL'),
                        createdAt: serverTimestamp(),
                    }
                };
                
                if (isEditMode) {
                    await updateDoc(orderRef, orderData); 
                } else {
                    await setDoc(orderRef, orderData); 
                }
                
                closeModal('addOrderModal');
                form.reset();
                currentEditDoc = null;
                
            } catch (e) {
                console.error("Error saving document: ", e);
                alert("שגיאה בשמירת הזמנה: " + e.message);
            }
        }
        
        // --- Update (Assign Driver) ---
        window.handleAssignDriver = async () => {
            const driverName = document.getElementById('driverNameInput').value;
            if (!driverName || !currentEditDoc) return;
            
            const orderRef = doc(db, "orders", currentEditDoc.id);
            
            try {
                const driverId = Object.keys(allDrivers).find(id => allDrivers[id].name === driverName) || driverName;
                const driverData = { id: driverId, name: driverName };
                
                await updateDoc(orderRef, {
                    driver: driverData,
                    status: "שויך"
                });
                
                closeModal('assignDriverModal');
                document.getElementById('driverNameInput').value = '';
                currentEditDoc = null;
                
            } catch (e) {
                console.error("Error updating document: ", e);
                alert("שגיאה בשיבוץ נהג: " + e.message);
            }
        }
        
        // --- Update (Mark as Completed) ---
        window.handleMarkAsCompleted = async (orderId) => {
            if (!confirm(`האם אתה בטוח שברצונך לסמן הזמנה ${orderId} כ"הושלם"?`)) return;
            
            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, { status: "הושלם" });
            } catch (e) {
                console.error("Error completing order: ", e);
                alert("שגיאה בסיום הזמנה: " + e.message);
            }
        }
        
        // --- Delete ---
        window.handleDelete = async (collectionName, docId) => {
            if (!confirm(`האם אתה בטוח שברצונך למחוק את פריט ${docId} מאוסף ${collectionName}?`)) return;
            
            const docRef = doc(db, collectionName, docId);
            try {
                await deleteDoc(docRef);
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("שגיאה במחיקת פריט: " + e.message);
            }
        }
        
        // --- Attach to window for onclick ---
        window.handleMarkAsCompleted = handleMarkAsCompleted;
        window.handleDelete = handleDelete; // v37: Attach delete handler

    </script>
    
    <!-- 2. Leaflet (Map System) JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="h-screen overflow-hidden bg-gray-100">

    <div class="main-layout">
        
        <!-- 1. Sidebar -->
        <aside class="light-card sidebar p-4 flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 p-2 mb-6">ח. סבן (v37)</h1>
                <nav class="sidebar-nav space-y-2">
                    <a href="#view-map">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m0 0v2.25m0-2.25h1.5M9 15H7.5m1.5-6.75V4.5m0 2.25H7.5M15 12m-3 0a3 3 0 116 0 3 3 0 01-6 0z" /></svg>
                        <span>חדר מצב (מפה)</span>
                    </a>
                    <a href="#view-orders">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        <span>ניהול הזמנות</span>
                    </a>
                    <a href="#view-drivers">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                        <span>ניהול נהגים</span>
                    </a>
                    <a href="#view-customers">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span>ניהול לקוחות</span>
                    </a>
                    <a href="#view-logs">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5M3.75 6.75h16.5M3.75 17.25h16.5" /></svg>
                        <span>צג לוגים (מלשינון)</span>
                    </a>
                </nav>
            </div>
            <div id="connection-status" class="text-sm text-yellow-500 p-2 text-center">
                טוען...
            </div>
        </aside>

        <!-- 2. Main Content Area -->
        <main class="h-full overflow-hidden light-card">
            
            <!-- View 1: Map (Default) -->
            <div id="view-map" class="app-view h-full">
                <!-- המפה תופסת את כל האזור -->
                 <div id="leaflet-map"></div>
            </div>

            <!-- View 2: Orders Table -->
            <div id="view-orders" class="app-view hidden h-full flex flex-col gap-4 p-4">
                <header class="flex-shrink-0 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ניהול הזמנות</h2>
                    <button class="btn btn-primary" onclick="openAddOrderModal()">
                        + הוסף הזמנה חדשה
                    </button>
                </header>
                <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full min-w-full text-right">
                            <thead class="sticky top-0 bg-gray-50 z-10">
                                <tr class="text-gray-600 text-sm">
                                    <th class="p-3 font-semibold">מזהה</th>
                                    <th class="p-3 font-semibold">לקוח</th>
                                    <th class="p-3 font-semibold">כתובת</th>
                                    <th class="p-3 font-semibold">נהג</th>
                                    <th class="p-3 font-semibold">סטטוס</th>
                                    <th class="p-3 font-semibold">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="divide-y divide-gray-200">
                                <!-- Rows injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- View 3: Drivers Table -->
            <div id="view-drivers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                <header class="flex-shrink-0 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ניהול נהגים</h2>
                    <!-- <button class="btn btn-primary">+ הוסף נהג חדש</button> -->
                </header>
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full min-w-full text-right">
                             <thead class="sticky top-0 bg-gray-50 z-10">
                                <tr class="text-gray-600 text-sm">
                                    <th class="p-3 font-semibold">שם (מזהה)</th>
                                    <th class="p-3 font-semibold">טלפון</th>
                                    <th class="p-3 font-semibold">סוג רכב</th>
                                    <th class="p-3 font-semibold">סטטוס</th>
                                    <th class="p-3 font-semibold">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View 4: Customers Table -->
             <div id="view-customers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ניהול לקוחות (פרויקטים)</h2>
                    <!-- <button class="btn btn-primary">+ הוסף לקוח חדש</button> -->
                </header>
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full min-w-full text-right">
                             <thead class="sticky top-0 bg-gray-50 z-10">
                                 <tr class="text-gray-600 text-sm">
                                    <th class="p-3 font-semibold">שם (פרויקט)</th>
                                    <th class="p-3 font-semibold">טלפון</th>
                                    <th class="p-3 font-semibold">כתובת ברירת מחדל</th>
                                    <th class="p-3 font-semibold">איש קשר</th>
                                    <th class="p-3 font-semibold">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View 5: Logs Table -->
             <div id="view-logs" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">צג לוגים (מלשינון)</h2>
                </header>
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg">
                    <div class="overflow-y-auto h-full">
                        <table class="w-full min-w-full text-right">
                            <thead class="sticky top-0 bg-gray-50 z-10">
                                <tr class="text-gray-600 text-sm">
                                    <th class="p-3 font-semibold">זמן</th>
                                    <th class="p-3 font-semibold">רמה</th>
                                    <th class="p-3 font-semibold">מקור</th>
                                    <th class="p-3 font-semibold">הודעה</th>
                                    <th class="p-3 font-semibold">נתונים</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- MODALS (v37 - Light Theme) -->
    
    <!-- Add / Edit Order Modal -->
    <div id="addOrderModal" class="modal-backdrop" style="display: none;">
        <div class="light-card modal-content p-6 space-y-4 max-h-[90vh] overflow-y-auto">
            <h2 id="addOrderModalTitle" class="text-xl font-bold text-gray-800">יצירת הזמנה חדשה</h2>
            <form id="addOrderForm" class="space-y-4" onsubmit="event.preventDefault(); handleSaveOrder();">
                <div>
                    <label class="form-label">שם לקוח</label>
                    <input type="text" name="customerName" class="form-input" required>
                </div>
                <div>
                    <label class="form-label">טלפון לקוח</label>
                    <input type="text" name="customerPhone" class="form-input" required>
                </div>
                <div>
                    <label class="form-label">כתובת</label>
                    <input type="text" name="address" class="form-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Latitude</label>
                        <input type="number" step="any" name="latitude" class="form-input">
                    </div>
                     <div>
                        <label class="form-label">Longitude</label>
                        <input type="number" step="any" name="longitude" class="form-input">
                    </div>
                </div>
                <div>
                    <label class="form-label">סוג הובלה</label>
                    <input type="text" name="deliveryType" class="form-input" value="פריקה ידנית">
                </div>
                 <div>
                    <label class="form-label">(אופציונלי) מזהה לקוח</label>
                    <input type="text" name="customerId" class="form-input">
                </div>
                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary w-full" onclick="closeModal('addOrderModal')">ביטול</button>
                    <button type="submit" class="btn btn-primary w-full">שמור שינויים</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Assign Driver Modal -->
    <div id="assignDriverModal" class="modal-backdrop" style="display: none;">
        <div class="light-card modal-content p-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">שיבוץ נהג</h2>
            <form onsubmit="event.preventDefault(); handleAssignDriver();">
                <div>
                    <label class="form-label">שם הנהג</label>
                    <input type="text" id="driverNameInput" class="form-input" placeholder="לדוגמה: עלי, חכמת..." required>
                </div>
                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary w-full" onclick="closeModal('assignDriverModal')">ביטול</button>
                    <button type="submit" class="btn btn-warning w-full">שבץ נהג</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

