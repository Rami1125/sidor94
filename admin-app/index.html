<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <!-- ... (head content remains unchanged) ... -->
    <style>
        /* ... (all previous CSS styles remain unchanged) ... */

        /* NEW: Style for the optimize button */
        .optimize-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .optimize-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- ... (h1, main-layout, etc. unchanged) ... -->
    </div>
    
    <!-- ... (Modals remain unchanged) ... -->

    <script>
        // ... (all previous script variables remain the same) ...
        
        // --- Scheduler Functions ---
        async function buildScheduler() {
            schedulerContainer.innerHTML = '';
            try {
                // ... (fetching drivers and orders remains the same) ...

                drivers.forEach(driver => {
                    const driverCol = document.createElement('div');
                    driverCol.className = 'scheduler-column';
                    // NEW: Added optimize button to the header
                    driverCol.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3><i class="fas fa-user-circle"></i> ${driver.name}</h3>
                            <button class="optimize-btn" data-driver-id="${driver.driverId}" title="סדר מסלול אופטימלי">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>`;
                    const driverLane = document.createElement('ul');
                    // ... (rest of driver column setup) ...
                    driverCol.appendChild(driverLane);
                    schedulerContainer.appendChild(driverCol);
                });

                // ... (populating orders remains the same) ...

                initSortable();
                
                // NEW: Add event listeners to optimize buttons
                document.querySelectorAll('.optimize-btn').forEach(btn => {
                    btn.addEventListener('click', handleOptimizeRoute);
                });

            } catch (error) {
                // ... (error handling) ...
            }
        }
        
        // NEW: Function to handle route optimization
        async function handleOptimizeRoute(event) {
            const btn = event.currentTarget;
            const driverId = btn.dataset.driverId;
            const driverLane = document.getElementById(`driver-lane-${driverId}`);
            const cards = Array.from(driverLane.children);

            if (cards.length < 2) {
                alert("יש צורך בלפחות שתי משימות כדי לבצע אופטימיזציה.");
                return;
            }

            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            btn.disabled = true;

            const orders = await Promise.all(cards.map(async card => {
                const orderId = card.dataset.orderId;
                // We need to fetch the full order to get its address
                const res = await fetch(`${API_URL}?action=getOrders&orderId=${orderId}`); // Note: getOrders would need a small tweak to support fetching a single order
                const result = await res.json();
                return { id: orderId, address: result.data[0].address };
            }));

            const startPoint = "החרש 10, הוד השרון"; // Should be fetched from settings
            const waypoints = orders.map(o => o.address);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({
                        action: 'optimizeRoute',
                        data: { start: startPoint, waypoints: waypoints }
                    })
                });
                const result = await response.json();

                if (result.status === 'success' && result.data.optimizedOrder) {
                    const optimizedOrder = result.data.optimizedOrder;
                    
                    // Create a new sorted array of cards
                    const sortedCards = optimizedOrder.map(index => cards[index]);

                    // Re-append cards to the lane in the new order
                    sortedCards.forEach(card => driverLane.appendChild(card));
                } else {
                    throw new Error(result.message || "Optimization failed");
                }

            } catch (error) {
                console.error("Error optimizing route:", error);
                alert("שגיאה בחישוב המסלול האופטימלי.");
            } finally {
                btn.innerHTML = `<i class="fas fa-magic"></i>`;
                btn.disabled = false;
            }
        }


        // ... (All other functions from the previous stable version remain here) ...
        
    </script>
</body>
</html>

