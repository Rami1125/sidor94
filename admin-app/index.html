<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v33.0 - 专 爪</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Tailwind Base & Utilities (minified subset for demo) */
        *,::before,::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; -moz-tab-size: 4; tab-size: 4; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; direction: rtl; }
        body { margin: 0; line-height: inherit; background-color: #111827; color: #d1d5db; }
        .container { width: 100%; margin-left: auto; margin-right: auto; padding-left: 1rem; padding-right: 1rem; }
        @media (min-width: 1280px) { .container { max-width: 1280px; } }
        /* --- v33.0 Glass UI Design System --- */
        .glass-ui {
            background-color: rgba(31, 41, 55, 0.7); /* bg-gray-800 bg-opacity-70 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .glass-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: rgba(59, 130, 246, 0.8); /* bg-blue-500 bg-opacity-80 */
            color: white;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-button:hover { background-color: rgba(37, 99, 235, 1); }
        .glass-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: rgba(17, 24, 39, 0.8); /* bg-gray-900 bg-opacity-80 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus { outline: 2px solid rgba(59, 130, 246, 0.8); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; }
        .status-new { background-color: #3b82f6; color: white; }
        .status-assigned { background-color: #eab308; color: #422006; }
        .status-delivered { background-color: #22c55e; color: #064e3b; }
        /* Leaflet RTL Fix */
        .leaflet-container { background: #374151; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container space-y-6">
        
        <header class="glass-ui p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">DeliveryMaster v33.0 - 专 爪</h1>
            <div class="text-sm text-gray-400">
                爪: <span class="text-green-400">专</span> | <span id="clock"></span>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass-ui p-5">
                <h3 class="text-gray-400 text-sm font-medium">住" 转 ()</h3>
                <p id="stat-total" class="text-3xl font-bold text-white">注...</p>
            </div>
            <div class="glass-ui p-5">
                <h3 class="text-gray-400 text-sm font-medium">转 砖抓</h3>
                <p id="stat-pending" class="text-3xl font-bold text-yellow-400">注...</p>
            </div>
            <div class="glass-ui p-5">
                <h3 class="text-gray-400 text-sm font-medium">转 砖砖</h3>
                <p id="stat-assigned" class="text-3xl font-bold text-blue-400">注...</p>
            </div>
            <div class="glass-ui p-5">
                <h3 class="text-gray-400 text-sm font-medium"> 驻注</h3>
                <p id="stat-drivers" class="text-3xl font-bold text-green-400">注...</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-4">
                <div class="glass-ui p-4">
                    <input type="text" id="smart-search" class="glass-input" placeholder=" 驻砖  (砖, 驻, 转转, , 住住)...">
                </div>
                <div class="glass-ui p-4 overflow-auto" style="max-height: 600px;">
                    <table class="w-full text-right">
                        <thead class="border-b border-gray-600">
                            <tr>
                                <th class="p-2"></th>
                                <th class="p-2">拽</th>
                                <th class="p-2">转转</th>
                                <th class="p-2"></th>
                                <th class="p-2">住住</th>
                                <th class="p-2">驻注转</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr><td colspan="6" class="p-8 text-center text-gray-400">注 转...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-ui p-4 space-y-2">
                    <h2 class="text-lg font-semibold text-white">驻转 转爪 </h2>
                    <div id="leaflet-map" class="w-full h-64 rounded-lg z-0"></div>
                </div>

                <div class="glass-ui p-4 space-y-2">
                    <h2 class="text-lg font-semibold text-white">转驻转 驻 住住</h2>
                    <canvas id="status-chart" class="w-full"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- 1. Configuration ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxbP_jAKtqTG279H_we5sB_QgRgLBTh7C7_D_-HAOmvfVYnFdWeJ6RBXH-LmYPw83Da/exec"; // 砖 拽  转 -URL 砖 -WebApp 砖驻专住
        const APP_NAME = "AdminApp_v33";
        const REFRESH_INTERVAL = 60000; // 1 minute auto-refresh
        
        // --- Global State ---
        let allOrders = [];
        let allDrivers = [];
        let mapInstance = null;
        let chartInstance = null;
        let localLogs = [];

        // --- 2. SmartLog v33.0 (Client) ---
        // "砖" 爪 拽
        const SmartLog = {
            info: (message, data = {}) => log('info', message, data),
            warn: (message, data = {}) => log('warn', message, data),
            error: (message, error, data = {}) => {
                const errorData = { 
                    error: error ? error.message : 'Unknown error', 
                    stack: error ? error.stack : undefined, ...data 
                };
                log('error', message, errorData);
            },
            sendBatch: () => {
                if (localLogs.length === 0) return;
                
                const batch = [...localLogs];
                localLogs = []; // Clear queue
                
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'logToServerBatch',
                        payload: batch,
                        context: { app: APP_NAME, version: 'v33.0' }
                    }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                })
                .catch(err => console.error("SmartLog FATAL: Failed to send batch.", err));
            }
        };

        function log(level, message, data) {
            console[level] || console.log(`[${level}] ${message}`, data);
            localLogs.push({ level, message, data, timestamp: new Date().toISOString() });
        }
        
        // Send logs to server every 30 seconds
        setInterval(SmartLog.sendBatch, 30000);

        // --- 3. API Fetch Utility (v33.0) ---
        async function apiFetch(action, payload = {}) {
            SmartLog.info(`API Request: ${action}`, payload);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload, context: { app: APP_NAME } }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok (status: ${response.status})`);
                }

                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                SmartLog.info(`API Success: ${action}`, result.data);
                return result.data;

            } catch (error) {
                SmartLog.error(`API Failure: ${action}`, error, payload);
                // TODO: Add "AutoError Recovery" UI notification
                alert(`砖转 转拽砖专转 专: ${error.message}`);
                throw error;
            }
        }

        // --- 4. Application Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            initClock();
            loadInitialData();
            initMap();
            
            // Auto-refresh data
            setInterval(loadInitialData, REFRESH_INTERVAL);

            // Smart search listener
            document.getElementById('smart-search').addEventListener('input', (e) => {
                renderOrders(e.target.value.toLowerCase());
            });
        });

        function initClock() {
            const clockEl = document.getElementById('clock');
            if (!clockEl) return;
            const update = () => {
                clockEl.textContent = new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            };
            update();
            setInterval(update, 1000);
        }

        async function loadInitialData() {
            SmartLog.info("Loading initial data...");
            try {
                // Run in parallel
                const [dashboardData, orders, drivers] = await Promise.all([
                    apiFetch('getDashboardData'),
                    apiFetch('getOrders', { force: true }), // Force refresh
                    apiFetch('getDrivers')
                ]);

                allOrders = orders;
                allDrivers = drivers;
                
                // Update UI
                renderDashboard(dashboardData);
                renderOrders();
                updateMapMarkers(orders);
                updateDashboardChart(dashboardData.stats.byStatus);

            } catch (error) {
                SmartLog.error('Failed to load initial data', error);
            }
        }

        // --- 5. Render Functions (UX Evolution) ---

        function renderDashboard(data) {
            const stats = data.stats;
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-pending').textContent = stats.byStatus[' 砖'] || 0;
            document.getElementById('stat-assigned').textContent = stats.today || 0;
            document.getElementById('stat-drivers').textContent = data.driverCount || 0;
        }

        function renderOrders(filter = '') {
            const tableBody = document.getElementById('orders-table-body');
            let html = '';
            
            const filteredOrders = allOrders.filter(order => {
                if (filter === '') return true;
                return (
                    (order.customerName && order.customerName.toLowerCase().includes(filter)) ||
                    (order.address && order.address.toLowerCase().includes(filter)) ||
                    (order.driverId && order.driverId.toLowerCase().includes(filter)) ||
                    (order.status && order.status.toLowerCase().includes(filter)) ||
                    (order.customerPhone && order.customerPhone.includes(filter)) ||
                    (order.orderId.toString().includes(filter))
                );
            });

            if (filteredOrders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400"> 爪 转 转转.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const statusClass = order.status === '砖' ? 'status-delivered' : (order.status === '砖' ? 'status-assigned' : 'status-new');
                html += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-3">${order.orderId}</td>
                        <td class="p-3">${order.customerName}</td>
                        <td class="p-3">${order.address}</td>
                        <td class="p-3">${order.driverId || '---'}</td>
                        <td class="p-3"><span class="status-badge ${statusClass}">${order.status || '砖'}</span></td>
                        <td class="p-3">
                            <button class="glass-button text-xs" onclick="openAssignModal('${order.orderId}')">砖抓</button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        function updateDashboardChart(statusData) {
            const ctx = document.getElementById('status-chart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: ['#eab308', '#3b82f6', '#22c55e', '#ef4444'],
                        borderColor: '#1f2937',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#d1d5db' }
                        }
                    }
                }
            });
        }

        // --- 6. Map System (Leaflet) ---
        
        function initMap() {
            try {
                // Center on Israel
                mapInstance = L.map('leaflet-map').setView([31.7683, 35.2137], 8);
                
                // Use a dark tile layer (MapLibre/OpenStreetMap based)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(mapInstance);
                SmartLog.info("Leaflet map initialized.");
            } catch (e) {
                SmartLog.error("Failed to initialize Leaflet map", e);
                document.getElementById('leaflet-map').innerHTML = "砖 注转 驻.";
            }
        }

        function updateMapMarkers(orders) {
            if (!mapInstance) return;
            
            // Clear existing markers (TODO: optimize this)
            mapInstance.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    mapInstance.removeLayer(layer);
                }
            });

            orders.forEach(order => {
                if (order.latitude && order.longitude) {
                    L.marker([order.latitude, order.longitude])
                        .addTo(mapInstance)
                        .bindPopup(`<b>${order.customerName}</b><br>${order.address}<br>住住: ${order.status}`);
                }
            });
        }

        // --- 7. Interactive Modals (UX) ---
        
        function openAssignModal(orderId) {
            // This is a placeholder for the modal logic
            // In a real app, this would open a 'glass-ui' modal
            SmartLog.info(`Opening assign modal for ${orderId}`);
            
            const driverId = prompt(`专  砖抓  ${orderId}:\n(住 ID 砖 )`);
            if (driverId) {
                assignDriver(orderId, driverId);
            }
        }
        
        async function assignDriver(orderId, driverId) {
            try {
                const result = await apiFetch('assignDriver', { orderId, driverId });
                alert(` ${orderId} 砖爪 爪  ${driverId}!`);
                loadInitialData(); // Refresh all data
            } catch (error) {
                alert(`砖 砖抓 : ${error.message}`);
            }
        }

    </script>
</body>
</html>
