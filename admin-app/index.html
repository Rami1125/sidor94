<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v31.5</title>
    <!-- 
      DeliveryMaster Admin App v31.5
      
      Changelog:
      - v31.5: Syntax Repair & UI Restore
      - UI: Restored modern v31.x UI (Glassmorphism + Tailwind).
      - FIX: Corrected 'Unexpected token )' SyntaxError in apiFetch.
      - API: Pointing to the correct deployed URL (...IiSge_u/exec).
      - LOGGER: Implemented v31.4 batching "Smart Logger" + global error handlers.
      - HEALTH: Added server status light and health check function.
    -->
    
    <!-- Tailwind CSS (CDN for Development) -->
    <!-- v31.2 WARNING: Using Tailwind CDN for development. For production, a compiled build is required. -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-hover: #2563eb; /* blue-600 */
            --bg-main: #f3f4f6; /* gray-100 */
            --bg-nav: rgba(255, 255, 255, 0.7); /* white alpha 70% */
            --bg-panel: rgba(255, 255, 255, 0.85);
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
        }
        @font-face {
            font-family: 'Rubik';
            src: url('https://fonts.gstatic.com/s/rubik/v28/iJWZBXyIfDnIV5PNhY1KTN7Z-Yh-B4iFV0U1.woff2') format('woff2');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Rubik';
            src: url('https://fonts.gstatic.com/s/rubik/v28/iJWZBXyIfDnIV5PNhY1KTN7Z-Yh-B4iFu0Q1.woff2') format('woff2');
            font-weight: 500;
        }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            overflow: hidden;
        }
        
        /* Glassmorphism Effect */
        .glass-nav {
            background: var(--bg-nav);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-color);
        }
        
        /* v31.4 Status Light */
        #server-status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #f59e0b; /* amber-500 (Connecting) */
            transition: background-color 0.3s;
        }
        #server-status-light.ok {
            background-color: #22c55e; /* green-500 (OK) */
        }
        #server-status-light.error {
            background-color: #ef4444; /* red-500 (Error) */
        }
        
        /* v31.4 Critical Error Bar */
        #critical-error-bar {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            text-align: center;
            font-weight: 600;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
        }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            height: 100vh;
        }
        #main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: 100vh;
            overflow: hidden;
        }
        #map { height: 100%; width: 100%; z-index: 0; }
        #side-panel {
            height: 100vh;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
        }
        #side-panel-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* Components */
        .nav-link {
            transition: all 0.2s;
            border-right: 3px solid transparent;
        }
        .nav-link.active {
            color: var(--primary-color);
            background-color: var(--bg-main);
            border-right-color: var(--primary-color);
        }
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .driver-card, .order-card {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .driver-card:hover, .order-card:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .driver-card.active, .order-card.active {
            background-color: #eff6ff; /* blue-50 */
            border-right: 4px solid var(--primary-color);
        }
        .status-active { background-color: #22c55e; } /* green-500 */
        .status-inactive { background-color: #ef4444; } /* red-500 */
        .status-stuck { background-color: #f59e0b; } /* amber-500 */
        
        /* Modal */
        #new-order-modal {
            max-width: 500px;
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
        }
        #new-order-modal::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            #main-content { grid-template-columns: 1fr; grid-template-rows: 50vh 50vh; }
            #side-panel { border-left: none; border-top: 1px solid var(--border-color); }
            .glass-panel { border-left: none; }
            #main-nav { 
                position: fixed; bottom: 0; left: 0; right: 0;
                z-index: 1000;
                height: 60px;
                border-top: 1px solid var(--border-color);
                border-bottom: none;
                flex-direction: row; justify-content: space-around;
            }
            .nav-link { border-right: none; border-bottom: 3px solid transparent; }
            .nav-link.active { border-right: none; border-bottom: 3px solid var(--primary-color); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- v31.4: Persistent Error Bar -->
    <div id="critical-error-bar">
        שגיאת תקשורת קריטית. השרת אינו מגיב כראוי. ודא שהקובץ Code.gs פרוס (Deployed) נכון.
    </div>

    <div class="app-layout">
        <!-- Navbar -->
        <nav id="main-nav" class="w-20 lg:w-24 h-full flex flex-col p-4 glass-nav">
            <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mb-6">
                <span class="text-white text-2xl font-bold">DM</span>
            </div>
            <a href="#" class="nav-link active flex flex-col items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100" onclick="return false;">
                <i data-feather="map"></i>
                <span class="text-xs mt-1">שיבוץ</span>
            </a>
            <a href="log.html" class="nav-link flex flex-col items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-feather="list"></i>
                <span class="text-xs mt-1">לוגים</span>
            </a>
            <div class="flex-grow"></div> <!-- Spacer -->
            
            <div class="hidden lg:block border-t pt-4">
                <div class="text-sm">שלום, <span class="font-semibold">מנהל</span></div>
                <div class="flex items-center space-x-2 space-x-reverse mt-1">
                    <div id="server-status-light" title="סטטוס שרת"></div>
                    <div id="last-updated" class="text-xs text-gray-500">מתחבר...</div>
                </div>
            </div>
        </nav>

        <!-- Main Content (Map + Side Panel) -->
        <main id="main-content">
            <!-- Map -->
            <div id="map-container" class="relative">
                <div id="map"></div>
                <!-- Loader for map -->
                <div id="map-loader" class="absolute inset-0 bg-gray-100 z-10 flex items-center justify-center">
                    <div class="loader-container">
                        <div class="loader"></div>
                    </div>
                </div>
                <!-- New Order Button -->
                <button onclick="openNewOrderForm()" class="absolute top-4 left-4 z-10 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 transition">
                    <i data-feather="plus" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Side Panel -->
            <aside id="side-panel" class="glass-panel">
                <!-- Search & Tabs -->
                <div class="p-4 border-b border-gray-200">
                    <input type="text" id="search-box" onkeyup="filterLists()" placeholder="חפש הזמנה, לקוח או נהג..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <div class="flex mt-4 border-b border-gray-200">
                        <button id="tab-orders" class="tab-button active flex-1 py-2 font-medium" onclick="showPanelTab('orders')">הזמנות (0)</button>
                        <button id="tab-drivers" class="tab-button flex-1 py-2 font-medium" onclick="showPanelTab('drivers')">נהגים (0)</button>
                    </div>
                </div>
                
                <!-- Content Lists -->
                <div id="side-panel-content">
                    <div id="orders-list">
                        <!-- Loader for orders -->
                        <div class="loader-container p-8 text-center"><div class="loader"></div></div>
                        <!-- Order cards will be injected here -->
                    </div>
                    <div id="drivers-list" style="display: none;">
                        <!-- Loader for drivers -->
                        <div class="loader-container p-8 text-center"><div class="loader"></div></div>
                        <!-- Driver cards will be injected here -->
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- New Order Modal -->
    <dialog id="new-order-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">הזמנה חדשה</h2>
                    <button type="button" onclick="closeNewOrderForm()" class="p-1 rounded-full hover:bg-gray-100 text-gray-500">
                        <i data-feather="x"></i>
                    </button>
                </div>
                
                <!-- Customer Search -->
                <label for="customer-search" class="block text-sm font-medium text-gray-700">חפש לקוח</label>
                <input type="text" id="customer-search" list="customer-list" oninput="handleCustomerSearch(this.value)" class="mt-1 w-full px-3 py-2 border rounded-md" required>
                <datalist id="customer-list"></datalist>

                <!-- Existing Customer Display -->
                <div id="existing-customer-display" class="mt-2 p-3 bg-blue-50 rounded-lg" style="display: none;">
                    <div class="font-semibold" id="customer-name-display"></div>
                    <div class="text-sm" id="customer-address-display"></div>
                    <div class="text-sm" id="customer-phone-display"></div>
                </div>

                <!-- New Customer Fields -->
                <div id="new-customer-fields" class="mt-4 space-y-3" style="display: none;">
                    <h3 class="font-medium text-gray-700">פרטי לקוח חדש</h3>
                    <input type="text" id="customer-id-new" placeholder="מספר לקוח (מזהה)" class="w-full px-3 py-2 border rounded-md" required>
                    <input type="text" id="customer-name-new" placeholder="שם לקוח" class="w-full px-3 py-2 border rounded-md" required>
                    <input type="text" id="customer-address-new" placeholder="כתובת ברירת מחדל" class="w-full px-3 py-2 border rounded-md" required>
                    <input type="text" id="customer-phone-new" placeholder="טלפון" class="w-full px-3 py-2 border rounded-md" required>
                    <input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full px-3 py-2 border rounded-md">
                </div>

                <!-- Order Details -->
                <div class="mt-4 space-y-3">
                    <h3 class="font-medium text-gray-700">פרטי הזמנה</h3>
                    <input type="date" id="order-date" class="w-full px-3 py-2 border rounded-md" required>
                    <select id="order-warehouse" class="w-full px-3 py-2 border rounded-md" required>
                        <option value="">בחר מחסן</option>
                        <option value="החרש">החרש</option>
                        <option value="התלמיד">התלמיד</option>
                    </select>
                    <select id="order-type" class="w-full px-3 py-2 border rounded-md" required>
                        <option value="">סוג משלוח</option>
                        <option value="הובלת מנוף">הובלת מנוף</option>
                        <option value="הובלת משאית">הובלת משאית</option>
                    </select>
                    <textarea id="order-notes" rows="2" placeholder="הערות להזמנה..." class="w-full px-3 py-2 border rounded-md"></textarea>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 flex justify-end space-x-3 space-x-reverse rounded-b-lg">
                <button type="button" onclick="closeNewOrderForm()" class="px-4 py-2 bg-white border rounded-md text-sm font-medium hover:bg-gray-50">ביטול</button>
                <button type="submit" id="submit-order-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md text-sm font-medium hover:bg-blue-600">צור הזמנה</button>
            </div>
        </form>
    </dialog>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-20 lg:bottom-4 right-4 z-[5000]"></div>

    <!-- Scripts -->
    <script>
        // --- CONFIG & STATE ---
        // v31.5: CRITICAL - Pointing to the correct deployed Apps Script URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbyGQ9NJhoY--Fl07JOtfIZKS1dS4Ujzeirf-lDcGYY9XM0ItOCgJItMwit5rIiSge_u/exec';
        
        const APP_MODULE = 'AdminDashboard';
        const APP_VERSION = '31.5';
        const REFRESH_INTERVAL = 45000; // 45 שניות

        let map;
        let state = {
            orders: [],
            drivers: [],
            customers: [],
            liveLocations: {}
        };
        let driverMarkers = {};
        let orderMarkers = {};
        let refreshTimer;
        
        // --- v31.5: "SMART LOGGER" v2 (Batching) ---
        let logQueue = [];
        let logFlushTimer = setInterval(flushLogQueue, 10000); // Flush every 10 seconds

        /**
         * v31.4: Upgraded smartLog to use a batch queue.
         * v31.5: Syntax-repaired.
         */
        function smartLog(level, message, context = {}) {
            const timestamp = new Date().toISOString();
            const origin = APP_MODULE;
            console.log(`[${timestamp}] [${level}] ${message}`, context);

            // 2. Push to queue
            logQueue.push({
                timestamp,
                origin,
                level: level.toUpperCase(),
                message,
                context
            });
            
            // 3. If fatal, flush immediately
            if (level.toUpperCase() === 'FATAL') {
                flushLogQueue();
            }
        }
        
        /**
         * v31.4: New function to flush the log queue to the server.
         */
        function flushLogQueue() {
            if (logQueue.length === 0) {
                return;
            }

            const logsToFlush = [...logQueue]; // Copy the queue
            logQueue = []; // Clear the queue immediately

            // Send to server (fire-and-forget)
            // v31.5: Now using the robust apiFetch
            apiFetch('logToServerBatch', {}, 'POST', logsToFlush)
                .catch(err => {
                    console.warn(`[SmartLog] Silent batch log failure: ${err.message}`);
                    // If sending fails, put them back in the queue
                    logQueue = [...logsToFlush, ...logQueue];
                });
        }


        /**
         * v31.2: Global Error Handler
         */
        window.onerror = function(message, source, lineno, colno, error) {
            smartLog('FATAL', `Unhandled JS Error: ${message}`, {
                source: source,
                lineno: lineno,
                colno: colno,
                errorStack: error ? error.stack : 'N/A'
            });
            // Don't suppress the default browser error console
            return false;
        };

        /**
         * v31.2: Global Promise Rejection Handler
         */
        window.onunhandledrejection = function(event) {
            smartLog('FATAL', 'Unhandled promise rejection', {
                reason: event.reason ? event.reason.message : 'Unknown reason',
                stack: event.reason ? event.reason.stack : 'N/A'
            });
        };
        
        // --- ICONS (Leaflet) ---
        const createIcon = (color) => new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });
        const driverIconActive = createIcon('green');
        const driverIconStuck = createIcon('orange');
        const orderIcon = createIcon('blue');

        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            smartLog('INFO', 'DOM content loaded. Initializing v31.5...');
            feather.replace();
            initMap();
            loadInitialData();
            setupEventListeners();
            refreshTimer = setInterval(() => loadInitialData(true), REFRESH_INTERVAL);
        });

        function initMap() {
            try {
                showLoader('map-loader', true);
                map = L.map('map').setView([32.0853, 34.7818], 10); // Tel Aviv
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                smartLog('INFO', 'Map initialized successfully');
            } catch (error) {
                smartLog('FATAL', 'Map initialization failed', { error: error.message, stack: error.stack });
                document.getElementById('map').innerHTML = `<div class="p-8 text-center text-red-600">שגיאה קריטית בטעינת המפה.</div>`;
            }
        }
        
        function setupEventListeners() {
            document.getElementById('submit-order-btn').form.addEventListener('submit', submitNewOrder);
        }

        async function loadInitialData(isRefresh = false) {
            const module = 'loadInitialData';
            const statusLight = document.getElementById('server-status-light');
            
            if (!isRefresh) {
                smartLog('INFO', `v${APP_VERSION}: Loading initial dashboard data...`, { module });
                showLoader('orders-list', true);
                showLoader('drivers-list', true);
            } else {
                smartLog('INFO', `v${APP_VERSION}: Auto-refreshing data...`, { module });
            }
            
            try {
                // v31.4: Health Check is part of the first data load
                const data = await apiFetch('getDashboardData');
                
                // v31.4: Communication OK!
                statusLight.className = 'ok';
                document.getElementById('last-updated').innerText = new Date().toLocaleTimeString('he-IL');
                document.getElementById('critical-error-bar').style.display = 'none';

                state.orders = data.orders || [];
                state.drivers = data.drivers || [];
                state.customers = data.customers || [];
                state.liveLocations = data.liveLocations || {};

                renderDrivers();
                renderOrders();
                renderMapMarkers();
                populateCustomerDatalist();
                
                if (isRefresh) {
                    smartLog('INFO', 'Auto-refresh successful', { module });
                } else {
                    showLoader('map-loader', false);
                    smartLog('INFO', 'Initial data loaded and rendered', { module, count: { orders: state.orders.length, drivers: state.drivers.length } });
                }
                
            } catch (error) {
                // v31.4: Communication ERROR!
                statusLight.className = 'error';
                smartLog('ERROR', 'Failed to load dashboard data', { module, error: error.message, stack: error.stack });
                showToast('טעינת נתונים נכשלה', 'error');
                
                // Show persistent error bar only on critical CORS/Fetch errors
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    document.getElementById('critical-error-bar').style.display = 'block';
                }

                if (!isRefresh) {
                    document.getElementById('orders-list').innerHTML = `<div class="p-4 text-red-600">${error.message}</div>`;
                    document.getElementById('drivers-list').innerHTML = `<div class="p-4 text-red-600">${error.message}</div>`;
                }
            } finally {
                if (!isRefresh) {
                    showLoader('orders-list', false);
                    showLoader('drivers-list', false);
                }
            }
        }
        
        

        // --- COMMUNICATION CHANNEL ("מלשינון") ---
        
        /**
         * v31.5: Robust API wrapper
         * Fixed v31.5 syntax error
         * Now talks to Google Apps Script directly (CORS fixed in Code.gs)
         */
        async function apiFetch(action, params = {}, method = 'GET', data = null) {
            let url = API_URL;
            let options = {
                method: method,
                mode: 'cors', // CRITICAL: This is required for cross-domain requests
                redirect: 'follow',
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (method === 'GET') {
                const queryParams = new URLSearchParams(params);
                queryParams.append('action', action);
                url += '?' + queryParams.toString();
            } else { // POST
                options.body = JSON.stringify({
                    action: action,
                    data: data 
                });
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                let errorText = await response.text();
                try {
                    // v31.6: Fixed syntax error here. Removed extra ')'
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.data) errorText = errorJson.data;
                } catch (e) {
                    // Not JSON, just use the text
                }
                
                // v31.4: Check for CORS failure signature
                if (response.status === 0 || (response.status === 200 && errorText.includes("<!DOCTYPE html>"))) {
                   throw new Error('שגיאת CORS. ודא שהשרת (Code.gs) פרוס כהלכה.');
                }
                throw new Error(`שגיאת שרת (${response.status}): ${errorText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'error') {
                throw new Error(result.data);
            }
            
            return result.data;
        }
        
        // --- RENDER FUNCTIONS ---
        function renderDrivers() {
            const list = document.getElementById('drivers-list');
            list.innerHTML = '';
            document.getElementById('tab-drivers').innerText = `נהגים (${state.drivers.length})`;
            if (state.drivers.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">לא נמצאו נהגים.</div>`;
                return;
            }
            state.drivers
                .sort((a,b) => a.name.localeCompare(b.name))
                .forEach(driver => {
                    const location = state.liveLocations[driver.driverId];
                    list.appendChild(createDriverCard(driver, location));
                });
        }
        
        function createDriverCard(driver, location) {
            const el = document.createElement('div');
            el.className = 'driver-card p-4 cursor-pointer';
            el.id = `driver-card-${driver.driverId}`;
            el.setAttribute('data-search', driver.name.toLowerCase());
            el.onclick = () => focusOnMapItem(driver.driverId, 'driver');
            let statusClass = 'status-inactive';
            let statusText = 'לא פעיל';
            if (driver.status === 'פעיל') {
                statusClass = 'status-active';
                statusText = 'פעיל';
                if (location) {
                    statusText = `פעיל (לפני ${location.minutesAgo} ד')`;
                    if (location.isStuck) {
                        statusClass = 'status-stuck';
                        statusText = `תקוע (לפני ${location.minutesAgo} ד')`;
                    }
                }
            }
            
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium">${driver.name}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full text-white ${statusClass}">${statusText}</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">${driver.phone} | ${driver.vehicleType}</div>
            `;
            return el;
        }
        
        function renderOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = '';
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            document.getElementById('tab-orders').innerText = `הזמנות (${unassignedOrders.length})`;
            if (unassignedOrders.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">אין הזמנות חדשות לשיבוץ.</div>`;
                return;
            }
            unassignedOrders
                .sort((a,b) => new Date(a.orderDate) - new Date(b.orderDate))
                .forEach(order => {
                    list.appendChild(createOrderCard(order));
                });
        }
        
        function createOrderCard(order) {
            const el = document.createElement('div');
            el.className = 'order-card p-4 cursor-pointer';
            el.id = `order-card-${order.orderId}`;
            el.setAttribute('data-search', `${order.orderId} ${order.customerName.toLowerCase()} ${order.address.toLowerCase()}`);
            el.onclick = () => focusOnMapItem(order.orderId, 'order');
            const orderDate = new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium">${order.customerName}</span>
                    <span class="text-sm font-semibold text-blue-600">#${order.orderId}</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">${order.address}</div>
                <div class="text-sm text-gray-500 mt-1">${order.deliveryType} | ${order.warehouse} | ${orderDate}</div>
            `;
            return el;
        }
        
        function renderMapMarkers() {
            if (!map) return;
            const bounds = L.latLngBounds();

            // Render drivers
            Object.values(state.liveLocations).forEach(driver => {
                if (!driver.latitude || !driver.longitude) return;
                const latLng = [driver.latitude, driver.longitude];
                const icon = driver.isStuck ? driverIconStuck : driverIconActive;
                const popupContent = `<h4>${driver.name}</h4><p>${driver.isStuck ? 'תקוע' : 'פעיל'} | עדכון לפני ${driver.minutesAgo} דקות</p>`;
                if (driverMarkers[driver.id]) {
                    driverMarkers[driver.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    driverMarkers[driver.id] = L.marker(latLng, { icon: icon }).addTo(map).bindPopup(popupContent);
                }
                bounds.extend(latLng);
            });
            // Render orders
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude && o.longitude);
            Object.keys(orderMarkers).forEach(orderId => {
                // Remove markers for orders that are no longer unassigned
                if (!unassignedOrders.some(o => o.orderId == orderId)) {
                    map.removeLayer(orderMarkers[orderId]);
                    delete orderMarkers[orderId];
                }
            });
            unassignedOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const popupContent = `
                    <h4>${order.customerName} (#${order.orderId})</h4>
                    <p>${order.address}</p>
                    <button class="w-full mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600" 
                            onclick="showAssignDriverModal('${order.orderId}')">
                        שייך נהג
                    </button>`;
                if (orderMarkers[order.orderId]) {
                    orderMarkers[order.orderId].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.orderId] = L.marker(latLng, { icon: orderIcon }).addTo(map).bindPopup(popupContent);
                }
                bounds.extend(latLng);
            });

            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        
        // --- UI & MAP INTERACTIONS ---
        
        function showPanelTab(tabName) {
            document.getElementById('orders-list').style.display = (tabName === 'orders') ? 'block' : 'none';
            document.getElementById('drivers-list').style.display = (tabName === 'drivers') ? 'block' : 'none';
            document.getElementById('tab-orders').classList.toggle('active', tabName === 'orders');
            document.getElementById('tab-drivers').classList.toggle('active', tabName === 'drivers');
            document.getElementById('tab-orders').classList.toggle('border-transparent', tabName !== 'orders');
            document.getElementById('tab-drivers').classList.toggle('border-transparent', tabName !== 'drivers');
        }
        
        function filterLists() {
            const query = document.getElementById('search-box').value.toLowerCase();
            document.querySelectorAll('.driver-card').forEach(card => {
                card.style.display = card.getAttribute('data-search').includes(query) ? 'block' : 'none';
            });
            document.querySelectorAll('.order-card').forEach(card => {
                card.style.display = card.getAttribute('data-search').includes(query) ? 'block' : 'none';
            });
        }
        
        function focusOnMapItem(id, type) {
            let marker, card, list;
            if (type === 'driver') {
                marker = driverMarkers[id];
                card = document.getElementById(`driver-card-${id}`);
                list = document.getElementById('drivers-list');
                document.querySelectorAll('.driver-card').forEach(c => c.classList.remove('active'));
            } else {
                marker = orderMarkers[id];
                card = document.getElementById(`order-card-${id}`);
                list = document.getElementById('orders-list');
                document.querySelectorAll('.order-card').forEach(c => c.classList.remove('active'));
            }
            if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
            }
            if (card) {
                card.classList.add('active');
                list.scrollTop = card.offsetTop - list.offsetTop;
            }
        }

        function showAssignDriverModal(orderId) {
            const module = 'showAssignDriverModal';
            const availableDrivers = state.drivers.filter(d => d.status === 'פעיל');
            if (availableDrivers.length === 0) {
                showToast('אין נהגים זמינים כרגע', 'error');
                smartLog('WARN', 'Assign driver modal opened, but no drivers available', { module, orderId });
                return;
            }
            let driverOptions = availableDrivers.map(d => `${d.driverId}: ${d.name}`).join('\n');
            let driverId = prompt(`שייך הזמנה #${orderId} לנהג:\n(הזן מספר נהג)\n\n${driverOptions}`);
            if (driverId) {
                const driverExists = availableDrivers.some(d => d.driverId == driverId.trim());
                if (driverExists) {
                    assignOrderToDriver(orderId, driverId.trim());
                } else {
                    showToast('מספר נהג לא תקין', 'error');
                    smartLog('WARN', 'Invalid driver ID entered for assignment', { module, enteredId: driverId });
                }
            }
        }
        
        async function assignOrderToDriver(orderId, driverId) {
            const module = 'assignOrderToDriver';
            const btn = document.querySelector(`.leaflet-popup-content button[onclick="showAssignDriverModal('${orderId}')"]`);
            if (btn) btn.innerText = 'משייך...';
            
            try {
                await apiFetch('assignDriver', {}, 'POST', { orderId: orderId, driverId: driverId });
                showToast(`הזמנה #${orderId} שויכה לנהג ${driverId}`, 'success');
                smartLog('INFO', `Order ${orderId} assigned to ${driverId}`, { module, orderId, driverId });
                map.closePopup();
                loadInitialData(true); // Refresh
            } catch (error) {
                showToast(`שגיאה בשיוך הזמנה: ${error.message}`, 'error');
                smartLog('ERROR', 'Failed to assign order', { module, orderId, driverId, error: error.message });
                if (btn) btn.innerText = 'שייך נהג';
            }
        }

        
        // --- NEW ORDER FORM (v31.0) ---
        
        function populateCustomerDatalist() {
            const datalist = document.getElementById('customer-list');
            datalist.innerHTML = '';
            state.customers.forEach(cust => {
                const option = document.createElement('option');
                option.value = cust.name;
                option.dataset.customerId = cust.customerId;
                datalist.appendChild(option);
            });
        }
        
        function openNewOrderForm() {
            smartLog('INFO', 'New order form opened', { module: 'openNewOrderForm' });
            document.getElementById('new-order-modal').showModal();
            document.getElementById('order-date').valueAsDate = new Date(); // Set default date
        }

        function closeNewOrderForm() {
            document.getElementById('new-order-modal').close();
            document.getElementById('submit-order-btn').form.reset();
            document.getElementById('new-customer-fields').style.display = 'none';
            document.getElementById('existing-customer-display').style.display = 'none';
        }
        
        function handleCustomerSearch(value) {
            const options = document.querySelectorAll('#customer-list option');
            let found = false;
            for (let option of options) {
                if (option.value === value) {
                    const customerId = option.dataset.customerId;
                    const customer = state.customers.find(c => c.customerId == customerId);
                    if (customer) {
                        document.getElementById('existing-customer-display').style.display = 'block';
                        document.getElementById('new-customer-fields').style.display = 'none';
                        document.getElementById('customer-name-display').innerText = customer.name;
                        document.getElementById('customer-address-display').innerText = customer.defaultAddress;
                        document.getElementById('customer-phone-display').innerText = customer.phone;
                    }
                    found = true;
                    break;
                }
            }
            if (!found) {
                document.getElementById('existing-customer-display').style.display = 'none';
                if (value.length > 2) {
                    document.getElementById('new-customer-fields').style.display = 'block';
                    document.getElementById('customer-name-new').value = value;
                } else {
                    document.getElementById('new-customer-fields').style.display = 'none';
                }
            }
        }
        
        async function submitNewOrder(event) {
            event.preventDefault();
            const module = 'submitNewOrder';
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerText = 'יוצר הזמנה...';
            
            try {
                let customerData = {};
                let orderData = {};
                
                // Check if new or existing customer
                if (document.getElementById('new-customer-fields').style.display === 'block') {
                    customerData = {
                        isNew: true,
                        customerId: document.getElementById('customer-id-new').value,
                        name: document.getElementById('customer-name-new').value,
                        address: document.getElementById('customer-address-new').value,
                        phone: document.getElementById('customer-phone-new').value,
                        contactPerson: document.getElementById('customer-contact-new').value
                    };
                } else if (document.getElementById('existing-customer-display').style.display === 'block') {
                    const customerName = document.getElementById('customer-name-display').innerText;
                    const customer = state.customers.find(c => c.name === customerName);
                    customerData = {
                        isNew: false,
                        id: customer.customerId,
                        name: customer.name,
                        phone: customer.phone,
                        address: customer.defaultAddress
                    };
                } else {
                    throw new Error('יש לבחור לקוח קיים או ליצור לקוח חדש');
                }
                
                orderData = {
                    orderDate: document.getElementById('order-date').value,
                    deliveryType: document.getElementById('order-type').value,
                    warehouse: document.getElementById('order-warehouse').value,
                    notes: document.getElementById('order-notes').value,
                    latitude: '', longitude: '' // TODO: Add geocoding
                };
            
                smartLog('INFO', 'Submitting new order...', { module, customer: customerData.name });
                const newOrder = await apiFetch('createNewOrder', {}, 'POST', { orderData, customerData });
                showToast(`הזמנה #${newOrder.orderId} נוצרה בהצלחה`, 'success');
                smartLog('INFO', `New order created successfully: ${newOrder.orderId}`, { module, orderId: newOrder.orderId });
                
                closeNewOrderForm();
                loadInitialData(true); // Refresh
                
            } catch (error) {
                showToast(`שגיאה ביצירת הזמנה: ${error.message}`, 'error');
                smartLog('ERROR', 'Failed to create new order', { module, error: error.message, stack: error.stack });
            } finally {
                btn.disabled = false;
                btn.innerText = 'צור הזמנה';
            }
        }

        
        // --- HELPERS ---
        
        function showLoader(elementId, show) {
            const container = document.getElementById(elementId);
            if (!container) return;
            let loader = container.querySelector('.loader-container');
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'loader-container p-8 text-center';
                    loader.innerHTML = `<div class="loader"></div>`;
                    if (elementId !== 'map-loader') {
                         container.prepend(loader);
                    } else {
                        container.style.display = 'flex';
                    }
                }
            } else {
                if (loader) {
                    if (elementId === 'map-loader') {
                        container.style.display = 'none';
                    } else {
                        container.removeChild(loader);
                    }
                }
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Final log to confirm script parse
        smartLog('INFO', `Admin App v${APP_VERSION} scripts parsed and running.`);

    </script>
</body>
</html>

