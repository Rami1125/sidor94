<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v41.0 - קוקפיט אולטימטיבי</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet-geometryutil"></script> 
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        /* Base & Theme (Light v40) - Further Refinements */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; font-family: 'Inter', system-ui, sans-serif; direction: rtl; }
        body { margin: 0; line-height: inherit; background-color: #f3f4f6; color: #1f2937; overflow: hidden; }
        .light-card { background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }

        /* Layout & Spacing */
        .p-4 { padding: 1rem; } .p-3 { padding: 0.75rem; } .p-6 { padding: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .flex { display: flex; } .grid { display: grid; } .hidden { display: none; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .justify-between { justify-content: space-between; } .items-center { align-items: center; }
        .text-2xl { font-size: 1.5rem; } .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; }
        .text-gray-600 { color: #4b5563; } .text-gray-800 { color: #1f2937; } .text-gray-500 { color: #6b7280; }
        .text-green-500 { color: #22c55e; } .text-yellow-500 { color: #eab308; } .text-red-500 { color: #ef4444; }
        .text-sky-500 { color: #0ea5e9; } .text-amber-500 { color: #f59e0b; }
        .text-center { text-align: center; } .text-right { text-align: right; }
        .w-full { width: 100%; } .h-screen { height: 100vh; } .h-full { height: 100%; }
        .overflow-hidden { overflow: hidden; } .overflow-y-auto { overflow-y: auto; }
        .border-b { border-bottom-width: 1px; } .border { border-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; } .border-gray-300 { border-color: #d1d5db; }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 1px; }
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #e5e7eb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .rounded-lg { border-radius: 0.5rem; } .rounded-xl { border-radius: 0.75rem; }
        .sticky { position: sticky; } .top-0 { top: 0; } .z-10 { z-index: 10; } .z-50 { z-index: 50; }
        .bg-gray-50 { background-color: #f9fafb; }

        /* Layout */
        .main-layout { display: grid; grid-template-columns: 240px 1fr; height: 100vh; padding: 1rem; gap: 1rem; background-color: #f3f4f6; }
        main { display: flex; flex-direction: column; height: calc(100vh - 2rem); overflow: hidden; }
        .main-content-area { flex-grow: 1; overflow: hidden; position: relative; /* Needed for absolute positioning of hidden views */ }
        .view-content { height: 100%; overflow-y: auto; padding: 1rem; /* Add padding for scrollable content */ }
        .view-content-table { padding: 0; /* Remove padding for table views */ }

        /* Sidebar */
        .sidebar { background-color: #fff; }
        .sidebar-nav a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #4b5563; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
        .sidebar-nav a:hover { background-color: #e0f2fe; color: #0369a1; }
        .sidebar-nav a.active { background-color: #0ea5e9; color: white; }
        .sidebar-nav a svg { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
        .sidebar-nav span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Map */
        #leaflet-map-container { height: 100%; width: 100%; border-radius: 0.75rem; overflow: hidden; }
        #leaflet-map { height: 100%; width: 100%; z-index: 10; }
        .leaflet-container { background: #e5e7eb; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #fff; color: #1f2937; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.8rem; }
        .leaflet-popup-content { margin: 10px 15px; max-width: 250px; /* Limit popup width */ }
        .leaflet-popup-close-button { color: #374151 !important; }
        .map-popup-button { margin-top: 6px; padding: 3px 6px; font-size: 11px; background-color: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .leaflet-marker-draggable.leaflet-drag-target { cursor: grabbing !important; }
        .leaflet-div-icon { background: none !important; border: none !important; font-size: 2rem; /* v41: Larger icons */ }

        /* Buttons v41 - Final Polish */
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s ease-out; border: 1px solid transparent; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; white-space: nowrap; }
        .btn:hover { filter: brightness(1.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06); } /* Add subtle hover shadow */
        .btn:active { transform: scale(0.98); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); filter: brightness(1); }
        .btn-primary { background-color: #0ea5e9; color: white; border-color: #0ea5e9; } .btn-primary:hover { background-color: #0284c7; border-color: #0284c7; }
        .btn-secondary { background-color: #fff; color: #374151; border-color: #d1d5db; } .btn-secondary:hover { background-color: #f9fafb; border-color: #adb5bd;}
        .btn-success { background-color: #22c55e; color: white; border-color: #22c55e; } .btn-success:hover { background-color: #16a34a; border-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; } .btn-warning:hover { background-color: #d97706; border-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; } .btn-danger:hover { background-color: #dc2626; border-color: #dc2626; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 0.5rem; }

        /* Status & Logs */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-חדש { background-color: #e0f2fe; color: #0ea5e9; } .status-שויך { background-color: #fef3c7; color: #d97706; } .status-הושלם { background-color: #dcfce7; color: #16a34a; } .status-default { background-color: #e5e7eb; color: #4b5563; }
        .level-INFO { color: #0ea5e9; } .level-WARN { color: #f59e0b; } .level-ERROR { color: #ef4444; font-weight: 700; }
        
        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { width: 90%; max-width: 500px; background-color: #fff; border-radius: 0.75rem; }
        .modal-header { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .modal-footer { margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding-top: 1rem; }
        
        /* Form & Filter Inputs v41 */
        .form-input { width: 100%; background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { border-color: #0ea5e9; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .filter-input-wrapper { position: relative; margin-bottom: 1rem; flex-shrink: 0; /* Prevent shrinking */ }
        .filter-input { padding-left: 2.5rem; /* Space for icon */ }
        .filter-input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }

        /* Table */
        table { border-collapse: collapse; } thead { background-color: #f9fafb; } th { color: #4b5563; padding: 0.75rem; font-weight: 600; text-align: right; } tbody { background-color: #fff; } td { padding: 0.75rem; text-align: right; }
        
        /* Select Driver Modal List */
        #driver-select-list button { display: block; width: 100%; text-align: right; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; border-radius: 0.5rem; }
        #driver-select-list button:hover { background-color: #f3f4f6; }
        
        /* v41: Notification Ticker */
        #notification-ticker { height: 40px; overflow: hidden; background-color: #fff; border-bottom: 1px solid #e5e7eb; position: relative; flex-shrink: 0; cursor: default; }
        #notification-ticker ul { list-style: none; padding: 0; margin: 0; position: absolute; width: 100%; animation: ticker-scroll-v41 40s linear infinite; }
        #notification-ticker li { height: 40px; padding: 0 1rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; color: #4b5563; border-bottom: 1px dashed #e5e7eb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #notification-ticker li:last-child { border-bottom: none; }
        #notification-ticker .time { font-size: 0.7rem; color: #9ca3af; margin-left: 1rem; flex-shrink: 0; }
        #notification-ticker .level-WARN { color: #d97706; } #notification-ticker .level-ERROR { color: #dc2626; font-weight: bold; }
        @keyframes ticker-scroll-v41 { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        #notification-ticker:hover ul { animation-play-state: paused; }

        /* v41: View Transitions */
        .app-view { transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out; will-change: transform, opacity; }
        .app-view.hidden { opacity: 0; transform: translateY(15px); pointer-events: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #view-map.app-view.hidden { opacity: 0; pointer-events: none; position: absolute; width: 100%; height: 100%; }
        #view-map.app-view { position: relative; width: 100%; height: 100%; opacity: 1; transform: translateY(0); }
        /* Ensure non-map views take full height when active */
         .app-view:not(.hidden):not(#view-map) { position: relative; width: 100%; height: 100%; opacity: 1; transform: translateY(0); }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { /* ... same ... */ apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949", storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB" };

        // --- Globals ---
        let db;
        let currentEditDoc = null; 
        let mapInstance = null;
        let allDrivers = {}; 
        let driverMarkers = {}; 
        let orderMarkers = {}; 
        let currentlyDraggedOrder = null;
        let assignmentLines = {}; 
        let notificationQueue = []; 
        const MAX_NOTIFICATIONS = 15; // Increased slightly

        // --- Warehouse Coordinates ---
        const WAREHOUSES = { /* ... same ... */ hatalmid: { name: "התלמיד 6", lat: 32.1860, lng: 34.9080 }, haharash: { name: "החרש 10", lat: 32.1840, lng: 34.9095 } };
        
        // --- Icons v41 ---
        // הדבק כאן לינקים לאייקונים שלך אם תרצה (השאר null כדי להשתמש ב-SVG/Emoji)
        const driverIconUrl = null; // למשל: 'https://img.icons8.com/ios-filled/50/f59e0b/truck.png'
        const orderIconUrl = null; // למשל: 'https://img.icons8.com/ios-filled/50/0ea5e9/map-pin.png'
        
        // Use SVG for better control and scaling
        const driverSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f59e0b" width="32px" height="32px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`;
        const orderSvg = `<svg xmlns="https://img.icons8.com/?size=100&id=9uHKZ60VvWW2&format=png&color=000000`;

        const driverIcon = driverIconUrl ? L.icon({ iconUrl: driverIconUrl, iconSize: [38, 38], iconAnchor: [19, 38] }) : L.divIcon({ html: driverSvg, className: 'leaflet-div-icon', iconSize: [32, 32], iconAnchor: [16, 16] }); 
        const orderIcon = orderIconUrl ? L.icon({ iconUrl: orderIconUrl, iconSize: [32, 42], iconAnchor: [16, 42] }) : L.divIcon({ html: orderSvg, className: 'leaflet-div-icon', iconSize: [32, 32], iconAnchor: [16, 32] }); 

        // --- Init App ---
        document.addEventListener('DOMContentLoaded', async () => { /* ... same init logic ... */ try{const a=initializeApp(firebaseConfig);const o=getAuth(a);db=getFirestore(a);setStatus('מתחבר...','text-yellow-500');await signInAnonymously(o);setStatus('מחובר (מאזין...)','text-green-500');initNavigation();initMap();listenToDrivers();listenToDriverLocations();listenToOrders();listenToCustomers();listenToSystemLogs();initFilters()}catch(e){console.error("Init Error",e);setStatus(`שגיאת התחברות: ${e.message}`,'text-red-500')} });
        
        // --- Navigation & View Transitions ---
        function initNavigation() { /* ... same event listeners ... */ const l=document.querySelectorAll('.sidebar-nav a');l.forEach(k=>{k.addEventListener('click',(e)=>{e.preventDefault();const v=e.currentTarget.getAttribute('href').substring(1);showView(v);l.forEach(j=>j.classList.remove('active'));e.currentTarget.classList.add('active');});});showView('view-map');document.querySelector('.sidebar-nav a[href="#view-map"]').classList.add('active'); }
        
        // v41: Improved view switching with transitions
        window.currentViewId = 'view-map'; // Track current view
        window.showView = (viewId) => { 
            if (viewId === window.currentViewId) return; // Don't switch if already active

            const currentView = document.getElementById(window.currentViewId);
            const targetView = document.getElementById(viewId); 

            if (currentView) currentView.classList.add('hidden'); // Start hiding current
            
            if (targetView) {
                // Ensure target is ready for transition
                targetView.style.position = 'absolute'; // Keep it positioned while hidden
                targetView.classList.remove('hidden'); // Make it visible but transparent/translated
                
                // Force reflow to apply initial hidden styles before transition
                targetView.offsetHeight; 

                // Start transition
                targetView.style.position = 'relative'; // Put back in flow
                targetView.style.opacity = '1';
                targetView.style.transform = 'translateY(0)';
            }
             window.currentViewId = viewId; // Update tracked view

            // Handle map invalidate after transition
            if (viewId === 'view-map' && mapInstance) { 
                setTimeout(() => mapInstance.invalidateSize({ animate: true }), 300); // Animate resize
            }
        }

        // --- Real-time Listeners (READ) ---
        // (Listeners remain the same, triggering renders/notifications)
        function listenToDrivers(){/*...*/} function listenToDriverLocations(){/*...*/} function listenToOrders(){/*...*/} function listenToCustomers(){/*...*/} function listenToSystemLogs(){/*...*/}

        // --- Render Functions (v41 Filters) ---
        function initFilters() { /* ... same ... */ document.getElementById('filter-orders')?.addEventListener('input',renderOrdersTable);document.getElementById('filter-drivers')?.addEventListener('input',renderDriversTable);document.getElementById('filter-customers')?.addEventListener('input',renderCustomersTable); }
        function renderOrdersTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('orders-table-body'); const filterInput = document.getElementById('filter-orders'); const f= filterInput ? filterInput.value.toLowerCase() : ''; const o=(window.allOrdersData||[]).filter(d=>{if(!f)return!0;const c=d.customer?.name||'';const v=d.driver?.name||'';const s=d.status||'';const a=d.address||'';return d.id.toLowerCase().includes(f)||c.toLowerCase().includes(f)||v.toLowerCase().includes(f)||s.toLowerCase().includes(f)||a.toLowerCase().includes(f)});if(!t)return;if(!o||o.length===0){t.innerHTML=`<tr><td colspan="6" class="p-8 text-center text-gray-500">לא נמצאו הזמנות תואמות.</td></tr>`;return;}t.innerHTML=o.map(d=>{const c=d.customer?.name||'לא ידוע';const v=d.driver?.name||'טרם שויך';const s=d.status||'חדש';const k=`status-${s.replace(' ','_')}`||'status-default';let h='';if(s==='חדש')h=`<button class="btn btn-warning btn-sm" onclick="openSelectDriverModal('${d.id}')">שבץ מרשימה</button>`;else if(s==='שויך')h=`<button class="btn btn-success btn-sm" onclick="handleMarkAsCompleted('${d.id}')">הושלם</button>`;return`<tr class="hover:bg-gray-100 text-sm"><td class="p-3">${d.id}</td><td class="p-3 text-gray-800 font-semibold">${c}</td><td class="p-3">${d.address}</td><td class="p-3 text-gray-800 font-semibold">${v}</td><td class="p-3"><span class="status-badge ${k}">${s}</span></td><td class="p-3 flex gap-2">${h}<button class="btn btn-secondary btn-sm" onclick="openEditOrderModal(JSON.stringify(window.allOrders['${d.id}']))">ערוך</button><button class="btn btn-danger btn-sm" onclick="handleDelete('orders','${d.id}')">מחק</button></td></tr>`}).join('');window.allOrders=o.reduce((a,c)=>{a[c.id]=c;return a},{})}
        function renderDriversTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('drivers-table-body'); const filterInput = document.getElementById('filter-drivers'); const f = filterInput ? filterInput.value.toLowerCase() : ''; const d=Object.values(allDrivers||{}).filter(v=>{if(!f)return!0;const n=v.name||'';const p=v.phone||'';const s=v.status||'';const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||s.toLowerCase().includes(f)||i.toLowerCase().includes(f)});if(!t)return;t.innerHTML=d.map(v=>{const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'N/A';return`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${v.name||i}</td><td class="p-3">${v.phone||'---'}</td><td class="p-3">${v.vehicleType||'לא ידוע'}</td><td class="p-3">${v.status||'לא פעיל'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('drivers','${i}')">מחק</button></td></tr>`}).join('')}
        function renderCustomersTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('customers-table-body'); const filterInput = document.getElementById('filter-customers'); const f = filterInput ? filterInput.value.toLowerCase() : ''; const c=(window.allCustomersData||[]).filter(u=>{if(!f)return!0;const n=u.name||'';const p=u.phone||'';const a=u.defaultAddress||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||a.toLowerCase().includes(f)});if(!t)return;t.innerHTML=c.map(u=>`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${u.name||u.id}</td><td class="p-3">${u.phone||'---'}</td><td class="p-3">${u.defaultAddress||'---'}</td><td class="p-3">${u.contactPerson||'---'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('customers','${u.id}')">מחק</button></td></tr>`).join('')}
        function renderLogsTable() { /* ... same rendering ... */ const t=document.getElementById('logs-table-body');if(!t)return;const l=window.allLogsData||[];t.innerHTML=l.map(g=>{const v=g.level||'INFO';const i=g.timestamp?.toDate().toLocaleString('he-IL')||'---';return`<tr class="hover:bg-gray-100 text-sm font-mono"><td class="p-3 text-gray-500">${i}</td><td class="p-3 font-bold level-${v}">${v}</td><td class="p-3 text-cyan-500">[${g.origin||'N/A'}]</td><td class="p-3 text-gray-800">${g.message||'---'}</td><td class="p-3 text-xs text-gray-500">${g.data||''}</td></tr>`}).join('')}
        function setStatus(message, cssClass) { /* ... same ... */ const el=document.getElementById('connection-status'); if(el) { el.textContent=message; el.className=`text-sm ${cssClass} p-2 text-center`; } } // Added padding/text-center

        // --- Map Functions ---
        window.initMap = () => { /* ... same init with zoom 9 ... */ const e=document.getElementById('leaflet-map');if(!e){console.error("Map container #leaflet-map not found!");return}try{if(typeof L==='undefined'){console.error("Leaflet (L) not defined.");setStatus('שגיאה בטעינת מפת','text-red-500');return}if(!mapInstance){mapInstance=L.map(e,{zoomControl:true}).setView([31.7683,35.2137],9);L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:19}).addTo(mapInstance);mapInstance.on('load',()=>{console.log("Map initialized.");setStatus('מחובר | מפה טעונה','text-green-500')});mapInstance.on('tileerror',(e)=>{console.error('Tile error:',e);setStatus('שגיאת אריחי מפה','text-red-500')})}else{mapInstance.invalidateSize()}}catch(e){console.error("Map init failed:",e);e.innerHTML=`<div class="p-4 text-center text-red-500">Map Error: ${e.message}</div>`;setStatus('שגיאה קריטית במפה','text-red-500')} }
        
        function updateDriverMarker(driverId, locationData) { /* ... same logic ... */ if(!mapInstance||!locationData.latitude||!locationData.longitude)return;const l=[locationData.latitude,locationData.longitude];const n=allDrivers[driverId]?.name||driverId;const p=`<b>נהג: ${n}</b><br>עודכן: ${locationData.lastUpdate?.toDate().toLocaleTimeString('he-IL')||'N/A'}`;if(driverMarkers[driverId])driverMarkers[driverId].setLatLng(l).setPopupContent(p);else{driverMarkers[driverId]=L.marker(l,{icon:driverIcon,draggable:!1}).addTo(mapInstance).bindPopup(p);driverMarkers[driverId]._driverInfo={id:driverId,name:n}}}
        
        function updateOrderMarkers(orders) { /* ... same logic including distance ... */ if(!mapInstance)return;const c=orders.map(o=>o.id);Object.keys(orderMarkers).forEach(m=>{if(!c.includes(m)){mapInstance.removeLayer(orderMarkers[m]);delete orderMarkers[m]}});let w=0;orders.forEach(o=>{if(!o.latitude||!o.longitude){if(o.status!=='הושלם')w++;if(orderMarkers[o.id]){mapInstance.removeLayer(orderMarkers[o.id]);delete orderMarkers[o.id]}return}if(o.status!=='הושלם'){const l=[o.latitude,o.longitude];const t=L.GeometryUtil.distance(mapInstance,l,[WAREHOUSES.hatalmid.lat,WAREHOUSES.hatalmid.lng]);const h=L.GeometryUtil.distance(mapInstance,l,[WAREHOUSES.haharash.lat,WAREHOUSES.haharash.lng]);const k=(t/1e3).toFixed(1);const r=(h/1e3).toFixed(1);const p=`<b>${o.customer?.name||'לקוח'}</b> (${o.id})<br>${o.address}<br>סטטוס: ${o.status}<hr class="my-1 border-gray-200">מרחק מהתלמיד: ${k} ק"מ<br>מרחק מהחרש: ${r} ק"מ`+(o.status==='חדש'?`<br><button class="map-popup-button" onclick="openSelectDriverModal('${o.id}')">שבץ מרשימה</button>`:'');const i=o.id;const d=o.status==='חדש';if(orderMarkers[i]){orderMarkers[i].setLatLng(l).setPopupContent(p);if(d&&!orderMarkers[i].dragging.enabled())orderMarkers[i].dragging.enable();else if(!d&&orderMarkers[i].dragging.enabled())orderMarkers[i].dragging.disable()}else{orderMarkers[i]=L.marker(l,{icon:orderIcon,draggable:d}).addTo(mapInstance).bindPopup(p,{minWidth:200});orderMarkers[i]._orderData=o;orderMarkers[i].on('dragstart',()=>{currentlyDraggedOrder=o});orderMarkers[i].on('dragend',handleOrderDrop)}}else if(orderMarkers[o.id]){mapInstance.removeLayer(orderMarkers[o.id]);delete orderMarkers[o.id]}});if(w>0){console.warn(`${w} active orders missing coords.`);addNotification(`${w} הזמנות ללא מיקום במפה`,'WARN')}}
        
        // --- Drag & Drop ---
        function handleOrderDrop(event) { /* ... same ... */ if (!currentlyDraggedOrder) return; const m = event.target; const l = m.getLatLng(); const THRESHOLD = 50; let closest = null; let minDist = Infinity; Object.keys(driverMarkers).forEach(dId => { const dM = driverMarkers[dId]; const dist = l.distanceTo(dM.getLatLng()); if (dist < minDist) { minDist = dist; closest = { id: dId, name: allDrivers[dId]?.name || dId, marker: dM }; } }); if (closest && minDist <= THRESHOLD) { openConfirmAssignModal(currentlyDraggedOrder.id, closest.id, currentlyDraggedOrder.customer?.name || '?', closest.name); } else { m.setLatLng([currentlyDraggedOrder.latitude, currentlyDraggedOrder.longitude]); alert("לא נמצא נהג קרוב מספיק."); } currentlyDraggedOrder = null; }
        
        // --- CRUD ---
        window.openAddOrderModal = () => { /* ... */ currentEditDoc = null; document.getElementById('addOrderModalTitle').textContent = "יצירת הזמנה חדשה"; document.getElementById('addOrderForm').reset(); document.getElementById('addOrderModal').style.display = 'flex'; }
        window.openEditOrderModal = (orderJson) => { /* ... */ const order = JSON.parse(orderJson); currentEditDoc = order; const form = document.getElementById('addOrderForm'); form.customerName.value = order.customer?.name || ''; form.customerPhone.value = order.customer?.phone || ''; form.address.value = order.address || ''; form.latitude.value = order.latitude || ''; form.longitude.value = order.longitude || ''; form.deliveryType.value = order.deliveryType || ''; form.customerId.value = order.customer?.id || ''; document.getElementById('addOrderModalTitle').textContent = `עריכת הזמנה ${order.id}`; document.getElementById('addOrderModal').style.display = 'flex'; }
        window.openAssignDriverModal = (orderId) => { /* ... */ currentEditDoc = { id: orderId }; document.getElementById('assignDriverModal').style.display = 'flex'; }
        window.openConfirmAssignModal = (orderId, driverId, customerName, driverName) => { /* ... */ document.getElementById('confirmAssignText').innerHTML = `האם לשייך את ההזמנה של <b>${customerName}</b> לנהג <b>${driverName}</b>?`; const confirmBtn = document.getElementById('confirmAssignBtn'); confirmBtn.onclick = () => handleConfirmAssign(orderId, driverId, driverName); document.getElementById('confirmAssignModal').style.display = 'flex'; }
        window.openSelectDriverModal = (orderId) => { /* ... */ currentEditDoc = { id: orderId }; const list = document.getElementById('driver-select-list'); list.innerHTML = ''; Object.values(driverMarkers).forEach(m => { const info = m._driverInfo; if(info) { const b = document.createElement('button'); b.textContent = info.name; b.onclick = () => { const oData = orderMarkers[orderId]?._orderData; closeModal('selectDriverModal'); openConfirmAssignModal(orderId, info.id, oData?.customer?.name || '?', info.name); }; list.appendChild(b); } }); if(list.innerHTML === '') list.innerHTML = '<p class="p-4 text-center text-gray-500">אין נהגים פעילים במפה.</p>'; document.getElementById('selectDriverModal').style.display = 'flex'; }
        window.closeModal = (modalId) => { /* ... */ const el = document.getElementById(modalId); if(el) el.style.display = 'none'; }
        
        window.handleSaveOrder = async () => { /* ... same logic ... */ };
        
        window.handleAssignDriver = async (orderId, driverId, driverName) => { /* ... same logic + notification ... */ const ref = doc(db, "orders", orderId); try { if (!driverName) { driverName = document.getElementById('driverNameInput').value; driverId = Object.keys(allDrivers).find(id => allDrivers[id].name === driverName) || driverName; } const dData = { id: driverId, name: driverName }; await updateDoc(ref, { driver: dData, status: "שויך" }); drawAssignmentLine(orderId, driverId); closeModal('assignDriverModal'); closeModal('confirmAssignModal'); closeModal('selectDriverModal'); const input = document.getElementById('driverNameInput'); if(input) input.value = ''; currentEditDoc = null; addNotification(`הזמנה ${orderId.slice(-4)} שויכה לנהג ${driverName}`, 'INFO'); } catch (e) { console.error("Assign Error:", e); alert("שגיאה בשיבוץ: " + e.message); } }
        
        window.handleConfirmAssign = (orderId, driverId, driverName) => { handleAssignDriver(orderId, driverId, driverName); }
        window.handleMarkAsCompleted = async (orderId) => { /* ... same logic + notification ... */ if (!confirm(`...`)) return; const ref = doc(db, "orders", orderId); try { await updateDoc(ref, { status: "הושלם" }); removeAssignmentLine(orderId); addNotification(`הזמנה ${orderId.slice(-4)} הושלמה`, 'INFO'); } catch (e) { console.error("Complete Error:", e); alert("שגיאה בסיום: " + e.message); } }
        window.handleDelete = async (collectionName, docId) => { /* ... same logic + notification ... */ if (!confirm(`...`)) return; const ref = doc(db, collectionName, docId); try { await deleteDoc(ref); if(collectionName === 'orders') removeAssignmentLine(docId); addNotification(`פריט ${docId.slice(-4)} נמחק מ-${collectionName}`, 'WARN'); } catch (e) { console.error("Delete Error:", e); alert("שגיאה במחיקה: " + e.message); } }
        
        // --- Assignment Line ---
        function drawAssignmentLine(orderId, driverId) { /* ... same ... */ if (!mapInstance || !orderMarkers[orderId] || !driverMarkers[driverId]) return; removeAssignmentLine(orderId); const oLatLng = orderMarkers[orderId].getLatLng(); const dLatLng = driverMarkers[driverId].getLatLng(); const line = L.polyline([oLatLng, dLatLng], { color: '#f59e0b', weight: 3, opacity: 0.7 }); const decorator = L.polylineDecorator(line, { patterns: [{ offset: '0%', repeat: 10, symbol: L.Symbol.dash({ pixelSize: 5, pathOptions: { color: '#f59e0b', weight: 3, opacity: 0.7 } }) }] }).addTo(mapInstance); assignmentLines[orderId] = { line, decorator }; setTimeout(() => removeAssignmentLine(orderId), 5000); }
        function removeAssignmentLine(orderId) { /* ... same ... */ if (assignmentLines[orderId]) { if (assignmentLines[orderId].line) mapInstance?.removeLayer(assignmentLines[orderId].line); if (assignmentLines[orderId].decorator) mapInstance?.removeLayer(assignmentLines[orderId].decorator); delete assignmentLines[orderId]; } }

         // --- Notification Ticker ---
         function addNotification(message, level = 'INFO') { /* ... same queue logic ... */ const timestamp = new Date(); notificationQueue.unshift({ message, level, timestamp }); if (notificationQueue.length > MAX_NOTIFICATIONS) notificationQueue.pop(); renderNotifications(); }
         function renderNotifications() { /* ... same rendering + animation restart ... */ 
             const tickerList = document.getElementById('notification-ticker-list'); if (!tickerList) return;
             tickerList.innerHTML = notificationQueue.map(n => `<li class="level-${n.level}"><span>${n.message}</span><span class="time">${n.timestamp.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</span></li>`).join('');
             const ticker = document.getElementById('notification-ticker'); if (ticker) { const ul = ticker.querySelector('ul'); if (ul) { ul.style.animation = 'none'; ul.offsetHeight; if (ul.scrollHeight > ticker.offsetHeight) { const duration = (ul.scrollHeight / 40) * 5; /* Approx 5s per item */ ul.style.animation = `ticker-scroll-v41 ${duration}s linear infinite`; } else { ul.style.animation = ''; ul.style.transform = 'translateY(0)'; } } }
         }
         document.addEventListener('DOMContentLoaded', renderNotifications); // Initial render

        // --- Attach handlers ---
        window.handleMarkAsCompleted = handleMarkAsCompleted;
        window.handleDelete = handleDelete; 

    </script>
</head>
<body class="h-screen overflow-hidden bg-gray-100">

    <div class="main-layout">
        
        <!-- Sidebar -->
        <aside class="light-card sidebar p-4 flex flex-col justify-between">
             <!-- Sidebar content (nav links - SVG icons added for visual clarity) -->
             <div> 
                 <h1 class="text-2xl font-bold text-gray-800 p-2 mb-6">ח. סבן (v41)</h1> 
                 <nav class="sidebar-nav space-y-2"> 
                    <a href="#view-map"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m0 0v2.25m0-2.25h1.5M9 15H7.5m1.5-6.75V4.5m0 2.25H7.5M15 12m-3 0a3 3 0 116 0 3 3 0 01-6 0z" /></svg> <span>חדר מצב (מפה)</span> </a>
                    <a href="#view-orders"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg> <span>ניהול הזמנות</span> </a>
                    <a href="#view-drivers"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg> <span>ניהול נהגים</span> </a>
                    <a href="#view-customers"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg> <span>ניהול לקוחות</span> </a>
                    <a href="#view-logs"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5M3.75 6.75h16.5M3.75 17.25h16.5" /></svg> <span>צג לוגים</span> </a> 
                 </nav> 
             </div> 
             <div id="connection-status" class="text-sm text-yellow-500 p-2 text-center"> טוען... </div>
        </aside>

        <!-- Main Content -->
        <main class="h-full overflow-hidden light-card flex flex-col">
            
            <!-- Notification Ticker -->
            <div id="notification-ticker" class="flex-shrink-0">
                 <ul id="notification-ticker-list">
                      <li><span class="time">--:--</span><span>מערכת v41.0 טעונה. ממתין לאירועים...</span></li>
                 </ul>
            </div>

            <!-- Main Content Area -->
            <div class="main-content-area flex-grow overflow-hidden">
                <!-- View 1: Map (Default) -->
                <div id="view-map" class="app-view h-full">
                    <div id="leaflet-map-container" class="h-full"> <div id="leaflet-map"></div> </div>
                </div>

                <!-- View 2: Orders Table -->
                <div id="view-orders" class="app-view hidden h-full flex flex-col gap-4">
                     <header class="flex-shrink-0 flex justify-between items-center p-4 border-b border-gray-200"> <h2 class="text-xl font-semibold text-gray-800">ניהול הזמנות</h2> <button class="btn btn-primary" onclick="openAddOrderModal()"> + הוסף הזמנה </button> </header>
                     <div class="filter-input-wrapper px-4 pt-4"> <span class="filter-input-icon"><svg>...</svg></span> <input type="text" id="filter-orders" class="filter-input" placeholder="חפש הזמנה..."> </div>
                     <div class="overflow-hidden flex-grow view-content view-content-table"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="orders-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>

                <!-- View 3: Drivers Table -->
                <div id="view-drivers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                     <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-xl font-semibold text-gray-800">ניהול נהגים</h2> </header>
                      <div class="filter-input-wrapper"> <span class="filter-input-icon"><svg>...</svg></span> <input type="text" id="filter-drivers" class="filter-input" placeholder="חפש נהג..."> </div>
                     <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content view-content-table"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="drivers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
                
                <!-- View 4: Customers Table -->
                 <div id="view-customers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                     <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-xl font-semibold text-gray-800">ניהול לקוחות</h2> </header>
                     <div class="filter-input-wrapper"> <span class="filter-input-icon"><svg>...</svg></span> <input type="text" id="filter-customers" class="filter-input" placeholder="חפש לקוח..."> </div>
                     <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content view-content-table"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="customers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
                
                <!-- View 5: Logs Table -->
                 <div id="view-logs" class="app-view hidden h-full flex flex-col gap-4 p-4">
                     <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-xl font-semibold text-gray-800">צג לוגים</h2> </header>
                     <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content view-content-table"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="logs-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modals -->
    <div id="addOrderModal" class="modal-backdrop">...</div>
    <div id="assignDriverModal" class="modal-backdrop">...</div>
    <div id="confirmAssignModal" class="modal-backdrop">...</div>
    <div id="selectDriverModal" class="modal-backdrop">...</div>

</body>
</html>

