<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v39.0 - 拽拽驻 砖驻专</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet-geometryutil"></script> 
    <!-- v39: Leaflet Polyline decorator for dashed lines -->
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        /* Base & Theme (Light v37/38) - Minor adjustments */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; font-family: 'Inter', system-ui, sans-serif; direction: rtl; }
        body { margin: 0; line-height: inherit; background-color: #f3f4f6; color: #1f2937; overflow: hidden; /* Prevent body scroll */ }
        .light-card { background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }

        /* Layout & Spacing */
        .p-4 { padding: 1rem; } .p-3 { padding: 0.75rem; } .p-6 { padding: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .flex { display: flex; } .grid { display: grid; } .hidden { display: none; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .justify-between { justify-content: space-between; } .items-center { align-items: center; }
        .text-2xl { font-size: 1.5rem; } .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; }
        .text-gray-600 { color: #4b5563; } .text-gray-800 { color: #1f2937; } .text-gray-500 { color: #6b7280; }
        .text-green-500 { color: #22c55e; } .text-yellow-500 { color: #eab308; } .text-red-500 { color: #ef4444; }
        .text-sky-500 { color: #0ea5e9; } .text-amber-500 { color: #f59e0b; }
        .text-center { text-align: center; } .text-right { text-align: right; }
        .w-full { width: 100%; } .h-screen { height: 100vh; } .h-full { height: 100%; }
        .overflow-hidden { overflow: hidden; } .overflow-y-auto { overflow-y: auto; }
        .border-b { border-bottom-width: 1px; } .border { border-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; } .border-gray-300 { border-color: #d1d5db; }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 1px; }
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #e5e7eb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .rounded-lg { border-radius: 0.5rem; } .rounded-xl { border-radius: 0.75rem; }
        .sticky { position: sticky; } .top-0 { top: 0; } .z-10 { z-index: 10; } .z-50 { z-index: 50; }
        .bg-gray-50 { background-color: #f9fafb; }

        /* Layout */
        .main-layout { display: grid; grid-template-columns: 240px 1fr; height: 100vh; padding: 1rem; gap: 1rem; background-color: #f3f4f6; }
        main { height: calc(100vh - 2rem); overflow: hidden; /* Main area should not scroll */ }
        .view-content { height: 100%; overflow-y: auto; /* Allow content within views to scroll */ }

        /* Sidebar */
        .sidebar { background-color: #fff; }
        .sidebar-nav a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #4b5563; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
        .sidebar-nav a:hover { background-color: #e0f2fe; color: #0369a1; }
        .sidebar-nav a.active { background-color: #0ea5e9; color: white; }
        .sidebar-nav a svg { width: 1.25rem; height: 1.25rem; }

        /* Map */
        #leaflet-map-container { height: 100%; width: 100%; border-radius: 0.75rem; overflow: hidden; }
        #leaflet-map { height: 100%; width: 100%; z-index: 10; }
        .leaflet-container { background: #e5e7eb; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #fff; color: #1f2937; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .leaflet-popup-close-button { color: #374151 !important; }
        .map-popup-button { margin-top: 8px; padding: 4px 8px; font-size: 12px; background-color: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .leaflet-marker-draggable.leaflet-drag-target { cursor: grabbing !important; }
        /* v39: Increase emoji size */
        .leaflet-div-icon { font-size: 1.8rem; /* Make emojis bigger */ }

        /* Buttons v39 - Refined */
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.75rem; /* More rounded */ font-weight: 600; cursor: pointer; transition: all 0.15s ease-out; border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:active { transform: scale(0.98); box-shadow: none; }
        .btn-primary { background-color: #0ea5e9; color: white; border-color: #0ea5e9; } .btn-primary:hover { background-color: #0284c7; border-color: #0284c7; }
        .btn-secondary { background-color: #fff; color: #374151; border-color: #d1d5db; } .btn-secondary:hover { background-color: #f9fafb; border-color: #adb5bd;}
        .btn-success { background-color: #22c55e; color: white; border-color: #22c55e; } .btn-success:hover { background-color: #16a34a; border-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; } .btn-warning:hover { background-color: #d97706; border-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; } .btn-danger:hover { background-color: #dc2626; border-color: #dc2626; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 0.5rem; }

        /* Status & Logs */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-砖 { background-color: #e0f2fe; color: #0ea5e9; } .status-砖 { background-color: #fef3c7; color: #d97706; } .status-砖 { background-color: #dcfce7; color: #16a34a; } .status-default { background-color: #e5e7eb; color: #4b5563; }
        .level-INFO { color: #0ea5e9; } .level-WARN { color: #f59e0b; } .level-ERROR { color: #ef4444; font-weight: 700; }
        
        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { width: 90%; max-width: 500px; background-color: #fff; border-radius: 0.75rem; /* More rounded */ }
        .modal-header { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .modal-footer { margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding-top: 1rem; }
        
        /* Form & Filter Inputs */
        .form-input, .filter-input { width: 100%; background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; padding: 0.75rem 1rem; border-radius: 0.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .filter-input { margin-bottom: 1rem; }
        
        /* Table */
        table { border-collapse: collapse; } thead { background-color: #f9fafb; } th { color: #4b5563; padding: 0.75rem; font-weight: 600; } tbody { background-color: #fff; } td { padding: 0.75rem; }
        
        /* v39: Select Driver Modal List */
        #driver-select-list button { display: block; width: 100%; text-align: right; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; }
        #driver-select-list button:hover { background-color: #f3f4f6; } /* gray-100 */
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { /* ... same config ... */ 
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.firebasestorage.app",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a",
            measurementId: "G-XV6RZDESSB"
        };

        // --- Globals ---
        let db;
        let currentEditDoc = null; 
        let mapInstance = null;
        let allDrivers = {}; 
        let driverMarkers = {}; 
        let orderMarkers = {}; 
        let currentlyDraggedOrder = null;
        let assignmentLines = {}; // v39: Store assignment polylines

        // --- Icons v39: Truck Emoji + Pin ---
        const driverIcon = L.divIcon({ html: '', className: 'leaflet-div-icon', iconSize: [32, 32], iconAnchor: [16, 16] }); 
        const orderIcon = L.divIcon({ html: '', className: 'leaflet-div-icon text-sky-500', iconSize: [32, 32], iconAnchor: [16, 32] }); // Pin anchor at bottom-center

        // --- Init App ---
        document.addEventListener('DOMContentLoaded', async () => { /* ... same init logic ... */ 
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                setStatus('转专...', 'text-yellow-500');
                await signInAnonymously(auth);
                setStatus('专 ( 转...)', 'text-green-500');
                initNavigation();
                initMap(); 
                listenToDrivers();
                listenToDriverLocations();
                listenToOrders();
                listenToCustomers();
                listenToSystemLogs();
                initFilters();
            } catch (error) { console.error("Firebase Init Error", error); setStatus(`砖转 转专转: ${error.message}`, 'text-red-500'); }
        });
        
        // --- Navigation ---
        function initNavigation() { /* ... same ... */ const l=document.querySelectorAll('.sidebar-nav a');l.forEach(k=>{k.addEventListener('click',(e)=>{e.preventDefault();const v=e.currentTarget.getAttribute('href').substring(1);showView(v);l.forEach(j=>j.classList.remove('active'));e.currentTarget.classList.add('active');});});showView('view-map');document.querySelector('.sidebar-nav a[href="#view-map"]').classList.add('active'); }
        window.showView = (viewId) => { /* ... same ... */ document.querySelectorAll('.app-view').forEach(v=>v.classList.add('hidden'));const t=document.getElementById(viewId);if(t)t.classList.remove('hidden');if(viewId==='view-map'&&mapInstance){setTimeout(()=>mapInstance.invalidateSize(),100);} }

        // --- Real-time Listeners (READ) ---
        // (No changes needed in listeners themselves)
        function listenToDrivers() { /* ... same ... */ const c=collection(db,"drivers");onSnapshot(c,(s)=>{const d=[];allDrivers={};s.forEach((doc)=>{const dd=doc.data();allDrivers[doc.id]=dd;d.push({id:doc.id,...dd});});renderDriversTable();},(e)=>console.error("Drivers:",e)); }
        function listenToDriverLocations() { /* ... same ... */ const c=collection(db,"driverLocations");onSnapshot(c,(s)=>{s.docChanges().forEach((ch)=>{const dId=ch.doc.id;const lData=ch.doc.data();if(ch.type==="added"||ch.type==="modified")updateDriverMarker(dId,lData);else if(ch.type==="removed"&&driverMarkers[dId]){mapInstance?.removeLayer(driverMarkers[dId]);delete driverMarkers[dId];}});},(e)=>console.error("Locations:",e)); }
        function listenToOrders() { /* ... same ... */ const c=collection(db,"orders");const q=query(c,orderBy("createdAt","desc"));onSnapshot(q,(s)=>{const o=[];s.forEach((doc)=>o.push({id:doc.id,...doc.data()}));window.allOrdersData=o;renderOrdersTable();updateOrderMarkers(o);},(e)=>{console.error("Orders:",e);setStatus("砖  转",'text-red-500');}); }
        function listenToCustomers() { /* ... same ... */ const c=collection(db,"customers");const q=query(c,orderBy("name","asc"));onSnapshot(q,(s)=>{const cust=[];s.forEach((doc)=>cust.push({id:doc.id,...doc.data()}));window.allCustomersData=cust;renderCustomersTable();},(e)=>console.error("Customers:",e)); }
        function listenToSystemLogs() { /* ... same ... */ const c=collection(db,"system_logs");const q=query(c,orderBy("timestamp","desc"));onSnapshot(q,(s)=>{const l=[];s.forEach((doc)=>l.push({id:doc.id,...doc.data()}));window.allLogsData=l;renderLogsTable();},(e)=>console.error("Logs:",e)); }

        // --- Render Functions (v39: Filters included) ---
        function initFilters() { /* ... same ... */ document.getElementById('filter-orders')?.addEventListener('input',renderOrdersTable);document.getElementById('filter-drivers')?.addEventListener('input',renderDriversTable);document.getElementById('filter-customers')?.addEventListener('input',renderCustomersTable); }
        function renderOrdersTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('orders-table-body');const f=document.getElementById('filter-orders').value.toLowerCase();const o=(window.allOrdersData||[]).filter(d=>{if(!f)return!0;const c=d.customer?.name||'';const v=d.driver?.name||'';const s=d.status||'';const a=d.address||'';return d.id.toLowerCase().includes(f)||c.toLowerCase().includes(f)||v.toLowerCase().includes(f)||s.toLowerCase().includes(f)||a.toLowerCase().includes(f)});if(!t)return;if(!o||o.length===0){t.innerHTML=`<tr><td colspan="6" class="p-8 text-center text-gray-500"> 爪 转 转转.</td></tr>`;return;}t.innerHTML=o.map(d=>{const c=d.customer?.name||' 注';const v=d.driver?.name||'专 砖';const s=d.status||'砖';const k=`status-${s.replace(' ','_')}`||'status-default';let h='';if(s==='砖')h=`<button class="btn btn-warning btn-sm" onclick="openAssignDriverModal('${d.id}')">砖抓</button>`;else if(s==='砖')h=`<button class="btn btn-success btn-sm" onclick="handleMarkAsCompleted('${d.id}')">砖</button>`;return`<tr class="hover:bg-gray-100 text-sm"><td class="p-3">${d.id}</td><td class="p-3 text-gray-800 font-semibold">${c}</td><td class="p-3">${d.address}</td><td class="p-3 text-gray-800 font-semibold">${v}</td><td class="p-3"><span class="status-badge ${k}">${s}</span></td><td class="p-3 flex gap-2">${h}<button class="btn btn-secondary btn-sm" onclick="openEditOrderModal(JSON.stringify(window.allOrders['${d.id}']))">注专</button><button class="btn btn-danger btn-sm" onclick="handleDelete('orders','${d.id}')">拽</button></td></tr>`}).join('');window.allOrders=o.reduce((a,c)=>{a[c.id]=c;return a},{})}
        function renderDriversTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('drivers-table-body');const f=document.getElementById('filter-drivers').value.toLowerCase();const d=Object.values(allDrivers||{}).filter(v=>{if(!f)return!0;const n=v.name||'';const p=v.phone||'';const s=v.status||'';const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||s.toLowerCase().includes(f)||i.toLowerCase().includes(f)});if(!t)return;t.innerHTML=d.map(v=>{const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'N/A';return`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${v.name||i}</td><td class="p-3">${v.phone||'---'}</td><td class="p-3">${v.vehicleType||' 注'}</td><td class="p-3">${v.status||' 驻注'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('drivers','${i}')">拽</button></td></tr>`}).join('')}
        function renderCustomersTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('customers-table-body');const f=document.getElementById('filter-customers').value.toLowerCase();const c=(window.allCustomersData||[]).filter(u=>{if(!f)return!0;const n=u.name||'';const p=u.phone||'';const a=u.defaultAddress||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||a.toLowerCase().includes(f)});if(!t)return;t.innerHTML=c.map(u=>`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${u.name||u.id}</td><td class="p-3">${u.phone||'---'}</td><td class="p-3">${u.defaultAddress||'---'}</td><td class="p-3">${u.contactPerson||'---'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('customers','${u.id}')">拽</button></td></tr>`).join('')}
        function renderLogsTable() { /* ... same rendering ... */ const t=document.getElementById('logs-table-body');if(!t)return;const l=window.allLogsData||[];t.innerHTML=l.map(g=>{const v=g.level||'INFO';const i=g.timestamp?.toDate().toLocaleString('he-IL')||'---';return`<tr class="hover:bg-gray-100 text-sm font-mono"><td class="p-3 text-gray-500">${i}</td><td class="p-3 font-bold level-${v}">${v}</td><td class="p-3 text-cyan-500">[${g.origin||'N/A'}]</td><td class="p-3 text-gray-800">${g.message||'---'}</td><td class="p-3 text-xs text-gray-500">${g.data||''}</td></tr>`}).join('')}
        function setStatus(message, cssClass) { /* ... same ... */ const el=document.getElementById('connection-status'); if(el) { el.textContent=message; el.className=`text-sm ${cssClass}`; } }

        // --- Map Functions ---
        window.initMap = () => { 
            const mapElement = document.getElementById('leaflet-map'); 
            if (!mapElement) { console.error("Map container #leaflet-map not found!"); return; } 
            try { 
                if (typeof L === 'undefined') { console.error("Leaflet (L) not defined."); setStatus('砖 注转 驻转', 'text-red-500'); return; } 
                if (!mapInstance) { 
                    // v39: Increased zoom level
                    mapInstance = L.map(mapElement).setView([31.7683, 35.2137], 9); 
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance); 
                    mapInstance.on('load', () => { console.log("Map initialized."); setStatus('专 | 驻 注', 'text-green-500'); }); 
                    mapInstance.on('tileerror', (e) => { console.error('Tile error:', e); setStatus('砖转 专 驻', 'text-red-500'); }); 
                } else { mapInstance.invalidateSize(); } 
            } catch (e) { console.error("Map init failed:", e); mapElement.innerHTML = `<div class="p-4 text-center text-red-500">Map Error: ${e.message}</div>`; setStatus('砖 拽专转 驻', 'text-red-500'); } 
        }
        
        function updateDriverMarker(driverId, locationData) { 
            if (!mapInstance || !locationData.latitude || !locationData.longitude) return; 
            const latLng = [locationData.latitude, locationData.longitude]; 
            const driverName = allDrivers[driverId]?.name || driverId; 
            const popupContent = `<b>: ${driverName}</b><br>注: ${locationData.lastUpdate?.toDate().toLocaleTimeString('he-IL') || 'N/A'}`; 
            if (driverMarkers[driverId]) {
                 driverMarkers[driverId].setLatLng(latLng).setPopupContent(popupContent); 
            } else { 
                driverMarkers[driverId] = L.marker(latLng, { icon: driverIcon, draggable: false }).addTo(mapInstance).bindPopup(popupContent);
                driverMarkers[driverId]._driverInfo = { id: driverId, name: driverName }; // v39: Store driver info
            }
        }
        
        function updateOrderMarkers(orders) {
            if (!mapInstance) return;
            const currentOrderIds = orders.map(o => o.id);
            Object.keys(orderMarkers).forEach(markerId => { if (!currentOrderIds.includes(markerId)) { mapInstance.removeLayer(orderMarkers[markerId]); delete orderMarkers[markerId]; } });
            
            orders.forEach(order => {
                if (order.status !== '砖' && order.latitude && order.longitude) {
                    const latLng = [order.latitude, order.longitude];
                    // v39: New popup content with "Select Driver" button
                    const popupContent = `<b>${order.customer?.name || '拽'}</b> (${order.id})<br>${order.address}<br>住住: ${order.status}` + 
                                         (order.status === '砖' ? `<br><button class="map-popup-button" onclick="openSelectDriverModal('${order.id}')">砖抓 专砖</button>` : '');
                    const orderId = order.id;
                    const draggable = order.status === '砖'; 

                    if (orderMarkers[orderId]) {
                        orderMarkers[orderId].setLatLng(latLng).setPopupContent(popupContent);
                        if (draggable && !orderMarkers[orderId].dragging.enabled()) orderMarkers[orderId].dragging.enable();
                        else if (!draggable && orderMarkers[orderId].dragging.enabled()) orderMarkers[orderId].dragging.disable();
                    } else {
                        orderMarkers[orderId] = L.marker(latLng, { icon: orderIcon, draggable: draggable })
                        .addTo(mapInstance)
                        .bindPopup(popupContent);
                        
                        orderMarkers[orderId]._orderData = order; 
                        orderMarkers[orderId].on('dragstart', () => { currentlyDraggedOrder = order; }); 
                        orderMarkers[orderId].on('dragend', handleOrderDrop); 
                    }
                } else if (orderMarkers[order.id]) {
                    mapInstance.removeLayer(orderMarkers[order.id]); delete orderMarkers[order.id];
                }
            });
        }
        
        // --- v39: Drag & Drop Logic (No changes, still uses confirmation modal) ---
        function handleOrderDrop(event) { /* ... same logic as v38 ... */ if (!currentlyDraggedOrder) return; const droppedOrderMarker = event.target; const droppedLatLng = droppedOrderMarker.getLatLng(); const DRAG_ASSIGN_THRESHOLD_METERS = 50; let closestDriver = null; let minDistance = Infinity; Object.keys(driverMarkers).forEach(driverId => { const driverMarker = driverMarkers[driverId]; const distance = droppedLatLng.distanceTo(driverMarker.getLatLng()); if (distance < minDistance) { minDistance = distance; closestDriver = { id: driverId, name: allDrivers[driverId]?.name || driverId, marker: driverMarker }; } }); if (closestDriver && minDistance <= DRAG_ASSIGN_THRESHOLD_METERS) { openConfirmAssignModal(currentlyDraggedOrder.id, closestDriver.id, currentlyDraggedOrder.customer?.name || ' 注', closestDriver.name); } else { droppedOrderMarker.setLatLng([currentlyDraggedOrder.latitude, currentlyDraggedOrder.longitude]); alert(" 爪  拽专 住驻拽 砖."); } currentlyDraggedOrder = null; }
        
        // --- CRUD Functions ---
        window.openAddOrderModal = () => { /* ... same ... */ currentEditDoc = null; document.getElementById('addOrderModalTitle').textContent = "爪专转  砖"; document.getElementById('addOrderForm').reset(); document.getElementById('addOrderModal').style.display = 'flex'; }
        window.openEditOrderModal = (orderJson) => { /* ... same ... */ const order = JSON.parse(orderJson); currentEditDoc = order; const form = document.getElementById('addOrderForm'); /* ... form population ... */ document.getElementById('addOrderModalTitle').textContent = `注专转  ${order.id}`; document.getElementById('addOrderModal').style.display = 'flex'; }
        window.openAssignDriverModal = (orderId) => { /* ... same ... */ currentEditDoc = { id: orderId }; document.getElementById('assignDriverModal').style.display = 'flex'; }
        window.openConfirmAssignModal = (orderId, driverId, customerName, driverName) => { /* ... same ... */ document.getElementById('confirmAssignText').innerHTML = ` 转  砖专爪 砖 转  砖 <b>${customerName}</b>  <b>${driverName}</b>?`; const confirmBtn = document.getElementById('confirmAssignBtn'); confirmBtn.onclick = () => handleConfirmAssign(orderId, driverId, driverName); document.getElementById('confirmAssignModal').style.display = 'flex'; }
        
        // v39: New Modal for Selecting Driver from List
        window.openSelectDriverModal = (orderId) => {
            currentEditDoc = { id: orderId }; // Store order ID
            const driverListDiv = document.getElementById('driver-select-list');
            driverListDiv.innerHTML = ''; // Clear previous list
            
            // Populate with currently active drivers (those with markers)
            Object.values(driverMarkers).forEach(marker => {
                const driverInfo = marker._driverInfo;
                if(driverInfo) {
                    const button = document.createElement('button');
                    button.textContent = driverInfo.name;
                    // When a driver is clicked, open the confirmation modal
                    button.onclick = () => {
                         const orderData = orderMarkers[orderId]?._orderData;
                         closeModal('selectDriverModal'); // Close this modal first
                         openConfirmAssignModal(orderId, driverInfo.id, orderData?.customer?.name || '拽', driverInfo.name);
                    };
                    driverListDiv.appendChild(button);
                }
            });
            
            if(driverListDiv.innerHTML === '') {
                 driverListDiv.innerHTML = '<p class="p-4 text-center text-gray-500"> 爪  驻注 驻.</p>';
            }
            
            document.getElementById('selectDriverModal').style.display = 'flex';
        }
        
        window.closeModal = (modalId) => { /* ... same ... */ const el = document.getElementById(modalId); if(el) el.style.display = 'none'; }
        
        window.handleSaveOrder = async () => { /* ... same logic ... */ };
        
        window.handleAssignDriver = async (orderId, driverId, driverName) => { 
            const orderRef = doc(db, "orders", orderId);
            try {
                 if (!driverName) { /* Find driver if coming from modal */ driverName = document.getElementById('driverNameInput').value; driverId = Object.keys(allDrivers).find(id => allDrivers[id].name === driverName) || driverName; }
                 const driverData = { id: driverId, name: driverName };
                 await updateDoc(orderRef, { driver: driverData, status: "砖" });
                 
                 // v39: Draw assignment line
                 drawAssignmentLine(orderId, driverId);
                 
                 closeModal('assignDriverModal');
                 closeModal('confirmAssignModal');
                 closeModal('selectDriverModal'); // Close all possible modals
                 const driverInput = document.getElementById('driverNameInput');
                 if(driverInput) driverInput.value = '';
                 currentEditDoc = null; 
            } catch (e) { console.error("Error assigning driver: ", e); alert("砖 砖抓 : " + e.message); } 
        }
        
        window.handleConfirmAssign = (orderId, driverId, driverName) => { handleAssignDriver(orderId, driverId, driverName); }
        window.handleMarkAsCompleted = async (orderId) => { /* ... same logic + remove line ... */ if (!confirm(`...`)) return; const orderRef = doc(db, "orders", orderId); try { await updateDoc(orderRef, { status: "砖" }); removeAssignmentLine(orderId); } catch (e) { /*...*/ alert("砖 住: " + e.message); } }
        window.handleDelete = async (collectionName, docId) => { /* ... same logic + remove line if order */ if (!confirm(`...`)) return; const docRef = doc(db, collectionName, docId); try { await deleteDoc(docRef); if(collectionName === 'orders') removeAssignmentLine(docId); } catch (e) { /*...*/ alert("砖 拽: " + e.message); } }
        
        // --- v39: Assignment Line Visualization ---
        function drawAssignmentLine(orderId, driverId) {
            if (!mapInstance || !orderMarkers[orderId] || !driverMarkers[driverId]) return;
            
            // Remove previous line if exists
            removeAssignmentLine(orderId);

            const orderLatLng = orderMarkers[orderId].getLatLng();
            const driverLatLng = driverMarkers[driverId].getLatLng();
            
            const line = L.polyline([orderLatLng, driverLatLng], { 
                color: '#f59e0b', // Amber color
                weight: 3,
                opacity: 0.7 
            });

            // Add dashed pattern using decorator
            const decorator = L.polylineDecorator(line, {
                patterns: [
                    { offset: '0%', repeat: 10, symbol: L.Symbol.dash({ pixelSize: 5, pathOptions: { color: '#f59e0b', weight: 3, opacity: 0.7 } }) }
                ]
            }).addTo(mapInstance);

            assignmentLines[orderId] = { line, decorator }; // Store both parts

            // Fade out and remove after a delay
            setTimeout(() => {
                removeAssignmentLine(orderId);
            }, 5000); // Remove after 5 seconds
        }

        function removeAssignmentLine(orderId) {
             if (assignmentLines[orderId]) {
                if (assignmentLines[orderId].line) mapInstance?.removeLayer(assignmentLines[orderId].line);
                if (assignmentLines[orderId].decorator) mapInstance?.removeLayer(assignmentLines[orderId].decorator);
                delete assignmentLines[orderId];
            }
        }

        // --- Attach handlers ---
        window.handleMarkAsCompleted = handleMarkAsCompleted;
        window.handleDelete = handleDelete; 

    </script>
</head>
<body class="h-screen overflow-hidden bg-gray-100">

    <div class="main-layout">
        
        <!-- Sidebar -->
        <aside class="light-card sidebar p-4 flex flex-col justify-between">
            <!-- Sidebar content (nav links - SVG content omitted for brevity) -->
             <div> 
                 <h1 class="text-2xl font-bold text-gray-800 p-2 mb-6">. 住 (v39)</h1> 
                 <nav class="sidebar-nav space-y-2"> 
                     <a href="#view-map"><svg>...</svg><span>专 爪 (驻)</span></a> 
                     <a href="#view-orders"><svg>...</svg><span> 转</span></a> 
                     <a href="#view-drivers"><svg>...</svg><span> </span></a> 
                     <a href="#view-customers"><svg>...</svg><span> 拽转</span></a> 
                     <a href="#view-logs"><svg>...</svg><span>爪 </span></a> 
                 </nav> 
             </div> 
             <div id="connection-status" class="text-sm text-yellow-500 p-2 text-center"> 注... </div>
        </aside>

        <!-- Main Content -->
        <main class="h-full overflow-hidden light-card">
            
            <!-- View 1: Map (Default) -->
            <div id="view-map" class="app-view h-full">
                <div id="leaflet-map-container" class="h-full"> <div id="leaflet-map"></div> </div>
            </div>

            <!-- View 2: Orders Table -->
            <div id="view-orders" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-2xl font-bold text-gray-800"> 转</h2> <button class="btn btn-primary" onclick="openAddOrderModal()"> + 住祝  </button> </header>
                 <input type="text" id="filter-orders" class="filter-input" placeholder=" 驻砖 ...">
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="orders-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
            </div>

            <!-- View 3: Drivers Table -->
            <div id="view-drivers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-2xl font-bold text-gray-800"> </h2> </header>
                 <input type="text" id="filter-drivers" class="filter-input" placeholder=" 驻砖 ...">
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="drivers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
            </div>
            
            <!-- View 4: Customers Table -->
             <div id="view-customers" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-2xl font-bold text-gray-800"> 拽转</h2> </header>
                 <input type="text" id="filter-customers" class="filter-input" placeholder=" 驻砖 拽...">
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="customers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
            </div>
            
            <!-- View 5: Logs Table -->
             <div id="view-logs" class="app-view hidden h-full flex flex-col gap-4 p-4">
                 <header class="flex-shrink-0 flex justify-between items-center"> <h2 class="text-2xl font-bold text-gray-800">爪 </h2> </header>
                 <div class="overflow-hidden flex-grow border border-gray-200 rounded-lg view-content"> <div class="h-full"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="logs-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
            </div>

        </main>
    </div>
    
    <!-- Modals -->
    <!-- Add/Edit Order Modal (content omitted) -->
    <div id="addOrderModal" class="modal-backdrop"> <div class="light-card modal-content p-6 space-y-4 max-h-[90vh] overflow-y-auto"> <h2 id="addOrderModalTitle">...</h2> <form id="addOrderForm">...</form> </div> </div>
    <!-- Assign Driver Modal (content omitted) -->
    <div id="assignDriverModal" class="modal-backdrop"> <div class="light-card modal-content p-6 space-y-4"> <h2>砖抓 </h2> <form>...</form> </div> </div>
    <!-- Confirm Assign Modal (content omitted) -->
    <div id="confirmAssignModal" class="modal-backdrop"> <div class="light-card modal-content p-6 space-y-4"> <div class="modal-header"><h2>砖专 砖抓</h2></div> <p id="confirmAssignText">...</p> <div class="modal-footer">...</div> </div> </div>

    <!-- v39: Select Driver From List Modal -->
    <div id="selectDriverModal" class="modal-backdrop" style="display: none;">
        <div class="light-card modal-content p-6 space-y-4">
            <div class="modal-header">
                 <h2 class="text-xl font-bold text-gray-800">专  砖抓</h2>
            </div>
            <div id="driver-select-list" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Driver buttons will be inserted here by JS -->
                <p class="p-4 text-center text-gray-500">注 专砖转 ...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('selectDriverModal')"></button>
            </div>
        </div>
    </div>

</body>
</html>

