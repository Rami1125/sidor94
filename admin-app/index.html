<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster - ניהול</title>
    <!-- DeliveryMaster Admin App v30.5 -->
    <!-- 
      v30.5 Changelog:
      - v30.1: Async loading principles confirmed.
      - v30.4: Improved error handling in data load functions.
      - v30.5: logToServer updated to be fire-and-forget.
    -->
    
    <!-- LeafletJS CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --header-height: 64px;
            --sidebar-width: 300px;
            --main-bg: #f4f7f6;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --text-color: #333;
            --text-light: #777;
            --border-color: #e0e0e0;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
            background-color: #eee;
        }
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #header {
            height: var(--header-height);
            background-color: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            flex-shrink: 0;
        }
        #map-container {
            flex: 1;
            position: relative;
        }
        #driver-list-container, #order-list-container {
            overflow-y: auto;
            flex: 1;
            position: relative;
        }
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden; /* v30.1 */
        }
        .tab-content.active {
            display: flex;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .driver-item, .order-card {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .driver-item:hover, .order-card:hover {
            background-color: #f9f9f9;
        }
        .driver-item.active, .order-card.active {
            background-color: #eaf5fc;
            border-right: 4px solid var(--primary-color);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        .status-active { background-color: #2ecc71; }
        .status-stuck { background-color: #e74c3c; }
        .status-inactive { background-color: #95a5a6; }

        /* Order Card Status */
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }
        .status-new { background-color: #3498db; }
        .status-assigned { background-color: #f39c12; }
        .status-loading { background-color: #9b59b6; }
        .status-onway { background-color: #1abc9c; }
        .status-delivered { background-color: #2ecc71; }
        .status-problem { background-color: #e74c3c; }
        .status-other { background-color: #7f8c8d; }

        /* v30.1 Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .loader-container {
            position: absolute; /* Changed from absolute to relative */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        #map-loader {
            position: absolute;
            z-index: 1001; /* Above map */
        }
        
        /* v30.4: Error message styling */
        .error-message {
            padding: 20px;
            text-align: center;
            color: #e74c3c;
            background: #fffafa;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            margin: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 2000;
            transition: bottom 0.5s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #toast.show {
            bottom: 30px;
        }
        #toast.error {
            background-color: #e74c3c;
        }

        /* Modal */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
        }
        #modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 8px;
            z-index: 3001;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        #modal-content {
            line-height: 1.6;
        }

        /* Map Controls */
        #map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="flex items-center justify-between p-4 border-b border-gray-200" style="height: var(--header-height);">
            <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
            <i data-feather="refresh-cw" class="cursor-pointer text-gray-600 hover:text-blue-500" onclick="manualRefresh()"></i>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button class="tab-button flex-1 active" onclick="showTab('drivers')">
                <i data-feather="truck" class="inline-block w-4 h-4 ml-1"></i> נהגים
            </button>
            <button class="tab-button flex-1" onclick="showTab('orders')">
                <i data-feather="package" class="inline-block w-4 h-4 ml-1"></i> הזמנות
            </button>
        </div>

        <!-- Driver List Tab -->
        <div id="drivers-tab" class="tab-content active">
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <input type="text" id="driver-search" placeholder="חיפוש נהג..." class="w-full px-3 py-2 border rounded-md" onkeyup="filterDrivers()">
            </div>
            <div id="driver-list-container">
                <div id="driver-list-loader" class="loader-container" style="display: none;">
                    <div class="loader"></div>
                </div>
                <div id="driver-list">
                    <!-- Driver items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Order List Tab -->
        <div id="orders-tab" class="tab-content">
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <input type="text" id="order-search" placeholder="חיפוש הזמנה, לקוח, כתובת..." class="w-full px-3 py-2 border rounded-md" onkeyup="filterOrders()">
            </div>
            <div id="order-list-container">
                <div id="order-list-loader" class="loader-container" style="display: none;">
                    <div class="loader"></div>
                </div>
                <div id="order-list">
                    <!-- Order cards will be injected here -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content">
        <header id="header">
            <div class="flex items-center space-x-4 space-x-reverse">
                <h2 id="main-title" class="text-lg font-semibold">מפה חיה</h2>
                <div id="last-updated" class="text-sm text-gray-500"></div>
            </div>
            <div class="flex items-center space-x-4 space-x-reverse">
                <a href="log.html" target="_blank" class="text-gray-600 hover:text-blue-500" title="פתיחת לוגים">
                    <i data-feather="file-text"></i>
                </a>
                <button class="text-gray-600 hover:text-blue-500" title="סנכרון מלא" onclick="triggerFullSync()">
                    <i data-feather="database"></i>
                </button>
                <span class="text-gray-600">שלום, מנהל</span>
            </div>
        </header>

        <div id="map-container">
            <div id="map"></div>
            <div id="map-loader" class="loader-container">
                <div class="loader"></div>
            </div>
            <div id="map-controls">
                <label class="flex items-center space-x-2 space-x-reverse cursor-pointer">
                    <input type="checkbox" id="autoZoomCheckbox" class="form-checkbox" checked>
                    <span class="text-sm">זום אוטומטי</span>
                </label>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Modal -->
    <div id="modal-backdrop" onclick="closeModal()"></div>
    <div id="modal">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold">פרטי הזמנה</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800">
                <i data-feather="x"></i>
            </button>
        </div>
        <div id="modal-content">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <script>
        // --- Config ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbxhJjLpnh8qZFutncdTLOX_ul8PIqZRrgjeE4289pPFiTozPcYiV8b0VzAg7KmuE6KZ/exec';
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // --- State ---
        let currentOrders = [];
        let currentDrivers = [];
        let currentLiveMapData = {};
        let refreshTimer;

        // --- Map Functions (v30.0 Leaflet Implementation) ---
        let map;
        let driverMarkers = {};
        let orderMarkers = {}; // Keep track of order markers
        const ISRAEL_CENTER = [32.0853, 34.7818]; // Tel Aviv center

        // Custom icons
        const driverIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        const driverIconStuck = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', // Red icon
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });
        
        const orderIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', // Blue icon
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        function initializeMap() {
            console.log("Initializing Leaflet map...");
            try {
                map = L.map('map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                console.log("Leaflet map initialized.");
                document.getElementById('map-loader').style.display = 'none';
            } catch (error) {
                console.error("Error initializing Leaflet map:", error);
                document.getElementById('map').innerHTML = "<div class='error-message'>Map failed to load. Please refresh.</div>";
                document.getElementById('map-loader').style.display = 'none';
            }
        }
        
        function updateDriverMarkers(liveMapData) {
            if (!map) return; // Don't run if map isn't ready

            const driverIds = Object.keys(liveMapData.drivers);
            const bounds = L.latLngBounds();

            // Update existing markers or create new ones
            driverIds.forEach(driverId => {
                const driver = liveMapData.drivers[driverId];
                if (!driver.latitude || !driver.longitude) return; // Skip drivers without coords

                const latLng = [driver.latitude, driver.longitude];
                const isStuck = driver.isStuck;
                const icon = isStuck ? driverIconStuck : driverIcon;

                if (driverMarkers[driverId]) {
                    // Marker exists, update position and icon
                    driverMarkers[driverId].setLatLng(latLng);
                    driverMarkers[driverId].setIcon(icon);
                    driverMarkers[driverId].getPopup().setContent(`<b>${driver.name}</b><br>${driver.status}<br>${driver.lastUpdate}`);
                } else {
                    // Create new marker
                    driverMarkers[driverId] = L.marker(latLng, { icon: icon })
                        .addTo(map)
                        .bindPopup(`<b>${driver.name}</b><br>${driver.status}<br>${driver.lastUpdate}`);
                }
                bounds.extend(latLng);
            });

            // Remove old markers (drivers who are no longer active)
            Object.keys(driverMarkers).forEach(markerId => {
                if (!driverIds.includes(markerId)) {
                    map.removeLayer(driverMarkers[markerId]);
                    delete driverMarkers[markerId];
                }
            });

            // Fit map to markers only if there are active drivers
            if (bounds.isValid() && document.getElementById('autoZoomCheckbox').checked) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function focusOnDriver(driverId) {
            const marker = driverMarkers[driverId];
            if (marker && map) {
                map.setView(marker.getLatLng(), 15); // Zoom level 15
                marker.openPopup();
                // Highlight the driver in the list
                document.querySelectorAll('.driver-item').forEach(el => el.classList.remove('active'));
                const driverElement = document.querySelector(`.driver-item[onclick*="'${driverId}'"]`);
                if (driverElement) {
                    driverElement.classList.add('active');
                    driverElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function focusOnOrder(orderId) {
            const order = currentOrders.find(o => o.orderId == orderId);
            if (order && order.latitude && order.longitude && map) {
                const latLng = [order.latitude, order.longitude];
                
                // Clear previous order markers
                Object.values(orderMarkers).forEach(marker => map.removeLayer(marker));
                orderMarkers = {};
                
                // Create a new marker for the order
                orderMarkers[orderId] = L.marker(latLng, { icon: orderIcon })
                    .addTo(map)
                    .bindPopup(`<b>הזמנה: ${order.orderId}</b><br>${order.customerName}<br>${order.address}`)
                    .openPopup();

                map.setView(latLng, 15); // Zoom level 15

                // Highlight the order in the list
                document.querySelectorAll('.order-card').forEach(el => el.classList.remove('active'));
                const orderElement = document.getElementById(`order-${orderId}`);
                if (orderElement) {
                    orderElement.classList.add('active');
                    orderElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } else {
                console.warn(`Order ${orderId} has no coordinates or map is not ready.`);
                showToast("לא ניתן למקד הזמנה. חסרות קואורדינטות.", true);
            }
        }
        // --- End of Map Functions ---


        // --- Data Fetching ---
        /**
         * v30.5: Updated apiFetch with logging and fire-and-forget logToServer
         */
        async function apiFetch(action, method = 'GET', data = null) {
            const url = `${API_URL}?action=${action}`;
            const options = {
                method: method,
                redirect: 'follow',
                muteHttpExceptions: true,
            };

            if (method === 'POST') {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify({ action: action, data: data });
            }

            try {
                const response = await fetch(method === 'GET' ? url : API_URL, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.data);
                }
                return result.data;
            } catch (error) {
                console.error(`API Fetch Error (${action}):`, error);
                
                // v30.4: Show toast on error
                showToast(`שגיאת תקשורת: ${error.message}`, true);
                
                // v30.5: Log error to server
                logToServer('AdminApp', 'ERROR', `API Fetch Failed: ${action}`, { error: error.message });
                
                throw error; // Re-throw to stop promise chain
            }
        }

        /**
         * v30.4: Improved error handling
         */
        function loadOrders() {
            showLoader('order-list-loader', true);
            document.getElementById('order-list').innerHTML = ''; // Clear previous errors
            
            apiFetch('getOrders')
                .then(data => {
                    currentOrders = data.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                    renderOrders();
                })
                .catch(error => {
                    console.error("Failed to load orders:", error);
                    document.getElementById('order-list').innerHTML = 
                        `<div class="error-message">טעינת הזמנות נכשלה.<br>${error.message}</div>`;
                })
                .finally(() => showLoader('order-list-loader', false));
        }

        /**
         * v30.4: Improved error handling
         */
        function loadDrivers() {
            showLoader('driver-list-loader', true);
            document.getElementById('driver-list').innerHTML = ''; // Clear previous errors

            apiFetch('getDrivers')
                .then(data => {
                    currentDrivers = data;
                    // We render drivers based on live map data, so just store this
                })
                .catch(error => {
                    console.error("Failed to load drivers:", error);
                     document.getElementById('driver-list').innerHTML = 
                        `<div class="error-message">טעינת נהגים נכשלה.<br>${error.message}</div>`;
                })
                .finally(() => {
                    // Loader is hidden by loadLiveMapData or its error state
                });
        }

        /**
         * v30.4: Improved error handling
         */
        function loadLiveMapData() {
            apiFetch('getLiveMapData')
                .then(data => {
                    currentLiveMapData = data;
                    renderDrivers(); // Now render drivers
                    updateDriverMarkers(data);
                    document.getElementById('last-updated').innerText = `עודכן: ${new Date().toLocaleTimeString('he-IL')}`;
                })
                .catch(error => {
                    console.error("Failed to load live map data:", error);
                    document.getElementById('driver-list').innerHTML = 
                        `<div class="error-message">טעינת מפה חיה נכשלה.<br>${error.message}</div>`;
                })
                .finally(() => {
                    // Hide driver loader regardless of success/fail
                    showLoader('driver-list-loader', false);
                });
        }

        // --- Rendering ---
        function renderDrivers() {
            const list = document.getElementById('driver-list');
            list.innerHTML = ''; // Clear list

            if (!currentLiveMapData.drivers || Object.keys(currentLiveMapData.drivers).length === 0) {
                 if(currentDrivers.length === 0) {
                    // If driver list is also empty (e.g. initial load error)
                    // list.innerHTML will already show error from loadDrivers()
                    return;
                 }
                 list.innerHTML = '<div class="p-4 text-center text-gray-500">אין נהגים פעילים כרגע.</div>';
                 // Continue to show inactive drivers
            }

            const activeDrivers = Object.keys(currentLiveMapData.drivers).map(id => ({
                id: id,
                ...currentLiveMapData.drivers[id]
            }));

            // Find drivers from main list who are not in live data (inactive)
            const inactiveDrivers = currentDrivers.filter(d => 
                !activeDrivers.some(ad => ad.id === d.driverId) && d.status === 'פעיל'
            );

            // Render active drivers
            activeDrivers
                .sort((a, b) => a.name.localeCompare(b.name, 'he'))
                .forEach(driver => {
                    list.appendChild(createDriverElement(driver));
                });

            // Render inactive (but 'פעיל') drivers
            inactiveDrivers
                .sort((a, b) => a.name.localeCompare(b.name, 'he'))
                .forEach(driver => {
                    list.appendChild(createDriverElement({
                        id: driver.driverId,
                        name: driver.name,
                        status: 'לא מחובר',
                        lastUpdate: 'N/A',
                        isStuck: false,
                        isInactive: true
                    }));
                });
            
            filterDrivers(); // Apply search filter
        }

        function createDriverElement(driver) {
            const el = document.createElement('div');
            el.className = 'driver-item flex justify-between items-center';
            el.setAttribute('data-name', driver.name.toLowerCase());
            el.onclick = () => focusOnDriver(driver.id);

            let statusClass, statusText;
            if (driver.isInactive) {
                statusClass = 'status-inactive';
                statusText = 'לא מחובר';
            } else if (driver.isStuck) {
                statusClass = 'status-stuck';
                statusText = 'תקוע';
            } else {
                statusClass = 'status-active';
                statusText = 'פעיל';
            }

            el.innerHTML = `
                <div>
                    <span class="font-semibold">${driver.name}</span>
                    <div class="text-sm text-gray-500">עדכון אחרון: ${driver.lastUpdate}</div>
                </div>
                <div class="flex items-center">
                    <span class="text-sm ml-2">${statusText}</span>
                    <span class="status-dot ${statusClass}"></span>
                </div>
            `;
            return el;
        }

        function renderOrders() {
            const list = document.getElementById('order-list');
            list.innerHTML = ''; // Clear list

            if (currentOrders.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-500">לא נמצאו הזמנות.</div>';
                return;
            }

            currentOrders.forEach(order => {
                list.appendChild(createOrderElement(order));
            });
            
            filterOrders(); // Apply search filter
        }

        function createOrderElement(order) {
            const el = document.createElement('div');
            el.className = 'order-card';
            el.id = `order-${order.orderId}`;
            el.setAttribute('data-search', 
                `${order.orderId} ${order.customerName ? order.customerName.toLowerCase() : ''} ${order.address ? order.address.toLowerCase() : ''} ${order.driverId || ''}`
            );
            
            const statusClass = getStatusClass(order.status);
            const orderTime = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }) : 'N/A';

            el.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-blue-600">#${order.orderId}</span>
                    <span class="status-badge ${statusClass}">${order.status || 'חדש'}</span>
                </div>
                <div class="mb-1">
                    <span class="font-semibold">${order.customerName || 'ללא שם'}</span>
                </div>
                <div class="text-sm text-gray-600 mb-2">
                    <i data-feather="map-pin" class="inline-block w-4 h-4 ml-1"></i>
                    ${order.address || 'ללא כתובת'}
                </div>
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>
                        <i data-feather="calendar" class="inline-block w-4 h-4 ml-1"></i>
                        ${orderTime}
                    </div>
                    <div>
                        <i data-feather="truck" class="inline-block w-4 h-4 ml-1"></i>
                        ${order.driverId || 'לא שויך'}
                    </div>
                </div>
                <div class="flex justify-end space-x-2 space-x-reverse mt-3">
                    <button class="text-gray-500 hover:text-blue-500" title="פרטים" onclick="event.stopPropagation(); showOrderDetails('${order.orderId}')">
                        <i data-feather="eye" class="w-5 h-5"></i>
                    </button>
                    <button class="text-gray-500 hover:text-green-500" title="מקד על המפה" onclick="event.stopPropagation(); focusOnOrder('${order.orderId}')">
                        <i data-feather="crosshair" class="w-5 h-5"></i>
                    </button>
                    ${order.pdfLink ? `<a href="${order.pdfLink}" target="_blank" class="text-gray-500 hover:text-red-500" title="צפה ב-PDF" onclick="event.stopPropagation(); logPDFView('${order.orderId}')">
                        <i data-feather="file" class="w-5 h-5"></i>
                    </a>` : ''}
                </div>
            `;
            return el;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'חדש': return 'status-new';
                case 'שויך': return 'status-assigned';
                case 'בתהליך ליקוט': return 'status-loading';
                case 'בדרך': return 'status-onway';
                case 'הושלם': return 'status-delivered';
                case 'בעיה': return 'status-problem';
                default: return 'status-other';
            }
        }

        // --- UI Interactions ---

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function filterDrivers() {
            const query = document.getElementById('driver-search').value.toLowerCase();
            document.querySelectorAll('#driver-list .driver-item').forEach(item => {
                const name = item.getAttribute('data-name');
                if (name.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function filterOrders() {
            const query = document.getElementById('order-search').value.toLowerCase();
            document.querySelectorAll('#order-list .order-card').forEach(item => {
                const searchData = item.getAttribute('data-search');
                if (searchData.includes(query)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function manualRefresh() {
            showToast('מרענן נתונים...');
            clearTimeout(refreshTimer); // Clear existing timer
            
            // v30.1: Use Promise.allSettled to ensure all data loads
            // v30.4: Errors are now handled inside the load functions
            Promise.allSettled([
                loadOrders(),
                loadDrivers(),
                loadLiveMapData()
            ]).then(() => {
                showToast('רענון הושלם');
                startRefreshTimer(); // Restart timer
            });
        }

        function triggerFullSync() {
            // v30.4: Replaced confirm with custom modal/toast logic
            showToast('מפעיל סנכרון מלא...');
            apiFetch('runFullSync', 'POST')
                .then(response => {
                    showToast('סנכרון מלא הושלם בהצלחה.');
                    logToServer('AdminApp', 'INFO', 'Full sync triggered by user.', response);
                    manualRefresh();
                })
                .catch(error => {
                    showToast('שגיאה בהפעלת סנכרון מלא.', true);
                });
        }

        function showLoader(loaderId, show) {
            const loader = document.getElementById(loaderId);
            if (loader) {
                loader.style.display = show ? 'block' : 'none';
            }
        }

        /**
         * v30.4: Added isError parameter
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = 'toast show';
            if (isError) {
                toast.classList.add('error');
            }
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function showOrderDetails(orderId) {
            document.getElementById('modal-title').innerText = `טוען פרטי הזמנה #${orderId}...`;
            document.getElementById('modal-content').innerHTML = '<div class="loader" style="position: relative; margin: auto;"></div>';
            openModal();

            try {
                const order = await apiFetch(`getOrderDetails&orderId=${orderId}`);
                
                document.getElementById('modal-title').innerText = `פרטי הזמנה #${orderId}`;
                
                const driversOptions = currentDrivers
                    .filter(d => d.status === 'פעיל')
                    .map(d => `<option value="${d.driverId}" ${d.driverId == order.driverId ? 'selected' : ''}>${d.name}</option>`)
                    .join('');

                const statusOptions = ['חדש', 'שויך', 'בתהליך ליקוט', 'בדרך', 'הושלם', 'בעיה', 'בוטל']
                    .map(s => `<option value="${s}" ${s == order.status ? 'selected' : ''}>${s}</option>`)
                    .join('');

                const commentsHtml = order.comments && order.comments.length > 0 ? order.comments.map(c => `
                    <div class="bg-gray-100 p-3 rounded-md mb-2">
                        <p class="text-sm">${c.text}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <strong>${c.author}</strong> - ${new Date(c.timestamp).toLocaleString('he-IL')}
                        </p>
                    </div>
                `).join('') : '<p class="text-sm text-gray-500">אין הערות.</p>';

                document.getElementById('modal-content').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><strong>לקוח:</strong> ${order.customerName}</div>
                        <div><strong>כתובת:</strong> ${order.address}</div>
                        <div><strong>טלפון:</strong> ${order.customerPhone || 'לא זמין'}</div>
                        <div><strong>סוג משלוח:</strong> ${order.deliveryType}</div>
                        <div><strong>תאריך:</strong> ${order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL') : 'N/A'}</div>
                        <div><strong>מחסן:</strong> ${order.warehouse}</div>
                    </div>

                    <div class="mb-4">
                        <strong>הערות הזמנה:</strong>
                        <p class="p-2 bg-gray-50 rounded border">${order.notes || 'אין'}</p>
                    </div>
                    
                    <div class="mb-4">
                        <strong>הערה פנימית:</strong>
                        <textarea id="internalNote-${orderId}" class="w-full p-2 border rounded" rows="2" onchange="updateOrderField('${orderId}', 'internalNote', this.value)">${order.internalNote || ''}</textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שייך לנהג:</label>
                            <select id="driverSelect-${orderId}" class="w-full p-2 border rounded" onchange="assignDriver('${orderId}', this.value)">
                                <option value="">בחר נהג...</option>
                                ${driversOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שנה סטטוס:</label>
                            <select id="statusSelect-${orderId}" class="w-full p-2 border rounded" onchange="updateOrderField('${orderId}', 'status', this.value)">
                                ${statusOptions}
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-bold mb-2">תמונות וחתימות</h4>
                        <div class="flex space-x-4 space-x-reverse">
                            ${order.photoUrl ? `<a href="${order.photoUrl}" target="_blank" class="text-blue-500 hover:underline">צפה בתמונה</a>` : '<span>אין תמונה</span>'}
                            ${order.signatureUrl ? `<a href="${order.signatureUrl}" target="_blank" class="text-blue-500 hover:underline">צפה בחתימה</a>` : '<span>אין חתימה</span>'}
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-bold mb-3">הערות לנהג / משרד</h4>
                        <div class="mb-3 max-h-40 overflow-y-auto">${commentsHtml}</div>
                        <div class="flex">
                            <input type="text" id="commentInput-${orderId}" class="flex-1 p-2 border rounded-r-md" placeholder="הוסף הערה...">
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-l-md hover:bg-blue-600" onclick="postComment('${orderId}')">שלח</button>
                        </div>
                    </div>
                `;

            } catch (error) {
                document.getElementById('modal-content').innerHTML = `<p class="text-red-500">שגיאה בטעינת נתונים: ${error.message}</p>`;
            }
        }

        function openModal() {
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modal-content').innerHTML = '';
        }

        async function updateOrderField(orderId, field, value) {
            showToast('מעדכן...');
            try {
                await apiFetch('updateOrder', 'POST', { orderId, field, value });
                showToast('הזמנה עודכנה בהצלחה.');
                // Optimistic UI update
                const order = currentOrders.find(o => o.orderId == orderId);
                if (order) {
                    order[field] = value;
                    if (field === 'status') {
                        // If status is reset, clear driver
                        if (value === 'חדש') {
                           order['driverId'] = ''; 
                           const driverSelect = document.getElementById(`driverSelect-${orderId}`);
                           if (driverSelect) driverSelect.value = '';
                        }
                    }
                }
                renderOrders(); // Re-render list
                logToServer('AdminApp', 'INFO', `Order ${orderId} field ${field} updated.`, { value });
            } catch (error) {
                showToast('שגיאה בעדכון הזמנה.', true);
            }
        }

        async function assignDriver(orderId, driverId) {
            if (!driverId) {
                showToast('בוטל שיוך.');
                await updateOrderField(orderId, 'driverId', '');
                await updateOrderField(orderId, 'status', 'חדש');
                return;
            }
            showToast('משייך נהג...');
            try {
                await apiFetch('assignDriver', 'POST', { orderId, driverId });
                showToast('נהג שויך בהצלחה.');
                // Optimistic UI update
                const order = currentOrders.find(o => o.orderId == orderId);
                if (order) {
                    order.driverId = driverId;
                    order.status = 'שויך';
                }
                renderOrders(); // Re-render list
                // Update status dropdown in modal if open
                const statusSelect = document.getElementById(`statusSelect-${orderId}`);
                if (statusSelect) {
                    statusSelect.value = 'שויך';
                }
                logToServer('AdminApp', 'INFO', `Order ${orderId} assigned to ${driverId}.`, {});
            } catch (error) {
                showToast('שגיאה בשיוך נהג.', true);
            }
        }

        async function postComment(orderId) {
            const input = document.getElementById(`commentInput-${orderId}`);
            const text = input.value.trim();
            if (!text) return;

            showToast('שולח הערה...');
            try {
                const newComment = await apiFetch('postComment', 'POST', {
                    orderId: orderId,
                    author: 'מנהל',
                    text: text
                });
                showToast('הערה נשלחה.');
                input.value = '';
                // Re-load details to show new comment
                showOrderDetails(orderId);
            } catch (error) {
                showToast('שגיאה בשליחת הערה.', true);
            }
        }

        function logPDFView(orderId) {
            logToServer('AdminApp', 'INFO', `User viewed PDF for order ${orderId}`, { orderId });
        }

        // --- Utility ---
        /**
         * v30.5: Updated to be fire-and-forget
         */
        function logToServer(origin, level, message, context = {}) {
            // Don't await, don't block UI
            apiFetch('logToServer', 'POST', {
                origin: origin,
                level: level,
                message: message,
                context: context
            }).catch(err => console.error("Silent log-to-server failed:", err)); // Log only to console
        }
        
        function startRefreshTimer() {
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(manualRefresh, REFRESH_INTERVAL);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded. v30.5");
            feather.replace(); // Initialize icons
            
            initializeMap(); // Call Leaflet map init directly
            
            loadDrivers();
            loadOrders();
            loadLiveMapData();
            
            startRefreshTimer(); // Start auto-refresh
            
            logToServer('AdminApp', 'INFO', 'Admin App v30.5 Loaded');
        });

    </script>
</body>
</html>

