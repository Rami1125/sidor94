<title>DeliveryMaster v32.0</title>
    <body class="antialiased">

    <div id="critical-error-bar">
        שגיאת תקשורת קריטית. השרת אינו מגיב כראוי.
    </div>
<script>
        // --- CONFIG & STATE ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbyGQ9NJhoY--Fl07JOtfIZKS1dS4Ujzeirf-lDcGYY9XM0ItOCgJItMwit5rIiSge_u/exec';
        
        const APP_MODULE = 'AdminDashboard';
        const APP_VERSION = '32.0'; // [AutoFix v32.0] Version updated
        const REFRESH_INTERVAL = 45000;

// ... (smartLog, flushLogQueue, error handlers remain the same) ...

        async function loadInitialData(isRefresh = false) {
            const module = 'loadInitialData';
            const statusLight = document.getElementById('server-status-light');
            
            if (!isRefresh) {
                smartLog('INFO', `v${APP_VERSION}: Loading initial dashboard data...`, { module });
                showLoader('orders-list', true);
                showLoader('drivers-list', true);
            } else {
                smartLog('INFO', `v${APP_VERSION}: Auto-refreshing data...`, { module });
            }
            
            try {
                // [AutoFix v32.0] Step 1: Check server version
                const versionData = await apiFetch('getVersion');
                if (versionData.version !== APP_VERSION) {
                    const errorMsg = `Server/Client version mismatch! Client is v${APP_VERSION}, Server is v${versionData.version}. Please refresh (Ctrl+F5).`;
                    smartLog('FATAL', errorMsg, { module });
                    const errorBar = document.getElementById('critical-error-bar');
                    errorBar.innerText = 'אי-תאימות גרסאות (לקוח/שרת). נסה לרענן את הדף.';
                    errorBar.style.display = 'block';
                    statusLight.className = 'error';
                    return; // Stop loading
                }
                
                // [AutoFix v32.0] Step 2: Load dashboard data (using the now-fixed endpoint)
                const data = await apiFetch('getDashboardData');
                
                // v31.4: Communication OK!
                statusLight.className = 'ok';
                document.getElementById('last-updated').innerText = new Date().toLocaleTimeString('he-IL');
                document.getElementById('critical-error-bar').style.display = 'none';

                state.orders = data.orders || [];
                state.drivers = data.drivers || [];
                state.customers = data.customers || [];
                state.liveLocations = data.liveLocations || {};

                renderDrivers();
                renderOrders();
                renderMapMarkers();
                populateCustomerDatalist();
                
                if (isRefresh) {
                    smartLog('INFO', 'Auto-refresh successful', { module });
                } else {
                    showLoader('map-loader', false);
                    smartLog('INFO', 'Initial data loaded and rendered', { module, count: { orders: state.orders.length, drivers: state.drivers.length } });
                }
                
            } catch (error) {
                // ... (error handling remains the same) ...
            } finally {
                // ... (finally block remains the same) ...
            }
        }

// ... (rest of admin-app/index.html script) ...
    </script>
</body>
</html>
