<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v42.0 - קוקפיט מחודש</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet-geometryutil"></script> 
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        /* v42: New Design System - Inspired by Modern Admin Dashboards */
        
        /* 1. Base & Reset */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; /* gray-200 */ }
        html { line-height: 1.5; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; direction: rtl; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { margin: 0; background-color: #f9fafb; /* bg-gray-50 */ color: #374151; /* text-gray-700 */ overflow: hidden; } /* Prevent body scroll */
        a { color: inherit; text-decoration: inherit; }
        button, input, select { font: inherit; margin: 0; padding: 0; }
        button { cursor: pointer; background-color: transparent; border: none; }
        svg { display: block; vertical-align: middle; }

        /* 2. Layout Structure */
        .app-layout { display: flex; height: 100vh; }
        .sidebar { width: 260px; background-color: #ffffff; /* bg-white */ border-left: 1px solid #e5e7eb; /* border-gray-200 */ display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-header { height: 60px; background-color: #ffffff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; flex-shrink: 0; }
        .content-wrapper { flex-grow: 1; padding: 1.5rem; overflow-y: auto; background-color: #f9fafb; /* gray-50 */ position: relative; } /* Ensure views are positioned correctly */

        /* 3. Sidebar Styling */
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .sidebar-title { font-size: 1.25rem; font-weight: 700; color: #111827; /* gray-900 */ }
        .sidebar-nav { padding: 1rem; flex-grow: 1; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; margin-bottom: 0.25rem; border-radius: 0.5rem; font-weight: 500; color: #4b5563; /* gray-600 */ transition: background-color 0.2s, color 0.2s; }
        .nav-link:hover { background-color: #f0f9ff; /* sky-50 */ color: #0369a1; /* sky-700 */ }
        .nav-link.active { background-color: #0ea5e9; /* sky-500 */ color: #ffffff; }
        .nav-link svg { width: 1.125rem; height: 1.125rem; flex-shrink: 0; }
        .nav-link span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .sidebar-footer { padding: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.8rem; color: #6b7280; /* gray-500 */ text-align: center; }

        /* 4. Header Styling */
        .connection-status { font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 9999px; }
        .status-connected { background-color: #dcfce7; /* green-100 */ color: #16a34a; /* green-600 */ }
        .status-connecting { background-color: #fef3c7; /* amber-100 */ color: #d97706; /* amber-600 */ }
        .status-error { background-color: #fee2e2; /* red-100 */ color: #dc2626; /* red-600 */ }

        /* 5. Content Area & Views */
        .app-view { 
            position: absolute; top: 1.5rem; left: 1.5rem; right: 1.5rem; bottom: 1.5rem; /* Match parent padding */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; 
            will-change: transform, opacity;
            opacity: 0; transform: translateY(10px); 
            pointer-events: none;
            display: flex; /* Allow flex children */
            flex-direction: column; /* Stack header/content */
            overflow: hidden; /* Prevent content overflow */
        }
        .app-view:not(.hidden) { 
            opacity: 1; transform: translateY(0); 
            pointer-events: auto; position: relative; /* Take space when active */
        }
         /* Ensure map fills its container when active */
        #view-map:not(.hidden) { display: block; } /* Override flex for map */
        #leaflet-map-container { flex-grow: 1; border-radius: 0.75rem; overflow: hidden; border: 1px solid #e5e7eb; }
        #leaflet-map { height: 100%; width: 100%; z-index: 10; }
        .leaflet-container { background: #e5e7eb; }

        /* 6. Table & Card Styling */
        .content-card { background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); overflow: hidden; flex-grow: 1; display: flex; flex-direction: column; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-title { font-size: 1.125rem; font-weight: 600; color: #111827; }
        .card-body { flex-grow: 1; overflow-y: auto; } /* Make table body scrollable */
        table { border-collapse: collapse; width: 100%; } 
        thead { background-color: #f9fafb; /* gray-50 */ position: sticky; top: 0; z-index: 5; } 
        th { color: #4b5563; /* gray-600 */ padding: 0.75rem 1.5rem; font-weight: 500; /* Medium weight */ text-align: right; white-space: nowrap; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; } 
        tbody { background-color: #fff; } 
        td { padding: 0.75rem 1.5rem; text-align: right; border-bottom: 1px solid #f3f4f6; /* gray-100 */ font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        td:last-child { white-space: nowrap; width: 1%; }
        tbody tr:hover { background-color: #f9fafb; /* gray-50 */ }

        /* 7. Buttons - Refined v42 */
        .btn { padding: 0.5rem 1rem; /* Slightly smaller default */ border-radius: 0.5rem; /* Standard rounding */ font-weight: 500; /* Medium weight */ cursor: pointer; transition: all 0.15s ease-out; border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; white-space: nowrap; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04); }
        .btn:active { transform: translateY(0px); box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #0ea5e9; color: white; border-color: #0ea5e9; } .btn-primary:hover { background-color: #0284c7; border-color: #0284c7; }
        .btn-secondary { background-color: #fff; color: #374151; border-color: #d1d5db; } .btn-secondary:hover { background-color: #f9fafb; border-color: #adb5bd;}
        .btn-success { background-color: #22c55e; color: white; border-color: #22c55e; } .btn-success:hover { background-color: #16a34a; border-color: #16a34a; }
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; } .btn-warning:hover { background-color: #d97706; border-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; } .btn-danger:hover { background-color: #dc2626; border-color: #dc2626; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.375rem; } /* sm rounding */
        .btn svg { width: 1em; height: 1em; } /* Size icons relative to text */

        /* 8. Forms & Filters v42 - Integrated Icon */
        .form-input { width: 100%; background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; padding: 0.6rem 1rem; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #0ea5e9; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; font-size: 0.85rem; }
        .filter-input-wrapper { position: relative; flex-shrink: 0; padding: 0 1.5rem 1rem 1.5rem; /* Padding for filter */ border-bottom: 1px solid #e5e7eb; }
        .filter-input { padding-left: 2.5rem; /* Space for icon */ height: 40px; }
        .filter-input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; width: 1.125rem; height: 1.125rem; }

        /* 9. Modals v42 */
        .modal-backdrop { /* ... same backdrop ... */ position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { width: 90%; max-width: 500px; background-color: #fff; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
        .modal-header { border-bottom: 1px solid #e5e7eb; padding: 1rem 1.5rem; }
        .modal-body { padding: 1.5rem; }
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #111827; }
        .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem; background-color: #f9fafb; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;}

        /* 10. Notification Ticker v42 */
        #notification-ticker { height: 40px; overflow: hidden; background-color: #e0f2fe; /* sky-100 */ border-bottom: 1px solid #bae6fd; /* sky-200 */ position: relative; flex-shrink: 0; cursor: default; }
        #notification-ticker ul { list-style: none; padding: 0; margin: 0; position: absolute; width: 100%; animation: ticker-scroll-v41 40s linear infinite; }
        #notification-ticker li { height: 40px; padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; color: #0369a1; /* sky-700 */ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #notification-ticker .time { font-size: 0.7rem; color: #0ea5e9; /* sky-500 */ margin-left: 1rem; flex-shrink: 0; }
        #notification-ticker .level-WARN { color: #d97706; } #notification-ticker .level-ERROR { color: #dc2626; font-weight: bold; }
        @keyframes ticker-scroll-v41 { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        #notification-ticker:hover ul { animation-play-state: paused; }

        /* Status Badges */
        .status-badge { /* ... same ... */ } .status-חדש { /* ... */ } .status-שויך { /* ... */ } .status-הושלם { /* ... */ } .status-default { /* ... */ }
        .level-INFO { /* ... */ } .level-WARN { /* ... */ } .level-ERROR { /* ... */ }
        
        /* Map Popups & Icons */
        .leaflet-popup-content { font-size: 0.8rem; } .map-popup-button { /* ... same ... */ }
        .leaflet-div-icon { /* ... same ... */ }

        /* Select Driver Modal List */
        #driver-select-list button { /* ... same ... */ }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { /* ... same ... */ apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949", storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB" };

        // --- Globals ---
        let db; let currentEditDoc = null; let mapInstance = null; let allDrivers = {}; 
        let driverMarkers = {}; let orderMarkers = {}; let currentlyDraggedOrder = null;
        let assignmentLines = {}; let notificationQueue = []; const MAX_NOTIFICATIONS = 15;

        // --- Warehouse Coordinates ---
        const WAREHOUSES = { /* ... same ... */ hatalmid: { name: "התלמיד 6", lat: 32.1860, lng: 34.9080 }, haharash: { name: "החרש 10", lat: 32.1840, lng: 34.9095 } };
        
        // --- Icons v42 ---
        const driverIconUrl = null; const orderIconUrl = null; 
        const driverSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f59e0b" width="32px" height="32px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`;
        const orderSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230ea5e9" width="32px" height="32px"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
        const driverIcon = driverIconUrl ? L.icon({ iconUrl: driverIconUrl, iconSize: [38, 38], iconAnchor: [19, 38] }) : L.divIcon({ html: driverSvg, className: 'leaflet-div-icon', iconSize: [32, 32], iconAnchor: [16, 16] }); 
        const orderIcon = orderIconUrl ? L.icon({ iconUrl: orderIconUrl, iconSize: [32, 42], iconAnchor: [16, 42] }) : L.divIcon({ html: orderSvg, className: 'leaflet-div-icon', iconSize: [32, 32], iconAnchor: [16, 32] }); 

        // --- Init App ---
        document.addEventListener('DOMContentLoaded', async () => { /* ... same init logic ... */ try{const a=initializeApp(firebaseConfig);const o=getAuth(a);db=getFirestore(a);setStatus('מתחבר...','status-connecting');await signInAnonymously(o);setStatus('מחובר','status-connected');initNavigation();initMap();listenToDrivers();listenToDriverLocations();listenToOrders();listenToCustomers();listenToSystemLogs();initFilters();renderNotifications()}catch(e){console.error("Init Error",e);setStatus(`שגיאה: ${e.message}`,'status-error')} });
        
        // --- Navigation & View Transitions ---
        function initNavigation() { /* ... same event listeners, corrected querySelector ... */ const l=document.querySelectorAll('.nav-link');l.forEach(k=>{k.addEventListener('click',(e)=>{e.preventDefault();const v=e.currentTarget.getAttribute('href').substring(1);showView(v);l.forEach(j=>j.classList.remove('active'));e.currentTarget.classList.add('active');});});const iL=document.querySelector('.nav-link[href="#view-map"]');if(iL){iL.classList.add('active');showView('view-map')}else{console.error("Initial map link not found!");showView('view-orders');const oL=document.querySelector('.nav-link[href="#view-orders"]');if(oL)oL.classList.add('active')}}
        window.currentViewId = null; 
        window.showView = (viewId) => { /* ... same transition logic ... */ if (viewId === window.currentViewId) return; const cV = window.currentViewId ? document.getElementById(window.currentViewId) : null; const tV = document.getElementById(viewId); console.log(`Switching view from ${window.currentViewId} to ${viewId}`); if (cV) { cV.classList.add('hidden'); cV.style.position = 'absolute';} if (tV) { tV.style.position = 'relative'; tV.offsetHeight; tV.classList.remove('hidden'); tV.offsetHeight; window.currentViewId = viewId; if (viewId === 'view-map' && mapInstance) { setTimeout(() => { mapInstance.invalidateSize({ animate: false }); }, 300); } } else { console.error(`Target view ${viewId} not found!`); window.currentViewId = null; } }

        // --- Real-time Listeners (READ) ---
        // (Listeners remain the same, triggering renders/notifications)
        function listenToDrivers(){/*...*/} function listenToDriverLocations(){/*...*/} function listenToOrders(){/*...*/} function listenToCustomers(){/*...*/} function listenToSystemLogs(){/*...*/}

        // --- Render Functions (v42 Filters & Styling) ---
        function initFilters() { 
             document.getElementById('filter-orders')?.addEventListener('input', renderOrdersTable);
             document.getElementById('filter-drivers')?.addEventListener('input', renderDriversTable);
             document.getElementById('filter-customers')?.addEventListener('input', renderCustomersTable); 
        }
        function renderOrdersTable() { 
            const tableBody = document.getElementById('orders-table-body'); 
            const filterInput = document.getElementById('filter-orders'); 
            const filterText = filterInput ? filterInput.value.toLowerCase() : ''; 
            const orders = (window.allOrdersData || []).filter(order => {
                if (!filterText) return true;
                return [order.id, order.customer?.name, order.driver?.name, order.status, order.address]
                       .some(field => field && field.toLowerCase().includes(filterText));
            });
            
            if (!tableBody) return; 
            if (!orders || orders.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">לא נמצאו הזמנות תואמות.</td></tr>`; 
                 return;
             }
             tableBody.innerHTML = orders.map(order => {
                const customerName = order.customer?.name || 'N/A';
                const driverName = order.driver?.name || '---';
                const status = order.status || 'חדש';
                const statusClass = `status-${status.replace(' ','_')}` || 'status-default';
                let actionsHtml = '';
                if (status === 'חדש') actionsHtml = `<button class="btn btn-warning btn-sm" onclick="openSelectDriverModal('${order.id}')">שבץ</button>`;
                else if (status === 'שויך') actionsHtml = `<button class="btn btn-success btn-sm" onclick="handleMarkAsCompleted('${order.id}')">הושלם</button>`;
                
                // Use optional chaining ?. safely
                const editButtonData = window.allOrders && window.allOrders[order.id] ? JSON.stringify(window.allOrders[order.id]) : '{}';

                return `<tr class="hover:bg-gray-100 text-sm">
                            <td class="p-3">${order.id.slice(-6)}</td>
                            <td class="p-3 font-semibold">${customerName}</td>
                            <td class="p-3">${order.address || 'N/A'}</td>
                            <td class="p-3 font-semibold">${driverName}</td>
                            <td class="p-3"><span class="status-badge ${statusClass}">${status}</span></td>
                            <td class="p-3 flex gap-2">
                                ${actionsHtml}
                                <button class="btn btn-secondary btn-sm" onclick='openEditOrderModal(${JSON.stringify(editButtonData)})'>ערוך</button>
                                <button class="btn btn-danger btn-sm" onclick="handleDelete('orders','${order.id}')">מחק</button>
                            </td>
                        </tr>`;
            }).join('');
             // Update global state AFTER rendering
             window.allOrders = orders.reduce((acc, order) => { acc[order.id] = order; return acc; }, {});
        }

        function renderDriversTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('drivers-table-body'); const filterInput = document.getElementById('filter-drivers'); const f = filterInput ? filterInput.value.toLowerCase() : ''; const d=Object.values(allDrivers||{}).filter(v=>{if(!f)return!0;const n=v.name||'';const p=v.phone||'';const s=v.status||'';const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||s.toLowerCase().includes(f)||i.toLowerCase().includes(f)});if(!t)return;t.innerHTML=d.map(v=>{const i=Object.keys(allDrivers).find(k=>allDrivers[k]===v)||'N/A';return`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${v.name||i}</td><td class="p-3">${v.phone||'---'}</td><td class="p-3">${v.vehicleType||'לא ידוע'}</td><td class="p-3">${v.status||'לא פעיל'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('drivers','${i}')">מחק</button></td></tr>`}).join('')}
        function renderCustomersTable() { /* ... same filtering and rendering ... */ const t=document.getElementById('customers-table-body'); const filterInput = document.getElementById('filter-customers'); const f = filterInput ? filterInput.value.toLowerCase() : ''; const c=(window.allCustomersData||[]).filter(u=>{if(!f)return!0;const n=u.name||'';const p=u.phone||'';const a=u.defaultAddress||'';return n.toLowerCase().includes(f)||p.toLowerCase().includes(f)||a.toLowerCase().includes(f)});if(!t)return;t.innerHTML=c.map(u=>`<tr class="hover:bg-gray-100 text-sm"><td class="p-3 text-gray-800 font-semibold">${u.name||u.id}</td><td class="p-3">${u.phone||'---'}</td><td class="p-3">${u.defaultAddress||'---'}</td><td class="p-3">${u.contactPerson||'---'}</td><td class="p-3 flex gap-2"><button class="btn btn-danger btn-sm" onclick="handleDelete('customers','${u.id}')">מחק</button></td></tr>`).join('')}
        function renderLogsTable() { /* ... same rendering ... */ const t=document.getElementById('logs-table-body');if(!t)return;const l=window.allLogsData||[];t.innerHTML=l.map(g=>{const v=g.level||'INFO';const i=g.timestamp?.toDate().toLocaleString('he-IL')||'---';return`<tr class="hover:bg-gray-100 text-sm font-mono"><td class="p-3 text-gray-500">${i}</td><td class="p-3 font-bold level-${v}">${v}</td><td class="p-3 text-cyan-500">[${g.origin||'N/A'}]</td><td class="p-3 text-gray-800">${g.message||'---'}</td><td class="p-3 text-xs text-gray-500">${g.data||''}</td></tr>`}).join('')}
        function setStatus(message, cssClass) { /* ... same ... */ const el=document.getElementById('connection-status'); if(el) { el.textContent=message; el.className=`connection-status ${cssClass}`; } } // Use base class

        // --- Map Functions ---
        window.initMap = () => { /* ... same init with zoom 9 ... */ const e=document.getElementById('leaflet-map');if(!e){console.error("Map container #leaflet-map not found!");return}try{if(typeof L==='undefined'){console.error("Leaflet (L) not defined.");setStatus('שגיאה בטעינת מפת','status-error');return}if(!mapInstance){mapInstance=L.map(e,{zoomControl:true}).setView([31.7683,35.2137],9);L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:19}).addTo(mapInstance);mapInstance.on('load',()=>{console.log("Map initialized.");setStatus('מחובר | מפה טעונה','status-connected')});mapInstance.on('tileerror',(e)=>{console.error('Tile error:',e);setStatus('שגיאת אריחי מפה','status-error')})}else{mapInstance.invalidateSize()}}catch(e){console.error("Map init failed:",e);e.innerHTML=`<div class="p-4 text-center text-red-500">Map Error: ${e.message}</div>`;setStatus('שגיאה קריטית במפה','status-error')} }
        
        function updateDriverMarker(driverId, locationData) { /* ... same logic ... */ if(!mapInstance||!locationData.latitude||!locationData.longitude)return;const l=[locationData.latitude,locationData.longitude];const n=allDrivers[driverId]?.name||driverId;const p=`<b>נהג: ${n}</b><br>עודכן: ${locationData.lastUpdate?.toDate().toLocaleTimeString('he-IL')||'N/A'}`;if(driverMarkers[driverId])driverMarkers[driverId].setLatLng(l).setPopupContent(p);else{driverMarkers[driverId]=L.marker(l,{icon:driverIcon,draggable:!1}).addTo(mapInstance).bindPopup(p);driverMarkers[driverId]._driverInfo={id:driverId,name:n}}}
        
        function updateOrderMarkers(orders) { /* ... same logic including distance & warning... */ if(!mapInstance)return;const c=orders.map(o=>o.id);Object.keys(orderMarkers).forEach(m=>{if(!c.includes(m)){mapInstance.removeLayer(orderMarkers[m]);delete orderMarkers[m]}});let w=0;orders.forEach(o=>{if(!o.latitude||!o.longitude){if(o.status!=='הושלם')w++;if(orderMarkers[o.id]){mapInstance.removeLayer(orderMarkers[o.id]);delete orderMarkers[o.id]}return}if(o.status!=='הושלם'){const l=[o.latitude,o.longitude];const t=L.GeometryUtil.distance(mapInstance,l,[WAREHOUSES.hatalmid.lat,WAREHOUSES.hatalmid.lng]);const h=L.GeometryUtil.distance(mapInstance,l,[WAREHOUSES.haharash.lat,WAREHOUSES.haharash.lng]);const k=(t/1e3).toFixed(1);const r=(h/1e3).toFixed(1);const p=`<b>${o.customer?.name||'לקוח'}</b> (${o.id.slice(-4)})<br>${o.address}<br>סטטוס: ${o.status}<hr class="my-1 border-gray-200">מרחק מהתלמיד: ${k} ק"מ<br>מרחק מהחרש: ${r} ק"מ`+(o.status==='חדש'?`<br><button class="map-popup-button" onclick="openSelectDriverModal('${o.id}')">שבץ מרשימה</button>`:'');const i=o.id;const d=o.status==='חדש';if(orderMarkers[i]){orderMarkers[i].setLatLng(l).setPopupContent(p);if(d&&!orderMarkers[i].dragging.enabled())orderMarkers[i].dragging.enable();else if(!d&&orderMarkers[i].dragging.enabled())orderMarkers[i].dragging.disable()}else{orderMarkers[i]=L.marker(l,{icon:orderIcon,draggable:d}).addTo(mapInstance).bindPopup(p,{minWidth:200});orderMarkers[i]._orderData=o;orderMarkers[i].on('dragstart',()=>{currentlyDraggedOrder=o});orderMarkers[i].on('dragend',handleOrderDrop)}}else if(orderMarkers[o.id]){mapInstance.removeLayer(orderMarkers[o.id]);delete orderMarkers[o.id]}});if(w>0){console.warn(`${w} active orders missing coords.`);addNotification(`${w} הזמנות ללא מיקום במפה`,'WARN')}}
        
        // --- Drag & Drop ---
        function handleOrderDrop(event) { /* ... same ... */ if (!currentlyDraggedOrder) return; const m = event.target; const l = m.getLatLng(); const THRESHOLD = 50; let closest = null; let minDist = Infinity; Object.keys(driverMarkers).forEach(dId => { const dM = driverMarkers[dId]; const dist = l.distanceTo(dM.getLatLng()); if (dist < minDist) { minDist = dist; closest = { id: dId, name: allDrivers[dId]?.name || dId, marker: dM }; } }); if (closest && minDist <= THRESHOLD) { openConfirmAssignModal(currentlyDraggedOrder.id, closest.id, currentlyDraggedOrder.customer?.name || '?', closest.name); } else { m.setLatLng([currentlyDraggedOrder.latitude, currentlyDraggedOrder.longitude]); alert("לא נמצא נהג קרוב מספיק."); } currentlyDraggedOrder = null; }
        
        // --- CRUD ---
        window.openAddOrderModal = () => { /* ... */ }
        window.openEditOrderModal = (orderJsonString) => { 
             try {
                 // v42: Safely parse JSON
                 const orderData = JSON.parse(orderJsonString || '{}');
                 openEditOrderModalLogic(orderData);
             } catch (e) {
                 console.error("Error parsing order data for edit modal:", e, orderJsonString);
                 alert("שגיאה בפתיחת עריכה: נתונים לא תקינים.");
             }
        }
        function openEditOrderModalLogic(order) { /* Actual logic from previous openEditOrderModal */ currentEditDoc = order; const form = document.getElementById('addOrderForm'); form.customerName.value = order.customer?.name || ''; form.customerPhone.value = order.customer?.phone || ''; form.address.value = order.address || ''; form.latitude.value = order.latitude || ''; form.longitude.value = order.longitude || ''; form.deliveryType.value = order.deliveryType || ''; form.customerId.value = order.customer?.id || ''; document.getElementById('addOrderModalTitle').textContent = `עריכת הזמנה ${order.id.slice(-6)}`; document.getElementById('addOrderModal').style.display = 'flex'; }
        window.openAssignDriverModal = (orderId) => { /* ... */ }
        window.openConfirmAssignModal = (orderId, driverId, customerName, driverName) => { /* ... */ }
        window.openSelectDriverModal = (orderId) => { /* ... */ }
        window.closeModal = (modalId) => { /* ... */ }
        window.handleSaveOrder = async () => { /* ... same logic ... */ };
        window.handleAssignDriver = async (orderId, driverId, driverName) => { /* ... same logic + notification ... */ }
        window.handleConfirmAssign = (orderId, driverId, driverName) => { handleAssignDriver(orderId, driverId, driverName); }
        window.handleMarkAsCompleted = async (orderId) => { /* ... same logic + notification ... */ }
        window.handleDelete = async (collectionName, docId) => { /* ... same logic + notification ... */ }
        
        // --- Assignment Line ---
        function drawAssignmentLine(orderId, driverId) { /* ... same ... */ }
        function removeAssignmentLine(orderId) { /* ... same ... */ }

         // --- Notification Ticker ---
         function addNotification(message, level = 'INFO') { /* ... same queue logic ... */ const timestamp = new Date(); notificationQueue.unshift({ message, level, timestamp }); if (notificationQueue.length > MAX_NOTIFICATIONS) notificationQueue.pop(); renderNotifications(); }
         function renderNotifications() { /* ... same rendering + animation restart ... */ 
             const tickerList = document.getElementById('notification-ticker-list'); if (!tickerList) return;
             const currentQueue = Array.isArray(notificationQueue) ? notificationQueue : [];
             tickerList.innerHTML = currentQueue.map(n => `<li class="level-${n.level}"><span>${n.message}</span><span class="time">${n.timestamp.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</span></li>`).join('');
             const ticker = document.getElementById('notification-ticker'); 
             if (ticker) { const ul = ticker.querySelector('ul'); if (ul) { ul.style.animation = 'none'; ul.offsetHeight; if (ul.scrollHeight > ticker.offsetHeight && currentQueue.length > 1) { const duration = currentQueue.length * 3; ul.style.animation = `ticker-scroll-v41 ${duration}s linear infinite`; } else { ul.style.animation = ''; ul.style.transform = 'translateY(0)'; } } }
         }
         // Initial render moved inside DOMContentLoaded

        // --- Attach handlers ---
        window.handleMarkAsCompleted = handleMarkAsCompleted;
        window.handleDelete = handleDelete; 

    </script>
</head>
<body class="h-screen overflow-hidden bg-gray-50"> {/* Changed body bg slightly */}

    <div class="app-layout">
        
        <!-- Sidebar -->
        <aside class="sidebar p-4 flex flex-col justify-between">
             <!-- Sidebar content -->
             <div> 
                 <div class="sidebar-header">
                     <span class="sidebar-title">ח. סבן <span class="text-sm font-normal text-sky-500">v42.0</span></span>
                 </div>
                 <nav class="sidebar-nav space-y-1"> {/* Reduced space */}
                    <a href="#view-map" class="nav-link"> <svg>...</svg> <span>חדר מצב</span> </a>
                    <a href="#view-orders" class="nav-link"> <svg>...</svg> <span>הזמנות</span> </a>
                    <a href="#view-drivers" class="nav-link"> <svg>...</svg> <span>נהגים</span> </a>
                    <a href="#view-customers" class="nav-link"> <svg>...</svg> <span>לקוחות</span> </a>
                    <a href="#view-logs" class="nav-link"> <svg>...</svg> <span>לוגים</span> </a> 
                 </nav> 
             </div> 
             <div id="connection-status" class="sidebar-footer"> טוען... </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Notification Ticker -->
            <div id="notification-ticker" class="flex-shrink-0">
                 <ul id="notification-ticker-list">
                      <li><span class="time">--:--</span><span>מערכת v42.0 טוענת...</span></li>
                 </ul>
            </div>

            <!-- Main Content Area (Views container) -->
            <div class="main-content-area flex-grow overflow-hidden">
                <!-- View 1: Map (Default) -->
                <div id="view-map" class="app-view hidden h-full"> {/* Start hidden, shown by JS */}
                    <div id="leaflet-map-container" class="h-full"> <div id="leaflet-map"></div> </div>
                </div>

                <!-- View 2: Orders Table -->
                <div id="view-orders" class="app-view hidden h-full flex flex-col"> 
                     <div class="card-header flex-shrink-0"> 
                         <h2 class="card-title">ניהול הזמנות</h2> 
                         <button class="btn btn-primary btn-sm" onclick="openAddOrderModal()"> + הוסף הזמנה </button> 
                     </div>
                     <div class="filter-input-wrapper flex-shrink-0"> 
                        <span class="filter-input-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></span> 
                        <input type="text" id="filter-orders" class="filter-input" placeholder="חיפוש..."> 
                     </div>
                     <div class="card-body flex-grow overflow-hidden"> 
                         <div class="h-full overflow-y-auto">
                            <table class="w-full min-w-full text-right"> 
                                <thead class="sticky top-0 bg-gray-50 z-10">...</thead> 
                                <tbody id="orders-table-body" class="divide-y divide-gray-200"></tbody> 
                            </table> 
                         </div>
                     </div>
                </div>

                 <!-- View 3: Drivers Table -->
                <div id="view-drivers" class="app-view hidden h-full flex flex-col">
                     <div class="card-header flex-shrink-0"> <h2 class="card-title">ניהול נהגים</h2> </div>
                     <div class="filter-input-wrapper flex-shrink-0"> 
                         <span class="filter-input-icon"><svg>...</svg></span> 
                         <input type="text" id="filter-drivers" class="filter-input" placeholder="חיפוש..."> 
                     </div>
                     <div class="card-body flex-grow overflow-hidden"> <div class="h-full overflow-y-auto"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="drivers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
                
                <!-- View 4: Customers Table -->
                 <div id="view-customers" class="app-view hidden h-full flex flex-col">
                     <div class="card-header flex-shrink-0"> <h2 class="card-title">ניהול לקוחות</h2> </div>
                     <div class="filter-input-wrapper flex-shrink-0"> 
                        <span class="filter-input-icon"><svg>...</svg></span> 
                        <input type="text" id="filter-customers" class="filter-input" placeholder="חיפוש..."> 
                    </div>
                     <div class="card-body flex-grow overflow-hidden"> <div class="h-full overflow-y-auto"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="customers-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
                
                <!-- View 5: Logs Table -->
                 <div id="view-logs" class="app-view hidden h-full flex flex-col">
                     <div class="card-header flex-shrink-0"> <h2 class="card-title">צג לוגים</h2> </div>
                     <div class="card-body flex-grow overflow-hidden"> <div class="h-full overflow-y-auto"> <table class="w-full min-w-full text-right"> <thead class="sticky top-0 bg-gray-50 z-10">...</thead> <tbody id="logs-table-body" class="divide-y divide-gray-200"></tbody> </table> </div> </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modals (Structure refined) -->
    <div id="addOrderModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 id="addOrderModalTitle" class="modal-title">...</h2></div> <div class="modal-body"><form id="addOrderForm">...</form></div> </div> </div>
    <div id="assignDriverModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">שיבוץ נהג</h2></div> <div class="modal-body"><form>...</form></div> </div> </div>
    <div id="confirmAssignModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">אישור שיבוץ</h2></div> <div class="modal-body"><p id="confirmAssignText">...</p></div> <div class="modal-footer">...</div> </div> </div>
    <div id="selectDriverModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">בחר נהג לשיבוץ</h2></div> <div class="modal-body"><div id="driver-select-list" class="max-h-60 overflow-y-auto">...</div></div> <div class="modal-footer">...</div> </div> </div>

</body>
</html>

