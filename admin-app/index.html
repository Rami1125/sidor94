<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v43.0 - קוקפיט (תבנית חדשה)</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet-geometryutil"></script> 
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        /* v43: New Design System - Clean & Modern Admin Template */
        
        /* 1. Base & Reset */
        :root {
            --primary-color: #0ea5e9; /* sky-500 */
            --primary-hover-color: #0284c7; /* sky-600 */
            --secondary-color: #64748b; /* slate-500 */
            --light-bg: #f8fafc; /* slate-50 */
            --white-bg: #ffffff;
            --border-color: #e2e8f0; /* slate-200 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #64748b; /* slate-500 */
            --text-muted: #94a3b8; /* slate-400 */
            --danger-color: #ef4444; /* red-500 */
            --warning-color: #f59e0b; /* amber-500 */
            --success-color: #22c55e; /* green-500 */
            --font-family: 'Inter', system-ui, sans-serif;
        }
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: var(--border-color); }
        html { line-height: 1.5; font-family: var(--font-family); direction: rtl; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }
        body { margin: 0; background-color: var(--light-bg); color: var(--text-primary); overflow: hidden; }
        a { color: inherit; text-decoration: inherit; }
        button, input, select { font: inherit; margin: 0; padding: 0; }
        button { cursor: pointer; background-color: transparent; border: none; }
        svg { display: block; vertical-align: middle; }
        .hidden { display: none !important; }

        /* 2. Layout Structure */
        .app-layout { display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: var(--white-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); z-index: 20; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        /* Removed main-header, integrated ticker below */
        .content-wrapper { flex-grow: 1; /* padding: 1.5rem; */ /* Removed padding, views will handle it */ overflow-y: auto; background-color: var(--light-bg); position: relative; }

        /* 3. Sidebar Styling */
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-title { font-size: 1.15rem; font-weight: 600; color: var(--text-primary); }
        .sidebar-version { font-size: 0.75rem; color: var(--primary-color); font-weight: 500; margin-right: 0.5rem; }
        .sidebar-nav { padding: 1rem; flex-grow: 1; overflow-y: auto; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 1rem; margin-bottom: 0.25rem; border-radius: 0.375rem; font-weight: 500; color: var(--text-secondary); transition: background-color 0.15s, color 0.15s; }
        .nav-link:hover { background-color: #f0f9ff; color: #0369a1; }
        .nav-link.active { background-color: var(--primary-color); color: var(--white-bg); }
        .nav-link svg { width: 1.1rem; height: 1.1rem; flex-shrink: 0; }
        .nav-link span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-muted); text-align: center; }

        /* 4. Connection Status (now in footer) */
        .connection-status { font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 500; display: inline-block; /* Allow centering */ }
        .status-connected { background-color: #dcfce7; color: #15803d; }
        .status-connecting { background-color: #fef3c7; color: #b45309; }
        .status-error { background-color: #fee2e2; color: #b91c1c; }

        /* 5. Content Area & Views */
        .app-view { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; /* Cover the wrapper */
            padding: 1.5rem; 
            transition: opacity 0.3s ease-out; /* Simpler transition */
            opacity: 0; 
            pointer-events: none;
            display: flex; flex-direction: column; 
            overflow: hidden; 
            background-color: var(--light-bg); /* Ensure background */
        }
        .app-view:not(.hidden) { 
            opacity: 1; 
            pointer-events: auto; 
            position: relative; /* Take space */
            z-index: 1; /* Ensure active view is on top */
        }
        #view-map { padding: 0; } 
        #leaflet-map-container { flex-grow: 1; border-radius: 0.75rem; overflow: hidden; border: 1px solid var(--border-color); }
        #leaflet-map { height: 100%; width: 100%; z-index: 1; } /* Lower z-index for map */
        .leaflet-container { background: #e2e8f0; }

        /* 6. Table & Card Styling */
        .content-card { background-color: var(--white-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); overflow: hidden; flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .card-body { flex-grow: 1; overflow-y: auto; }
        table { border-collapse: collapse; width: 100%; } 
        thead { background-color: #f8fafc; position: sticky; top: 0; z-index: 5; } 
        th { color: var(--text-secondary); padding: 0.75rem 1.5rem; font-weight: 500; text-align: right; white-space: nowrap; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-color); } 
        tbody { background-color: var(--white-bg); } 
        td { padding: 0.75rem 1.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }
        td:last-child { white-space: nowrap; width: auto; /* Allow actions to wrap if needed, adjust column width */ }
        tbody tr:hover { background-color: #f8fafc; }

        /* 7. Buttons - Refined v43 */
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease-out; border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; white-space: nowrap; line-height: 1.25rem; font-size: 0.875rem; }
        .btn:hover { filter: brightness(1.05); }
        .btn:active { transform: scale(0.98); box-shadow: inset 0 1px 1px 0 rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); } .btn-primary:hover { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); }
        .btn-secondary { background-color: var(--white-bg); color: var(--text-secondary); border-color: #cbd5e1; } .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; color: var(--text-primary); }
        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); } .btn-success:hover { background-color: #16a34a; border-color: #15803d; }
        .btn-warning { background-color: var(--warning-color); color: white; border-color: var(--warning-color); } .btn-warning:hover { background-color: #d97706; border-color: #b45309; }
        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); } .btn-danger:hover { background-color: #dc2626; border-color: #b91c1c; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
        .btn svg { width: 1rem; height: 1rem; }

        /* 8. Forms & Filters v43 - Enhanced */
        .form-input { width: 100%; background-color: var(--white-bg); border: 1px solid #cbd5e1; color: var(--text-primary); padding: 0.6rem 0.75rem; border-radius: 0.375rem; transition: border-color 0.2s, box-shadow 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15); outline: none; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); font-size: 0.8rem; }
        .filter-input-wrapper { position: relative; flex-shrink: 0; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); background-color: var(--white-bg); /* Match card header */ }
        .filter-input { padding-left: 2.5rem; height: 38px; font-size: 0.9rem; background-color: var(--light-bg); border-radius: 0.375rem; border: 1px solid var(--border-color); }
        .filter-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15); outline: none; background-color: var(--white-bg); }
        .filter-input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; width: 1rem; height: 1rem; }

        /* 9. Modals v43 */
        .modal-backdrop { /* ... same backdrop ... */ }
        .modal-content { /* ... same shape ... */ }
        .modal-header { border-bottom: 1px solid var(--border-color); padding: 1rem 1.5rem; }
        .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; } /* Allow modal scroll */
        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; border-top: 1px solid var(--border-color); padding: 1rem 1.5rem; background-color: var(--light-bg); border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;}

        /* 10. Notification Ticker v43 */
        #notification-ticker { height: 36px; overflow: hidden; background-color: #f0f9ff; border-bottom: 1px solid #e0f2fe; position: relative; flex-shrink: 0; cursor: default; }
        #notification-ticker ul { list-style: none; padding: 0; margin: 0; position: absolute; width: 100%; animation: ticker-scroll-v41 40s linear infinite; }
        #notification-ticker li { height: 36px; padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; color: #075985; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #notification-ticker .time { font-size: 0.7rem; color: #38bdf8; margin-left: 1rem; flex-shrink: 0; }
        #notification-ticker .level-WARN { color: #b45309; } #notification-ticker .level-ERROR { color: #b91c1c; font-weight: 500; }
        @keyframes ticker-scroll-v41 { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        #notification-ticker:hover ul { animation-play-state: paused; }

        /* Status Badges */
        .status-badge { /* ... same ... */ } .status-חדש { /* ... */ } .status-שויך { /* ... */ } .status-הושלם { /* ... */ } .status-default { /* ... */ }
        .level-INFO { /* ... */ } .level-WARN { /* ... */ } .level-ERROR { /* ... */ }
        
        /* Map Popups & Icons */
        .leaflet-popup-content { font-size: 0.8rem; } .map-popup-button { /* ... same ... */ }
        .leaflet-div-icon { /* ... same ... */ }

        /* Select Driver Modal List */
        #driver-select-list button { /* ... same ... */ }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { /* ... same ... */ apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949", storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB" };

        // --- Globals ---
        let db; let currentEditDoc = null; let mapInstance = null; let allDrivers = {}; 
        let driverMarkers = {}; let orderMarkers = {}; let currentlyDraggedOrder = null;
        let assignmentLines = {}; let notificationQueue = []; const MAX_NOTIFICATIONS = 15;

        // --- Warehouse Coordinates ---
        const WAREHOUSES = { /* ... same ... */ hatalmid: { name: "התלמיד 6", lat: 32.1860, lng: 34.9080 }, haharash: { name: "החרש 10", lat: 32.1840, lng: 34.9095 } };
        
        // --- Icons v43 ---
        const driverIconUrl = null; 
        const orderIconUrl = null; 
        const driverSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f59e0b" width="36px" height="36px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`; 
        const orderSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230ea5e9" width="36px" height="36px"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
        const driverIcon = driverIconUrl ? L.icon({ iconUrl: driverIconUrl, iconSize: [42, 42], iconAnchor: [21, 42] }) : L.divIcon({ html: driverSvg, className: 'leaflet-div-icon', iconSize: [36, 36], iconAnchor: [18, 18] }); 
        const orderIcon = orderIconUrl ? L.icon({ iconUrl: orderIconUrl, iconSize: [36, 46], iconAnchor: [18, 46] }) : L.divIcon({ html: orderSvg, className: 'leaflet-div-icon', iconSize: [36, 36], iconAnchor: [18, 36] }); 

        // --- Init App ---
        document.addEventListener('DOMContentLoaded', async () => { 
            try { 
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                setStatus('מתחבר...', 'status-connecting'); 
                await signInAnonymously(auth);
                setStatus('מחובר', 'status-connected'); 
                initNavigation(); 
                initMap(); 
                listenToDrivers();
                listenToDriverLocations();
                listenToOrders();
                listenToCustomers();
                listenToSystemLogs();
                initFilters();
                renderNotifications(); 
            } catch (error) { 
                console.error("Init Error", error); 
                setStatus(`שגיאה: ${error.message}`, 'status-error'); 
            } 
        });
        
        // --- Navigation & View Transitions ---
        function initNavigation() { 
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => { 
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const viewId = e.currentTarget.getAttribute('href').substring(1); 
                    showView(viewId); 
                    navLinks.forEach(l => l.classList.remove('active')); 
                    e.currentTarget.classList.add('active'); 
                }); 
            });
            const initialLink = document.querySelector('.nav-link[href="#view-map"]');
            if (initialLink) { 
                initialLink.classList.add('active'); 
                // Ensure map view is shown initially without transition delay
                const targetView = document.getElementById('view-map');
                if(targetView) {
                    targetView.classList.remove('hidden');
                    targetView.style.opacity = '1';
                    targetView.style.transform = 'translateY(0)';
                    targetView.style.pointerEvents = 'auto';
                     targetView.style.position = 'relative'; // Make sure it takes space
                    window.currentViewId = 'view-map';
                    // Delay map init slightly to ensure container is rendered
                    setTimeout(initMap, 50); 
                } else {
                     console.error("Map view container not found on init!");
                }

            } else { 
                console.error("Initial map link not found!"); 
                showView('view-orders'); 
                const ol = document.querySelector('.nav-link[href="#view-orders"]'); 
                if (ol) ol.classList.add('active');
            }
        }
        
        window.currentViewId = null; 
        window.showView = (viewId) => { 
             if (viewId === window.currentViewId) return; 
             const currentView = window.currentViewId ? document.getElementById(window.currentViewId) : null;
             const targetView = document.getElementById(viewId); 
             console.log(`Switching view from ${window.currentViewId} to ${viewId}`); 
             
             // Hide current view immediately
             if (currentView) { 
                 currentView.style.opacity = '0';
                 currentView.style.transform = 'translateY(10px)';
                 currentView.style.pointerEvents = 'none';
                 // Use setTimeout to add hidden class after transition
                 setTimeout(() => {
                    if(window.currentViewId !== viewId) { // Check if view hasn't changed again quickly
                        currentView.classList.add('hidden');
                        currentView.style.position = 'absolute'; // Keep it out of flow when hidden
                    }
                 }, 300); // Match transition duration
             } 
             
             if (targetView) {
                 // Prepare target view (remove hidden, set initial state for transition)
                 targetView.style.position = 'relative'; // Ensure it takes space
                 targetView.classList.remove('hidden'); 
                 targetView.offsetHeight; // Force reflow
                 
                 // Start transition
                 targetView.style.opacity = '1';
                 targetView.style.transform = 'translateY(0)';
                 targetView.style.pointerEvents = 'auto';

                 window.currentViewId = viewId; 

                 // Handle map invalidate after transition
                 if (viewId === 'view-map' && mapInstance) { 
                     setTimeout(() => { 
                         console.log("Invalidating map size");
                         mapInstance.invalidateSize({ animate: false }); 
                     }, 350); // Delay slightly more than transition
                 }
             } else { 
                 console.error(`Target view ${viewId} not found!`); 
                 window.currentViewId = null; 
             } 
        }


        // --- Real-time Listeners (READ) ---
        // (Listeners remain the same)
        function listenToDrivers(){/*...*/} function listenToDriverLocations(){/*...*/} function listenToOrders(){/*...*/} function listenToCustomers(){/*...*/} function listenToSystemLogs(){/*...*/}

        // --- Render Functions (v43 Filters & Styling) ---
        function initFilters() { /* ... same ... */ }
        function renderOrdersTable() { /* ... same ... */ }
        function renderDriversTable() { /* ... same ... */ }
        function renderCustomersTable() { /* ... same ... */ }
        function renderLogsTable() { /* ... same ... */ }
        function setStatus(message, cssClass) { /* ... same ... */ }

        // --- Map Functions ---
        window.initMap = () => { 
            const mapElement = document.getElementById('leaflet-map');
            if (!mapElement) { console.error("Map container #leaflet-map not found!"); return; }
            try { 
                if (typeof L === 'undefined') { console.error("Leaflet (L) not defined."); setStatus('שגיאת מפה', 'status-error'); return; }
                if (!mapInstance) { 
                    mapInstance = L.map(mapElement, { zoomControl: true }).setView([31.7683, 35.2137], 9); 
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance); 
                    mapInstance.whenReady(() => { // Use whenReady for better timing
                        console.log("Map initialized and ready."); 
                        setStatus('מחובר', 'status-connected'); 
                    });
                    mapInstance.on('tileerror', (e) => { console.error('Tile error:', e); setStatus('שגיאת מפה', 'status-error'); });
                } else { 
                    console.log("Map already initialized, invalidating size.");
                    mapInstance.invalidateSize(); // Invalidate size if exists
                } 
            } catch (e) { 
                console.error("Map init failed:", e); 
                mapElement.innerHTML = `<div class="p-4 text-center text-red-500">Map Error: ${e.message}</div>`; 
                setStatus('שגיאת מפה', 'status-error'); 
            } 
        }
        
        function updateDriverMarker(driverId, locationData) { /* ... same logic ... */ }
        function updateOrderMarkers(orders) { /* ... same logic ... */ }
        
        // --- Drag & Drop ---
        function handleOrderDrop(event) { /* ... same ... */ }
        
        // --- CRUD ---
        window.openAddOrderModal = () => { /* ... */ }
        window.openEditOrderModal = (orderJsonString) => { /* ... */ }
        window.openAssignDriverModal = (orderId) => { /* ... */ }
        window.openConfirmAssignModal = (orderId, driverId, customerName, driverName) => { /* ... */ }
        window.openSelectDriverModal = (orderId) => { /* ... */ }
        window.closeModal = (modalId) => { /* ... */ }
        window.handleSaveOrder = async () => { /* ... same logic ... */ };
        window.handleAssignDriver = async (orderId, driverId, driverName) => { /* ... same logic + notification ... */ }
        window.handleConfirmAssign = (orderId, driverId, driverName) => { handleAssignDriver(orderId, driverId, driverName); }
        window.handleMarkAsCompleted = async (orderId) => { /* ... same logic + notification ... */ }
        window.handleDelete = async (collectionName, docId) => { /* ... same logic + notification ... */ }
        
        // --- Assignment Line ---
        function drawAssignmentLine(orderId, driverId) { /* ... same ... */ }
        function removeAssignmentLine(orderId) { /* ... same ... */ }

         // --- Notification Ticker ---
         function addNotification(message, level = 'INFO') { /* ... same queue logic ... */ }
         function renderNotifications() { /* ... same rendering + animation restart ... */ }
         // Initial render moved inside DOMContentLoaded

        // --- Attach handlers ---
        window.handleMarkAsCompleted = handleMarkAsCompleted;
        window.handleDelete = handleDelete; 

    </script>
</head>
<body class="h-screen overflow-hidden bg-gray-50"> 

    <div class="app-layout">
        
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col justify-between">
             <!-- Sidebar content -->
             <div> 
                 <div class="sidebar-header">
                     <span class="sidebar-title">ח. סבן <span class="sidebar-version">v43.0</span></span>
                 </div>
                 <nav class="sidebar-nav space-y-1"> 
                    {/* SVG Icons for better clarity */}
                    <a href="#view-map" class="nav-link"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m0 0v2.25m0-2.25h1.5M9 15H7.5m1.5-6.75V4.5m0 2.25H7.5M15 12m-3 0a3 3 0 116 0 3 3 0 01-6 0z" /></svg>
                        <span>חדר מצב</span> 
                    </a>
                    <a href="#view-orders" class="nav-link"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                        <span>הזמנות</span> 
                    </a>
                    <a href="#view-drivers" class="nav-link"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0z" /></svg>
                        <span>נהגים</span> 
                    </a>
                    <a href="#view-customers" class="nav-link"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.94-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.06-3.172m10.12 0A5.97 5.97 0 0012 9.75a5.97 5.97 0 00-5.06 3.001m10.12 0L17.25 12A2.25 2.25 0 0015 9.75V6.75a2.25 2.25 0 00-2.25-2.25H11.25a2.25 2.25 0 00-2.25 2.25v3a2.25 2.25 0 002.25 2.25m6.75 0L18 18.72m-3.75-6.75a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0z" /></svg>
                        <span>לקוחות</span> 
                    </a>
                    <a href="#view-logs" class="nav-link"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 6.75h16.5" /></svg>
                        <span>לוגים</span> 
                    </a> 
                 </nav> 
             </div> 
             <div id="connection-status" class="sidebar-footer"> טוען... </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Notification Ticker -->
            <div id="notification-ticker" class="flex-shrink-0">
                 <ul id="notification-ticker-list">
                      <li><span class="time">--:--</span><span>מערכת v43.0 טוענת...</span></li>
                 </ul>
            </div>

            <!-- Main Content Area (Views container) -->
            <div class="content-wrapper">
                <!-- View 1: Map (Default) -->
                <div id="view-map" class="app-view hidden h-full"> 
                    <div id="leaflet-map-container" class="h-full"> <div id="leaflet-map"></div> </div>
                </div>

                <!-- View 2: Orders Table -->
                <div id="view-orders" class="app-view hidden h-full flex flex-col"> 
                    <div class="content-card flex-grow overflow-hidden"> 
                          <div class="card-header">
                             <h2 class="card-title">ניהול הזמנות</h2> 
                             <button class="btn btn-primary btn-sm" onclick="openAddOrderModal()"> + הוסף הזמנה </button> 
                          </div>
                           <div class="filter-input-wrapper flex-shrink-0"> 
                                <span class="filter-input-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></span> 
                                <input type="text" id="filter-orders" class="filter-input" placeholder="חיפוש הזמנה..."> 
                            </div>
                         <div class="card-body overflow-y-auto">
                            <table class="w-full min-w-full text-right"> 
                                <thead class="sticky top-0 bg-gray-50 z-10">...</thead> 
                                <tbody id="orders-table-body" class="divide-y divide-gray-200"></tbody> 
                            </table> 
                         </div>
                     </div>
                </div>

                 <!-- View 3: Drivers Table -->
                <div id="view-drivers" class="app-view hidden h-full flex flex-col">
                     <div class="content-card flex-grow overflow-hidden">
                          <div class="card-header"> <h2 class="card-title">ניהול נהגים</h2> </div>
                           <div class="filter-input-wrapper flex-shrink-0"> 
                             <span class="filter-input-icon"><svg>...</svg></span> 
                             <input type="text" id="filter-drivers" class="filter-input" placeholder="חיפוש נהג..."> 
                         </div>
                         <div class="card-body overflow-y-auto"> 
                            <table class="w-full min-w-full text-right"> 
                                <thead class="sticky top-0 bg-gray-50 z-10">...</thead> 
                                <tbody id="drivers-table-body" class="divide-y divide-gray-200"></tbody> 
                            </table> 
                         </div> 
                     </div>
                </div>
                
                <!-- View 4: Customers Table -->
                 <div id="view-customers" class="app-view hidden h-full flex flex-col">
                     <div class="content-card flex-grow overflow-hidden">
                          <div class="card-header"> <h2 class="card-title">ניהול לקוחות</h2> </div>
                           <div class="filter-input-wrapper flex-shrink-0"> 
                            <span class="filter-input-icon"><svg>...</svg></span> 
                            <input type="text" id="filter-customers" class="filter-input" placeholder="חיפוש לקוח..."> 
                        </div>
                         <div class="card-body overflow-y-auto"> 
                             <table class="w-full min-w-full text-right"> 
                                <thead class="sticky top-0 bg-gray-50 z-10">...</thead> 
                                <tbody id="customers-table-body" class="divide-y divide-gray-200"></tbody> 
                             </table> 
                         </div> 
                    </div>
                </div>
                
                <!-- View 5: Logs Table -->
                 <div id="view-logs" class="app-view hidden h-full flex flex-col">
                    <div class="content-card flex-grow overflow-hidden">
                        <div class="card-header"> <h2 class="card-title">צג לוגים</h2> </div>
                        <div class="card-body overflow-y-auto"> 
                             <table class="w-full min-w-full text-right"> 
                                <thead class="sticky top-0 bg-gray-50 z-10">...</thead> 
                                <tbody id="logs-table-body" class="divide-y divide-gray-200"></tbody> 
                             </table> 
                         </div> 
                     </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modals (Structure refined) -->
    <div id="addOrderModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 id="addOrderModalTitle" class="modal-title">...</h2></div> <div class="modal-body"><form id="addOrderForm">...</form></div> </div> </div>
    <div id="assignDriverModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">שיבוץ נהג</h2></div> <div class="modal-body"><form>...</form></div> </div> </div>
    <div id="confirmAssignModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">אישור שיבוץ</h2></div> <div class="modal-body"><p id="confirmAssignText">...</p></div> <div class="modal-footer">...</div> </div> </div>
    <div id="selectDriverModal" class="modal-backdrop"> <div class="modal-content"> <div class="modal-header p-4"><h2 class="modal-title">בחר נהג לשיבוץ</h2></div> <div class="modal-body"><div id="driver-select-list" class="max-h-60 overflow-y-auto">...</div></div> <div class="modal-footer">...</div> </div> </div>

</body>
</html>

