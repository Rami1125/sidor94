<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster - טרמינל מחסן</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        :root {
            --primary-color: #007bff; --success: #28a745; --warning: #ffc107;
            --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Rubik', sans-serif; margin: 0; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); }
        .view { display: none !important; height: 100vh; }
        .view.active { display: flex !important; flex-direction: column; }
        .glass-card {
            background: rgba(255, 255, 255, 0.4); box-shadow: var(--shadow-light); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.6);
        }
        #loginView { justify-content: center; align-items: center; }
        .login-card { padding: 40px; text-align: center; width: 90%; max-width: 400px; }
        .login-card input { width: 100%; padding: 15px; margin-bottom: 20px; border: none; border-radius: 12px; font-size: 1.2rem; text-align: center; }
        .login-card button { width: 100%; padding: 15px; background-color: var(--primary-color); color:white; border:none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }
        .app-header { padding: 15px 20px; z-index: 10; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        main { flex-grow: 1; overflow-y: auto; padding: 0 15px; }
        .order-section { margin-bottom: 30px; }
        .order-section h2 { padding-bottom: 10px; display: flex; align-items: center; gap: 10px; font-size: 1.5rem; }
        .order-card { margin: 10px 0; padding: 20px; }
        .order-card button { width: 100%; padding: 12px; border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 1em; margin-top: 15px; }
        .btn-acknowledge { background-color: var(--success); }
        .btn-load { background-color: var(--warning); }
        button:disabled { background-color: #999; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="loginView" class="view active">
        <div class="login-card glass-card">
            <h2>כניסת מנהל מחסן</h2>
            <input type="text" id="managerIdInput" placeholder="הזן קוד מנהל (OREN/TAMIR)">
            <button id="loginBtn">כניסה</button>
        </div>
    </div>

    <div id="mainView" class="view">
        <header class="app-header glass-card" style="margin: 15px; height: 70px;">
            <h1 id="welcomeMessage"></h1>
            <button id="logoutBtn" style="background:none; border:none; color:#333; font-size: 1.5em;"><i class="fas fa-sign-out-alt"></i></button>
        </header>
        <main>
            <div id="newOrders" class="order-section">
                <h2><i class="fas fa-inbox"></i> הזמנות חדשות לאישור</h2>
                <div id="newOrdersList"></div>
            </div>
            <div id="inProgressOrders" class="order-section">
                <h2><i class="fas fa-tasks"></i> הזמנות בתהליך</h2>
                <div id="inProgressOrdersList"></div>
            </div>
        </main>
    </div>

    <script>
        // *** IMPORTANT ***
        // After deploying the updated Code.gs script, replace the URL below with your new Web App URL.
        const API_URL = 'https://script.google.com/macros/s/AKfycby_VQ0cAMNBGbCPJVHibQ-k32n0L2pM0NqnhgT27T5jIoKVCbxA8cGmGLspKY7eZvxU/exec';
        
        const loginView = document.getElementById('loginView');
        const mainView = document.getElementById('mainView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const newOrdersList = document.getElementById('newOrdersList');
        const inProgressOrdersList = document.getElementById('inProgressOrdersList');

        let currentManager = null, refreshInterval, knownOrderIds = new Set();
        
        async function apiFetch(action, params = {}, method = 'GET', body = null) {
            const url = new URL(API_URL);
            if (method === 'GET') {
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            }
            const options = { method };
            if (method === 'POST') {
                options.body = JSON.stringify({ action, data: body });
                options.headers = { 'Content-Type': 'text/plain;charset=UTF-8' };
            }
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`Network error`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            return result.data;
        }

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async (OneSignal) => {
            await OneSignal.init({ appId: "c711df10-6c87-4d81-889c-8e13963a155b" });
            initializeApp();
        });

        function initializeApp() {
            loginBtn.addEventListener('click', onLogin);
            logoutBtn.addEventListener('click', onLogout);
            const loggedInManager = JSON.parse(sessionStorage.getItem('warehouseManager'));
            if (loggedInManager) initApp(loggedInManager);
        }
        
        function onLogin() {
            const managerId = document.getElementById('managerIdInput').value.trim().toUpperCase();
            if(!managerId) return;
            const managerData = { id: managerId, name: managerId, warehouse: managerId === 'OREN' ? 'החרש' : 'התלמיד' };
            sessionStorage.setItem('warehouseManager', JSON.stringify(managerData));
            initApp(managerData);
        }

        function onLogout() {
            sessionStorage.removeItem('warehouseManager');
            if(refreshInterval) clearInterval(refreshInterval);
            if(window.OneSignal) OneSignal.logout();
            switchView('loginView');
        }

        function initApp(manager) {
            currentManager = manager;
            document.getElementById('welcomeMessage').textContent = `מחסן ${manager.warehouse} | ${manager.name}`;
            switchView('mainView');
            initializeNotifications(manager.id);
            startPolling();
        }
        
        function startPolling() {
            if (refreshInterval) clearInterval(refreshInterval);
            const poll = async () => { await fetchWarehouseOrders(); };
            poll();
            refreshInterval = setInterval(poll, 20000);
        }

        async function fetchWarehouseOrders() {
            if (!currentManager) return;
            try {
                const orders = await apiFetch('getWarehouseOrders', { warehouse: currentManager.warehouse });
                renderOrders(orders);
            } catch (error) {
                newOrdersList.innerHTML = `<p style="color:red;">שגיאת תקשורת עם השרת: ${error.message}</p>`;
            }
        }

        function renderOrders(orders) {
            newOrdersList.innerHTML = '';
            inProgressOrdersList.innerHTML = '';
            
            const newOrders = orders.filter(o => ['חדש', 'ממתין לאישור מחסן'].includes(o.status));
            const inProgress = orders.filter(o => ['באיסוף', 'טעון'].includes(o.status));

            const newIncomingIds = new Set(newOrders.map(o => o.orderId));
            if (knownOrderIds.size > 0 && [...newIncomingIds].some(id => !knownOrderIds.has(id))) {
                playNotificationSound();
            }
            knownOrderIds = new Set(orders.map(o => o.orderId));

            if (newOrders.length === 0) newOrdersList.innerHTML = '<p>אין הזמנות חדשות.</p>';
            newOrders.forEach(order => newOrdersList.innerHTML += createOrderCard(order, 'acknowledge'));

            if (inProgress.length === 0) inProgressOrdersList.innerHTML = '<p>אין הזמנות בתהליך.</p>';
            inProgress.forEach(order => inProgressOrdersList.innerHTML += createOrderCard(order, 'load'));
        }

        function createOrderCard(order, type) {
            let buttonHtml = '';
            if (type === 'acknowledge') {
                buttonHtml = `<button class="btn-acknowledge" onclick="updateOrderStatus(event, '${order.orderId}', 'באיסוף')">אשר קבלה</button>`;
            } else if (order.status === 'באיסוף') {
                buttonHtml = `<button class="btn-load" onclick="updateOrderStatus(event, '${order.orderId}', 'טעון')">סמן כטעון</button>`;
            } else {
                 buttonHtml = `<p style="color:var(--success); font-weight:bold; text-align:center;">הועמס ✔️</p>`;
            }

            return `
                <div class="order-card glass-card">
                    <h4>${order.customerName} (${order.orderId.substring(0,6)})</h4>
                    <p><strong>כתובת:</strong> ${order.address}</p>
                    <p><strong>שעה:</strong> ${order.orderTime}</p>
                    ${buttonHtml}
                </div>`;
        }
        
        async function updateOrderStatus(event, orderId, newStatus) {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
             try {
                await apiFetch('updateOrder', {}, 'POST', { orderId, updates: { status: newStatus } });
                setTimeout(fetchWarehouseOrders, 500);
            } catch (error) {
                console.error(`Error updating status for order ${orderId}`, error);
                btn.disabled = false;
                btn.innerHTML = 'שגיאה!';
            }
        }
        
        async function playNotificationSound() {
            try {
                await Tone.start();
                new Tone.Synth().toDestination().triggerAttackRelease("C5", "8n");
            } catch(e) { console.error('Could not play sound', e); }
        }
        
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        async function initializeNotifications(managerId) {
            try {
                await OneSignal.Notifications.requestPermission();
                await OneSignal.login(managerId);
                const playerId = OneSignal.User.onesignalId;
                if (playerId) await apiFetch('registerWarehouseDevice', {}, 'POST', { managerId, deviceId: playerId });
             } catch (e) { console.error("Error initializing notifications", e); }
        }

        // Initial load
        initializeApp();
    </script>
</body>
</html>
