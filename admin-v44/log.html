<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v45.5 - צג לוגים</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* v45.2: עיצוב בהיר קבוע */
        :root {
            --m3-primary: #0066cc; /* כחול בהיר */
            --m3-surface: #ffffff;
            --m3-on-surface: #1a1a1a;
            --m3-surface-container: #f0f4f8; /* רקע בהיר מאוד */
            --m3-on-surface-variant: #5f6368;
            --m3-outline: #d0d0d0;
            --m3-success: #1e8e3e;
            --m3-warning: #f9a825;
            --m3-error: #d93025;
            --m3-info: var(--m3-primary);
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--m3-surface);
            color: var(--m3-on-surface);
            margin: 0;
            padding: 1.5rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-weight: 500; color: var(--m3-on-surface); }
        h1 span { color: var(--m3-primary); }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            background-color: var(--m3-surface-container);
            padding: 1rem;
            border-radius: 1rem;
        }
        
        .form-control {
            flex-grow: 1;
            background-color: var(--m3-surface);
            color: var(--m3-on-surface);
            border: 1px solid var(--m3-outline);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Rubik', sans-serif;
        }
        .form-control::placeholder { color: var(--m3-on-surface-variant); }
        
        .log-container {
            height: 75vh;
            overflow-y: auto;
            border: 1px solid var(--m3-outline);
            border-radius: 1rem;
            background-color: var(--m3-surface-container);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Fira Code', monospace;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--m3-outline);
            font-size: 0.85rem;
            vertical-align: top;
        }
        
        thead {
            position: sticky; top: 0;
            background: var(--m3-surface-container);
        }
        th { font-family: 'Rubik'; color: var(--m3-on-surface-variant); }
        
        tr:hover { background-color: rgba(0,0,0,0.03); }
        
        /* Log Levels */
        .level-INFO { color: var(--m3-info); font-weight: 500; }
        .level-WARN { color: var(--m3-warning); font-weight: 500; }
        .level-ERROR { color: var(--m3-error); font-weight: 700; }
        
        .col-time { color: var(--m3-on-surface-variant); width: 150px; }
        .col-level { width: 80px; }
        .col-origin { color: var(--m3-success); width: 120px; }
        .col-context { color: #888; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>
            <span>[v45.5]</span> צג לוגים (מתורגם)
            <span id="status" style="font-size: 0.9rem; color: var(--m3-warning); margin-right: 10px;">(מתחבר...)</span>
        </h1>
    </div>
    
    <div class="filters">
        <input type="text" id="filter-text" class="form-control" placeholder="סנן לפי הודעה, מקור...">
        <select id="filter-level" class="form-control">
            <option value="">כל הרמות</option>
            <!-- v45.5: תרגום הטקסט באפשרויות -->
            <option value="INFO">מידע (INFO)</option>
            <option value="WARN">אזהרה (WARN)</option>
            <option value="ERROR">שגיאה (ERROR)</option>
        </select>
    </div>

    <div class="log-container">
        <table>
            <thead>
                <tr>
                    <th>זמן</th>
                    <th>רמה</th>
                    <th>מקור</th>
                    <th>הודעה</th>
                    <th>קונטקסט</th>
                </tr>
            </thead>
            <tbody id="logs-table-body">
                <!-- Logs יטענו כאן -->
            </tbody>
        </table>
    </div>

    <script type="module">
        // v45.3: שינוי לייבוא סטטי קשיח
        import { db, authReady } from "/admin-v44/config.js"; 
        import { SmartLog } from "/admin-v44/SmartLog.js";
        import { 
            collection, 
            query, 
            orderBy, 
            limit, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";


        const LOG_COLLECTION = 'system_logs_v3';
        const LOG_LIMIT = 200; 
        
        const DOM = {
            tableBody: document.getElementById('logs-table-body'),
            filterText: document.getElementById('filter-text'),
            filterLevel: document.getElementById('filter-level'),
            status: document.getElementById('status'),
        };
        
        let allLogs = []; 
        let unsubscribe = null; 

        function init() {
            try {
                console.log("Auth Ready. Log Viewer v45.5 Initializing.");
                
                DOM.filterText.addEventListener('input', renderLogs);
                DOM.filterLevel.addEventListener('input', renderLogs);
                
                listenToLogs();
                
                SmartLog.info("Log Viewer Initialized Successfully.", "LogViewer.Init");

            } catch (error) {
                console.error("Fatal Error during Log Viewer init:", error);
                DOM.status.textContent = `(שגיאת אתחול קריטית: ${error.message})`;
                DOM.status.style.color = 'var(--m3-error)';
                SmartLog.error(error, "LogViewer.Init.Catch");
            }
        }
        
        // --- v45.5: מנוע תרגום לוגים ---
        /**
         * מתרגם שדות טכניים לעברית קלילה
         * @param {object} log - אובייקט הלוג המקורי
         * @returns {object} - אובייקט עם שדות מתורגמים
         */
        function translateLogEntry(log) {
            let hebrewLevel = log.level;
            let levelClass = `level-${log.level || 'INFO'}`;
            let hebrewOrigin = log.origin || 'לא ידוע';

            // תרגום רמת הלוג
            switch (log.level) {
                case 'INFO':
                    hebrewLevel = 'מידע';
                    levelClass = 'level-INFO';
                    break;
                case 'WARN':
                    hebrewLevel = 'אזהרה';
                    levelClass = 'level-WARN';
                    break;
                case 'ERROR':
                    hebrewLevel = 'שגיאה';
                    levelClass = 'level-ERROR';
                    break;
            }

            // תרגום "קל" למקורות (אפשר להרחיב בקלות)
            switch (log.origin) {
                case 'Init': hebrewOrigin = 'אתחול מערכת'; break;
                case 'MapModule': hebrewOrigin = 'מודול מפה'; break;
                case 'Firestore.Drivers': hebrewOrigin = 'DB נהגים'; break;
                case 'Firestore.Orders': hebrewOrigin = 'DB הזמנות'; break;
                case 'Firestore.Locations': hebrewOrigin = 'DB מיקומים'; break;
                case 'Navigation': hebrewOrigin = 'ניווט דפים'; break;
                case 'LogViewer': hebrewOrigin = 'צג לוגים'; break;
                case 'LogViewer.Init': hebrewOrigin = 'אתחול צג לוגים'; break;
                case 'Auth.Fatal': hebrewOrigin = 'שגיאת חיבור'; break;
                // הוסף עוד תרגומים לפי הצורך
            }
            
            return { hebrewLevel, levelClass, hebrewOrigin };
        }
        // --- סוף מנוע תרגום ---

        function listenToLogs() {
            if (unsubscribe) unsubscribe(); 

            const q = query(
                collection(db, LOG_COLLECTION),
                orderBy("timestamp", "desc"),
                limit(LOG_LIMIT)
            );

            DOM.status.textContent = '(מאזין לשינויים...)';
            DOM.status.style.color = 'var(--m3-success)';

            unsubscribe = onSnapshot(q, (snapshot) => {
                allLogs = []; 
                snapshot.forEach(doc => {
                    allLogs.push(doc.data());
                });
                renderLogs(); 
            }, (error) => {
                console.error("Error listening to logs:", error);
                DOM.status.textContent = `(שגיאת האזנה: ${error.message})`;
                DOM.status.style.color = 'var(--m3-error)';
            });
        }

        function renderLogs() {
            const textFilter = DOM.filterText.value.toLowerCase();
            const levelFilter = DOM.filterLevel.value;

            const filteredLogs = allLogs.filter(log => {
                // v45.5: סינון לפי המידע המקורי (באנגלית)
                const levelMatch = !levelFilter || log.level === levelFilter;
                
                // v45.5: תרגום המקור לצורך חיפוש
                const t = translateLogEntry(log);
                const hebrewOriginForSearch = t.hebrewOrigin.toLowerCase();

                const textMatch = !textFilter ||
                    (log.message && log.message.toLowerCase().includes(textFilter)) ||
                    (log.origin && log.origin.toLowerCase().includes(textFilter)) ||
                    (hebrewOriginForSearch.includes(textFilter)); // מאפשר חיפוש גם בעברית
                
                return levelMatch && textMatch;
            });

            if (filteredLogs.length === 0) {
                DOM.tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">אין לוגים תואמים...</td></tr>`;
                return;
            }

            DOM.tableBody.innerHTML = filteredLogs.map(log => {
                // v45.5: הפעלת התרגום על כל לוג
                const t = translateLogEntry(log);
                
                const time = log.timestamp ? 
                    new Date(log.timestamp.toDate()).toLocaleString('he-IL', { timeStyle: 'medium' }) : '...';
                
                const safeMessage = log.message ? String(log.message).replace(/</g, "&lt;").replace(/>/g, "&gt;") : '---';
                
                let context = '';
                if (log.context) {
                    if (log.context.stack) {
                        context = log.context.stack.split('\n')[1] || 'Stack trace available';
                    } else {
                        context = JSON.stringify(log.context);
                        if (context.length > 100) context = context.substring(0, 100) + '...';
                    }
                }
                
                return `
                    <tr class="${t.levelClass}">
                        <td class="col-time">${time}</td>
                        <td class="col-level">${t.hebrewLevel}</td>
                        <td class="col-origin">[${t.hebrewOrigin}]</td>
                        <td>${safeMessage}</td>
                        <td class="col-context">${context}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- Start App ---
        authReady.then(() => {
            // v45.5: שיניתי את ההודעה כדי לבדוק את התרגום
            SmartLog.info("דף הלוגים עלה בהצלחה", "LogViewer.Init");
            init();
        }).catch(err => {
            console.error("Fatal Auth Error", err);
            DOM.status.textContent = `(שגיאת אימות: ${err.message})`;
            DOM.status.style.color = 'var(--m3-error)';
        });

    </script>
</body>
</html>

