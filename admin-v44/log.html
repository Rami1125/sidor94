<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v49.3 - צג לוגים</title> <!-- v49.3 -->

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* Base Variables */
        :root {
            --sl-border-radius: 0.75rem;
            --sl-spacing: 1rem;
            --sl-font-main: 'Rubik', sans-serif;
            --sl-font-mono: 'Fira Code', monospace;
        }

        /* Light Theme (Default) */
        :root[data-theme="light"] {
            --sl-bg-page: #f8f9fa;
            --sl-text-primary: #212529;
            --sl-text-secondary: #6c757d;
            --sl-bg-card: #ffffff;
            --sl-bg-table-header: #e9ecef;
            --sl-bg-table-body: #ffffff;
            --sl-bg-table-row-hover: #f1f3f5;
            --sl-border-color: #dee2e6;
            --sl-input-bg: #ffffff;
            --sl-input-border: #ced4da;
            --sl-button-bg: #0d6efd;
            --sl-button-text: #ffffff;
            --sl-info-color: #0dcaf0;
            --sl-warn-color: #ffc107;
            --sl-error-color: #dc3545;
            --sl-success-color: #198754;
             --sl-driver-highlight-bg: #e0f2fe; /* Light blue for driver events */
        }

        /* Dark Theme */
        :root[data-theme="dark"] {
            --sl-bg-page: #1a1a1a;
            --sl-text-primary: #e0e0e0;
            --sl-text-secondary: #adb5bd;
            --sl-bg-card: #2c2c2c;
            --sl-bg-table-header: #3a3a3a;
            --sl-bg-table-body: #222222;
            --sl-bg-table-row-hover: #333333;
            --sl-border-color: #444444;
            --sl-input-bg: #3a3a3a;
            --sl-input-border: #555555;
            --sl-button-bg: #0b5ed7;
            --sl-button-text: #ffffff;
            --sl-info-color: #6edff6;
            --sl-warn-color: #ffca2c;
            --sl-error-color: #f17c7c;
            --sl-success-color: #75b798;
             --sl-driver-highlight-bg: #374151; /* Darker blue/gray for driver events */
        }

        /* General Styles */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--sl-font-main);
            background-color: var(--sl-bg-page);
            color: var(--sl-text-primary);
            margin: 0;
            padding: calc(var(--sl-spacing) * 1.5);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        h1 { font-weight: 500; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .material-symbols-outlined { vertical-align: middle; }

        /* Theme Toggle Button */
        #theme-toggle {
            background: none; border: none; cursor: pointer;
            color: var(--sl-text-secondary); padding: 0.5rem;
            display: flex; align-items: center;
        }

        /* Filters */
        .filters {
            display: flex; flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: var(--sl-spacing);
            margin-bottom: calc(var(--sl-spacing) * 1.5);
            background-color: var(--sl-bg-card);
            padding: var(--sl-spacing);
            border-radius: var(--sl-border-radius);
            border: 1px solid var(--sl-border-color);
        }
        .form-control {
            flex: 1 1 150px; /* Allow shrinking and growing */
            min-width: 150px; /* Minimum width before wrapping */
            background-color: var(--sl-input-bg);
            color: var(--sl-text-primary);
            border: 1px solid var(--sl-input-border);
            padding: 0.6rem 0.8rem;
            border-radius: calc(var(--sl-border-radius) / 2);
            font-family: var(--sl-font-main);
            font-size: 0.9rem;
        }
        select.form-control {
            /* Basic arrow styling */
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); /* Adjusted arrow color */
            background-repeat: no-repeat;
            background-position: left 0.7em top 50%;
            background-size: 0.65em auto;
            padding-left: 2.5em; /* Space for arrow */
        }
         :root[data-theme="dark"] select.form-control {
              background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23adb5bd%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); /* Dark theme arrow */
         }


        /* Log Container & Table */
        .log-container {
            height: 70vh; /* Adjusted height */
            overflow-y: auto;
            border: 1px solid var(--sl-border-color);
            border-radius: var(--sl-border-radius);
            background-color: var(--sl-bg-table-body);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        table { width: 100%; border-collapse: collapse; font-family: var(--sl-font-mono); }
        th, td { padding: 0.6rem 1rem; text-align: right; border-bottom: 1px solid var(--sl-border-color); font-size: 0.8rem; vertical-align: top; }
        thead { position: sticky; top: 0; background: var(--sl-bg-table-header); z-index: 10; }
        th { font-family: var(--sl-font-main); font-weight: 500; color: var(--sl-text-secondary); }
        tbody tr:hover { background-color: var(--sl-bg-table-row-hover); }

        /* Log Levels & Highlighting */
        .level-INFO { color: var(--sl-info-color); }
        .level-WARN { color: var(--sl-warn-color); }
        .level-ERROR { color: var(--sl-error-color); font-weight: 500; }
        .log-driver-event { background-color: var(--sl-driver-highlight-bg); } /* Driver event highlight */

        .col-time { color: var(--sl-text-secondary); width: 80px; white-space: nowrap; }
        .col-level { width: 60px; font-weight: 500; }
        .col-origin { color: var(--sl-success-color); width: 120px; white-space: nowrap; }
        .col-source { color: #8e44ad; width: 150px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* New source column */
        .col-context { color: var(--sl-text-secondary); font-size: 0.7rem; white-space: pre-wrap; word-break: break-all; } /* Allow context to wrap */

         /* Status Indicator */
        #status { font-size: 0.9rem; margin-right: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .status-ok { color: var(--sl-success-color); }
        .status-ok .status-dot { background-color: var(--sl-success-color); }
        .status-warn { color: var(--sl-warn-color); }
        .status-warn .status-dot { background-color: var(--sl-warn-color); }
        .status-error { color: var(--sl-error-color); }
        .status-error .status-dot { background-color: var(--sl-error-color); }
    </style>
</head>
<body>

    <h1>
        <div>
            <span style="color: var(--sl-info-color);">[v49.3]</span> צג לוגים (מלשינון חכם) <!-- v49.3 -->
            <span id="status" class="status-warn">
                 <span class="status-dot"></span><span id="status-text">מתחבר...</span>
            </span>
        </div>
        <button id="theme-toggle" title="שנה ערכת נושא">
            <span class="material-symbols-outlined" id="theme-icon">light_mode</span>
        </button>
    </h1>

    <div class="filters">
        <input type="text" id="filter-text" class="form-control" placeholder="סנן לפי הודעה, מקור...">
        <select id="filter-level" class="form-control">
            <option value="">כל הרמות</option>
            <option value="INFO">מידע (INFO)</option>
            <option value="WARN">אזהרה (WARN)</option>
            <option value="ERROR">שגיאה (ERROR)</option>
        </select>
         <select id="filter-source" class="form-control">
             <option value="">כל הקבצים</option>
             <!-- Options will be populated by JS -->
         </select>
    </div>

    <div class="log-container">
        <table>
            <thead>
                <tr>
                    <th class="col-time">זמן</th>
                    <th class="col-level">רמה</th>
                    <th class="col-origin">מקור (קוד)</th>
                    <th class="col-source">מקור (קובץ)</th> <!-- v49.3: Removed comment -->
                    <th>הודעה</th>
                    <th class="col-context">קונטקסט / פרטים</th>
                </tr>
            </thead>
            <tbody id="logs-table-body">
                <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--sl-text-secondary);">ממתין ללוגים...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        // Assuming config.js v47.7+ is available in the same directory
        import { db } from './config.js'; // Use relative path
        import {
            collection,
            query,
            orderBy,
            limit,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const LOG_COLLECTION = 'system_logs_v3';
        const LOG_LIMIT = 300; // Show more logs

        const DOM = {
            tableBody: document.getElementById('logs-table-body'),
            filterText: document.getElementById('filter-text'),
            filterLevel: document.getElementById('filter-level'),
            filterSource: document.getElementById('filter-source'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status').querySelector('.status-dot'),
            statusContainer: document.getElementById('status'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIcon: document.getElementById('theme-icon'),
        };

        let allLogs = []; // Cache for raw logs
        let uniqueSources = new Set();
        let unsubscribe = null;

        // --- Initialization ---
        function init() {
            console.log("Log Viewer Initializing (v49.3)..."); // v49.3
             initializeTheme();
             DOM.themeToggle.addEventListener('click', toggleTheme);
             DOM.filterText.addEventListener('input', renderLogs);
             DOM.filterLevel.addEventListener('input', renderLogs);
             DOM.filterSource.addEventListener('input', renderLogs);
             listenToLogs();
             console.log("Initialization complete. Listening for logs.");
             console.info("[LogViewer] Initialized Successfully.");
        }

        // --- Theme Management ---
         function initializeTheme() { /* ... */ }
         function setTheme(themeName) { /* ... */ }
         function toggleTheme() { /* ... */ }

        // --- Firestore Listener ---
        function listenToLogs() {
            if (unsubscribe) { try { unsubscribe(); } catch(e) { console.warn("Error unsubscribing:", e); } }
            updateStatus('warn', 'מתחבר למאזין...');
            const q = query( collection(db, LOG_COLLECTION), orderBy("timestamp", "desc"), limit(LOG_LIMIT) );
            unsubscribe = onSnapshot(q, (snapshot) => {
                updateStatus('ok', 'מאזין לשינויים...');
                console.log(`Snapshot: ${snapshot.size} docs, ${snapshot.docChanges().length} changes.`);
                const newLogs = []; const currentSources = new Set(uniqueSources);
                snapshot.forEach(doc => {
                    const logData = doc.data(); newLogs.push({ id: doc.id, ...logData });
                    const sourcePath = logData.context?.page;
                    if (sourcePath && typeof sourcePath === 'string') {
                         const sourceName = sourcePath.split('/').pop() || sourcePath; if(sourceName) currentSources.add(sourceName);
                     } else if (logData.origin?.startsWith('FirebaseFunction')) { currentSources.add('Firebase Function'); }
                });
                allLogs = newLogs;
                 if (currentSources.size !== uniqueSources.size || !setsAreEqual(currentSources, uniqueSources)) { uniqueSources = currentSources; populateSourceFilter(); }
                renderLogs();
            }, (error) => { console.error("Error listening to logs:", error); updateStatus('error', `שגיאת האזנה: ${error.message}`); });
        }

        // --- UI Rendering & Filtering ---
         function setsAreEqual(setA, setB) { /* ... */ }
         function populateSourceFilter() { /* ... */ }

        function renderLogs() {
            const textFilter = DOM.filterText.value.toLowerCase();
            const levelFilter = DOM.filterLevel.value;
            const sourceFilter = DOM.filterSource.value;
            console.log("Rendering logs with filters:", { textFilter, levelFilter, sourceFilter });

            const filteredLogs = allLogs.filter(log => {
                 const levelMatch = !levelFilter || log.level === levelFilter; if (!levelMatch) return false;
                 const textMatch = !textFilter || (log.message && String(log.message).toLowerCase().includes(textFilter)) || (log.origin && log.origin.toLowerCase().includes(textFilter)) || (log.context && JSON.stringify(log.context).toLowerCase().includes(textFilter)); if (!textMatch) return false;
                 const sourcePath = log.context?.page; const sourceName = sourcePath ? (sourcePath.split('/').pop() || sourcePath) : (log.origin?.startsWith('FirebaseFunction') ? 'Firebase Function' : ''); const sourceMatch = !sourceFilter || sourceName === sourceFilter; if (!sourceMatch) return false;
                return true;
            });
            console.log(`Rendering ${filteredLogs.length} filtered logs of ${allLogs.length} total.`);

            if (filteredLogs.length === 0) {
                DOM.tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--sl-text-secondary);">לא נמצאו לוגים תואמים לסינון.</td></tr>`; return;
            }

            DOM.tableBody.innerHTML = filteredLogs.map(log => {
                const time = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleTimeString('he-IL') : '---';
                const safeMessage = String(log.message || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                let contextStr = ''; if (log.context) { try { contextStr = JSON.stringify(log.context, null, 2); } catch (e) { contextStr = "{ Error stringifying }"; } }
                 const sourcePath = log.context?.page; const sourceName = sourcePath ? (sourcePath.split('/').pop() || sourcePath) : (log.origin?.startsWith('FirebaseFunction') ? 'שרת' : '?');
                 const isDriverEvent = log.origin && ( log.origin.includes('Driver') || log.origin.includes('Auth') || log.origin.includes('GPS') || log.origin.includes('Login') );
                 const rowClass = isDriverEvent ? 'log-driver-event' : '';

                // v49.3: Removed HTML comments from template literal
                return `
                    <tr class="${rowClass}">
                        <td class="col-time">${time}</td>
                        <td class="col-level level-${log.level || 'INFO'}">${log.level || 'INFO'}</td>
                        <td class="col-origin">[${log.origin || 'N/A'}]</td>
                        <td class="col-source">${sourceName}</td>
                        <td>${safeMessage}</td>
                        <td class="col-context"><pre>${contextStr}</pre></td>
                    </tr>
                `;
            }).join('');
        }

        // --- Status Update ---
        function updateStatus(level, text) { console.log(`Status: ${level} - ${text}`); if (DOM.statusText) DOM.statusText.textContent = text; if (DOM.statusContainer) { DOM.statusContainer.className = `status-${level}`; } }

        // --- Start ---
        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); }
        else { init(); }

    </script>
</body>
</html>

