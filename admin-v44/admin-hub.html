<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v46.4 - מרכז בקרה</title>

    <!-- Leaflet (Map) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* v46.0: עיצוב בהיר קלאסי (מבוסס v43.0) */
        :root {
            --primary-color: #0ea5e9; /* כחול שמיים (v43) */
            --on-primary: #ffffff;
            --surface: #f8f9fa; /* רקע אפרפר בהיר */
            --on-surface: #202124; /* טקסט כהה */
            --surface-container: #ffffff; /* רקע כרטיסים (לבן) */
            --on-surface-variant: #5f6368; /* טקסט משני */
            --outline: #dee2e6; /* גבולות */
            --success: #1e8e3e;
            --warning: #f9a825; /* צהוב לאייקון משאית */
            --error: #d93025;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        body, html {
            height: 100vh; width: 100vw; margin: 0;
            font-family: 'Inter', sans-serif; /* פונט v43 */
            background-color: var(--surface);
            color: var(--on-surface);
            overflow: hidden;
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            font-size: 1.25rem;
        }
        
        .card {
            background: var(--surface-container);
            border: 1px solid var(--outline);
            border-radius: 1rem; /* 16px */
            box-shadow: var(--shadow);
        }
        
        /* Layout (v43: Sidebar Left) */
        .app-layout {
            display: grid;
            /* סרגל צד קבוע משמאל (כמו ב-v43) */
            grid-template-columns: 280px 1fr; 
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1.5rem; /* ריווח v43 */
            padding: 1.5rem;
            box-sizing: border-box;
        }
        
        /* v46.0: Header (כולל Ticker) */
        header {
            grid-column: 1 / -1;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* v46.0: "מלשינון" (Ticker) */
        .ticker-wrap {
            grid-column: 1 / -1;
            grid-row: 1 / 2;
            padding: 0;
            background-color: var(--on-surface);
            color: var(--surface);
            border-radius: 0.5rem;
            overflow: hidden;
            height: 40px;
            display: flex;
            align-items: center;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker-move 30s linear infinite;
        }
        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
            font-size: 0.9rem;
        }
        @keyframes ticker-move {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }
        
        /* v46.0: Layout (Header + Ticker) */
        .header-with-ticker {
            display: grid;
            grid-template-rows: 40px auto;
            grid-column: 1 / -1;
            gap: 1rem;
        }

        nav {
            grid-row: 2 / 3;
            grid-column: 1 / 2; /* Sidebar Left */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        main {
            grid-row: 2 / 3;
            grid-column: 2 / 3; /* Content Right */
            overflow: hidden;
            position: relative;
        }
        
        #app-title { font-size: 1.5rem; font-weight: 500; }
        #app-version { font-size: 0.8rem; color: var(--primary-color); margin-right: 8px; }
        #connection-status { 
            font-size: 0.85rem; font-weight: 500; 
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 99px;
            transition: all 0.3s ease;
        }
        #connection-status .dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-connecting { background-color: rgba(249, 168, 37, 0.1); color: var(--warning); }
        .status-connecting .dot { background-color: var(--warning); }
        .status-connected { background-color: rgba(30, 142, 62, 0.1); color: var(--success); }
        .status-connected .dot { background-color: var(--success); }
        .status-error { background-color: rgba(217, 48, 37, 0.1); color: var(--error); }
        .status-error .dot { background-color: var(--error); }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1.25rem;
            border-radius: 99px;
            text-decoration: none;
            color: var(--on-surface-variant);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .nav-link:hover {
            background-color: rgba(0,0,0, 0.05);
            color: var(--on-surface);
        }
        .nav-link.active {
            background-color: var(--primary-color);
            color: var(--on-primary);
            font-weight: 700;
        }
        
        .app-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(10px);
        }
        .app-view.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        #view-map { padding: 0; }
        #leaflet-map { width: 100%; height: 100%; z-index: 1; border-radius: 1rem; }
        .leaflet-container { background: #eee; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: var(--surface-container);
            color: var(--on-surface);
            border: 1px solid var(--outline);
        }
        
        /* v46.0: קו שיוך */
        .assignment-line {
            stroke: var(--primary-color);
            stroke-width: 3;
            stroke-dasharray: 5, 5;
        }
        
        .view-table { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .table-controls { display: flex; justify-content: space-between; gap: 1rem; }
        .search-container { position: relative; flex-grow: 1; }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 3rem; /* מקום לאייקון */
            border-radius: 0.5rem;
            border: 1px solid var(--outline);
            background: var(--surface);
        }
        .search-container .icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--on-surface-variant);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: var(--on-primary);
            background-color: var(--primary-color);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background-color: #0b98d9; }
        .btn-icon { padding: 0.75rem; }

        .table-container { 
            flex-grow: 1; 
            overflow-y: auto; 
            border: 1px solid var(--outline);
            border-radius: 1rem;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 1rem; text-align: right; 
            border-bottom: 1px solid var(--outline);
        }
        thead {
            position: sticky; top: 0;
            background: var(--surface-container);
        }
        th { font-size: 0.8rem; color: var(--on-surface-variant); }
        
        /* v46.0: Modal (חלון קופץ) */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none; /* מופעל עם JS */
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.visible {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: var(--surface-container);
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--outline);
            background: var(--surface);
            box-sizing: border-box; /* תיקון ריווח */
        }
        .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        .btn-secondary {
            background-color: var(--surface);
            color: var(--on-surface-variant);
            border: 1px solid var(--outline);
        }
        .btn-secondary:hover { background-color: #f1f3f4; }
        
    </style>
</head>
<body>

    <div class="app-layout">
        
        <!-- v46.0: Header + Ticker Layout -->
        <div class="header-with-ticker">
            <div class="ticker-wrap" aria-hidden="true">
                <div class="ticker" id="ticker-messages">
                    <span class="ticker-item">ברוכים הבאים ל-DeliveryMaster v46.4</span>
                    <span class="ticker-item">מערכת ניהול המשלוחים בזמן אמת</span>
                    <span class="ticker-item">החיבור ל-Firebase פעיל ויציב.</span>
                </div>
            </div>
            
            <header class="card">
                <div id="app-title">
                    <span id="app-version">v46.4</span>DeliveryMaster
                </div>
                <div id="connection-status" class="status-connecting">
                    <div class="dot"></div>
                    <span>מאתחל חיבור...</span>
                </div>
            </header>
        </div>

        <!-- 2. Navigation (Sidebar Left) -->
        <nav class="card">
            <a class="nav-link active" data-view="view-map">
                <span class="material-symbols-outlined">map</span>
                חדר מצב (מפה)
            </a>
            <a class="nav-link" data-view="view-orders">
                <span class="material-symbols-outlined">list_alt</span>
                ניהול הזמנות
            </a>
            <a class="nav-link" data-view="view-drivers">
                <span class="material-symbols-outlined">local_shipping</span>
                ניהול נהגים
            </a>
            <a class="nav-link" data-view="view-log">
                <span class="material-symbols-outlined">terminal</span>
                צג לוגים (בחלון חדש)
            </a>
        </nav>

        <!-- 3. Main Content (Content Right) -->
        <main>
            <!-- View 1: Map (Default) -->
            <div id="view-map" class="app-view active">
                <div id="leaflet-map" class="card"></div>
            </div>

            <!-- View 2: Orders -->
            <div id="view-orders" class="app-view view-table card">
                <h2>ניהול הזמנות</h2>
                <div class="table-controls">
                    <div class="search-container">
                        <input type="text" id="orders-search" class="search-input" placeholder="חיפוש הזמנות...">
                        <span class="material-symbols-outlined icon">search</span>
                    </div>
                    <button class="btn" id="add-order-btn">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">add</span>
                        הוסף הזמנה
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>מזהה</th>
                                <th>לקוח</th>
                                <th>כתובת</th>
                                <th>נהג</th>
                                <th>סטטוס</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- View 3: Drivers -->
            <div id="view-drivers" class="app-view view-table card">
                <h2>ניהול נהגים</h2>
                <div class="table-controls">
                    <div class="search-container">
                        <input type="text" id="drivers-search" class="search-input" placeholder="חיפוש נהגים...">
                        <span class="material-symbols-outlined icon">search</span>
                    </div>
                </div>
                 <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>טלפון</th>
                                <th>סטטוס</th>
                                <th>מיקום אחרון</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

    </div>
    
    <!-- v46.0: Modal for Add Order -->
    <div id="addOrderModal" class="modal-backdrop">
        <div class="modal-content">
            <form id="addOrderForm">
                <div class="modal-header">
                    <h2 class="text-xl font-bold">יצירת הזמנה חדשה</h2>
                    <button type="button" class="btn-icon btn-secondary" id="closeModalBtn">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div class="form-group full-width">
                    <label for="customerName" class="form-label">שם לקוח</label>
                    <input type="text" id="customerName" class="form-input" required>
                </div>
                <div class="form-group full-width">
                    <label for="address" class="form-label">כתובת</label>
                    <input type="text" id="address" class="form-input" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="latitude" class="form-label">Latitude</label>
                        <input type="text" id="latitude" class="form-input" placeholder="32.123">
                    </div>
                    <div class="form-group">
                        <label for="longitude" class="form-label">Longitude</label>
                        <input type="text" id="longitude" class="form-input" placeholder="34.456">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelModalBtn">ביטול</button>
                    <button type="submit" class="btn">שמור הזמנה</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase & App Logic (Modular) -->
    <script type="module">
        // v45.3: נתיב סטטי קשיח
        const APP_ROOT = "/admin-v44"; 
        
        import { db, auth, authReady } from "/admin-v44/config.js"; 
        import { SmartLog } from "/admin-v44/SmartLog.js";
        import { 
            collection, 
            doc, 
            onSnapshot, 
            query, 
            orderBy,
            addDoc, // v46.0: ליצירת הזמנה
            updateDoc, // v46.0: לשיוך
            serverTimestamp // v46.0: חותמת זמן
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- v46.1: Helper Functions (Moved outside authReady) ---
        function getCssVariable(varName) {
            try { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
            catch (e) { console.warn(`Could not get CSS variable ${varName}.`); return null; }
        }
        
        // v46.4: תיקון פונקציה
        function hexToRgba(hex, opacity) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c= '0x'+c.join('');
                return `rgba(${[(c>>16)&255, (c>>8)&255, c&255].join(',')},${opacity})`;
            }
            if (hex && hex.startsWith('rgb')) return hex;
             console.warn(`Invalid hex color received: ${hex}. Falling back to default.`);
            return `rgba(255, 255, 255, ${opacity})`;
        }
        
        // --- v46.3: Define Icon URLs ---
        const orderIconUrl = 'https://i.ibb.co/3zdFhR7/order-pin.png'; // Link from user
        const driverIcons = {
            'חכמת': 'https://i.postimg.cc/1z14r3RV/icons8-delivery-100-2.png', // Link from user
            'עלי': 'https://i.postimg.cc/52L2yW54/icons8-delivery-100.png', // Link from user
            'default': 'https://img.icons8.com/?size=100&id=yxWJT71r2aIi&format=png&color=000000' // Default marker if no specific icon
        };
        const defaultIconSize = [50, 50]; // הגדלת גודל האייקון
        const defaultIconAnchor = [25, 50]; // התאמת נקודת העיגון

        // --- v46.3: Define Leaflet Icons using Image URLs ---
        const orderIcon = L.icon({
            iconUrl: orderIconUrl,
            iconSize: defaultIconSize, // [רוחב, גובה]
            iconAnchor: defaultIconAnchor, // [מרכז אופקי, קצה תחתון]
            popupAnchor: [0, -50] // הזזת הפופאפ מעל האייקון
        });

        // פונקציה ליצירת אייקון נהג (עם תמונות שונות)
        function createDriverIcon(driverName) {
            const iconUrl = driverIcons[driverName] || driverIcons['default'];
            return L.icon({
                iconUrl: iconUrl,
                iconSize: defaultIconSize,
                iconAnchor: defaultIconAnchor,
                popupAnchor: [0, -50]
            });
        }


        // --- v46.0: הגדרות מ-v43 ---
        const WAREHOUSE_LOCATIONS = {
            "החרש": L.latLng(32.0573, 34.7963),
            "התלמיד": L.latLng(32.0853, 34.7818) // (דוגמה, מרכז ת"א)
        };

        // --- Globals ---
        let map;
        const state = {
            drivers: {},
            orders: {},
            locations: {},
            markers: { drivers: {}, orders: {} }
        };
        let assignmentLine = null; // v46.0: קו שיוך
        let selectedOrderMarker = null; // v46.0: מעקב לחיצה

        const DOM = {
            status: document.getElementById('connection-status'),
            navLinks: document.querySelectorAll('.nav-link[data-view]'),
            views: document.querySelectorAll('.app-view'),
            ordersTable: document.getElementById('orders-table-body'),
            driversTable: document.getElementById('drivers-table-body'),
            tickerMessages: document.getElementById('ticker-messages'),
            addOrderBtn: document.getElementById('add-order-btn'),
            addOrderModal: document.getElementById('addOrderModal'),
            addOrderForm: document.getElementById('addOrderForm'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            cancelModalBtn: document.getElementById('cancelModalBtn'),
            ordersSearch: document.getElementById('orders-search'),
            driversSearch: document.getElementById('drivers-search'),
        };
        
        // --- 1. Initialization ---
        function init() {
            SmartLog.info("Auth Ready. Admin Hub v46.4 Initializing", "Init");
            try {
                initNavigation();
                initMap();
                initTicker();
                initModals();
                initSearch();
                
                listenToDrivers();
                listenToOrders();
                listenToLocations(); // v46.0: האזנה נפרדת למיקומים
                
                updateConnectionStatus(true, "מחובר ומאזין");
                SmartLog.info("Initialization complete. Listeners attached.", "Init");

            } catch (e) {
                SmartLog.error(e, "Init");
                updateConnectionStatus(false, "שגיאת אתחול קריטית");
            }
        }
        
        function updateConnectionStatus(isConnected, message) {
            const statusEl = DOM.status;
            statusEl.querySelector('span').textContent = message;
            if (isConnected) statusEl.className = 'status-connected';
            else statusEl.className = 'status-error';
        }

        // --- 2. UI Modules (Nav, Ticker, Modal, Search) ---
        // v46.4: תיקון פונקציות מלא
        function initNavigation() {
            DOM.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = link.getAttribute('data-view');
                    if (viewId === 'view-log') {
                        window.open(`${APP_ROOT}/log.html`, '_blank');
                        return;
                    }
                    DOM.views.forEach(v => v.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');
                    DOM.navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    if (viewId === 'view-map') {
                        setTimeout(() => map?.invalidateSize(), 10);
                    }
                });
            });
        }
        
        function initTicker() {
            const ticker = DOM.tickerMessages;
            const items = ticker.querySelectorAll('.ticker-item');
            items.forEach(item => ticker.appendChild(item.cloneNode(true)));
        }
        
        function initModals() {
            DOM.addOrderBtn.addEventListener('click', () => {
                DOM.addOrderModal.classList.add('visible');
            });
            DOM.closeModalBtn.addEventListener('click', closeModal);
            DOM.cancelModalBtn.addEventListener('click', closeModal);
            DOM.addOrderForm.addEventListener('submit', handleSaveOrder);
        }
        
        function closeModal() {
            DOM.addOrderModal.classList.remove('visible');
            DOM.addOrderForm.reset();
        }

        function initSearch() {
            DOM.ordersSearch.addEventListener('input', () => renderOrdersTable(DOM.ordersSearch.value));
            DOM.driversSearch.addEventListener('input', () => renderDriversTable(DOM.driversSearch.value));
        }

        // --- 3. Map Logic (Leaflet) ---
        function initMap() {
             try {
                if (map) map.remove();
                map = L.map('leaflet-map').setView([32.109333, 34.855499], 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap', maxZoom: 19
                }).addTo(map);
                
                map.on('mousemove', (e) => {
                    if (assignmentLine) {
                        assignmentLine.setLatLngs([selectedOrderMarker.getLatLng(), e.latlng]);
                    }
                });

                SmartLog.info("Map Initialized (v46.4)", "MapModule");
            } catch(e) {
                SmartLog.error(e, "MapModule.initMap");
            }
        }

        // --- 4. Firestore Real-time Listeners ---
        function listenToDrivers() {
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const driverId = change.doc.id;
                    const driverData = { id: driverId, ...change.doc.data() };
                    
                    if (change.type === "added" || change.type === "modified") {
                        state.drivers[driverId] = driverData;
                        updateDriverMarker(driverId, driverData);
                    } else if (change.type === "removed") {
                        delete state.drivers[driverId];
                        removeDriverMarker(driverId);
                    }
                });
                renderDriversTable();
            }, e => SmartLog.error(e, "Firestore.Drivers"));
        }

        function listenToOrders() {
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                 snapshot.docChanges().forEach((change) => {
                    const orderId = change.doc.id;
                    const orderData = { id: orderId, ...change.doc.data() };

                    if (change.type === "added" || change.type === "modified") {
                        state.orders[orderId] = orderData;
                        updateOrderMarker(orderId, orderData);
                    } else if (change.type === "removed") {
                        delete state.orders[orderId];
                        removeOrderMarker(orderId);
                    }
                });
                renderOrdersTable();
            }, e => SmartLog.error(e, "Firestore.Orders"));
        }
        
        function listenToLocations() {
            const q = query(collection(db, "driverLocations"));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const driverId = change.doc.id;
                    const locData = change.doc.data();
                    if (change.type === "modified" || change.type === "added") {
                        state.locations[driverId] = { id: driverId, ...locData };
                        updateDriverMarkerLocation(driverId, locData);
                    }
                });
                renderDriversTable(); 
            }, e => SmartLog.error(e, "Firestore.Locations"));
        }
        
        // --- 5. v46.3: Map Marker & Assignment Logic (Updates for Image Icons & Click-Zoom) ---
        function updateDriverMarker(driverId, driverData) {
            const location = state.locations[driverId];
            const latLng = location ? [location.latitude, location.longitude] : [32.10, 34.85];
            const driverName = driverData.name || 'לא ידוע';
            const iconToUse = createDriverIcon(driverName); 

            const marker = state.markers.drivers[driverId];

            if (marker) {
                marker.setLatLng(latLng);
                marker.setIcon(iconToUse);
                marker.getPopup().setContent(`<b>${driverName}</b><br>${driverData.phone}`);
                marker.driverData = driverData; 
            } else {
                const newMarker = L.marker(latLng, {
                    icon: iconToUse,
                    draggable: false
                }).addTo(map);

                newMarker.bindPopup(`<b>${driverName}</b><br>${driverData.phone}`);
                newMarker.driverData = driverData;

                newMarker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (selectedOrderMarker) {
                        assignOrder(selectedOrderMarker.orderData, driverData);
                    } else {
                        zoomToMarker(newMarker, 17); 
                    }
                });

                state.markers.drivers[driverId] = newMarker;
            }
        }
        
        function removeDriverMarker(driverId) {
            const marker = state.markers.drivers[driverId];
            if (marker) {
                map.removeLayer(marker);
                delete state.markers.drivers[driverId];
            }
        }
        
        function updateOrderMarker(orderId, orderData) {
            if (orderData.status === 'הושלם') {
                removeOrderMarker(orderId);
                return;
            }
            const latLng = (orderData.latitude && orderData.longitude) ? [orderData.latitude, orderData.longitude] : null;
            if (!latLng) return;

            const distances = calculateDistances(latLng);
            const popupContent = `<b>${orderData.customer?.name}</b><br>${orderData.address}<br><b>סטטוס:</b> ${orderData.status || 'חדש'}<br><small>${distances}</small>`;

            const marker = state.markers.orders[orderId];
            
            if (marker) {
                marker.setLatLng(latLng);
                marker.getPopup().setContent(popupContent);
                marker.orderData = orderData;
            } else {
                const newMarker = L.marker(latLng, { 
                    icon: orderIcon, 
                    draggable: true 
                }).addTo(map);
                
                newMarker.bindPopup(popupContent);
                newMarker.orderData = orderData;
                
                newMarker.on('click', (e) => {
                     L.DomEvent.stopPropagation(e);
                    handleOrderClick(newMarker); 
                    if (!selectedOrderMarker) { 
                        zoomToMarker(newMarker, 17);
                    }
                });
                
                newMarker.on('dragend', (e) => handleOrderDrop(e.target, orderData));
                
                state.markers.orders[orderId] = newMarker;
            }
        }
        
        function removeOrderMarker(orderId) {
            const marker = state.markers.orders[orderId];
            if (marker) {
                map.removeLayer(marker);
                delete state.markers.orders[orderId];
            }
        }
        
        function updateDriverMarkerLocation(driverId, locData) {
            const marker = state.markers.drivers[driverId];
            if (marker && locData.latitude && locData.longitude) {
                marker.setLatLng([locData.latitude, locData.longitude]);
            }
        }
        
        function calculateDistances(orderLatLng) {
            let distStr = "מרחקים: ";
            try {
                const orderPoint = L.latLng(orderLatLng);
                for (const [name, loc] of Object.entries(WAREHOUSE_LOCATIONS)) {
                    const dist = (orderPoint.distanceTo(loc) / 1000).toFixed(1);
                    distStr += `<b>${name}:</b> ${dist} ק"מ | `;
                }
                return distStr.slice(0, -3);
            } catch (e) {
                return "שגיאה בחישוב מרחק";
            }
        }
        
        function handleOrderClick(marker) {
            if (selectedOrderMarker === marker) {
                if (assignmentLine) map.removeLayer(assignmentLine);
                assignmentLine = null;
                selectedOrderMarker = null;
            } else {
                selectedOrderMarker = marker;
                if (!assignmentLine) {
                    assignmentLine = L.polyline([marker.getLatLng(), marker.getLatLng()], {
                        className: 'assignment-line'
                    }).addTo(map);
                } else {
                    assignmentLine.setLatLngs([marker.getLatLng(), marker.getLatLng()]);
                }
                SmartLog.info(`Order ${marker.orderData.id} selected for assignment`, "MapModule.Assign");
            }
        }

        function handleOrderDrop(orderMarker, orderData) {
            const dropLatLng = orderMarker.getLatLng();
            let closestDriver = null;
            let minDistance = Infinity;

            Object.values(state.markers.drivers).forEach(driverMarker => {
                const dist = map.latLngToContainerPoint(driverMarker.getLatLng())
                              .distanceTo(map.latLngToContainerPoint(dropLatLng));
                if (dist < minDistance && dist < 50) { // סף של 50 פיקסלים
                    minDistance = dist;
                    closestDriver = driverMarker.driverData;
                }
            });

            if (closestDriver) {
                assignOrder(orderData, closestDriver);
            } else {
                SmartLog.warn(`Order ${orderData.id} dropped, but no driver found.`, "MapModule.Assign");
            }
        }
        
        async function assignOrder(orderData, driverData) {
            SmartLog.info(`Assigning order ${orderData.id} to driver ${driverData.name}`, "Assignment");
            
            const orderRef = doc(db, "orders", orderData.id);
            try {
                await updateDoc(orderRef, {
                    status: "שויך",
                    driver: {
                        id: driverData.id,
                        name: driverData.name
                    }
                });
                SmartLog.info("Assignment successful", "Assignment", { order: orderData.id, driver: driverData.id });
            } catch (e) {
                SmartLog.error(e, "Assignment", { order: orderData.id, driver: driverData.id });
            }
            
            if (assignmentLine) map.removeLayer(assignmentLine);
            assignmentLine = null;
            selectedOrderMarker = null;
        }

        // v46.3: פונקציית זום למרקר
        function zoomToMarker(marker, zoomLevel) {
            if (!map || !marker) return;
            map.flyTo(marker.getLatLng(), zoomLevel, {
                animate: true,
                duration: 1 
            });
        }

        // --- 6. v46.0: CRUD & Render Logic ---
        async function handleSaveOrder(e) {
            e.preventDefault();
            const formData = {
                customer: {
                    name: DOM.addOrderForm.customerName.value,
                },
                address: DOM.addOrderForm.address.value,
                latitude: parseFloat(DOM.addOrderForm.latitude.value) || null,
                longitude: parseFloat(DOM.addOrderForm.longitude.value) || null,
                status: "חדש",
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, "orders"), formData);
                SmartLog.info("New order created", "CRUD.Order", { id: docRef.id });
                closeModal();
            } catch (e) {
                SmartLog.error(e, "CRUD.Order");
            }
        }

        function renderOrdersTable(filter = '') {
            const lcFilter = filter.toLowerCase();
            const orders = Object.values(state.orders).filter(o => 
                !lcFilter ||
                (o.customer?.name && o.customer.name.toLowerCase().includes(lcFilter)) ||
                (o.address && o.address.toLowerCase().includes(lcFilter)) ||
                (o.driver?.name && o.driver.name.toLowerCase().includes(lcFilter))
            );
            
            if (orders.length === 0) {
                DOM.ordersTable.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">אין הזמנות</td></tr>`;
                return;
            }
            DOM.ordersTable.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.id.slice(-6)}</td>
                    <td>${order.customer?.name || '---'}</td>
                    <td>${order.address || '---'}</td>
                    <td>${order.driver?.name || '<i>טרם שויך</i>'}</td>
                    <td><span style="color: var(--primary-color); font-weight: 500;">${order.status || 'חדש'}</span></td>
                    <td>...</td>
                </tr>
            `).join('');
        }
        
        function renderDriversTable(filter = '') {
            const lcFilter = filter.toLowerCase();
            const drivers = Object.values(state.drivers).filter(d =>
                !lcFilter || (d.name && d.name.toLowerCase().includes(lcFilter))
            );

            if (drivers.length === 0) {
                DOM.driversTable.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem;">אין נהגים רשומים</td></tr>`;
                return;
            }
            DOM.driversTable.innerHTML = drivers.map(driver => {
                const location = state.locations[driver.id];
                const lastUpdate = location?.lastUpdate ? 
                    new Date(location.lastUpdate.toDate()).toLocaleTimeString('he-IL') : 'אין נתונים';
                
                return `
                <tr>
                    <td>${driver.name}</td>
                    <td>${driver.phone || '---'}</td>
                    <td><span style="color: var(--success);">${driver.status || 'פעיל'}</span></td>
                    <td>${lastUpdate}</td>
                </tr>
            `}).join('');
        }
        
        // --- Start App ---
        authReady.then(() => {
            init();
        }).catch(err => {
            SmartLog.error(err, "Auth.Fatal");
            updateConnectionStatus(false, "שגיאת אימות Firebase");
        });
        
    </script>
</body>
</html>

